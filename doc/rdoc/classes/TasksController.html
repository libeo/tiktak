<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type"/><title>Class: TasksController</title><link type="text/css" href=".././rdoc-style.css" media="screen" rel="stylesheet"/><script type="text/javascript">
// Allison template
// Copyright 2007, 2008 Cloudburst, LLC. Licensed under the AFL 3. See the included LICENSE file.

var href_base = '.././rdoc-style.css'.replace(/(.*\/).*/, '$1'); // inline js is good for something  

function $(id) {
    if (document.getElementById)
      elem = document.getElementById(id);
    else if ( document.all )
      elem = eval("document.all." + id);
    else
      return false;
    return elem;
}

  function toggle(id) {
    elem = $(id);
    elemStyle = elem.style;   
    if (elemStyle.display == "block") {
      elemStyle.display = "none"
    } else {
      elemStyle.display = "block"
    }
    return true;
  }

  function toggleText(id) {
    elem = $(id)
    if (m = elem.innerHTML.match(/(Hide)(.*)/)) {
      elem.innerHTML = "Show" + m[2];
    } else if (m = elem.innerHTML.match(/(Show)(.*)/)) {
      elem.innerHTML = "Hide" + m[2];
    }
    return true;
  }

function span(s, klass) {
  return '<span class="' + klass + '">' + s + '</span>';
}
  
function highlightSymbols() {
  pres = document.getElementsByTagName('pre');
  for(var i = 0; i < pres.length; i++) {
    pre = pres[i];
    spans = pre.getElementsByTagName('span');
    for(var k = 0; k < spans.length; k++) {
      span = spans[k];
      if (span.className.match(/ruby-identifier/)) {
        if (span.innerHTML.match(/^:/)) {
          span.className += " ruby-symbol";
        }
      }
    }
  }
}

 function hasClass(obj) {
     var result = false;
     if (obj.getAttributeNode("class") != null) {
         result = obj.getAttributeNode("class").value;
     }
     return result;
  }   

 function stripe() {
    var even = true;
    var color = "#e4ebed";
    var tables = document.getElementsByTagName('table');
    if (tables.length == 0) { return; }
    for (var h = 0; h < tables.length; h++) {
        var trs = tables[h].getElementsByTagName("tr");
        for (var i = 0; i < trs.length; i++) {
          var tds = trs[i].getElementsByTagName("td");
            for (var j = 0; j < tds.length; j++) {       
              if (hasClass(tds[j]) != "first") {                
              var mytd = tds[j];
              if (even) {
                mytd.style.backgroundColor = color;
              }         
            }
          }
          even =  ! even;
      }
    }
  }
  
function ajaxGet(url) {
  url = (href_base + url).replace('/./', '/')
  var req = false;

  if (window.ActiveXObject) {
    try {
      // stupid hack because IE7 disables local Ajax with the native xmlhttprequest object
      // for security purposes. Yet ActiveX still works. Thanks, Microsoft. I hate you. Die.
      req = new ActiveXObject("MSXML2.XMLHTTP.3.0");
    } catch (e) {
      try {
        /* IE 6 and maybe 5, don't know, don't care */
        req = new ActiveXObject("Msxml2.XMLHTTP");
      } catch (e) {
        try {
          req = new ActiveXObject("Microsoft.XMLHTTP");
        } catch (e) {
          req = false;
        }
      }
    }
  }
    
  /* real browsers */
  if (!req && window.XMLHttpRequest) {
    try {
      req = new XMLHttpRequest();
    } catch (e) {
      req = false;
    }
  } 
  
  if (req) {
    req.open('GET', url, false);
    req.send(null);
    return req.responseText;
  } else {
    return "Ajax error";  
  }
}


function addEvent(elm, evType, fn, useCapture) {
	if (elm.addEventListener) {
	  elm.addEventListener(evType, fn, useCapture);  
  	return true;
	} else if (elm.attachEvent) {
  	var r = elm.attachEvent('on' + evType, fn);  
	  return r;  
	} else {
  	elm['on' + evType] = fn;
	}
}

function insertIndices() {
  pages = ["class", "file", "method"]
  for (x in pages) { 
    $(pages[x]).innerHTML += ajaxGet('fr_' + pages[x] + '_index.html').replace(/(href=")/g, '$1' + href_base);
  }
  /* mouseoverify method links */
  links = $('method').getElementsByTagName('a');
  for (var x = 0; x < links.length; x++) {
    if (m = links[x].innerHTML.match(/(.*)\s\((.*)\)/)) {
      links[x].innerHTML = m[1] + '<br>';
      links[x].title = m[2];
    }
  }
  /* this is stupid */
  $('class').style.display = "block";
  $('file').style.display = "block";
  
  /* has to be here because IE7 does not guarantee the onLoad callback order */
  abbreviateIndicesInner(["class", "file"], 25, "a");
  /* same, linkTitle() depends on the class link list */
  linkTitle();
}

function abbreviateIndices() {
  var ids = ["defined_in", "child_of", "includes", "requires", "method", "methods"];
  abbreviateIndicesInner(ids, 25, 'a');
  abbreviateIndicesInner(ids, 25, 'span');
}

function abbreviateIndicesInner(indices, amount, tag) {
  for (var x = 0; x < indices.length; x++) { 
    var the_index = $(indices[x]);
    if (the_index) {
      links = the_index.getElementsByTagName(tag);
      for (var y = 0; y < links.length; y++) {
        var link = links[y];
        if (link.getElementsByTagName('span').length == 0 && link.getElementsByTagName('a').length == 0) {
          // avoid nesting
          link.innerHTML = link.innerHTML.replace(/<br>|\n/gi, '');
          link.title = link.innerHTML;
          link.innerHTML = abbreviate(link.innerHTML, amount) + '<br>';
        }
      }
    }
  }
}

function linkTitle() {
  
  /* grab the correct title element from the index */
  var index_page = ajaxGet('index.html');
  title_text = index_page.match(/<title>(.*)<\/title>/m)[1];
  document.title = title_text + " - " + document.title;
  var p = $('header').getElementsByTagName('p')[0]
  if (p.innerHTML.match(/^\s*$/)) {
    p.innerHTML = title_text;
  } else {
    p.innerHTML = title_text + ": " + p.innerHTML;
  }
  
  /* set the link properly */
  title_link = index_page.match(/<a\s+href="(.*?)"/)[1];
  var element = $('title');
  var item_type = "";
  var item_name = "";
  if (m = element.innerHTML.match(/(Class:|Module:|File:)\s*(.*)/)) {
    item_type = m[1];
    item_name = m[2];
  } else {
    item_name = element.innerHTML;
  }
  element.innerHTML = '<a href="' + href_base + title_link + '">' + item_type + " " + abbreviate(item_name, 45) + '</a>';
  element.getElementsByTagName('a')[0].title = item_name
  
  /* breadcrumb navigation */
  items = item_name.split("::");
  items_new = item_name.split("::");
  file_links = $('class').getElementsByTagName('a');
  for (var x = 0; x < items.length - 1; x++ ){
    var item = items[x];
    link = ("/classes/" + items.slice(0,x).join("/") + "/" + item + ".html").replace('//', '/');
    regex = new RegExp(RegExp.escape(link) + '$');
    for (var y = 0; y < file_links.length; y++) {
      if (file_links[y].href.match(regex)) {
         items_new[x] = '<a href="' + href_base + link + '">' + item + '</a>';
         break;
      }
    }  
  }
  $('item_name').innerHTML = item_type + ' ' + items_new.join(" :: ");
}

function abbreviate(s, size) {
  while (s.length > size) {
    var old_s = s;
    s = s.replace(/\s|\n/mg, '');
    s = s.replace(/([A-Z])[a-z]+/m, '$1');
    if (!s || old_s == s) {
      return "..." + s.substring(s.length - size, s.length);
    }
  }
  return s;
}

function disableSubmit(event) {
  var keyCode = event.keyCode ? event.keyCode : event.which ? event.which : event.charCode;
  if (keyCode == 13) {
    return false;
  } else {
    return true;
  }
}
  
function filterList(id, s, event) {
  
  /* some weak escaping */
  s = s.replace(/[^\w\d\.\_\-\/\:\=\[\]\?\!]/g, '');
  s = RegExp.escape(s);
  
  var show_all = false;
  if (s.match(/^\s*$/)) {
    show_all = true;
  }
  
  links = $(id).getElementsByTagName('a')
  regex = new RegExp(s, 'i');
  
  for (var x = 0; x < links.length; x++) {
    var link = links[x];
    if (show_all) {
      link.style.display = 'inline';
    } else {
       if (link.innerHTML.match(regex)) {        
         link.style.display = 'inline';
       } else {
         link.style.display = 'none';
       }
    }
  }
  return true;
}

RegExp.escape = function(text) {
  if (!arguments.callee.sRE) {
    var specials = ['/', '.', '*', '+', '?', '|', '(', ')', '[', ']', '{', '}', '\\'];
    arguments.callee.sRE = new RegExp(
      '(\\' + specials.join('|\\') + ')', 'g'
    );
  }
  return text.replace(arguments.callee.sRE, '\\$1');
}

function hacks() {
  // show the spacer if necessary, 
  divs = document.getElementsByTagName('div');
  for(var x = 0; x < divs.length; x++) {
    if (divs[x].className && divs[x].className.match(/top/)) {
      document.getElementById('spacer').style.display = 'block';
    }
  }
  // remove extra colons from tables
  tds = document.getElementsByTagName('td');
  for(var x = 0; x < tds.length; x++) {
    str = tds[x].innerHTML
    if (str.charAt(str.length - 1) == ":") {
      tds[x].innerHTML = str.slice(0, str.length - 1)
    }
  }
}

addEvent(window, 'load', insertIndices, false);
addEvent(window, 'load', abbreviateIndices, false);
addEvent(window, 'load', stripe, false);
addEvent(window, 'load', highlightSymbols, false);
addEvent(window, 'load', hacks, false);
</script></head><body><div id="container"><div class="curve" id="preheader_curve_0"></div><div class="curve" id="preheader_curve_1"></div><div class="curve" id="preheader_curve_2"></div><div class="curve" id="preheader_curve_3"></div><div class="curve" id="preheader_curve_4"></div><div class="curve" id="preheader_curve_5"></div><div id="header"><p>
</p><span><h1 id="title">
Class: TasksController
</h1></span>
</div><div class="clear"></div><div id="left">
<div class="navigation darker top" id="child_of"><h3>Child of</h3><span>

<a href='ApplicationController.html'>
ApplicationController
</a>
</span></div>

<div class="navigation darker top" id="defined_in"><h3>Defined in</h3>

<a href="../files/app/controllers/tasks_controller_rb.html">app/controllers/tasks_controller.rb</a>

</div>



<div class="navigation top" id="methods"><h3>Methods</h3>


<a href='#M000178'>
add_log<br/>
</a>




<a href='#M000167'>
add_work<br/>
</a>




<a href='#M000160'>
ajax_check<br/>
</a>




<a href='#M000158'>
ajax_hide<br/>
</a>




<a href='#M000159'>
ajax_restore<br/>
</a>




<a href='#M000161'>
ajax_uncheck<br/>
</a>




<a href='#M000165'>
cancel_work_ajax<br/>
</a>




<a href='#M000152'>
create<br/>
</a>




<a href='#M000184'>
create_ajax<br/>
</a>




<a href='#M000185'>
create_shortlist_ajax<br/>
</a>




<a href='#M000188'>
create_todo_ajax<br/>
</a>




<a href='#M000193'>
delete_tag<br/>
</a>




<a href='#M000150'>
dependency_targets<br/>
</a>




<a href='#M000177'>
destroy_log<br/>
</a>




<a href='#M000173'>
do_filter<br/>
</a>




<a href='#M000154'>
edit<br/>
</a>




<a href='#M000176'>
edit_log<br/>
</a>




<a href='#M000174'>
filter<br/>
</a>




<a href='#M000175'>
filter_shortlist<br/>
</a>




<a href='#M000180'>
get_csv<br/>
</a>




<a href='#M000149'>
get_milestones<br/>
</a>




<a href='#M000151'>
get_owners<br/>
</a>




<a href='#M000147'>
index<br/>
</a>




<a href='#M000148'>
list<br/>
</a>




<a href='#M000181'>
move<br/>
</a>




<a href='#M000146'>
new<br/>
</a>




<a href='#M000190'>
order_todos<br/>
</a>




<a href='#M000187'>
pause_work_ajax<br/>
</a>




<a href='#M000183'>
quick_add<br/>
</a>




<a href='#M000155'>
repeat_task<br/>
</a>




<a href='#M000179'>
save_log<br/>
</a>




<a href='#M000194'>
save_tag<br/>
</a>




<a href='#M000186'>
shortlist<br/>
</a>




<a href='#M000162'>
start_work<br/>
</a>




<a href='#M000163'>
start_work_ajax<br/>
</a>




<a href='#M000164'>
start_work_edit_ajax<br/>
</a>




<a href='#M000168'>
stop_work<br/>
</a>




<a href='#M000169'>
stop_work_shortlist<br/>
</a>




<a href='#M000166'>
swap_work_ajax<br/>
</a>




<a href='#M000192'>
tags<br/>
</a>




<a href='#M000189'>
todo_check_ajax<br/>
</a>




<a href='#M000191'>
todo_delete_ajax<br/>
</a>




<a href='#M000182'>
toggle_history<br/>
</a>




<a href='#M000156'>
update<br/>
</a>




<a href='#M000157'>
update_ajax<br/>
</a>




<a href='#M000171'>
update_sheet_info<br/>
</a>




<a href='#M000172'>
update_tasks<br/>
</a>




<a href='#M000170'>
updatelog<br/>
</a>




<a href='#M000153'>
view<br/>
</a>


</div>
<div id="spacer"></div><div class="navigation darker index" id="class_wrapper"><div class="list_header"><h3>All classes</h3></div><div class="list_header_link"><a onclick="toggle('class'); toggleText('class_link'); return false;" href="#" id="class_link">Hide...</a></div><div class="clear"></div><div id="class"><form><label for="filter_class">Filter:&nbsp;&nbsp;</label><input type="text" onKeyUp="return filterList('class', this.value, event);" onKeyPress="return disableSubmit(event);" id="filter_class"></input></form></div></div><div class="navigation darker index" id="file_wrapper"><div class="list_header"><h3>All files</h3></div><div class="list_header_link"><a onclick="toggle('file'); toggleText('file_link'); return false;" href="#" id="file_link">Hide...</a></div><div class="clear"></div><div id="file"><form><label for="filter_file">Filter:&nbsp;&nbsp;</label><input type="text" onKeyUp="return filterList('file', this.value, event);" onKeyPress="return disableSubmit(event);" id="filter_file"></input></form></div></div><div class="navigation darker index" id="method_wrapper"><div class="list_header"><h3>All methods</h3></div><div class="list_header_link"><a onclick="toggle('method'); toggleText('method_link'); return false;" href="#" id="method_link">Show...</a></div><div class="clear"></div><div id="method"><form><label for="filter_method">Filter:&nbsp;&nbsp;</label><input type="text" onKeyUp="return filterList('method', this.value, event);" onKeyPress="return disableSubmit(event);" id="filter_method"></input></form></div></div></div><div id="content">
<h1 id="item_name">Class: TasksController</h1>

<div id="description"><p>
Handle tasks for a <a href="Company.html">Company</a> / <a
href="User.html">User</a>
</p>
<table>
<tr><td valign="top">Author:</td><td>Erlend Simonsen (<a
href="mailto:admin@clockingit.com">admin@clockingit.com</a>)

</td></tr>
</table>
</div>




<p></p>






<h1>Public Instance Methods</h1>


<a class="small" name="M000178"><br/></a>
<div class="method_block"><h3>
<a href='#M000178'>


add_log

()

</a>
</h3>

<p class="source_link" id="M000178-show-link"><a onclick="toggle('M000178-source'); toggleText('M000178-link'); return false;" href="#" id="M000178-link">Show source...</a></p><div class="source" id="M000178-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1268</span>
1268:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">add_log</span>
1269:     <span class="ruby-ivar">@log</span> = <span class="ruby-constant">Worklog</span>.<span class="ruby-identifier">new</span>
1270:     <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">started_at</span> = <span class="ruby-identifier">tz</span>.<span class="ruby-identifier">utc_to_local</span>(<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>)
1271:     <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;company_id = ?&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>])
1272:     <span class="ruby-identifier">render</span> <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'edit_log'</span>
1273:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000167"><br/></a>
<div class="method_block"><h3>
<a href='#M000167'>


add_work

()

</a>
</h3>

<p class="source_link" id="M000167-show-link"><a onclick="toggle('M000167-source'); toggleText('M000167-link'); return false;" href="#" id="M000167-link">Show source...</a></p><div class="source" id="M000167-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1097</span>
1097:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">add_work</span>
1098:     <span class="ruby-keyword kw">begin</span>
1099:       <span class="ruby-ivar">@task</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">tasks</span>.<span class="ruby-identifier">find</span>( <span class="ruby-identifier">params</span>[<span class="ruby-value str">'id'</span>] )
1100:     <span class="ruby-keyword kw">rescue</span>
1101:       <span class="ruby-identifier">flash</span>[<span class="ruby-value str">'notice'</span>] = <span class="ruby-identifier">_</span>(<span class="ruby-value str">'Unable to find task belonging to you with that ID.'</span>)
1102:       <span class="ruby-identifier">redirect_from_last</span>
1103:       <span class="ruby-keyword kw">return</span>
1104:     <span class="ruby-keyword kw">end</span>
1105: 
1106:     <span class="ruby-ivar">@log</span> = <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">new</span>
1107:     <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">user</span> = <span class="ruby-identifier">current_user</span>
1108:     <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">company</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company</span>
1109:     <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">project</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>
1110:     <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">task</span> = <span class="ruby-ivar">@task</span>
1111:     <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">customer</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">customer</span>
1112:     <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">started_at</span> = <span class="ruby-identifier">tz</span>.<span class="ruby-identifier">utc_to_local</span>(<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>)
1113:     <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-value">0</span>
1114:     <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_WORK_ADDED</span>
1115:     
1116:     <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">save</span>
1117:     <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; @task.id)}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
1118: 
1119:     <span class="ruby-identifier">render</span> <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'edit_log'</span>
1120:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000160"><br/></a>
<div class="method_block"><h3>
<a href='#M000160'>


ajax_check

()

</a>
</h3>

<p class="source_link" id="M000160-show-link"><a onclick="toggle('M000160-source'); toggleText('M000160-link'); return false;" href="#" id="M000160-link">Show source...</a></p><div class="source" id="M000160-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 918</span>
918:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">ajax_check</span>
919:     <span class="ruby-keyword kw">begin</span>
920:       <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;project_id IN (?)&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span><span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span>}], <span class="ruby-identifier">:include</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:project</span>)
921:     <span class="ruby-keyword kw">rescue</span>
922:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:nothing</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>
923:       <span class="ruby-keyword kw">return</span>
924:     <span class="ruby-keyword kw">end</span> 
925: 
926:     <span class="ruby-identifier">old_status</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status_type</span>
927:     
928:     <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">completed_at</span>
929: 
930:       <span class="ruby-identifier">worklog</span> = <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">new</span>
931:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">user</span> = <span class="ruby-identifier">current_user</span>
932:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">company</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">company</span>
933:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">customer</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">customer</span>
934:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">project</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>
935:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">task</span> = <span class="ruby-ivar">@task</span>
936: 
937:       <span class="ruby-identifier">body</span> = <span class="ruby-value str">&quot;&quot;</span>
938: 
939:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@current_sheet</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">task_id</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">id</span>
940:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">started_at</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">created_at</span>
941:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">duration</span>
942:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">paused_duration</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">paused_duration</span>
943:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_COMPLETED</span>
944:         <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">body</span>.<span class="ruby-identifier">blank?</span>
945:           <span class="ruby-identifier">body</span> = <span class="ruby-node">&quot;\n#{@current_sheet.body}&quot;</span>
946:           <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">comment</span> = <span class="ruby-keyword kw">true</span> 
947:         <span class="ruby-keyword kw">end</span> 
948:       <span class="ruby-keyword kw">else</span> 
949:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">started_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>
950:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-value">0</span>
951:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_COMPLETED</span>
952:       <span class="ruby-keyword kw">end</span> 
953: 
954:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">completed_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>
955:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">updated_by_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
956:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status</span> = <span class="ruby-value">2</span>
957:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">save</span>
958:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">reload</span>
959: 
960:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">body</span> = <span class="ruby-node">&quot;- &lt;strong&gt;Status&lt;/strong&gt;: #{old_status} -&gt; #{@task.status_type}\n&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">body</span>
961:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">save</span>
962:         <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">destroy</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@current_sheet</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">task_id</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">id</span>
963:       <span class="ruby-keyword kw">end</span> 
964: 
965: 
966:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">next_repeat_date</span> <span class="ruby-operator">!=</span> <span class="ruby-keyword kw">nil</span>
967:           <span class="ruby-identifier">repeat_task</span>(<span class="ruby-ivar">@task</span>)
968:       <span class="ruby-keyword kw">end</span>
969: 
970:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">send_notifications?</span>
971:         <span class="ruby-constant">Notifications</span><span class="ruby-operator">::</span><span class="ruby-identifier">deliver_changed</span>(<span class="ruby-identifier">:completed</span>, <span class="ruby-ivar">@task</span>, <span class="ruby-identifier">current_user</span>, <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">body</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/&lt;[^&gt;]*&gt;/</span>,<span class="ruby-value str">''</span>) ) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
972:       <span class="ruby-keyword kw">end</span>
973: 
974:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; @task.id)}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
975:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'activities', :action =&gt; 'refresh')}');&quot;</span>, [<span class="ruby-node">&quot;activity_#{current_user.company_id}&quot;</span>])
976:     <span class="ruby-keyword kw">end</span>
977: 
978:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000158"><br/></a>
<div class="method_block"><h3>
<a href='#M000158'>


ajax_hide

()

</a>
</h3>

<p class="source_link" id="M000158-show-link"><a onclick="toggle('M000158-source'); toggleText('M000158-link'); return false;" href="#" id="M000158-link">Show source...</a></p><div class="source" id="M000158-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 870</span>
870:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">ajax_hide</span>
871:     <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;project_id IN (#{current_project_ids})&quot;</span>])
872: 
873:     <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">hidden</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
874:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">hidden</span> = <span class="ruby-value">1</span>
875:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">updated_by_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
876:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">save</span>
877: 
878:       <span class="ruby-identifier">worklog</span> = <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">new</span>
879:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">user</span> = <span class="ruby-identifier">current_user</span>
880:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">company</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">company</span>
881:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">customer</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">customer</span>
882:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">project</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>
883:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">task</span> = <span class="ruby-ivar">@task</span>
884:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">started_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>
885:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-value">0</span>
886:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_ARCHIVED</span>
887:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">body</span> = <span class="ruby-value str">&quot;&quot;</span>
888:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">save</span>
889:     <span class="ruby-keyword kw">end</span>
890: 
891:     <span class="ruby-identifier">render</span> <span class="ruby-identifier">:nothing</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>
892:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000159"><br/></a>
<div class="method_block"><h3>
<a href='#M000159'>


ajax_restore

()

</a>
</h3>

<p class="source_link" id="M000159-show-link"><a onclick="toggle('M000159-source'); toggleText('M000159-link'); return false;" href="#" id="M000159-link">Show source...</a></p><div class="source" id="M000159-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 894</span>
894:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">ajax_restore</span>
895:     <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;project_id IN (#{current_project_ids})&quot;</span>])
896:     <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">hidden</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
897:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">hidden</span> = <span class="ruby-value">0</span>
898:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">updated_by_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
899:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">save</span>
900: 
901:       <span class="ruby-identifier">worklog</span> = <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">new</span>
902:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">user</span> = <span class="ruby-identifier">current_user</span>
903:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">company</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">company</span>
904:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">customer</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">customer</span>
905:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">project</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>
906:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">task</span> = <span class="ruby-ivar">@task</span>
907:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">started_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>
908:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-value">0</span>
909:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-value">1</span>
910:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_RESTORED</span>
911:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">body</span> = <span class="ruby-value str">&quot;&quot;</span>
912:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">save</span>
913:     <span class="ruby-keyword kw">end</span>
914:     <span class="ruby-identifier">render</span> <span class="ruby-identifier">:nothing</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>
915:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000161"><br/></a>
<div class="method_block"><h3>
<a href='#M000161'>


ajax_uncheck

()

</a>
</h3>

<p class="source_link" id="M000161-show-link"><a onclick="toggle('M000161-source'); toggleText('M000161-link'); return false;" href="#" id="M000161-link">Show source...</a></p><div class="source" id="M000161-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 980</span>
 980:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">ajax_uncheck</span>
 981:     <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;project_id IN (?)&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span><span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span>}], <span class="ruby-identifier">:include</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:project</span>)
 982: 
 983:     <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">completed_at</span>.<span class="ruby-identifier">nil?</span>
 984: 
 985:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">completed_at</span> = <span class="ruby-keyword kw">nil</span>
 986:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status</span> = <span class="ruby-value">0</span>
 987:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">updated_by_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
 988:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">save</span>
 989: 
 990:       <span class="ruby-identifier">worklog</span> = <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">new</span>
 991:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">user</span> = <span class="ruby-identifier">current_user</span>
 992:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">company</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">company</span>
 993:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">customer</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">customer</span>
 994:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">project</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>
 995:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">task</span> = <span class="ruby-ivar">@task</span>
 996:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">started_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>
 997:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-value">0</span>
 998:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_REVERTED</span>
 999:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">body</span> = <span class="ruby-value str">&quot;&quot;</span>
1000:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">save</span>
1001: 
1002:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">send_notifications?</span>
1003:         <span class="ruby-constant">Notifications</span><span class="ruby-operator">::</span><span class="ruby-identifier">deliver_changed</span>(<span class="ruby-identifier">:reverted</span>, <span class="ruby-ivar">@task</span>, <span class="ruby-identifier">current_user</span>, <span class="ruby-value str">&quot;&quot;</span> ) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">begin</span> <span class="ruby-keyword kw">end</span>
1004:       <span class="ruby-keyword kw">end</span>
1005: 
1006:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; @task.id)}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
1007:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'activities', :action =&gt; 'refresh')}');&quot;</span>, [<span class="ruby-node">&quot;activity_#{current_user.company_id}&quot;</span>])
1008:     <span class="ruby-keyword kw">end</span>
1009: 
1010:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000165"><br/></a>
<div class="method_block"><h3>
<a href='#M000165'>


cancel_work_ajax

()

</a>
</h3>

<p class="source_link" id="M000165-show-link"><a onclick="toggle('M000165-source'); toggleText('M000165-link'); return false;" href="#" id="M000165-link">Show source...</a></p><div class="source" id="M000165-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1045</span>
1045:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">cancel_work_ajax</span>
1046:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@current_sheet</span> 
1047:       <span class="ruby-ivar">@task</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">task</span>
1048:       <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">destroy</span>
1049:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; @current_sheet.task_id)}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
1050:       <span class="ruby-ivar">@current_sheet</span> = <span class="ruby-keyword kw">nil</span>
1051:     <span class="ruby-keyword kw">end</span>
1052:     <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">xhr?</span>
1053:     <span class="ruby-identifier">redirect_from_last</span>
1054:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000152"><br/></a>
<div class="method_block"><h3>
<a href='#M000152'>


create

()

</a>
</h3>
<p>
def get_watchers
</p>
<pre>
  @users = Project.find(params[:project_id]).users.find(:all, :order =&gt; 'name' )

  @options = @users.collect{ |u| (' {&quot;text&quot;:&quot;' + u.name.gsub(/&quot;/,'\&quot;') + '&quot;, &quot;value&quot;:&quot;' + u.id.to_s + '&quot;}') }.join( ',' )
  res = '{&quot;options&quot;:['
  res &lt;&lt; &quot;#{@options}&quot; unless @options.nil? || @options.empty?
  res &lt;&lt; ']}'

  render :text =&gt; &quot;#{res}&quot;
</pre>
<p>
end
</p>

<p class="source_link" id="M000152-show-link"><a onclick="toggle('M000152-source'); toggleText('M000152-link'); return false;" href="#" id="M000152-link">Show source...</a></p><div class="source" id="M000152-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 292</span>
292:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">create</span>
293: 
294:     <span class="ruby-identifier">tags</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:set_tags</span>]
295:     <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:set_tags</span>] = <span class="ruby-keyword kw">nil</span>
296: 
297:     <span class="ruby-ivar">@task</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company</span>.<span class="ruby-identifier">tasks</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>])
298: 
299:     <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:due_at</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:due_at</span>].<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
300: 
301:       <span class="ruby-identifier">repeat</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">parse_repeat</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:due_at</span>])
302:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">repeat</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">repeat</span> <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;&quot;</span>
303:         <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">repeat</span> = <span class="ruby-identifier">repeat</span>
304:         <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">due_at</span> = <span class="ruby-identifier">tz</span>.<span class="ruby-identifier">local_to_utc</span>(<span class="ruby-ivar">@task</span>.<span class="ruby-identifier">next_repeat_date</span>)
305:       <span class="ruby-keyword kw">else</span>
306:         <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">repeat</span> = <span class="ruby-keyword kw">nil</span>
307:         <span class="ruby-identifier">due_date</span> = <span class="ruby-constant">DateTime</span>.<span class="ruby-identifier">strptime</span>( <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:due_at</span>], <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">date_format</span> ) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">begin</span>
308:                                                                                                     <span class="ruby-identifier">flash</span>[<span class="ruby-value str">'notice'</span>] = <span class="ruby-identifier">_</span>(<span class="ruby-value str">'Invalid due date ignored.'</span>)
309:                                                                                                     <span class="ruby-identifier">due_date</span> = <span class="ruby-keyword kw">nil</span>
310:                                                                                                   <span class="ruby-keyword kw">end</span>
311:         <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">due_at</span> = <span class="ruby-identifier">tz</span>.<span class="ruby-identifier">local_to_utc</span>(<span class="ruby-identifier">due_date</span>.<span class="ruby-identifier">to_time</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>.<span class="ruby-identifier">day</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>.<span class="ruby-identifier">minute</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">due_date</span>.<span class="ruby-identifier">nil?</span>
312:       <span class="ruby-keyword kw">end</span>
313:     <span class="ruby-keyword kw">else</span>
314:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">repeat</span> = <span class="ruby-keyword kw">nil</span>
315:     <span class="ruby-keyword kw">end</span>
316: 
317:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">company_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>
318:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">updated_by_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
319:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">creator_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
320:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-identifier">parse_time</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:duration</span>], <span class="ruby-keyword kw">true</span>) 
321:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">set_tags</span>(<span class="ruby-identifier">tags</span>) 
322:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">set_task_num</span>(<span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>)
323:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-value">0</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">duration</span>.<span class="ruby-identifier">nil?</span>
324: 
325:     <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">can?</span>(<span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>, <span class="ruby-value str">'create'</span>)
326:       <span class="ruby-identifier">flash</span>[<span class="ruby-value str">'notice'</span>] = <span class="ruby-identifier">_</span>(<span class="ruby-value str">&quot;You don't have access to create tasks on this project.&quot;</span>)
327:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">xhr?</span>
328: 
329:       <span class="ruby-ivar">@projects</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'name'</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;completed_at IS NULL&quot;</span>]).<span class="ruby-identifier">collect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> [ <span class="ruby-node">&quot;#{c.name} / #{c.customer.name}&quot;</span>, <span class="ruby-identifier">c</span>.<span class="ruby-identifier">id</span> ] <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">can?</span>(<span class="ruby-identifier">c</span>, <span class="ruby-value str">'create'</span>)  }.<span class="ruby-identifier">compact</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">nil?</span>
330:       <span class="ruby-ivar">@tags</span> = <span class="ruby-constant">Tag</span>.<span class="ruby-identifier">top_counts</span>({ <span class="ruby-identifier">:company_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>, <span class="ruby-identifier">:project_ids</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">current_project_ids</span>, <span class="ruby-identifier">:filter_hidden</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_hidden</span>]})
331:       <span class="ruby-ivar">@notify_targets</span> = <span class="ruby-identifier">current_projects</span>.<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">users</span>.<span class="ruby-identifier">collect</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">:name</span>) }.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>
332:       <span class="ruby-ivar">@notify_targets</span> <span class="ruby-operator">+=</span> <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;project_id IN (#{current_project_ids}) AND notify_emails IS NOT NULL and notify_emails &lt;&gt; ''&quot;</span>]).<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">notify_emails</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">','</span>).<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">strip</span> } }
333:       <span class="ruby-ivar">@notify_targets</span> = <span class="ruby-ivar">@notify_targets</span>.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>
334:       <span class="ruby-ivar">@notify_targets</span> <span class="ruby-operator">||=</span> []
335: 
336:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'new'</span>
337:       <span class="ruby-keyword kw">return</span>
338:     <span class="ruby-keyword kw">end</span>
339:     
340:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">save</span>
341: 
342:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:last_project_id</span>] = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project_id</span>
343:       
344:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:watchers</span>]
345:         <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:watchers</span>].<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">elem</span><span class="ruby-operator">|</span>
346:           <span class="ruby-identifier">elem</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">','</span>).<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">w</span><span class="ruby-operator">|</span>
347:             <span class="ruby-identifier">u</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by_name</span>(<span class="ruby-identifier">w</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;company_id = ?&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>])
348:             <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">u</span>.<span class="ruby-identifier">nil?</span>
349:               <span class="ruby-comment cmt"># Found user</span>
350:               <span class="ruby-identifier">n</span> = <span class="ruby-constant">Notification</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">:user</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">u</span>, <span class="ruby-identifier">:task</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@task</span>)
351:               <span class="ruby-identifier">n</span>.<span class="ruby-identifier">save</span>
352:             <span class="ruby-keyword kw">else</span>
353:               <span class="ruby-comment cmt"># Not a user, check for email address</span>
354:               <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">w</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-value str">'@'</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span>(<span class="ruby-ivar">@task</span>.<span class="ruby-identifier">notify_emails</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">notify_emails</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">w</span>))
355:                 <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">notify_emails</span> <span class="ruby-operator">||=</span> <span class="ruby-value str">&quot;&quot;</span>
356:                 <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">notify_emails</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;,&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">notify_emails</span>.<span class="ruby-identifier">empty?</span>
357:                 <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">notify_emails</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">w</span>
358:               <span class="ruby-keyword kw">end</span>
359:             <span class="ruby-keyword kw">end</span>
360:           <span class="ruby-keyword kw">end</span>
361:         <span class="ruby-keyword kw">end</span>
362:         <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">save</span>
363:       <span class="ruby-keyword kw">end</span>
364: 
365:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:users</span>]
366:         <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:users</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">o</span><span class="ruby-operator">|</span>
367:           <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
368:           <span class="ruby-identifier">u</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">o</span>.<span class="ruby-identifier">to_i</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;company_id = ?&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>])
369:           <span class="ruby-identifier">to</span> = <span class="ruby-constant">TaskOwner</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">:user</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">u</span>, <span class="ruby-identifier">:task</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@task</span>)
370:           <span class="ruby-identifier">to</span>.<span class="ruby-identifier">save</span>
371:         <span class="ruby-keyword kw">end</span>
372:       <span class="ruby-keyword kw">end</span>
373: 
374:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:dependencies</span>]
375:         <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:dependencies</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">d</span><span class="ruby-operator">|</span>
376:           <span class="ruby-identifier">deps</span> = <span class="ruby-identifier">d</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">','</span>)
377:           <span class="ruby-identifier">deps</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">dep</span><span class="ruby-operator">|</span>
378:             <span class="ruby-identifier">dep</span>.<span class="ruby-identifier">strip!</span>
379:             <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">dep</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
380:             <span class="ruby-identifier">t</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;project_id IN (#{current_project_ids}) AND task_num = ?&quot;</span>, <span class="ruby-identifier">dep</span>])
381:             <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">nil?</span>
382:               <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">dependencies</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">t</span>
383:             <span class="ruby-keyword kw">end</span>
384:           <span class="ruby-keyword kw">end</span>
385:         <span class="ruby-keyword kw">end</span>
386:         <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">save</span>
387:       <span class="ruby-keyword kw">end</span>
388: 
389:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value str">'task_file'</span>].<span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">:original_filename</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value str">'task_file'</span>].<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
390: 
391:         <span class="ruby-identifier">filename</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task_file</span>].<span class="ruby-identifier">original_filename</span>
392:         <span class="ruby-identifier">filename</span> = <span class="ruby-identifier">filename</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">&quot;/&quot;</span>).<span class="ruby-identifier">last</span>
393:         <span class="ruby-identifier">filename</span> = <span class="ruby-identifier">filename</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">&quot;\\&quot;</span>).<span class="ruby-identifier">last</span>
394:         <span class="ruby-identifier">filename</span> = <span class="ruby-identifier">filename</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/[^a-zA-Z0-9.]/</span>, <span class="ruby-value str">'_'</span>)
395: 
396:         <span class="ruby-identifier">task_file</span> = <span class="ruby-constant">ProjectFile</span>.<span class="ruby-identifier">new</span>()
397:         <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">company</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company</span>
398:         <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">customer</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">customer</span>
399:         <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">project</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>
400:         <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">task_id</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">id</span>
401:         <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">user_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
402:         <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">filename</span> = <span class="ruby-identifier">filename</span>
403:         <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">name</span> = <span class="ruby-identifier">filename</span>
404:         <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">save</span>
405:         <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">file_size</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value str">'task_file'</span>].<span class="ruby-identifier">size</span>
406: 
407: 
408:         <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">save</span>
409:         <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">reload</span>
410: 
411:         <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-constant">File</span>.<span class="ruby-identifier">directory?</span>(<span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">path</span>)
412:           <span class="ruby-constant">File</span>.<span class="ruby-identifier">umask</span>(<span class="ruby-value">0</span>)
413:           <span class="ruby-constant">Dir</span>.<span class="ruby-identifier">mkdir</span>(<span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">path</span>, <span class="ruby-value">0777</span>) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
414:         <span class="ruby-keyword kw">end</span>
415: 
416:         <span class="ruby-constant">File</span>.<span class="ruby-identifier">umask</span>(<span class="ruby-value">0</span>)
417:         <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">file_path</span>, <span class="ruby-value str">&quot;wb&quot;</span>, <span class="ruby-value">0777</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">write</span>( <span class="ruby-identifier">params</span>[<span class="ruby-value str">'task_file'</span>].<span class="ruby-identifier">read</span> ) } <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">begin</span>
418:                                                                                                         <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">destroy</span>
419:                                                                                                         <span class="ruby-identifier">task_file</span> = <span class="ruby-keyword kw">nil</span>
420:                                                                                                         <span class="ruby-identifier">flash</span>[<span class="ruby-value str">'notice'</span>] = <span class="ruby-identifier">_</span>(<span class="ruby-value str">&quot;Permission denied while saving file.&quot;</span>)
421:                                                                                                       <span class="ruby-keyword kw">end</span>
422:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">task_file</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">filename</span>[<span class="ruby-regexp re">/\.gif|\.png|\.jpg|\.jpeg|\.tif|\.bmp|\.psd/i</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">file_size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
423:            <span class="ruby-identifier">image</span> = <span class="ruby-constant">Magick</span><span class="ruby-operator">::</span><span class="ruby-constant">Image</span>.<span class="ruby-identifier">read</span>( <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">file_path</span> ).<span class="ruby-identifier">first</span>
424: 
425:            <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">image</span>.<span class="ruby-identifier">columns</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
426:               <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">file_type</span> = <span class="ruby-constant">ProjectFile</span><span class="ruby-operator">::</span><span class="ruby-constant">FILETYPE_IMG</span>
427:               <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">mime_type</span> = <span class="ruby-identifier">image</span>.<span class="ruby-identifier">mime_type</span>
428:               <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">save</span>
429:            <span class="ruby-keyword kw">end</span>
430:            <span class="ruby-identifier">image</span> = <span class="ruby-keyword kw">nil</span>
431:            <span class="ruby-constant">GC</span>.<span class="ruby-identifier">start</span>
432:         <span class="ruby-keyword kw">end</span>
433: 
434:         <span class="ruby-comment cmt">#TODO Add notification</span>
435:       <span class="ruby-keyword kw">end</span>
436: 
437:       <span class="ruby-identifier">worklog</span> = <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">new</span>
438:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">user</span> = <span class="ruby-identifier">current_user</span>
439:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">company</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">company</span>
440:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">customer</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">customer</span>
441:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">project</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>
442:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">task</span> = <span class="ruby-ivar">@task</span>
443:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">started_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>
444:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-value">0</span>
445:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_CREATED</span>
446:       <span class="ruby-keyword kw">if</span> (<span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-identifier">:comment</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:comment</span>].<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>)
447:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">body</span> =  <span class="ruby-constant">CGI</span><span class="ruby-operator">::</span><span class="ruby-identifier">escapeHTML</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:comment</span>])
448:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">comment</span> = <span class="ruby-keyword kw">true</span>
449:       <span class="ruby-keyword kw">end</span> 
450: 
451:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">save</span>
452:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value str">'notify'</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
453:         <span class="ruby-constant">Notifications</span><span class="ruby-operator">::</span><span class="ruby-identifier">deliver_created</span>( <span class="ruby-ivar">@task</span>, <span class="ruby-identifier">current_user</span>, <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:comment</span>]) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">begin</span> <span class="ruby-keyword kw">end</span>
454:       <span class="ruby-keyword kw">end</span>
455: 
456:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'activities', :action =&gt; 'refresh')}');&quot;</span>, [<span class="ruby-node">&quot;activity_#{current_user.company_id}&quot;</span>])
457: 
458:       <span class="ruby-identifier">flash</span>[<span class="ruby-value str">'notice'</span>] <span class="ruby-operator">||=</span> <span class="ruby-node">&quot;#{link_to_task(@task)} - #{_('Task was successfully created.')}&quot;</span>
459: 
460:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">xhr?</span>
461: 
462:       <span class="ruby-identifier">redirect_from_last</span>
463:     <span class="ruby-keyword kw">else</span>
464:       <span class="ruby-ivar">@projects</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'name'</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;completed_at IS NULL&quot;</span>]).<span class="ruby-identifier">collect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> [ <span class="ruby-node">&quot;#{c.name} / #{c.customer.name}&quot;</span>, <span class="ruby-identifier">c</span>.<span class="ruby-identifier">id</span> ] <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">can?</span>(<span class="ruby-identifier">c</span>, <span class="ruby-value str">'create'</span>)  }.<span class="ruby-identifier">compact</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">nil?</span>
465:       <span class="ruby-ivar">@tags</span> = <span class="ruby-constant">Tag</span>.<span class="ruby-identifier">top_counts</span>({ <span class="ruby-identifier">:company_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>, <span class="ruby-identifier">:project_ids</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">current_project_ids</span>, <span class="ruby-identifier">:filter_hidden</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_hidden</span>]})
466:       <span class="ruby-ivar">@notify_targets</span> = <span class="ruby-identifier">current_projects</span>.<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">users</span>.<span class="ruby-identifier">collect</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">:name</span>) }.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>
467:       <span class="ruby-ivar">@notify_targets</span> <span class="ruby-operator">+=</span> <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;project_id IN (#{current_project_ids}) AND notify_emails IS NOT NULL and notify_emails &lt;&gt; ''&quot;</span>]).<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">notify_emails</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">','</span>).<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">strip</span> } }
468:       <span class="ruby-ivar">@notify_targets</span> = <span class="ruby-ivar">@notify_targets</span>.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>
469:       <span class="ruby-ivar">@notify_targets</span> <span class="ruby-operator">||=</span> []
470:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">xhr?</span>
471:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'new'</span>
472:     <span class="ruby-keyword kw">end</span>
473:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000184"><br/></a>
<div class="method_block"><h3>
<a href='#M000184'>


create_ajax

()

</a>
</h3>

<p class="source_link" id="M000184-show-link"><a onclick="toggle('M000184-source'); toggleText('M000184-link'); return false;" href="#" id="M000184-link">Show source...</a></p><div class="source" id="M000184-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1598</span>
1598:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">create_ajax</span>
1599:     <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">create</span>
1600:     <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">id</span>
1601:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1602:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-value str">&quot;quick_add_container&quot;</span>, <span class="ruby-identifier">:duration</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span><span class="ruby-value">.5</span>, <span class="ruby-identifier">:startcolor</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;#ff9999&quot;</span>)
1603:       <span class="ruby-keyword kw">end</span>
1604:     <span class="ruby-keyword kw">else</span>
1605:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">reload</span>
1606:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1607:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">insert_html</span> <span class="ruby-identifier">:top</span>, <span class="ruby-value str">&quot;task_list&quot;</span>, <span class="ruby-identifier">:partial</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'task_row'</span>, <span class="ruby-identifier">:locals</span> =<span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">:task</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@task</span>, <span class="ruby-identifier">:depth</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>}
1608:         [<span class="ruby-value str">'task_name'</span>, <span class="ruby-value str">'task_set_tags'</span>, <span class="ruby-value str">'task_description'</span>, <span class="ruby-value str">'dependencies_input'</span>, <span class="ruby-value str">'task_duration'</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">el</span><span class="ruby-operator">|</span>
1609:           <span class="ruby-identifier">page</span>.<span class="ruby-identifier">call</span> <span class="ruby-node">&quot;$('#{el}').clear&quot;</span>
1610:         <span class="ruby-keyword kw">end</span>
1611:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-node">&quot;task_#{@task.id}&quot;</span>, <span class="ruby-identifier">:duration</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">1.5</span>)
1612:         <span class="ruby-identifier">page</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;$('task_name').focus();&quot;</span>
1613:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">call</span>(<span class="ruby-value str">&quot;updateTooltips&quot;</span>)
1614:       <span class="ruby-keyword kw">end</span>
1615:     <span class="ruby-keyword kw">end</span>
1616:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000185"><br/></a>
<div class="method_block"><h3>
<a href='#M000185'>


create_shortlist_ajax

()

</a>
</h3>

<p class="source_link" id="M000185-show-link"><a onclick="toggle('M000185-source'); toggleText('M000185-link'); return false;" href="#" id="M000185-link">Show source...</a></p><div class="source" id="M000185-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1618</span>
1618:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">create_shortlist_ajax</span>
1619: 
1620:     <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:name</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:name</span>].<span class="ruby-identifier">empty?</span>
1621:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1622:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-value str">&quot;shortlist&quot;</span>, <span class="ruby-identifier">:duration</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span><span class="ruby-value">.5</span>, <span class="ruby-identifier">:startcolor</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;#ff9999&quot;</span>)
1623:       <span class="ruby-keyword kw">end</span>
1624:       <span class="ruby-keyword kw">return</span>
1625:     <span class="ruby-keyword kw">end</span>
1626: 
1627:     <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">new</span>
1628:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">name</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:name</span>]
1629:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">company_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>
1630:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">updated_by_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
1631:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">creator_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
1632:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-value">0</span>
1633:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">set_task_num</span>(<span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>)
1634:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">description</span> = <span class="ruby-value str">&quot;&quot;</span>
1635: 
1636:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_milestone_short</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
1637:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span> = <span class="ruby-constant">Milestone</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;company_id = ? AND id = ?&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>, <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_milestone_short</span>]]).<span class="ruby-identifier">project</span>
1638:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone_id</span> = <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_milestone_short</span>].<span class="ruby-identifier">to_i</span>
1639:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project_short</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
1640:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project_id</span> = <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project_short</span>].<span class="ruby-identifier">to_i</span>
1641:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone_id</span> = <span class="ruby-keyword kw">nil</span>
1642:     <span class="ruby-keyword kw">else</span>
1643:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1644:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-value str">&quot;shortlist&quot;</span>, <span class="ruby-identifier">:duration</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span><span class="ruby-value">.5</span>, <span class="ruby-identifier">:startcolor</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;#ff9999&quot;</span>)
1645:       <span class="ruby-keyword kw">end</span>
1646:       <span class="ruby-keyword kw">return</span>
1647:     <span class="ruby-keyword kw">end</span>
1648: 
1649:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">save</span>
1650:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">reload</span>
1651: 
1652:     <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">id</span>
1653:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1654:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-value str">&quot;quick_add_container&quot;</span>, <span class="ruby-identifier">:duration</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span><span class="ruby-value">.5</span>, <span class="ruby-identifier">:startcolor</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;#ff9999&quot;</span>)
1655:       <span class="ruby-keyword kw">end</span>
1656:     <span class="ruby-keyword kw">else</span>
1657:       <span class="ruby-identifier">to</span> = <span class="ruby-constant">TaskOwner</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">:user</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">current_user</span>, <span class="ruby-identifier">:task</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@task</span>)
1658:       <span class="ruby-identifier">to</span>.<span class="ruby-identifier">save</span>
1659: 
1660:       <span class="ruby-identifier">worklog</span> = <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">new</span>
1661:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">user</span> = <span class="ruby-identifier">current_user</span>
1662:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">company</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">company</span>
1663:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">customer</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">customer</span>
1664:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">project</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>
1665:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">task</span> = <span class="ruby-ivar">@task</span>
1666:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">started_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>
1667:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-value">0</span>
1668:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_CREATED</span>
1669:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">body</span> = <span class="ruby-value str">&quot;&quot;</span>
1670:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">save</span>
1671:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value str">'notify'</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
1672:         <span class="ruby-constant">Notifications</span><span class="ruby-operator">::</span><span class="ruby-identifier">deliver_created</span>( <span class="ruby-ivar">@task</span>, <span class="ruby-identifier">current_user</span>, <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:comment</span>]) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">begin</span> <span class="ruby-keyword kw">end</span>
1673:       <span class="ruby-keyword kw">end</span>
1674: 
1675:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; @task.id)}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
1676:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'activities', :action =&gt; 'refresh')}');&quot;</span>, [<span class="ruby-node">&quot;activity_#{current_user.company_id}&quot;</span>])
1677: 
1678:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1679:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">insert_html</span> <span class="ruby-identifier">:bottom</span>, <span class="ruby-value str">&quot;shortlist-tasks&quot;</span>, <span class="ruby-identifier">:partial</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'task_row'</span>, <span class="ruby-identifier">:locals</span> =<span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">:task</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@task</span>, <span class="ruby-identifier">:depth</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>}
1680:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-node">&quot;task_#{@task.id}&quot;</span>, <span class="ruby-identifier">:duration</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">1.5</span>)
1681:         <span class="ruby-identifier">page</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;$('task_name').focus();&quot;</span>
1682:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">call</span>(<span class="ruby-value str">&quot;fixShortLinks&quot;</span>)
1683:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">call</span>(<span class="ruby-value str">&quot;updateTooltips&quot;</span>)
1684:       <span class="ruby-keyword kw">end</span>
1685:     <span class="ruby-keyword kw">end</span>
1686:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000188"><br/></a>
<div class="method_block"><h3>
<a href='#M000188'>


create_todo_ajax

()

</a>
</h3>

<p class="source_link" id="M000188-show-link"><a onclick="toggle('M000188-source'); toggleText('M000188-link'); return false;" href="#" id="M000188-link">Show source...</a></p><div class="source" id="M000188-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1732</span>
1732:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">create_todo_ajax</span>
1733: 
1734:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:todo</span>][<span class="ruby-identifier">:name</span>].<span class="ruby-identifier">blank?</span>
1735:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1736:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-node">&quot;todo-form-#{params[:id]}&quot;</span>, <span class="ruby-identifier">:duration</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span><span class="ruby-value">.5</span>, <span class="ruby-identifier">:startcolor</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;#ff9999&quot;</span>)
1737:       <span class="ruby-keyword kw">end</span>
1738:       <span class="ruby-keyword kw">return</span>
1739:     <span class="ruby-keyword kw">end</span>
1740: 
1741:     <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;id = ? AND project_id IN (#{current_project_ids})&quot;</span>, <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>]])
1742:     <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@task</span>
1743:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1744:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-node">&quot;todo-form-#{params[:id]}&quot;</span>, <span class="ruby-identifier">:duration</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span><span class="ruby-value">.5</span>, <span class="ruby-identifier">:startcolor</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;#ff9999&quot;</span>)
1745:       <span class="ruby-keyword kw">end</span>
1746:       <span class="ruby-keyword kw">return</span>
1747:     <span class="ruby-keyword kw">end</span>
1748:     <span class="ruby-ivar">@todo</span> = <span class="ruby-constant">Todo</span>.<span class="ruby-identifier">new</span>
1749:     <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">name</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:todo</span>][<span class="ruby-identifier">:name</span>]
1750:     <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">creator_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
1751:     <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">task_id</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">id</span>
1752: 
1753:     <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">save</span>
1754:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1755:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-node">&quot;todo-form-tasks-#{params[:id]}&quot;</span>, <span class="ruby-identifier">:duration</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span><span class="ruby-value">.5</span>, <span class="ruby-identifier">:startcolor</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;#ff9999&quot;</span>)
1756:       <span class="ruby-keyword kw">end</span>
1757:     <span class="ruby-keyword kw">else</span>
1758:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; params[:id])}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
1759:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'activities', :action =&gt; 'refresh')}');&quot;</span>, [<span class="ruby-node">&quot;activity_#{current_user.company_id}&quot;</span>])
1760: 
1761:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1762:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">insert_html</span> <span class="ruby-identifier">:bottom</span>, <span class="ruby-node">&quot;todo-#{@task.dom_id}&quot;</span>, <span class="ruby-identifier">:partial</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;tasks/todo_row&quot;</span>
1763:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">replace_html</span> <span class="ruby-node">&quot;todo-status-#{@task.dom_id}&quot;</span>, <span class="ruby-identifier">link_to_function</span>( <span class="ruby-node">&quot;#{@task.todo_status}&quot;</span>, <span class="ruby-node">&quot;Element.toggle('todo-container-#{@task.dom_id}');&quot;</span>, <span class="ruby-identifier">:class</span> =<span class="ruby-operator">&gt;</span> (<span class="ruby-ivar">@task</span>.<span class="ruby-identifier">todos</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-value">? </span><span class="ruby-value str">&quot;todo-status-link-empty&quot;</span> <span class="ruby-operator">:</span><span class="ruby-value str">&quot;todo-status-link&quot;</span>))
1764:         <span class="ruby-identifier">page</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;$('todo_text_#{@task.id}').clear();&quot;</span>
1765:         <span class="ruby-identifier">page</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;$('todo_text_#{@task.id}').focus();&quot;</span>
1766:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">call</span>(<span class="ruby-value str">&quot;updateTooltips&quot;</span>)
1767:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span> <span class="ruby-identifier">:highlight</span>, <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">dom_id</span>
1768:         <span class="ruby-identifier">page</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;Sortable.create('todo-#{@task.dom_id}', {containment:'todo-#{@task.dom_id}', format:/^[^-]*-(.*)$/, onUpdate:function(){new Ajax.Request('/tasks/order_todos/#{@task.id}', {asynchronous:true, evalScripts:true, parameters:Sortable.serialize('todo-#{@task.dom_id}')})}, only:'todo-active'})&quot;</span>
1769:       <span class="ruby-keyword kw">end</span>
1770:     <span class="ruby-keyword kw">end</span>
1771: 
1772:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000193"><br/></a>
<div class="method_block"><h3>
<a href='#M000193'>


delete_tag

()

</a>
</h3>

<p class="source_link" id="M000193-show-link"><a onclick="toggle('M000193-source'); toggleText('M000193-link'); return false;" href="#" id="M000193-link">Show source...</a></p><div class="source" id="M000193-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1866</span>
1866:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">delete_tag</span>
1867:     <span class="ruby-identifier">tag</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company</span>.<span class="ruby-identifier">tags</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>]) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
1868:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">tag</span>
1869:       <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">destroy</span>
1870:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1871:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">remove</span> <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">dom_id</span>
1872:       <span class="ruby-keyword kw">end</span> 
1873:     <span class="ruby-keyword kw">else</span> 
1874:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:nothing</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>
1875:     <span class="ruby-keyword kw">end</span> 
1876:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000150"><br/></a>
<div class="method_block"><h3>
<a href='#M000150'>


dependency_targets

()

</a>
</h3>

<p class="source_link" id="M000150-show-link"><a onclick="toggle('M000150-source'); toggleText('M000150-link'); return false;" href="#" id="M000150-link">Show source...</a></p><div class="source" id="M000150-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 240</span>
240:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">dependency_targets</span>
241:     <span class="ruby-identifier">value</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:dependencies</span>][<span class="ruby-value">0</span>]
242:     <span class="ruby-identifier">value</span>.<span class="ruby-identifier">gsub!</span>(<span class="ruby-regexp re">/#/</span>, <span class="ruby-value str">''</span>)
243: 
244:     <span class="ruby-identifier">query</span> = <span class="ruby-value str">&quot;&quot;</span>
245:     <span class="ruby-ivar">@keys</span> = <span class="ruby-identifier">value</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">' '</span>)
246:     <span class="ruby-ivar">@keys</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">k</span><span class="ruby-operator">|</span>
247:       <span class="ruby-identifier">query</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;+issue_name:#{k}* &quot;</span>
248:     <span class="ruby-keyword kw">end</span>
249: 
250:     <span class="ruby-comment cmt"># Append project id's the user has access to</span>
251:     <span class="ruby-identifier">projects</span> = <span class="ruby-value str">&quot;0&quot;</span>
252:     <span class="ruby-identifier">current_projects</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span>
253:       <span class="ruby-identifier">projects</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;|#{p.id}&quot;</span>
254:     <span class="ruby-keyword kw">end</span>
255:     <span class="ruby-identifier">projects</span> = <span class="ruby-node">&quot;+project_id:\&quot;#{projects}\&quot;&quot;</span> 
256: 
257:     <span class="ruby-comment cmt"># Find the tasks</span>
258:     <span class="ruby-ivar">@tasks</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find_by_contents</span>(<span class="ruby-node">&quot;+company_id:#{current_user.company_id} #{projects} #{query}&quot;</span>, {<span class="ruby-identifier">:limit</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">13</span>})
259:     <span class="ruby-identifier">render</span> <span class="ruby-identifier">:text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;&lt;ul&gt;#{@tasks.collect{ |t| &quot;&lt;li&gt;[#{ &quot;&lt;strike&gt;&quot; if t.done? }#&lt;span class=\&quot;complete_value\&quot;&gt;#{ t.task_num}&lt;/span&gt;#{ &quot;&lt;/strike&gt;&quot; if t.done? }] #{@keys.nil? ? t.name : highlight_all(t.name, @keys)}&lt;/li&gt;&quot;}.join(&quot;&quot;) }&lt;/ul&gt;&quot;</span>
260:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000177"><br/></a>
<div class="method_block"><h3>
<a href='#M000177'>


destroy_log

()

</a>
</h3>

<p class="source_link" id="M000177-show-link"><a onclick="toggle('M000177-source'); toggleText('M000177-link'); return false;" href="#" id="M000177-link">Show source...</a></p><div class="source" id="M000177-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1261</span>
1261:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">destroy_log</span>
1262:     <span class="ruby-ivar">@log</span> = <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">find</span>( <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;company_id = ?&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>] )
1263:     <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">destroy</span>
1264:     <span class="ruby-identifier">flash</span>[<span class="ruby-value str">'notice'</span>] = <span class="ruby-identifier">_</span>(<span class="ruby-value str">&quot;Log entry deleted...&quot;</span>)
1265:     <span class="ruby-identifier">redirect_from_last</span>
1266:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000173"><br/></a>
<div class="method_block"><h3>
<a href='#M000173'>


do_filter

()

</a>
</h3>

<p class="source_link" id="M000173-show-link"><a onclick="toggle('M000173-source'); toggleText('M000173-link'); return false;" href="#" id="M000173-link">Show source...</a></p><div class="source" id="M000173-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1194</span>
1194:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">do_filter</span>
1195: 
1196:     <span class="ruby-identifier">f</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:filter</span>]
1197: 
1198:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">f</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;0&quot;</span>
1199:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_customer</span>] = <span class="ruby-value str">&quot;0&quot;</span>
1200:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_milestone</span>] = <span class="ruby-value str">&quot;0&quot;</span>
1201:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project</span>] = <span class="ruby-value str">&quot;0&quot;</span>
1202:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">f</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">'c'</span>
1203:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_customer</span>] = <span class="ruby-identifier">f</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>]
1204:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_milestone</span>] = <span class="ruby-value str">&quot;0&quot;</span>
1205:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project</span>] = <span class="ruby-value str">&quot;0&quot;</span>
1206:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">f</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">'p'</span>
1207:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_customer</span>] = <span class="ruby-value str">&quot;0&quot;</span>
1208:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_milestone</span>] = <span class="ruby-value str">&quot;0&quot;</span>
1209:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project</span>] = <span class="ruby-identifier">f</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>]
1210:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">f</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">'m'</span>
1211:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_customer</span>] = <span class="ruby-value str">&quot;0&quot;</span>
1212:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_milestone</span>] = <span class="ruby-identifier">f</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>]
1213:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project</span>] = <span class="ruby-value str">&quot;0&quot;</span>
1214:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">f</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">'u'</span>
1215:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_customer</span>] = <span class="ruby-value str">&quot;0&quot;</span>
1216:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_milestone</span>] = <span class="ruby-value str">&quot;-1&quot;</span>
1217:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project</span>] = <span class="ruby-identifier">f</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>]
1218:     <span class="ruby-keyword kw">end</span>
1219: 
1220:     [<span class="ruby-identifier">:filter_user</span>, <span class="ruby-identifier">:filter_hidden</span>, <span class="ruby-identifier">:filter_status</span>, <span class="ruby-identifier">:group_by</span>, <span class="ruby-identifier">:hide_dependencies</span>, <span class="ruby-identifier">:sort</span>, <span class="ruby-identifier">:filter_type</span>, <span class="ruby-identifier">:filter_severity</span>, <span class="ruby-identifier">:filter_priority</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">filter</span><span class="ruby-operator">|</span>
1221:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">filter</span>] = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">filter</span>]
1222:     <span class="ruby-keyword kw">end</span>
1223: 
1224:     <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">last_filter</span> = <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_hidden</span>]
1225:     <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">last_milestone_id</span> = <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_milestone</span>]
1226:     <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">last_project_id</span> = <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project</span>]
1227:     <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">save</span>
1228:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000154"><br/></a>
<div class="method_block"><h3>
<a href='#M000154'>


edit

()

</a>
</h3>

<p class="source_link" id="M000154-show-link"><a onclick="toggle('M000154-source'); toggleText('M000154-link'); return false;" href="#" id="M000154-link">Show source...</a></p><div class="source" id="M000154-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 484</span>
484:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">edit</span>
485:     <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;project_id IN (?)&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span><span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span>}] ) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">begin</span>
486:                                                                                                                            <span class="ruby-identifier">flash</span>[<span class="ruby-value str">'notice'</span>] = <span class="ruby-identifier">_</span>(<span class="ruby-value str">&quot;You don't have access to that task, or it doesn't exist.&quot;</span>)
487:                                                                                                                            <span class="ruby-identifier">redirect_from_last</span>
488:                                                                                                                            <span class="ruby-keyword kw">return</span>
489:                                                                                                                          <span class="ruby-keyword kw">end</span> 
490:                                                                                                                            
491:     
492:     
493:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">due_at</span> = <span class="ruby-identifier">tz</span>.<span class="ruby-identifier">utc_to_local</span>(<span class="ruby-ivar">@task</span>.<span class="ruby-identifier">due_at</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">due_at</span>.<span class="ruby-identifier">nil?</span>
494:     <span class="ruby-ivar">@tags</span> = <span class="ruby-constant">Tag</span>.<span class="ruby-identifier">top_counts</span>({ <span class="ruby-identifier">:company_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>, <span class="ruby-identifier">:project_ids</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">current_project_ids</span>, <span class="ruby-identifier">:filter_hidden</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_hidden</span>]})
495:     <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@logs</span> = <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;work_logs.started_at desc,work_logs.id desc&quot;</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;work_logs.task_id = ? #{&quot;AND (work_logs.comment = 1 OR work_logs.log_type=6)&quot; if session[:only_comments].to_i == 1}&quot;</span>, <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">id</span>], <span class="ruby-identifier">:include</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:user</span>, <span class="ruby-identifier">:task</span>, <span class="ruby-identifier">:project</span>])
496:           <span class="ruby-ivar">@logs</span> = []
497:     <span class="ruby-keyword kw">end</span>
498:     <span class="ruby-ivar">@projects</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>).<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'name'</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;completed_at IS NULL&quot;</span>]).<span class="ruby-identifier">collect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> [ <span class="ruby-node">&quot;#{c.name} / #{c.customer.name}&quot;</span>, <span class="ruby-identifier">c</span>.<span class="ruby-identifier">id</span> ] <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">can?</span>(<span class="ruby-identifier">c</span>, <span class="ruby-value str">'create'</span>)  }.<span class="ruby-identifier">compact</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">nil?</span>
499: 
500:     <span class="ruby-ivar">@notify_targets</span> = <span class="ruby-identifier">current_projects</span>.<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">users</span>.<span class="ruby-identifier">collect</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">:name</span>) }.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>
501:     <span class="ruby-ivar">@notify_targets</span> <span class="ruby-operator">+=</span> <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;project_id IN (#{current_project_ids}) AND notify_emails IS NOT NULL and notify_emails &lt;&gt; ''&quot;</span>]).<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">notify_emails</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">','</span>).<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">strip</span> } }.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>
502: 
503:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000176"><br/></a>
<div class="method_block"><h3>
<a href='#M000176'>


edit_log

()

</a>
</h3>

<p class="source_link" id="M000176-show-link"><a onclick="toggle('M000176-source'); toggleText('M000176-link'); return false;" href="#" id="M000176-link">Show source...</a></p><div class="source" id="M000176-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1255</span>
1255:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">edit_log</span>
1256:     <span class="ruby-ivar">@log</span> = <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">find</span>( <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;company_id = ?&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>] )
1257:     <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">started_at</span> = <span class="ruby-identifier">tz</span>.<span class="ruby-identifier">utc_to_local</span>(<span class="ruby-ivar">@log</span>.<span class="ruby-identifier">started_at</span>)
1258:     <span class="ruby-ivar">@task</span> = <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">task</span>
1259:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000174"><br/></a>
<div class="method_block"><h3>
<a href='#M000174'>


filter

()

</a>
</h3>

<p class="source_link" id="M000174-show-link"><a onclick="toggle('M000174-source'); toggleText('M000174-link'); return false;" href="#" id="M000174-link">Show source...</a></p><div class="source" id="M000174-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1230</span>
1230:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">filter</span>
1231:     <span class="ruby-identifier">do_filter</span>
1232:     <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">:controller</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'tasks'</span>, <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'list'</span>
1233:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000175"><br/></a>
<div class="method_block"><h3>
<a href='#M000175'>


filter_shortlist

()

</a>
</h3>

<p class="source_link" id="M000175-show-link"><a onclick="toggle('M000175-source'); toggleText('M000175-link'); return false;" href="#" id="M000175-link">Show source...</a></p><div class="source" id="M000175-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1235</span>
1235:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">filter_shortlist</span>
1236: 
1237:     <span class="ruby-identifier">tmp</span> = { }
1238:     [<span class="ruby-identifier">:filter_customer</span>, <span class="ruby-identifier">:filter_milestone</span>, <span class="ruby-identifier">:filter_project</span>, <span class="ruby-identifier">:filter_user</span>, <span class="ruby-identifier">:filter_hidden</span>, <span class="ruby-identifier">:filter_status</span>, <span class="ruby-identifier">:group_by</span>, <span class="ruby-identifier">:hide_dependencies</span>, <span class="ruby-identifier">:sort</span>, <span class="ruby-identifier">:filter_type</span>, <span class="ruby-identifier">:filter_severity</span>, <span class="ruby-identifier">:filter_priority</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
1239:       <span class="ruby-identifier">tmp</span>[<span class="ruby-identifier">v</span>] = <span class="ruby-identifier">session</span>[<span class="ruby-identifier">v</span>]
1240:     <span class="ruby-keyword kw">end</span>
1241: 
1242:     <span class="ruby-identifier">do_filter</span>
1243: 
1244:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project_short</span>] = <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project</span>]
1245:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_customer_short</span>] = <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_customer</span>]
1246:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_milestone_short</span>] = <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_milestone</span>]
1247: 
1248:     [<span class="ruby-identifier">:filter_customer</span>, <span class="ruby-identifier">:filter_milestone</span>, <span class="ruby-identifier">:filter_project</span>, <span class="ruby-identifier">:filter_user</span>, <span class="ruby-identifier">:filter_hidden</span>, <span class="ruby-identifier">:filter_status</span>, <span class="ruby-identifier">:group_by</span>, <span class="ruby-identifier">:hide_dependencies</span>, <span class="ruby-identifier">:sort</span>, <span class="ruby-identifier">:filter_type</span>, <span class="ruby-identifier">:filter_severity</span>, <span class="ruby-identifier">:filter_priority</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
1249:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">v</span>] = <span class="ruby-identifier">tmp</span>[<span class="ruby-identifier">v</span>]
1250:     <span class="ruby-keyword kw">end</span>
1251: 
1252:     <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">:controller</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'tasks'</span>, <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'shortlist'</span>
1253:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000180"><br/></a>
<div class="method_block"><h3>
<a href='#M000180'>


get_csv

()

</a>
</h3>

<p class="source_link" id="M000180-show-link"><a onclick="toggle('M000180-source'); toggleText('M000180-link'); return false;" href="#" id="M000180-link">Show source...</a></p><div class="source" id="M000180-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1341</span>
1341:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">get_csv</span>
1342:     <span class="ruby-identifier">list</span>
1343: 
1344:     <span class="ruby-identifier">filename</span> = <span class="ruby-value str">&quot;clockingit_tasks&quot;</span>
1345: 
1346:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_customer</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
1347:       <span class="ruby-identifier">filename</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;_&quot;</span>
1348:       <span class="ruby-identifier">filename</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">Customer</span>.<span class="ruby-identifier">find</span>( <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_customer</span>] ).<span class="ruby-identifier">name</span>
1349:     <span class="ruby-keyword kw">end</span>
1350: 
1351:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
1352:       <span class="ruby-identifier">p</span> = <span class="ruby-constant">Project</span>.<span class="ruby-identifier">find</span>( <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project</span>] )
1353:       <span class="ruby-identifier">filename</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;_&quot;</span>
1354:       <span class="ruby-identifier">filename</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;#{p.customer.name}_#{p.name}&quot;</span>
1355:     <span class="ruby-keyword kw">end</span>
1356: 
1357:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_milestone</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
1358:       <span class="ruby-identifier">m</span> = <span class="ruby-constant">Milestone</span>.<span class="ruby-identifier">find</span>( <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_milestone</span>] )
1359:       <span class="ruby-identifier">filename</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;_&quot;</span>
1360:       <span class="ruby-identifier">filename</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;#{m.project.customer.name}_#{m.project.name}_#{m.name}&quot;</span>
1361:     <span class="ruby-keyword kw">end</span>
1362: 
1363:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_user</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
1364:       <span class="ruby-identifier">filename</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;_&quot;</span>
1365:       <span class="ruby-identifier">filename</span> <span class="ruby-operator">&lt;&lt;</span>  <span class="ruby-constant">User</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_user</span>]).<span class="ruby-identifier">name</span>
1366:     <span class="ruby-keyword kw">end</span>
1367: 
1368:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_status</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
1369:       <span class="ruby-identifier">filename</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;_&quot;</span>
1370:       <span class="ruby-identifier">filename</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">Task</span>.<span class="ruby-identifier">status_type</span>(<span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_status</span>].<span class="ruby-identifier">to_i</span>)
1371:     <span class="ruby-keyword kw">end</span>
1372: 
1373:     <span class="ruby-identifier">filename</span> = <span class="ruby-identifier">filename</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/ /</span>, <span class="ruby-value str">&quot;_&quot;</span>).<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/[&quot;']/</span>, <span class="ruby-value str">''</span>).<span class="ruby-identifier">downcase</span>
1374:     <span class="ruby-identifier">filename</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;.csv&quot;</span>
1375: 
1376:     <span class="ruby-identifier">csv_string</span> = <span class="ruby-constant">FasterCSV</span>.<span class="ruby-identifier">generate</span>( <span class="ruby-identifier">:col_sep</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;,&quot;</span> ) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">csv</span><span class="ruby-operator">|</span>
1377: 
1378:       <span class="ruby-identifier">header</span> = [<span class="ruby-value str">'Client'</span>, <span class="ruby-value str">'Project'</span>, <span class="ruby-value str">'Num'</span>, <span class="ruby-value str">'Name'</span>, <span class="ruby-value str">'Tags'</span>, <span class="ruby-value str">'User'</span>, <span class="ruby-value str">'Milestone'</span>, <span class="ruby-value str">'Due'</span>, <span class="ruby-value str">'Worked'</span>, <span class="ruby-value str">'Estimated'</span>, <span class="ruby-value str">'Status'</span>, <span class="ruby-value str">'Priority'</span>, <span class="ruby-value str">'Severity'</span>]
1379:       <span class="ruby-identifier">csv</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">header</span>
1380: 
1381:       <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">t</span> <span class="ruby-keyword kw">in</span> <span class="ruby-ivar">@tasks</span>
1382:         <span class="ruby-identifier">csv</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">t</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">customer</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">t</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">t</span>.<span class="ruby-identifier">task_num</span>, <span class="ruby-identifier">t</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">t</span>.<span class="ruby-identifier">tags</span>.<span class="ruby-identifier">collect</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">:name</span>).<span class="ruby-identifier">join</span>(<span class="ruby-value str">','</span>), <span class="ruby-identifier">t</span>.<span class="ruby-identifier">owners</span>, <span class="ruby-identifier">t</span>.<span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-value">? </span><span class="ruby-keyword kw">nil</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">t</span>.<span class="ruby-identifier">due_at</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-value">? </span><span class="ruby-identifier">t</span>.<span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-value">? </span><span class="ruby-keyword kw">nil</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">due_at</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">due_at</span>, <span class="ruby-identifier">t</span>.<span class="ruby-identifier">worked_minutes</span>, <span class="ruby-identifier">t</span>.<span class="ruby-identifier">duration</span>, <span class="ruby-identifier">t</span>.<span class="ruby-identifier">status_type</span>, <span class="ruby-identifier">t</span>.<span class="ruby-identifier">priority_type</span>, <span class="ruby-identifier">t</span>.<span class="ruby-identifier">severity_type</span>]
1383:       <span class="ruby-keyword kw">end</span>
1384: 
1385:     <span class="ruby-keyword kw">end</span>
1386:     <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span>(<span class="ruby-node">&quot;Seinding[#{filename}]&quot;</span>)
1387: 
1388:     <span class="ruby-identifier">send_data</span>(<span class="ruby-identifier">csv_string</span>,
1389:               <span class="ruby-identifier">:type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'text/csv; charset=utf-8; header=present'</span>,
1390:               <span class="ruby-identifier">:filename</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">filename</span>)
1391:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000149"><br/></a>
<div class="method_block"><h3>
<a href='#M000149'>


get_milestones

()

</a>
</h3>
<p>
Return a json formatted <a href="TasksController.html#M000148">list</a> of
options to refresh the <a href="Milestone.html">Milestone</a> dropdown
</p>

<p class="source_link" id="M000149-show-link"><a onclick="toggle('M000149-source'); toggleText('M000149-link'); return false;" href="#" id="M000149-link">Show source...</a></p><div class="source" id="M000149-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 222</span>
222:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">get_milestones</span>
223:     <span class="ruby-ivar">@milestones</span> = <span class="ruby-constant">Milestone</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'name'</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">'company_id = ? AND project_id = ? AND completed_at IS NULL'</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>, <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:project_id</span>]]).<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-node">&quot;{\&quot;text\&quot;:\&quot;#{m.name.gsub(/&quot;/,'\&quot;')}\&quot;, \&quot;value\&quot;:\&quot;#{m.id}\&quot;}&quot;</span> }.<span class="ruby-identifier">join</span>(<span class="ruby-value str">','</span>)
224: 
225:     <span class="ruby-comment cmt"># {&quot;options&quot;:[{&quot;value&quot;:&quot;1&quot;,&quot;text&quot;:&quot;Test Page&quot;}]}</span>
226:     <span class="ruby-identifier">res</span> = <span class="ruby-value str">'{&quot;options&quot;:[{&quot;value&quot;:&quot;0&quot;, &quot;text&quot;:&quot;'</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">_</span>(<span class="ruby-value str">'[None]'</span>) <span class="ruby-operator">+</span> <span class="ruby-value str">'&quot;}'</span>
227:     <span class="ruby-identifier">res</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;, #{@milestones}&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@milestones</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@milestones</span>.<span class="ruby-identifier">empty?</span>
228:     <span class="ruby-identifier">res</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">']}'</span>
229:   
230:     <span class="ruby-identifier">p</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:project_id</span>]) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
231:     <span class="ruby-identifier">script</span> = <span class="ruby-value str">&quot;&quot;</span>
232:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">p</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">can?</span>(<span class="ruby-identifier">p</span>, <span class="ruby-value str">'milestone'</span>)
233:       <span class="ruby-identifier">script</span> = <span class="ruby-value str">&quot;\n&lt;script type=\&quot;text/javascript\&quot;&gt;if($('add_milestone')){$('add_milestone').show();}&lt;/script&gt;&quot;</span>
234:     <span class="ruby-keyword kw">else</span> 
235:       <span class="ruby-identifier">script</span> = <span class="ruby-value str">&quot;\n&lt;script type=\&quot;text/javascript\&quot;&gt;if($('add_milestone')){$('add_milestone').hide();}&lt;/script&gt;&quot;</span>
236:     <span class="ruby-keyword kw">end</span> 
237:     <span class="ruby-identifier">render</span> <span class="ruby-identifier">:text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;#{res}#{script}&quot;</span>
238:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000151"><br/></a>
<div class="method_block"><h3>
<a href='#M000151'>


get_owners

()

</a>
</h3>
<p>
Return a json formatted <a href="TasksController.html#M000148">list</a> of
users to refresh the <a href="User.html">User</a> dropdown This a bit
tricky, as it also updates a JavaScript variable with the current drop-down
box.
</p>

<p class="source_link" id="M000151-show-link"><a onclick="toggle('M000151-source'); toggleText('M000151-link'); return false;" href="#" id="M000151-link">Show source...</a></p><div class="source" id="M000151-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 264</span>
264:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">get_owners</span>
265: 
266:     <span class="ruby-ivar">@users</span> = <span class="ruby-constant">Project</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:project_id</span>]).<span class="ruby-identifier">users</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'name'</span> )
267: 
268:     <span class="ruby-ivar">@resource_string</span> = <span class="ruby-node">&quot;&lt;option value=\&quot;\&quot;&gt;[#{_('No one')}]&lt;/option&gt;&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@users</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">us</span><span class="ruby-operator">|</span> <span class="ruby-node">&quot;&lt;option value=\&quot;#{us.id}\&quot;&gt;#{us.name}&lt;/option&gt;&quot;</span>}.<span class="ruby-identifier">join</span>(<span class="ruby-value str">''</span>)
269:     <span class="ruby-ivar">@resource_string</span> = <span class="ruby-ivar">@resource_string</span>.<span class="ruby-identifier">split</span>(<span class="ruby-regexp re">/\n/</span>).<span class="ruby-identifier">join</span>(<span class="ruby-value str">''</span>).<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/'/</span>, <span class="ruby-value str">&quot;\\\\\'&quot;</span>)
270: 
271:     <span class="ruby-ivar">@options</span> = <span class="ruby-ivar">@users</span>.<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">u</span><span class="ruby-operator">|</span> (<span class="ruby-value str">' {&quot;text&quot;:&quot;'</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">u</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/&quot;/</span>,<span class="ruby-value str">'\&quot;'</span>) <span class="ruby-operator">+</span> <span class="ruby-value str">'&quot;, &quot;value&quot;:&quot;'</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">u</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-value str">'&quot;}'</span>) }.<span class="ruby-identifier">join</span>( <span class="ruby-value str">','</span> )
272:     <span class="ruby-identifier">res</span> = <span class="ruby-value str">'{&quot;options&quot;:[{&quot;value&quot;:&quot;0&quot;, &quot;text&quot;:&quot;[None]&quot;}'</span>
273:     <span class="ruby-identifier">res</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;, #{@options}&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@options</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@options</span>.<span class="ruby-identifier">empty?</span>
274:     <span class="ruby-identifier">res</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">']}'</span>
275: 
276:     <span class="ruby-identifier">render</span> <span class="ruby-identifier">:text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;#{res}\n&lt;script type=\&quot;text/javascript\&quot;&gt;resource = '&lt;select name=\&quot;users[]\&quot; id=\&quot;task_users\&quot;&gt;#{@resource_string}&lt;/select&gt;';&lt;/script&gt;&quot;</span>
277:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000147"><br/></a>
<div class="method_block"><h3>
<a href='#M000147'>


index

()

</a>
</h3>

<p class="source_link" id="M000147-show-link"><a onclick="toggle('M000147-source'); toggleText('M000147-link'); return false;" href="#" id="M000147-link">Show source...</a></p><div class="source" id="M000147-source"><pre>    <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 40</span>
40:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">index</span>
41:     <span class="ruby-identifier">redirect_to</span> <span class="ruby-value str">'list'</span>
42:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000148"><br/></a>
<div class="method_block"><h3>
<a href='#M000148'>


list

()

</a>
</h3>

<p class="source_link" id="M000148-show-link"><a onclick="toggle('M000148-source'); toggleText('M000148-link'); return false;" href="#" id="M000148-link">Show source...</a></p><div class="source" id="M000148-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 44</span>
 44:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">list</span>
 45:     <span class="ruby-comment cmt"># Subscribe to the juggernaut channel for Task updates</span>
 46:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:channels</span>] <span class="ruby-operator">+=</span> [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>]
 47: 
 48:     <span class="ruby-ivar">@tags</span> = {}
 49:     <span class="ruby-ivar">@tags</span>.<span class="ruby-identifier">default</span> = <span class="ruby-value">0</span>
 50:     <span class="ruby-ivar">@tags_total</span> = <span class="ruby-value">0</span>
 51:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
 52:       <span class="ruby-identifier">project_ids</span> = <span class="ruby-identifier">current_project_ids</span>
 53:     <span class="ruby-keyword kw">else</span>
 54:       <span class="ruby-identifier">project_ids</span> = <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project</span>]
 55:     <span class="ruby-keyword kw">end</span>
 56: 
 57:     <span class="ruby-identifier">filter</span> = <span class="ruby-value str">&quot;&quot;</span>
 58: 
 59:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_user</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
 60:       <span class="ruby-identifier">task_ids</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_user</span>].<span class="ruby-identifier">to_i</span>).<span class="ruby-identifier">tasks</span>.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">id</span> }.<span class="ruby-identifier">join</span>(<span class="ruby-value str">','</span>)
 61:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">task_ids</span> <span class="ruby-operator">==</span> <span class="ruby-value str">''</span>
 62:         <span class="ruby-identifier">filter</span> = <span class="ruby-value str">&quot;tasks.id IN (0) AND &quot;</span>
 63:       <span class="ruby-keyword kw">else</span>
 64:         <span class="ruby-identifier">filter</span> = <span class="ruby-node">&quot;tasks.id IN (#{task_ids}) AND &quot;</span>
 65:       <span class="ruby-keyword kw">end</span>
 66:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_user</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">0</span>
 67:       <span class="ruby-identifier">not_task_ids</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:select</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;tasks.*&quot;</span>, <span class="ruby-identifier">:joins</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;LEFT OUTER JOIN task_owners t_o ON tasks.id = t_o.task_id&quot;</span>, <span class="ruby-identifier">:readonly</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">false</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;tasks.company_id = ? AND t_o.id IS NULL&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>]).<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">id</span> }.<span class="ruby-identifier">join</span>(<span class="ruby-value str">','</span>)
 68:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">not_task_ids</span> <span class="ruby-operator">==</span> <span class="ruby-value str">''</span>
 69:         <span class="ruby-identifier">filter</span> = <span class="ruby-value str">&quot;tasks.id = 0 AND &quot;</span>
 70:       <span class="ruby-keyword kw">else</span>
 71:         <span class="ruby-identifier">filter</span> = <span class="ruby-node">&quot;tasks.id IN (#{not_task_ids}) AND &quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">not_task_ids</span> <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;&quot;</span>
 72:       <span class="ruby-keyword kw">end</span>
 73:     <span class="ruby-keyword kw">end</span>
 74: 
 75:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_milestone</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
 76:       <span class="ruby-identifier">filter</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;tasks.milestone_id = #{session[:filter_milestone]} AND &quot;</span>
 77:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_milestone</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">0</span>
 78:       <span class="ruby-identifier">filter</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;(tasks.milestone_id IS NULL OR tasks.milestone_id = 0) AND &quot;</span>
 79:     <span class="ruby-keyword kw">end</span>
 80: 
 81:     <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_status</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">-1</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_status</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">-2</span>
 82:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_status</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
 83:         <span class="ruby-identifier">filter</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;(tasks.status = 0 OR tasks.status = 1) AND &quot;</span>
 84:       <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_status</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span>
 85:         <span class="ruby-identifier">filter</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;(tasks.status &gt; 1) AND &quot;</span>
 86:       <span class="ruby-keyword kw">else</span>
 87:         <span class="ruby-identifier">filter</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;tasks.status = #{session[:filter_status].to_i} AND &quot;</span>
 88:       <span class="ruby-keyword kw">end</span>
 89:     <span class="ruby-keyword kw">end</span>
 90: 
 91:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_status</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">-2</span>
 92:       <span class="ruby-identifier">filter</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;tasks.hidden = 1 AND &quot;</span>
 93:     <span class="ruby-keyword kw">else</span>
 94:       <span class="ruby-identifier">filter</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;tasks.hidden = 0 AND &quot;</span>
 95:     <span class="ruby-keyword kw">end</span>
 96: 
 97:     <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_type</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">-1</span>
 98:       <span class="ruby-identifier">filter</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;tasks.type_id = #{session[:filter_type].to_i} AND &quot;</span>
 99:     <span class="ruby-keyword kw">end</span>
100: 
101:     <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_severity</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">-10</span>
102:       <span class="ruby-identifier">filter</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;tasks.severity_id &gt;= #{session[:filter_severity].to_i} AND &quot;</span>
103:     <span class="ruby-keyword kw">end</span> 
104: 
105:     <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_priority</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">-10</span>
106:       <span class="ruby-identifier">filter</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;tasks.priority &gt;= #{session[:filter_priority].to_i} AND &quot;</span>
107:     <span class="ruby-keyword kw">end</span> 
108: 
109:     <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_customer</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
110:       <span class="ruby-identifier">filter</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;tasks.project_id IN (#{current_user.projects.find(:all, :conditions =&gt; [&quot;customer_id = ?&quot;, session[:filter_customer]]).collect(&amp;:id).compact.join(',') }) AND &quot;</span>
111:     <span class="ruby-keyword kw">end</span>
112: 
113:     <span class="ruby-identifier">filter</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;(tasks.milestone_id NOT IN (#{completed_milestone_ids}) OR tasks.milestone_id IS NULL) &quot;</span>
114: 
115:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:tag</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:tag</span>].<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
116:       <span class="ruby-comment cmt"># Looking for tasks based on tags</span>
117:       <span class="ruby-ivar">@selected_tags</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:tag</span>].<span class="ruby-identifier">downcase</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">','</span>).<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">strip</span>}
118:       <span class="ruby-ivar">@tasks</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">tagged_with</span>(<span class="ruby-ivar">@selected_tags</span>, { <span class="ruby-identifier">:company_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>, <span class="ruby-identifier">:project_ids</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">project_ids</span>, <span class="ruby-identifier">:filter_hidden</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_hidden</span>], <span class="ruby-identifier">:filter_user</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_user</span>], <span class="ruby-identifier">:filter_milestone</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_milestone</span>], <span class="ruby-identifier">:filter_status</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_status</span>], <span class="ruby-identifier">:filter_customer</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_customer</span>] })
119:     <span class="ruby-keyword kw">else</span>
120:       <span class="ruby-comment cmt"># Looking for tasks based on filters</span>
121:       <span class="ruby-ivar">@selected_tags</span> = []
122:       <span class="ruby-ivar">@tasks</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;tasks.project_id IN (#{project_ids}) AND &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">filter</span>], <span class="ruby-identifier">:include</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:users</span>, <span class="ruby-identifier">:tags</span>, <span class="ruby-identifier">:sheets</span>, <span class="ruby-identifier">:todos</span>, <span class="ruby-identifier">:dependencies</span>, {<span class="ruby-identifier">:dependants</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:users</span>, <span class="ruby-identifier">:tags</span>, <span class="ruby-identifier">:sheets</span>, <span class="ruby-identifier">:todos</span>, { <span class="ruby-identifier">:project</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:customer</span> }, <span class="ruby-identifier">:milestone</span>]}, { <span class="ruby-identifier">:project</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:customer</span>}, <span class="ruby-identifier">:milestone</span> ])
123:     <span class="ruby-keyword kw">end</span>
124: 
125:     <span class="ruby-ivar">@tasks</span> = <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:sort</span>].<span class="ruby-identifier">to_i</span>
126:              <span class="ruby-keyword kw">when</span> <span class="ruby-value">0</span><span class="ruby-operator">:</span>
127:                  <span class="ruby-ivar">@tasks</span>.<span class="ruby-identifier">sort_by</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> [<span class="ruby-operator">-</span><span class="ruby-identifier">t</span>.<span class="ruby-identifier">completed_at</span>.<span class="ruby-identifier">to_i</span>, <span class="ruby-identifier">t</span>.<span class="ruby-identifier">priority</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">severity_id</span>, (<span class="ruby-identifier">t</span>.<span class="ruby-identifier">due_date</span> <span class="ruby-operator">||</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>).<span class="ruby-identifier">to_i</span>, <span class="ruby-operator">-</span><span class="ruby-identifier">t</span>.<span class="ruby-identifier">task_num</span>] }.<span class="ruby-identifier">reverse</span>
128:              <span class="ruby-keyword kw">when</span> <span class="ruby-value">1</span><span class="ruby-operator">:</span> 
129:                  <span class="ruby-ivar">@tasks</span>.<span class="ruby-identifier">sort_by</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> [<span class="ruby-operator">-</span><span class="ruby-identifier">t</span>.<span class="ruby-identifier">completed_at</span>.<span class="ruby-identifier">to_i</span>, (<span class="ruby-identifier">t</span>.<span class="ruby-identifier">due_date</span> <span class="ruby-operator">||</span> <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>).<span class="ruby-identifier">to_i</span>, <span class="ruby-identifier">t</span>.<span class="ruby-identifier">priority</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">severity_id</span>,  <span class="ruby-operator">-</span><span class="ruby-identifier">t</span>.<span class="ruby-identifier">task_num</span>] }
130:              <span class="ruby-keyword kw">when</span> <span class="ruby-value">2</span><span class="ruby-operator">:</span> 
131:                  <span class="ruby-ivar">@tasks</span>.<span class="ruby-identifier">sort_by</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> [<span class="ruby-operator">-</span><span class="ruby-identifier">t</span>.<span class="ruby-identifier">completed_at</span>.<span class="ruby-identifier">to_i</span>, <span class="ruby-identifier">t</span>.<span class="ruby-identifier">created_at</span>.<span class="ruby-identifier">to_i</span>, <span class="ruby-identifier">t</span>.<span class="ruby-identifier">priority</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">severity_id</span>,  <span class="ruby-operator">-</span><span class="ruby-identifier">t</span>.<span class="ruby-identifier">task_num</span>] }
132:              <span class="ruby-keyword kw">when</span> <span class="ruby-value">3</span><span class="ruby-operator">:</span> 
133:                  <span class="ruby-ivar">@tasks</span>.<span class="ruby-identifier">sort_by</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> [<span class="ruby-operator">-</span><span class="ruby-identifier">t</span>.<span class="ruby-identifier">completed_at</span>.<span class="ruby-identifier">to_i</span>, <span class="ruby-identifier">t</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">t</span>.<span class="ruby-identifier">priority</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">severity_id</span>,  <span class="ruby-operator">-</span><span class="ruby-identifier">t</span>.<span class="ruby-identifier">task_num</span>] }
134:              <span class="ruby-keyword kw">when</span> <span class="ruby-value">4</span><span class="ruby-operator">:</span> 
135:                  <span class="ruby-ivar">@tasks</span>.<span class="ruby-identifier">sort_by</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> [<span class="ruby-operator">-</span><span class="ruby-identifier">t</span>.<span class="ruby-identifier">completed_at</span>.<span class="ruby-identifier">to_i</span>, <span class="ruby-identifier">t</span>.<span class="ruby-identifier">updated_at</span>.<span class="ruby-identifier">to_i</span>, <span class="ruby-identifier">t</span>.<span class="ruby-identifier">priority</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">severity_id</span>,  <span class="ruby-operator">-</span><span class="ruby-identifier">t</span>.<span class="ruby-identifier">task_num</span>] }.<span class="ruby-identifier">reverse</span>
136:              <span class="ruby-keyword kw">end</span>
137: 
138:     <span class="ruby-comment cmt"># Most popular tags, currently unlimited.</span>
139:     <span class="ruby-ivar">@all_tags</span> = <span class="ruby-constant">Tag</span>.<span class="ruby-identifier">top_counts</span>({ <span class="ruby-identifier">:company_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>, <span class="ruby-identifier">:project_ids</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">project_ids</span>, <span class="ruby-identifier">:filter_hidden</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_hidden</span>], <span class="ruby-identifier">:filter_customer</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_customer</span>]})
140:     <span class="ruby-ivar">@group_ids</span> = { }
141:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:group_by</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span> <span class="ruby-comment cmt"># tags</span>
142:       <span class="ruby-ivar">@tag_names</span> = <span class="ruby-ivar">@all_tags</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span>,<span class="ruby-identifier">j</span><span class="ruby-operator">|</span> <span class="ruby-identifier">i</span>}
143:       <span class="ruby-ivar">@groups</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">tag_groups</span>(<span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>, <span class="ruby-ivar">@tag_names</span>, <span class="ruby-ivar">@tasks</span>)
144:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:group_by</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span> <span class="ruby-comment cmt"># Clients</span>
145:       <span class="ruby-identifier">clients</span> = <span class="ruby-constant">Customer</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;company_id = ?&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>], <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;name&quot;</span>)
146:       <span class="ruby-identifier">clients</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-ivar">@group_ids</span>[<span class="ruby-identifier">c</span>.<span class="ruby-identifier">name</span>] = <span class="ruby-identifier">c</span>.<span class="ruby-identifier">id</span> }
147:       <span class="ruby-identifier">items</span> = <span class="ruby-identifier">clients</span>.<span class="ruby-identifier">collect</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">:name</span>).<span class="ruby-identifier">sort</span>
148:       <span class="ruby-ivar">@groups</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">group_by</span>(<span class="ruby-ivar">@tasks</span>, <span class="ruby-identifier">items</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">t</span>,<span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">customer</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">i</span> }
149:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:group_by</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">3</span> <span class="ruby-comment cmt"># Projects</span>
150:       <span class="ruby-identifier">projects</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>
151:       <span class="ruby-identifier">projects</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-ivar">@group_ids</span>[<span class="ruby-identifier">p</span>.<span class="ruby-identifier">full_name</span>] = <span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span> }
152:       <span class="ruby-identifier">items</span> = <span class="ruby-identifier">projects</span>.<span class="ruby-identifier">collect</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">:full_name</span>).<span class="ruby-identifier">sort</span>
153:       <span class="ruby-ivar">@groups</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">group_by</span>(<span class="ruby-ivar">@tasks</span>, <span class="ruby-identifier">items</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">t</span>,<span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">full_name</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">i</span> }
154:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:group_by</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">4</span> <span class="ruby-comment cmt"># Milestones</span>
155:       <span class="ruby-identifier">filter</span> = <span class="ruby-value str">&quot;&quot;</span>
156:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_milestone</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
157:         <span class="ruby-identifier">m</span> = <span class="ruby-constant">Milestone</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_milestone</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;project_id IN (#{current_project_ids}) AND completed_at IS NULL&quot;</span>], <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;due_at, name&quot;</span>) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
158:         <span class="ruby-identifier">filter</span> = <span class="ruby-node">&quot; AND project_id = #{m.project_id}&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">m</span>
159:       <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
160:         <span class="ruby-identifier">filter</span> = <span class="ruby-node">&quot; AND project_id = #{session[:filter_project]}&quot;</span>
161:       <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_customer</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
162:         <span class="ruby-identifier">pids</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company</span>.<span class="ruby-identifier">customers</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_customer</span>]).<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span>}.<span class="ruby-identifier">join</span>(<span class="ruby-value str">','</span>) <span class="ruby-keyword kw">rescue</span> <span class="ruby-value str">'0'</span>
163:         <span class="ruby-identifier">filter</span> = <span class="ruby-node">&quot; AND project_id IN (#{pids})&quot;</span>
164:       <span class="ruby-keyword kw">end</span>
165:       <span class="ruby-identifier">milestones</span> = <span class="ruby-constant">Milestone</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;company_id = ? AND project_id IN (#{current_project_ids})#{filter} AND completed_at IS NULL&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>], <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;due_at, name&quot;</span>)
166:       <span class="ruby-identifier">milestones</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-ivar">@group_ids</span>[<span class="ruby-identifier">m</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot; / &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">name</span>] = <span class="ruby-identifier">m</span>.<span class="ruby-identifier">id</span> }
167:       <span class="ruby-ivar">@group_ids</span>[<span class="ruby-value str">'Unassigned'</span>] = <span class="ruby-value">0</span>
168:       <span class="ruby-identifier">items</span> = [<span class="ruby-value str">&quot;Unassigned&quot;</span>] <span class="ruby-operator">+</span>  <span class="ruby-identifier">milestones</span>.<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot; / &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">name</span> }
169:       <span class="ruby-ivar">@groups</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">group_by</span>(<span class="ruby-ivar">@tasks</span>, <span class="ruby-identifier">items</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">t</span>,<span class="ruby-identifier">i</span><span class="ruby-operator">|</span> (<span class="ruby-identifier">t</span>.<span class="ruby-identifier">milestone</span> <span class="ruby-value">? </span>(<span class="ruby-identifier">t</span>.<span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot; / &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">name</span>) <span class="ruby-operator">:</span> <span class="ruby-value str">&quot;Unassigned&quot;</span> ) <span class="ruby-operator">==</span> <span class="ruby-identifier">i</span> }
170:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:group_by</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">5</span> <span class="ruby-comment cmt"># Users</span>
171:       <span class="ruby-identifier">users</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company</span>.<span class="ruby-identifier">users</span>
172:       <span class="ruby-identifier">users</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">u</span><span class="ruby-operator">|</span> <span class="ruby-ivar">@group_ids</span>[<span class="ruby-identifier">u</span>.<span class="ruby-identifier">name</span>] = <span class="ruby-identifier">u</span>.<span class="ruby-identifier">id</span> }
173:       <span class="ruby-ivar">@group_ids</span>[<span class="ruby-identifier">_</span>(<span class="ruby-value str">'Unassigned'</span>)] = <span class="ruby-value">0</span>
174:       <span class="ruby-identifier">items</span> = [<span class="ruby-identifier">_</span>(<span class="ruby-value str">&quot;Unassigned&quot;</span>)] <span class="ruby-operator">+</span> <span class="ruby-identifier">users</span>.<span class="ruby-identifier">collect</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">:name</span>).<span class="ruby-identifier">sort</span>
175:       <span class="ruby-ivar">@groups</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">group_by</span>(<span class="ruby-ivar">@tasks</span>, <span class="ruby-identifier">items</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">t</span>,<span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
176:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">users</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
177:           <span class="ruby-identifier">res</span> = <span class="ruby-identifier">t</span>.<span class="ruby-identifier">users</span>.<span class="ruby-identifier">collect</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">:name</span>).<span class="ruby-identifier">include?</span> <span class="ruby-identifier">i</span>
178:         <span class="ruby-keyword kw">else</span>
179:           <span class="ruby-identifier">res</span> = (<span class="ruby-identifier">_</span>(<span class="ruby-value str">&quot;Unassigned&quot;</span>) <span class="ruby-operator">==</span> <span class="ruby-identifier">i</span>)
180:         <span class="ruby-keyword kw">end</span>
181:         <span class="ruby-identifier">res</span>
182:       }
183:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:group_by</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">6</span> <span class="ruby-comment cmt"># Task Type</span>
184:       <span class="ruby-value">0</span>.<span class="ruby-identifier">upto</span>(<span class="ruby-value">3</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-ivar">@group_ids</span>[ <span class="ruby-identifier">_</span>(<span class="ruby-constant">Task</span>.<span class="ruby-identifier">issue_types</span>[<span class="ruby-identifier">i</span>]) ] = <span class="ruby-identifier">i</span> }
185:       <span class="ruby-identifier">items</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">issue_types</span>.<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">_</span>(<span class="ruby-identifier">i</span>) }.<span class="ruby-identifier">sort</span>
186:       <span class="ruby-ivar">@groups</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">group_by</span>(<span class="ruby-ivar">@tasks</span>, <span class="ruby-identifier">items</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">t</span>,<span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">_</span>(<span class="ruby-identifier">t</span>.<span class="ruby-identifier">issue_type</span>) <span class="ruby-operator">==</span> <span class="ruby-identifier">i</span> }
187:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:group_by</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">7</span> <span class="ruby-comment cmt"># Status</span>
188:       <span class="ruby-value">0</span>.<span class="ruby-identifier">upto</span>(<span class="ruby-value">5</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-ivar">@group_ids</span>[ <span class="ruby-identifier">_</span>(<span class="ruby-constant">Task</span>.<span class="ruby-identifier">status_types</span>[<span class="ruby-identifier">i</span>]) ] = <span class="ruby-identifier">i</span> }
189:       <span class="ruby-identifier">items</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">status_types</span>.<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">_</span>(<span class="ruby-identifier">i</span>) }
190:       <span class="ruby-ivar">@groups</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">group_by</span>(<span class="ruby-ivar">@tasks</span>, <span class="ruby-identifier">items</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">t</span>,<span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">_</span>(<span class="ruby-identifier">t</span>.<span class="ruby-identifier">status_type</span>) <span class="ruby-operator">==</span> <span class="ruby-identifier">i</span> }
191:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:group_by</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">8</span> <span class="ruby-comment cmt"># Severity</span>
192:       <span class="ruby-value">-2</span>.<span class="ruby-identifier">upto</span>(<span class="ruby-value">3</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-ivar">@group_ids</span>[<span class="ruby-identifier">_</span>(<span class="ruby-constant">Task</span>.<span class="ruby-identifier">severity_types</span>[<span class="ruby-identifier">i</span>])] = <span class="ruby-identifier">i</span> }
193:       <span class="ruby-identifier">items</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">severity_types</span>.<span class="ruby-identifier">sort</span>.<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span> <span class="ruby-identifier">_</span>(<span class="ruby-identifier">v</span>[<span class="ruby-value">1</span>]) }.<span class="ruby-identifier">reverse</span>
194:       <span class="ruby-ivar">@groups</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">group_by</span>(<span class="ruby-ivar">@tasks</span>, <span class="ruby-identifier">items</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">t</span>,<span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">_</span>(<span class="ruby-identifier">t</span>.<span class="ruby-identifier">severity_type</span>) <span class="ruby-operator">==</span> <span class="ruby-identifier">i</span> }
195:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:group_by</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">9</span> <span class="ruby-comment cmt"># Priority</span>
196:       <span class="ruby-value">-2</span>.<span class="ruby-identifier">upto</span>(<span class="ruby-value">3</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-ivar">@group_ids</span>[ <span class="ruby-identifier">_</span>(<span class="ruby-constant">Task</span>.<span class="ruby-identifier">priority_types</span>[<span class="ruby-identifier">i</span>])] = <span class="ruby-identifier">i</span> }
197:       <span class="ruby-identifier">items</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">priority_types</span>.<span class="ruby-identifier">sort</span>.<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span> <span class="ruby-identifier">_</span>(<span class="ruby-identifier">v</span>[<span class="ruby-value">1</span>]) }.<span class="ruby-identifier">reverse</span>
198:       <span class="ruby-ivar">@groups</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">group_by</span>(<span class="ruby-ivar">@tasks</span>, <span class="ruby-identifier">items</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">t</span>,<span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">_</span>(<span class="ruby-identifier">t</span>.<span class="ruby-identifier">priority_type</span>) <span class="ruby-operator">==</span> <span class="ruby-identifier">i</span> }
199:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:group_by</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">10</span> <span class="ruby-comment cmt"># Projects / Milestones</span>
200:       <span class="ruby-identifier">milestones</span> = <span class="ruby-constant">Milestone</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;company_id = ? AND project_id IN (#{current_project_ids}) AND completed_at IS NULL&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>], <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;due_at, name&quot;</span>)
201:       <span class="ruby-identifier">projects</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>
202: 
203:       <span class="ruby-identifier">milestones</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-ivar">@group_ids</span>[<span class="ruby-node">&quot;#{m.project.name} / #{m.name}&quot;</span>] = <span class="ruby-node">&quot;#{m.project_id}_#{m.id}&quot;</span> }
204:       <span class="ruby-identifier">projects</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-ivar">@group_ids</span>[<span class="ruby-node">&quot;#{p.name}&quot;</span>] = <span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span> }
205: 
206:       <span class="ruby-identifier">items</span> = <span class="ruby-identifier">milestones</span>.<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-node">&quot;#{m.project.name} / #{m.name}&quot;</span> }.<span class="ruby-identifier">flatten</span>
207:       <span class="ruby-identifier">items</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">projects</span>.<span class="ruby-identifier">collect</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">:name</span>)
208:       <span class="ruby-identifier">items</span> = <span class="ruby-identifier">items</span>.<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">sort</span>
209: 
210:       <span class="ruby-ivar">@groups</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">group_by</span>(<span class="ruby-ivar">@tasks</span>, <span class="ruby-identifier">items</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">t</span>,<span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">milestone</span> <span class="ruby-value">? </span>(<span class="ruby-node">&quot;#{t.project.name} / #{t.milestone.name}&quot;</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">i</span>) <span class="ruby-operator">:</span> (<span class="ruby-identifier">t</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">i</span>)  }
211:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:group_by</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">11</span> <span class="ruby-comment cmt"># Requested By</span>
212:       <span class="ruby-identifier">requested_by</span> = <span class="ruby-ivar">@tasks</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">requested_by</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-value">? </span><span class="ruby-keyword kw">nil</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">requested_by</span> }.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">sort</span>
213:       <span class="ruby-identifier">requested_by</span> = [<span class="ruby-identifier">_</span>(<span class="ruby-value str">'No one'</span>)] <span class="ruby-operator">+</span> <span class="ruby-identifier">requested_by</span>
214:       <span class="ruby-ivar">@groups</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">group_by</span>(<span class="ruby-ivar">@tasks</span>, <span class="ruby-identifier">requested_by</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">t</span>,<span class="ruby-identifier">i</span><span class="ruby-operator">|</span> (<span class="ruby-identifier">t</span>.<span class="ruby-identifier">requested_by</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-value">? </span><span class="ruby-identifier">_</span>(<span class="ruby-value str">'No one'</span>) <span class="ruby-operator">:</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">requested_by</span>) <span class="ruby-operator">==</span> <span class="ruby-identifier">i</span> }
215:     <span class="ruby-keyword kw">else</span>
216:       <span class="ruby-ivar">@groups</span> = [<span class="ruby-ivar">@tasks</span>]
217:     <span class="ruby-keyword kw">end</span>
218: 
219:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000181"><br/></a>
<div class="method_block"><h3>
<a href='#M000181'>


move

()

</a>
</h3>

<p class="source_link" id="M000181-show-link"><a onclick="toggle('M000181-source'); toggleText('M000181-link'); return false;" href="#" id="M000181-link">Show source...</a></p><div class="source" id="M000181-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1393</span>
1393:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">move</span>
1394:     <span class="ruby-keyword kw">begin</span>
1395:       <span class="ruby-identifier">body</span> = <span class="ruby-value str">&quot;&quot;</span>
1396:       <span class="ruby-identifier">elems</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>].<span class="ruby-identifier">split</span>(<span class="ruby-value str">' '</span>)
1397:       <span class="ruby-identifier">element</span> = <span class="ruby-identifier">elems</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">split</span>(<span class="ruby-value str">'_'</span>)[<span class="ruby-value">1</span>]
1398: 
1399:       <span class="ruby-ivar">@group</span> = <span class="ruby-identifier">elems</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">split</span>(<span class="ruby-value str">'_'</span>)[<span class="ruby-value">1</span>].<span class="ruby-identifier">to_i</span>
1400: 
1401:       <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">element</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;project_id IN (#{current_project_ids})&quot;</span>])
1402: 
1403:       <span class="ruby-identifier">worklog</span> = <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">new</span>
1404:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_MODIFIED</span>
1405: 
1406:       <span class="ruby-identifier">update_type</span> = <span class="ruby-identifier">:updated</span>
1407: 
1408:       <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:group_by</span>].<span class="ruby-identifier">to_i</span>
1409:       <span class="ruby-keyword kw">when</span> <span class="ruby-value">3</span>
1410:         <span class="ruby-comment cmt"># Project</span>
1411:         <span class="ruby-identifier">project</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">find</span>(<span class="ruby-ivar">@group</span>)
1412:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project_id</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">project</span>.<span class="ruby-identifier">id</span>
1413:           <span class="ruby-identifier">body</span> = <span class="ruby-node">&quot;- &lt;strong&gt;Project&lt;/strong&gt;: #{@task.project.name} -&gt; #{project.name}\n&quot;</span>
1414:           <span class="ruby-identifier">old_milestone</span> = <span class="ruby-keyword kw">nil</span>
1415:           <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone</span>
1416:             <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Milestone&lt;/strong&gt;: #{@task.milestone.name} -&gt; None&quot;</span>
1417:             <span class="ruby-identifier">old_milestone</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone</span>
1418:             <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone</span> = <span class="ruby-keyword kw">nil</span>
1419:           <span class="ruby-keyword kw">end</span>
1420:           <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project_id</span> = <span class="ruby-identifier">project</span>.<span class="ruby-identifier">id</span>
1421:           <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">save</span>
1422:           <span class="ruby-identifier">old_milestone</span>.<span class="ruby-identifier">update_counts</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">old_milestone</span>
1423:         <span class="ruby-keyword kw">end</span>
1424:       <span class="ruby-keyword kw">when</span> <span class="ruby-value">4</span>
1425:         <span class="ruby-comment cmt"># Milestone</span>
1426:         <span class="ruby-identifier">milestone</span> = <span class="ruby-constant">Milestone</span>.<span class="ruby-identifier">find</span>(<span class="ruby-ivar">@group</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;project_id IN (#{current_project_ids})&quot;</span>]) <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@group</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
1427: 
1428:         <span class="ruby-keyword kw">if</span>(<span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone_id</span>.<span class="ruby-identifier">to_i</span>) <span class="ruby-operator">!=</span> <span class="ruby-ivar">@group</span>
1429:           <span class="ruby-keyword kw">if</span>( <span class="ruby-identifier">milestone</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">project_id</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project_id</span> )
1430:             <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Project&lt;/strong&gt;: #{@task.project.name} -&gt; #{milestone.project.name}\n&quot;</span>
1431:             <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project_id</span> = <span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">project_id</span>
1432:             <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">update_all</span>(<span class="ruby-node">&quot;customer_id = #{milestone.project.customer_id}, project_id = #{milestone.project_id}&quot;</span>, <span class="ruby-node">&quot;task_id = #{@task.id}&quot;</span>)
1433:             <span class="ruby-constant">ProjectFile</span>.<span class="ruby-identifier">update_all</span>(<span class="ruby-node">&quot;customer_id = #{milestone.project.customer_id}, project_id = #{milestone.project_id}&quot;</span>, <span class="ruby-node">&quot;task_id = #{@task.id}&quot;</span>)
1434:           <span class="ruby-keyword kw">end</span>
1435: 
1436:           <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone_id</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@group</span>
1437:             <span class="ruby-identifier">old_milestone</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-value">? </span><span class="ruby-value str">&quot;None&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">name</span>
1438:             <span class="ruby-identifier">new_milestone</span> = <span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-value">? </span><span class="ruby-value str">&quot;None&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">name</span>
1439: 
1440:             <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Milestone&lt;/strong&gt;: #{old_milestone} -&gt; #{new_milestone}&quot;</span>
1441: 
1442:             <span class="ruby-identifier">old</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone</span>
1443: 
1444:             <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone</span> = <span class="ruby-identifier">milestone</span>
1445:             <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">save</span>
1446: 
1447:             <span class="ruby-identifier">old</span>.<span class="ruby-identifier">update_counts</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">old</span>
1448: 
1449:           <span class="ruby-keyword kw">end</span>
1450:         <span class="ruby-keyword kw">end</span>
1451:       <span class="ruby-keyword kw">when</span> <span class="ruby-value">5</span>
1452:         <span class="ruby-comment cmt"># User</span>
1453: 
1454:         <span class="ruby-identifier">old_users</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">users</span>.<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">u</span><span class="ruby-operator">|</span> <span class="ruby-identifier">u</span>.<span class="ruby-identifier">id</span>}.<span class="ruby-identifier">sort</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">','</span>)
1455:         <span class="ruby-identifier">old_users</span> = <span class="ruby-value str">&quot;0&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">old_users</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">old_users</span>.<span class="ruby-identifier">empty?</span>
1456: 
1457:         <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">task_owners</span>.<span class="ruby-identifier">destroy_all</span>
1458:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@group</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
1459:           <span class="ruby-identifier">u</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find</span>(<span class="ruby-ivar">@group</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;company_id = ?&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>])
1460:           <span class="ruby-identifier">to</span> = <span class="ruby-constant">TaskOwner</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">:user</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">u</span>, <span class="ruby-identifier">:task</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@task</span>)
1461:           <span class="ruby-identifier">to</span>.<span class="ruby-identifier">save</span>
1462: 
1463:           <span class="ruby-keyword kw">if</span>( <span class="ruby-identifier">old_users</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">u</span>.<span class="ruby-identifier">name</span> )
1464:             <span class="ruby-identifier">new_name</span> = <span class="ruby-identifier">u</span>.<span class="ruby-identifier">name</span>
1465:             <span class="ruby-identifier">body</span> = <span class="ruby-node">&quot;- &lt;strong&gt;Assignment&lt;/strong&gt;: #{new_name}\n&quot;</span>
1466:             <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">users</span>.<span class="ruby-identifier">reload</span>
1467:             <span class="ruby-identifier">update_type</span> = <span class="ruby-identifier">:reassigned</span>
1468:           <span class="ruby-keyword kw">end</span>
1469: 
1470:         <span class="ruby-keyword kw">end</span>
1471:         <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">save</span>
1472:       <span class="ruby-keyword kw">when</span> <span class="ruby-value">6</span>
1473:         <span class="ruby-comment cmt"># Task Type</span>
1474:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">type_id</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@group</span>
1475:           <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Type&lt;/strong&gt;: #{@task.issue_type} -&gt; #{Task.issue_types[@group]}\n&quot;</span>
1476:           <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">type_id</span> = <span class="ruby-ivar">@group</span>
1477:           <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">save</span>
1478:         <span class="ruby-keyword kw">end</span>
1479:       <span class="ruby-keyword kw">when</span> <span class="ruby-value">7</span>
1480:         <span class="ruby-comment cmt"># Status</span>
1481:         <span class="ruby-keyword kw">if</span>( <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@group</span> )
1482:           <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@group</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">2</span>
1483:             <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">completed_at</span> = <span class="ruby-keyword kw">nil</span>
1484:             <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>
1485:               <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_REVERTED</span>
1486:               <span class="ruby-identifier">update_type</span> = <span class="ruby-identifier">:reverted</span>
1487:             <span class="ruby-keyword kw">end</span>
1488:           <span class="ruby-keyword kw">else</span>
1489:             <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">completed_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">completed_at</span>.<span class="ruby-identifier">nil?</span>
1490:             <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">2</span>
1491:               <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_COMPLETED</span>
1492:               <span class="ruby-identifier">update_type</span> = <span class="ruby-identifier">:completed</span>
1493:             <span class="ruby-keyword kw">end</span>
1494:           <span class="ruby-keyword kw">end</span>
1495:           <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Status&lt;/strong&gt;: #{@task.status_type} -&gt; #{Task.status_types[@group]}\n&quot;</span>
1496:           <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status</span> = <span class="ruby-ivar">@group</span>
1497:           <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">save</span>
1498:         <span class="ruby-keyword kw">end</span>
1499:       <span class="ruby-keyword kw">when</span> <span class="ruby-value">8</span>
1500:         <span class="ruby-comment cmt"># Severity</span>
1501:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">severity_id</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@group</span>
1502:           <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Severity&lt;/strong&gt;: #{@task.severity_type} -&gt; #{Task.severity_types[@group]}\n&quot;</span>
1503:           <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">severity_id</span> = <span class="ruby-ivar">@group</span>
1504:           <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">save</span>
1505:         <span class="ruby-keyword kw">end</span>
1506:       <span class="ruby-keyword kw">when</span> <span class="ruby-value">9</span>
1507:         <span class="ruby-comment cmt"># Priority</span>
1508:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">priority</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@group</span>
1509:           <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Priority&lt;/strong&gt;: #{@task.priority_type} -&gt; #{Task.priority_types[@group]}\n&quot;</span>
1510:           <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">priority</span> = <span class="ruby-ivar">@group</span>
1511:           <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">save</span>
1512:         <span class="ruby-keyword kw">end</span>
1513:       <span class="ruby-keyword kw">when</span> <span class="ruby-value">10</span>
1514:         <span class="ruby-comment cmt"># Project / Milestone</span>
1515:         <span class="ruby-comment cmt"># task-group_44_15</span>
1516: 
1517:         <span class="ruby-identifier">project</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">find</span>(<span class="ruby-ivar">@group</span>)
1518:         <span class="ruby-identifier">old</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone</span>
1519: 
1520:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project_id</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@group</span>
1521:           <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Project&lt;/strong&gt;: #{@task.project.name} -&gt; #{project.name}\n&quot;</span>
1522:           <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project_id</span> = <span class="ruby-ivar">@group</span>
1523:         <span class="ruby-keyword kw">end</span>
1524: 
1525:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">elems</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">split</span>(<span class="ruby-value str">'_'</span>).<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">2</span>
1526:           <span class="ruby-identifier">milestone</span> = <span class="ruby-constant">Milestone</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">elems</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">split</span>(<span class="ruby-value str">'_'</span>)[<span class="ruby-value">2</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;project_id IN (#{current_project_ids})&quot;</span>])
1527: 
1528:           
1529:           <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone_id</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">id</span>
1530:             <span class="ruby-identifier">old_milestone</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-value">? </span><span class="ruby-value str">&quot;None&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">name</span>
1531:             <span class="ruby-identifier">new_milestone</span> = <span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-value">? </span><span class="ruby-value str">&quot;None&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">name</span>
1532:             <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Milestone&lt;/strong&gt;: #{old_milestone} -&gt; #{new_milestone}&quot;</span>
1533: 
1534:             <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone_id</span> = <span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">id</span>
1535: 
1536:           <span class="ruby-keyword kw">end</span>
1537:           <span class="ruby-ivar">@group</span> = <span class="ruby-node">&quot;#{@group}_#{milestone.id}&quot;</span>
1538:         <span class="ruby-keyword kw">else</span>
1539:           <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone_id</span>.<span class="ruby-identifier">nil?</span>
1540:             <span class="ruby-identifier">old_milestone</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-value">? </span><span class="ruby-value str">&quot;None&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">name</span>
1541:             <span class="ruby-identifier">new_milestone</span> = <span class="ruby-value str">&quot;None&quot;</span>
1542:             <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Milestone&lt;/strong&gt;: #{old_milestone} -&gt; #{new_milestone}&quot;</span>
1543:             <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone_id</span> = <span class="ruby-keyword kw">nil</span>
1544:           <span class="ruby-keyword kw">end</span>
1545:         <span class="ruby-keyword kw">end</span>
1546: 
1547:         <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">update_all</span>(<span class="ruby-node">&quot;customer_id = #{project.customer_id}, project_id = #{project.id}&quot;</span>, <span class="ruby-node">&quot;task_id = #{@task.id}&quot;</span>)
1548:         <span class="ruby-constant">ProjectFile</span>.<span class="ruby-identifier">update_all</span>(<span class="ruby-node">&quot;customer_id = #{project.customer_id}, project_id = #{project.id}&quot;</span>, <span class="ruby-node">&quot;task_id = #{@task.id}&quot;</span>)
1549: 
1550:         <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">save</span>
1551:         <span class="ruby-identifier">old</span>.<span class="ruby-identifier">update_counts</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">old</span>
1552:       <span class="ruby-keyword kw">end</span>
1553: 
1554: 
1555:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">body</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
1556:         <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">reload</span>
1557:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">user</span> = <span class="ruby-identifier">current_user</span>
1558:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">company</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">company</span>
1559:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">customer</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">customer</span>
1560:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">project</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>
1561:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">task</span> = <span class="ruby-ivar">@task</span>
1562:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">started_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>
1563:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-value">0</span>
1564:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">body</span> = <span class="ruby-identifier">body</span>
1565:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">save</span>
1566:         <span class="ruby-constant">Notifications</span><span class="ruby-operator">::</span><span class="ruby-identifier">deliver_changed</span>( <span class="ruby-identifier">update_type</span>, <span class="ruby-ivar">@task</span>, <span class="ruby-identifier">current_user</span>, <span class="ruby-identifier">body</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/&lt;[^&gt;]*&gt;/</span>,<span class="ruby-value str">''</span>)) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">send_notifications?</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
1567:         <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; @task.id)}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
1568:       <span class="ruby-keyword kw">end</span>
1569: 
1570:     <span class="ruby-keyword kw">end</span>
1571: 
1572:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000146"><br/></a>
<div class="method_block"><h3>
<a href='#M000146'>


new

()

</a>
</h3>

<p class="source_link" id="M000146-show-link"><a onclick="toggle('M000146-source'); toggleText('M000146-link'); return false;" href="#" id="M000146-link">Show source...</a></p><div class="source" id="M000146-source"><pre>    <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 13</span>
13:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">new</span>
14:     <span class="ruby-ivar">@projects</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'name'</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;completed_at IS NULL&quot;</span>]).<span class="ruby-identifier">collect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> [ <span class="ruby-node">&quot;#{c.name} / #{c.customer.name}&quot;</span>, <span class="ruby-identifier">c</span>.<span class="ruby-identifier">id</span> ] <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">can?</span>(<span class="ruby-identifier">c</span>, <span class="ruby-value str">'create'</span>)  }.<span class="ruby-identifier">compact</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">nil?</span>
15: 
16:     <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@projects</span>.<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">1</span>] }.<span class="ruby-identifier">include?</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:last_project_id</span>].<span class="ruby-identifier">to_i</span>
17:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:last_project_id</span>] = <span class="ruby-keyword kw">nil</span>
18:     <span class="ruby-keyword kw">end</span>
19: 
20:     <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@projects</span>.<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">1</span>] }.<span class="ruby-identifier">include?</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project</span>].<span class="ruby-identifier">to_i</span>
21:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project</span>] = <span class="ruby-keyword kw">nil</span>
22:     <span class="ruby-keyword kw">end</span>
23:     
24:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@projects</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@projects</span>.<span class="ruby-identifier">empty?</span>
25:       <span class="ruby-identifier">flash</span>[<span class="ruby-value str">'notice'</span>] = <span class="ruby-identifier">_</span>(<span class="ruby-value str">&quot;You need to create a project to hold your tasks, or get access to create tasks in an existing project...&quot;</span>)
26:       <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">:controller</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'projects'</span>, <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'new'</span>
27:       <span class="ruby-keyword kw">return</span>
28:     <span class="ruby-keyword kw">else</span>
29:       <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">new</span>
30:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-value">0</span>
31:       <span class="ruby-ivar">@tags</span> = <span class="ruby-constant">Tag</span>.<span class="ruby-identifier">top_counts</span>({ <span class="ruby-identifier">:company_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>, <span class="ruby-identifier">:project_ids</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">current_project_ids</span>, <span class="ruby-identifier">:filter_hidden</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_hidden</span>]})
32:     <span class="ruby-keyword kw">end</span>
33: 
34:     <span class="ruby-ivar">@notify_targets</span> = <span class="ruby-identifier">current_projects</span>.<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">users</span>.<span class="ruby-identifier">collect</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">:name</span>) }.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>
35:     <span class="ruby-ivar">@notify_targets</span> <span class="ruby-operator">+=</span> <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;project_id IN (#{current_project_ids}) AND notify_emails IS NOT NULL and notify_emails &lt;&gt; ''&quot;</span>]).<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">notify_emails</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">','</span>).<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">strip</span> } }
36:     <span class="ruby-ivar">@notify_targets</span> = <span class="ruby-ivar">@notify_targets</span>.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>
37:     <span class="ruby-ivar">@notify_targets</span> <span class="ruby-operator">||=</span> []
38:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000190"><br/></a>
<div class="method_block"><h3>
<a href='#M000190'>


order_todos

()

</a>
</h3>

<p class="source_link" id="M000190-show-link"><a onclick="toggle('M000190-source'); toggleText('M000190-link'); return false;" href="#" id="M000190-link">Show source...</a></p><div class="source" id="M000190-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1821</span>
1821:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">order_todos</span>
1822:     <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;id = ? AND project_id IN (#{current_project_ids})&quot;</span>, <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>]])
1823:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">todos</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;completed_at IS NULL&quot;</span>]).<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">todo</span><span class="ruby-operator">|</span>
1824:       <span class="ruby-identifier">todo</span>.<span class="ruby-identifier">position</span> = <span class="ruby-identifier">params</span>[<span class="ruby-node">&quot;todo-tasks-#{@task.id}&quot;</span>].<span class="ruby-identifier">index</span>(<span class="ruby-identifier">todo</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span>) <span class="ruby-operator">+</span> <span class="ruby-value">1</span>
1825:       <span class="ruby-identifier">todo</span>.<span class="ruby-identifier">save</span>
1826:     <span class="ruby-keyword kw">end</span>
1827:     <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1828:       <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-node">&quot;todo-#{@task.dom_id}&quot;</span>)
1829:     <span class="ruby-keyword kw">end</span>
1830:     <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; @task.id)}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
1831:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000187"><br/></a>
<div class="method_block"><h3>
<a href='#M000187'>


pause_work_ajax

()

</a>
</h3>

<p class="source_link" id="M000187-show-link"><a onclick="toggle('M000187-source'); toggleText('M000187-link'); return false;" href="#" id="M000187-link">Show source...</a></p><div class="source" id="M000187-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1715</span>
1715:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">pause_work_ajax</span>
1716:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@current_sheet</span> 
1717:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">paused_at</span>
1718:         <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">paused_duration</span> <span class="ruby-operator">+=</span> (<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">paused_at</span>).<span class="ruby-identifier">to_i</span>
1719:         <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">paused_at</span> = <span class="ruby-keyword kw">nil</span>
1720:       <span class="ruby-keyword kw">else</span>
1721:         <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">paused_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>
1722:       <span class="ruby-keyword kw">end</span>
1723:       <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">save</span>
1724:     <span class="ruby-keyword kw">else</span> 
1725:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:nothing</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>
1726:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(0, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; params[:id])}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
1727:       <span class="ruby-keyword kw">return</span>
1728:     <span class="ruby-keyword kw">end</span>
1729:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000183"><br/></a>
<div class="method_block"><h3>
<a href='#M000183'>


quick_add

()

</a>
</h3>

<p class="source_link" id="M000183-show-link"><a onclick="toggle('M000183-source'); toggleText('M000183-link'); return false;" href="#" id="M000183-link">Show source...</a></p><div class="source" id="M000183-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1589</span>
1589:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">quick_add</span>
1590:     <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">new</span>
1591:     <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1592:       <span class="ruby-identifier">page</span>.<span class="ruby-identifier">replace_html</span> <span class="ruby-value str">'quick_add_container'</span>, <span class="ruby-identifier">:partial</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'quick_add'</span>
1593:       <span class="ruby-identifier">page</span>.<span class="ruby-identifier">show</span>(<span class="ruby-value str">'quick_add_container'</span>)
1594:       <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-value str">&quot;quick_add_container&quot;</span>, <span class="ruby-identifier">:duration</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span><span class="ruby-value">.5</span>)
1595:     <span class="ruby-keyword kw">end</span>
1596:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000155"><br/></a>
<div class="method_block"><h3>
<a href='#M000155'>


repeat_task

(task)

</a>
</h3>
<p>
def edit_ajax
</p>
<pre>
  self.edit
  render :action =&gt; 'edit', :layout =&gt; false
</pre>
<p>
end
</p>

<p class="source_link" id="M000155-show-link"><a onclick="toggle('M000155-source'); toggleText('M000155-link'); return false;" href="#" id="M000155-link">Show source...</a></p><div class="source" id="M000155-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 510</span>
510:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">repeat_task</span>(<span class="ruby-identifier">task</span>)
511:     <span class="ruby-ivar">@repeat</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">new</span>
512:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">status</span> = <span class="ruby-value">0</span>
513:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">project_id</span> = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">project_id</span>
514:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">company_id</span> = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">company_id</span>
515:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">name</span> = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">name</span>
516:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">repeat</span> = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">repeat</span>
517:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">requested_by</span> = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">requested_by</span>
518:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">creator_id</span> = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">creator_id</span>
519:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">type_id</span> = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">type_id</span>
520:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">priority</span> = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">priority</span>
521:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">severity_id</span> = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">severity_id</span>
522:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">set_tags</span>(<span class="ruby-identifier">task</span>.<span class="ruby-identifier">tags</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">name</span>}.<span class="ruby-identifier">join</span>(<span class="ruby-value str">', '</span>))
523:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">set_task_num</span>(<span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>)
524:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">duration</span>
525:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">notify_emails</span> = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">notify_emails</span>
526:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">milestone_id</span> = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">milestone_id</span>
527:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">hidden</span> = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">hidden</span>
528:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">due_at</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">due_at</span>
529:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">due_at</span> = <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">next_repeat_date</span>
530:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">description</span> = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">description</span>
531: 
532:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">save</span>
533:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">reload</span>
534: 
535:     <span class="ruby-identifier">task</span>.<span class="ruby-identifier">notifications</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">w</span><span class="ruby-operator">|</span>
536:       <span class="ruby-identifier">n</span> = <span class="ruby-constant">Notification</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">:user</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">w</span>.<span class="ruby-identifier">user</span>, <span class="ruby-identifier">:task</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@repeat</span>)
537:       <span class="ruby-identifier">n</span>.<span class="ruby-identifier">save</span>
538:     <span class="ruby-keyword kw">end</span>
539: 
540:     <span class="ruby-identifier">task</span>.<span class="ruby-identifier">task_owners</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">o</span><span class="ruby-operator">|</span>
541:       <span class="ruby-identifier">to</span> = <span class="ruby-constant">TaskOwner</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">:user</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">user</span>, <span class="ruby-identifier">:task</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@repeat</span>)
542:       <span class="ruby-identifier">to</span>.<span class="ruby-identifier">save</span>
543:     <span class="ruby-keyword kw">end</span>
544: 
545:     <span class="ruby-identifier">task</span>.<span class="ruby-identifier">dependencies</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">d</span><span class="ruby-operator">|</span>
546:         <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">dependencies</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">d</span>
547:     <span class="ruby-keyword kw">end</span>
548: 
549:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">save</span>
550: 
551:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000179"><br/></a>
<div class="method_block"><h3>
<a href='#M000179'>


save_log

()

</a>
</h3>

<p class="source_link" id="M000179-show-link"><a onclick="toggle('M000179-source'); toggleText('M000179-link'); return false;" href="#" id="M000179-link">Show source...</a></p><div class="source" id="M000179-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1275</span>
1275:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">save_log</span>
1276:     <span class="ruby-ivar">@log</span> = <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">find</span>( <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;company_id = ?&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>] )
1277:     
1278:     <span class="ruby-identifier">old_duration</span> = <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">duration</span>
1279:     <span class="ruby-identifier">old_note</span> = <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">body</span>
1280:     
1281:     <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-identifier">:log</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-identifier">:log</span>][<span class="ruby-identifier">:started_at</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:log</span>][<span class="ruby-identifier">:started_at</span>].<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
1282:       <span class="ruby-keyword kw">begin</span>
1283:         <span class="ruby-identifier">due_date</span> = <span class="ruby-constant">DateTime</span>.<span class="ruby-identifier">strptime</span>( <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:log</span>][<span class="ruby-identifier">:started_at</span>], <span class="ruby-node">&quot;#{current_user.date_format} #{current_user.time_format}&quot;</span> )
1284:         <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:log</span>][<span class="ruby-identifier">:started_at</span>] = <span class="ruby-identifier">tz</span>.<span class="ruby-identifier">local_to_utc</span>(<span class="ruby-identifier">due_date</span>)
1285:       <span class="ruby-keyword kw">rescue</span>
1286:         <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:log</span>][<span class="ruby-identifier">:started_at</span>] = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>
1287:       <span class="ruby-keyword kw">end</span>
1288:     <span class="ruby-keyword kw">end</span>
1289: 
1290:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">update_attributes</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:log</span>])
1291: 
1292: 
1293:       <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">started_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span> <span class="ruby-keyword kw">if</span>(<span class="ruby-ivar">@log</span>.<span class="ruby-identifier">started_at</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> (<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:log</span>] <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:log</span>][<span class="ruby-identifier">:started_at</span>].<span class="ruby-identifier">blank?</span>)) )
1294: 
1295:       <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-identifier">parse_time</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:log</span>][<span class="ruby-identifier">:duration</span>])
1296:       <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-identifier">old_duration</span> <span class="ruby-keyword kw">if</span>((<span class="ruby-identifier">old_duration</span> <span class="ruby-operator">/</span> <span class="ruby-value">60</span>) <span class="ruby-operator">==</span> (<span class="ruby-ivar">@log</span>.<span class="ruby-identifier">duration</span> <span class="ruby-operator">/</span> <span class="ruby-value">60</span>)) 
1297: 
1298:       <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">task</span>.<span class="ruby-identifier">updated_by_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
1299: 
1300:       <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">comment</span> = <span class="ruby-operator">!</span><span class="ruby-ivar">@log</span>.<span class="ruby-identifier">body</span>.<span class="ruby-identifier">blank?</span>
1301:       
1302:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:status</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">task</span>.<span class="ruby-identifier">status</span>
1303: 
1304:         <span class="ruby-identifier">status_type</span> = <span class="ruby-identifier">:completed</span>
1305: 
1306:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:status</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">2</span>
1307:           <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_WORK_ADDED</span> 
1308:           <span class="ruby-identifier">status_type</span> = <span class="ruby-identifier">:updated</span>
1309:         <span class="ruby-keyword kw">end</span> 
1310:         
1311:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:status</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">2</span>
1312:           <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_COMPLETED</span> 
1313:           <span class="ruby-identifier">status_type</span> = <span class="ruby-identifier">:completed</span>
1314:         <span class="ruby-keyword kw">end</span> 
1315: 
1316:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:status</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">2</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>
1317:           <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_REVERTED</span> 
1318:           <span class="ruby-identifier">status_type</span>= <span class="ruby-identifier">:reverted</span>
1319:         <span class="ruby-keyword kw">end</span> 
1320:         
1321:         <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">task</span>.<span class="ruby-identifier">status</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:status</span>].<span class="ruby-identifier">to_i</span>
1322:         <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">task</span>.<span class="ruby-identifier">updated_by_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
1323:         <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">task</span>.<span class="ruby-identifier">completed_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>
1324:         <span class="ruby-constant">Notifications</span><span class="ruby-operator">::</span><span class="ruby-identifier">deliver_changed</span>( <span class="ruby-identifier">status_type</span>, <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">task</span>, <span class="ruby-identifier">current_user</span>, <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:log</span>][<span class="ruby-identifier">:body</span>] ) <span class="ruby-keyword kw">if</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value str">'notify'</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
1325: 
1326:       <span class="ruby-keyword kw">elsif</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-identifier">:log</span>][<span class="ruby-identifier">:body</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:log</span>][<span class="ruby-identifier">:body</span>] <span class="ruby-operator">!=</span> <span class="ruby-identifier">old_note</span> <span class="ruby-operator">&amp;&amp;</span>  <span class="ruby-identifier">params</span>[<span class="ruby-value str">'notify'</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
1327:         <span class="ruby-constant">Notifications</span><span class="ruby-operator">::</span><span class="ruby-identifier">deliver_changed</span>( <span class="ruby-identifier">:comment</span>, <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">task</span>, <span class="ruby-identifier">current_user</span>, <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:log</span>][<span class="ruby-identifier">:body</span>].<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/&lt;[^&gt;]*&gt;/</span>,<span class="ruby-value str">''</span>)) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
1328:       <span class="ruby-keyword kw">end</span>
1329: 
1330:       <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">task</span>.<span class="ruby-identifier">save</span>
1331:       <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">save</span>
1332: 
1333:       <span class="ruby-identifier">flash</span>[<span class="ruby-value str">'notice'</span>] = <span class="ruby-identifier">_</span>(<span class="ruby-value str">&quot;Log entry saved...&quot;</span>)
1334:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; @log.task.id)}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
1335:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'activities', :action =&gt; 'refresh')}');&quot;</span>, [<span class="ruby-node">&quot;activity_#{current_user.company_id}&quot;</span>])
1336: 
1337:     <span class="ruby-keyword kw">end</span>
1338:     <span class="ruby-identifier">redirect_from_last</span>
1339:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000194"><br/></a>
<div class="method_block"><h3>
<a href='#M000194'>


save_tag

()

</a>
</h3>

<p class="source_link" id="M000194-show-link"><a onclick="toggle('M000194-source'); toggleText('M000194-link'); return false;" href="#" id="M000194-link">Show source...</a></p><div class="source" id="M000194-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1878</span>
1878:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">save_tag</span>
1879:     <span class="ruby-ivar">@tag</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company</span>.<span class="ruby-identifier">tags</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>]) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
1880:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@tag</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-value str">'tag-name'</span>].<span class="ruby-identifier">blank?</span>
1881:       <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Tag</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-identifier">:company_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>, <span class="ruby-identifier">:name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value str">'tag-name'</span>])
1882:         
1883:         <span class="ruby-ivar">@existing</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company</span>.<span class="ruby-identifier">tags</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;name = ?&quot;</span>, <span class="ruby-identifier">params</span>[<span class="ruby-value str">'tag-name'</span>]] )
1884:         <span class="ruby-ivar">@tag</span>.<span class="ruby-identifier">tasks</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
1885:           <span class="ruby-ivar">@existing</span>.<span class="ruby-identifier">tasks</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">t</span>
1886:         <span class="ruby-keyword kw">end</span> 
1887:         <span class="ruby-ivar">@tag</span>.<span class="ruby-identifier">destroy</span>
1888: 
1889:         <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1890:           <span class="ruby-identifier">page</span>[<span class="ruby-ivar">@tag</span>.<span class="ruby-identifier">dom_id</span>].<span class="ruby-identifier">remove</span>
1891:           <span class="ruby-ivar">@tag</span> = <span class="ruby-ivar">@existing</span>
1892:           <span class="ruby-identifier">page</span>[<span class="ruby-ivar">@tag</span>.<span class="ruby-identifier">dom_id</span>].<span class="ruby-identifier">replace</span> <span class="ruby-identifier">:partial</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'edit_tag_row'</span>
1893:         <span class="ruby-keyword kw">end</span> 
1894:         
1895:       <span class="ruby-keyword kw">else</span> 
1896:         <span class="ruby-ivar">@tag</span>.<span class="ruby-identifier">name</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value str">'tag-name'</span>]
1897:         <span class="ruby-ivar">@tag</span>.<span class="ruby-identifier">save</span>
1898:         <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1899:           <span class="ruby-identifier">page</span>[<span class="ruby-ivar">@tag</span>.<span class="ruby-identifier">dom_id</span>].<span class="ruby-identifier">replace</span> <span class="ruby-identifier">:partial</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'edit_tag_row'</span>
1900:         <span class="ruby-keyword kw">end</span> 
1901:       <span class="ruby-keyword kw">end</span> 
1902:     <span class="ruby-keyword kw">else</span> 
1903:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:nothing</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>
1904:     <span class="ruby-keyword kw">end</span> 
1905:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000186"><br/></a>
<div class="method_block"><h3>
<a href='#M000186'>


shortlist

()

</a>
</h3>

<p class="source_link" id="M000186-show-link"><a onclick="toggle('M000186-source'); toggleText('M000186-link'); return false;" href="#" id="M000186-link">Show source...</a></p><div class="source" id="M000186-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1688</span>
1688:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">shortlist</span>
1689:     <span class="ruby-identifier">tmp</span> = { }
1690:     <span class="ruby-comment cmt"># Save filtering</span>
1691:     [<span class="ruby-identifier">:filter_customer</span>, <span class="ruby-identifier">:filter_milestone</span>, <span class="ruby-identifier">:filter_project</span>, <span class="ruby-identifier">:filter_user</span>, <span class="ruby-identifier">:filter_hidden</span>, <span class="ruby-identifier">:filter_status</span>, <span class="ruby-identifier">:group_by</span>, <span class="ruby-identifier">:hide_dependencies</span>, <span class="ruby-identifier">:sort</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
1692:       <span class="ruby-identifier">tmp</span>[<span class="ruby-identifier">v</span>] = <span class="ruby-identifier">session</span>[<span class="ruby-identifier">v</span>]
1693:     <span class="ruby-keyword kw">end</span>
1694: 
1695:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project</span>] = <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project_short</span>] <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project_short</span>]
1696:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_customer</span>] = <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_customer_short</span>] <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project_short</span>]
1697:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_milestone</span>] = <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_milestone_short</span>] <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project_short</span>]
1698:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_user</span>] = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span>
1699:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_hidden</span>] = <span class="ruby-value str">&quot;0&quot;</span>
1700:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_status</span>] = <span class="ruby-value str">&quot;0&quot;</span>
1701:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:group_by</span>] = <span class="ruby-value str">&quot;0&quot;</span>
1702:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:hide_dependencies</span>] = <span class="ruby-value str">&quot;1&quot;</span>
1703:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:sort</span>] = <span class="ruby-value str">&quot;0&quot;</span>
1704: 
1705:     <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">list</span>
1706: 
1707:     <span class="ruby-comment cmt"># Restore filtering</span>
1708:     [<span class="ruby-identifier">:filter_customer</span>, <span class="ruby-identifier">:filter_milestone</span>, <span class="ruby-identifier">:filter_project</span>, <span class="ruby-identifier">:filter_user</span>, <span class="ruby-identifier">:filter_hidden</span>, <span class="ruby-identifier">:filter_status</span>, <span class="ruby-identifier">:group_by</span>, <span class="ruby-identifier">:hide_dependencies</span>, <span class="ruby-identifier">:sort</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
1709:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">v</span>] = <span class="ruby-identifier">tmp</span>[<span class="ruby-identifier">v</span>]
1710:     <span class="ruby-keyword kw">end</span>
1711: 
1712:     <span class="ruby-identifier">render</span> <span class="ruby-identifier">:layout</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'shortlist'</span>
1713:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000162"><br/></a>
<div class="method_block"><h3>
<a href='#M000162'>


start_work

()

</a>
</h3>

<p class="source_link" id="M000162-show-link"><a onclick="toggle('M000162-source'); toggleText('M000162-link'); return false;" href="#" id="M000162-link">Show source...</a></p><div class="source" id="M000162-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1013</span>
1013:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">start_work</span>
1014:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@current_sheet</span>
1015:       <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">swap_work_ajax</span>
1016:     <span class="ruby-keyword kw">end</span>
1017:     
1018:     <span class="ruby-identifier">task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;company_id = ?&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>])
1019:     <span class="ruby-identifier">sheet</span> = <span class="ruby-constant">Sheet</span>.<span class="ruby-identifier">new</span>
1020: 
1021:     <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">task</span> = <span class="ruby-identifier">task</span>
1022:     <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">user</span> = <span class="ruby-identifier">current_user</span>
1023:     <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">project</span> = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">project</span>
1024:     <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">save</span>
1025: 
1026:     <span class="ruby-identifier">task</span>.<span class="ruby-identifier">status</span> = <span class="ruby-value">1</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
1027:     <span class="ruby-identifier">task</span>.<span class="ruby-identifier">save</span>
1028: 
1029:     <span class="ruby-ivar">@current_sheet</span> = <span class="ruby-identifier">sheet</span>
1030: 
1031:     <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; task.id)}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
1032: 
1033:     <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">xhr?</span>
1034:     <span class="ruby-identifier">redirect_from_last</span>
1035:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000163"><br/></a>
<div class="method_block"><h3>
<a href='#M000163'>


start_work_ajax

()

</a>
</h3>

<p class="source_link" id="M000163-show-link"><a onclick="toggle('M000163-source'); toggleText('M000163-link'); return false;" href="#" id="M000163-link">Show source...</a></p><div class="source" id="M000163-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1037</span>
1037:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">start_work_ajax</span>
1038:     <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">start_work</span>
1039:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000164"><br/></a>
<div class="method_block"><h3>
<a href='#M000164'>


start_work_edit_ajax

()

</a>
</h3>

<p class="source_link" id="M000164-show-link"><a onclick="toggle('M000164-source'); toggleText('M000164-link'); return false;" href="#" id="M000164-link">Show source...</a></p><div class="source" id="M000164-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1041</span>
1041:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">start_work_edit_ajax</span>
1042:     <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">start_work</span>
1043:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000168"><br/></a>
<div class="method_block"><h3>
<a href='#M000168'>


stop_work

()

</a>
</h3>

<p class="source_link" id="M000168-show-link"><a onclick="toggle('M000168-source'); toggleText('M000168-link'); return false;" href="#" id="M000168-link">Show source...</a></p><div class="source" id="M000168-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1122</span>
1122:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">stop_work</span>
1123:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@current_sheet</span>
1124:       <span class="ruby-identifier">worklog</span> = <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">new</span>
1125:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">user</span> = <span class="ruby-identifier">current_user</span>
1126:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">company</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company</span>
1127:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">project</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">project</span>
1128:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">task</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">task</span>
1129:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">customer</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">customer</span>
1130:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">started_at</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">created_at</span>
1131:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">duration</span>
1132:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">paused_duration</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">paused_duration</span>
1133:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">body</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">body</span>
1134:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_WORK_ADDED</span>
1135:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">comment</span> = <span class="ruby-keyword kw">true</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">body</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">body</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span> 
1136:       
1137:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">save</span>
1138:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">task</span>.<span class="ruby-identifier">updated_by_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
1139:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">task</span>.<span class="ruby-identifier">save</span>
1140: 
1141:         <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">destroy</span>
1142:         <span class="ruby-identifier">flash</span>[<span class="ruby-value str">'notice'</span>] = <span class="ruby-identifier">_</span>(<span class="ruby-value str">&quot;Log entry saved...&quot;</span>)
1143:         <span class="ruby-ivar">@log</span> = <span class="ruby-identifier">worklog</span>
1144:         <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">started_at</span> = <span class="ruby-identifier">tz</span>.<span class="ruby-identifier">utc_to_local</span>(<span class="ruby-ivar">@log</span>.<span class="ruby-identifier">started_at</span>)
1145:         <span class="ruby-ivar">@task</span> = <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">task</span>
1146:         <span class="ruby-identifier">render</span> <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'edit_log'</span>
1147:         <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; @task.id)}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
1148:       <span class="ruby-keyword kw">else</span>
1149:         <span class="ruby-identifier">flash</span>[<span class="ruby-value str">'notice'</span>] = <span class="ruby-identifier">_</span>(<span class="ruby-value str">&quot;Unable to save log entry...&quot;</span>)
1150:         <span class="ruby-identifier">redirect_from_last</span>
1151:       <span class="ruby-keyword kw">end</span>
1152:     <span class="ruby-keyword kw">else</span>
1153:       <span class="ruby-ivar">@current_sheet</span> = <span class="ruby-keyword kw">nil</span>
1154:       <span class="ruby-identifier">flash</span>[<span class="ruby-value str">'notice'</span>] = <span class="ruby-identifier">_</span>(<span class="ruby-value str">&quot;Log entry already saved from another browser instance.&quot;</span>)
1155:       <span class="ruby-identifier">redirect_from_last</span>
1156:     <span class="ruby-keyword kw">end</span>
1157: 
1158:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000169"><br/></a>
<div class="method_block"><h3>
<a href='#M000169'>


stop_work_shortlist

()

</a>
</h3>

<p class="source_link" id="M000169-show-link"><a onclick="toggle('M000169-source'); toggleText('M000169-link'); return false;" href="#" id="M000169-link">Show source...</a></p><div class="source" id="M000169-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1160</span>
1160:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">stop_work_shortlist</span>
1161:     <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@current_sheet</span>
1162:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:nothing</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>
1163:       <span class="ruby-keyword kw">return</span>
1164:     <span class="ruby-keyword kw">end</span>
1165: 
1166:     <span class="ruby-ivar">@task</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">task</span>
1167:     <span class="ruby-identifier">swap_work_ajax</span>
1168:     <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; @task.id)}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
1169: <span class="ruby-comment cmt">#    redirect_to :action =&gt; 'shortlist'</span>
1170:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000166"><br/></a>
<div class="method_block"><h3>
<a href='#M000166'>


swap_work_ajax

()

</a>
</h3>

<p class="source_link" id="M000166-show-link"><a onclick="toggle('M000166-source'); toggleText('M000166-link'); return false;" href="#" id="M000166-link">Show source...</a></p><div class="source" id="M000166-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1057</span>
1057:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">swap_work_ajax</span>
1058:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@current_sheet</span>
1059: 
1060:       <span class="ruby-ivar">@old_task</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">task</span>
1061: 
1062:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">nil?</span>
1063:         <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">destroy</span>
1064:         <span class="ruby-ivar">@current_sheet</span> = <span class="ruby-keyword kw">nil</span>
1065:         <span class="ruby-identifier">redirect_from_last</span>
1066:       <span class="ruby-keyword kw">end</span>
1067: 
1068: <span class="ruby-comment cmt">#      @old_task.updated_by_id = current_user.id</span>
1069: <span class="ruby-comment cmt">#      @old_task.save</span>
1070: 
1071:       <span class="ruby-identifier">worklog</span> = <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">new</span>
1072:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">user</span> = <span class="ruby-identifier">current_user</span>
1073:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">company</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company</span>
1074:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">project</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">project</span>
1075:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">task</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">task</span>
1076:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">customer</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">customer</span>
1077:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">started_at</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">created_at</span>
1078:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">duration</span>
1079:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">paused_duration</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">paused_duration</span>
1080:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">body</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">body</span>
1081:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">comment</span> = <span class="ruby-keyword kw">true</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">body</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">body</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
1082:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_WORK_ADDED</span>
1083:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">save</span>
1084:         <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">destroy</span>
1085:         <span class="ruby-identifier">flash</span>[<span class="ruby-value str">'notice'</span>] = <span class="ruby-identifier">_</span>(<span class="ruby-value str">&quot;Log entry saved...&quot;</span>)
1086:         <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; @old_task.id)}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
1087:         <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'activities', :action =&gt; 'refresh')}');&quot;</span>, [<span class="ruby-node">&quot;activity_#{current_user.company_id}&quot;</span>])
1088:         <span class="ruby-ivar">@current_sheet</span> = <span class="ruby-keyword kw">nil</span>
1089:       <span class="ruby-keyword kw">else</span>
1090:         <span class="ruby-identifier">flash</span>[<span class="ruby-value str">'notice'</span>] = <span class="ruby-identifier">_</span>(<span class="ruby-value str">&quot;Unable to save log entry...&quot;</span>)
1091:         <span class="ruby-identifier">redirect_from_last</span>
1092:       <span class="ruby-keyword kw">end</span>
1093: 
1094:     <span class="ruby-keyword kw">end</span>
1095:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000192"><br/></a>
<div class="method_block"><h3>
<a href='#M000192'>


tags

()

</a>
</h3>

<p class="source_link" id="M000192-show-link"><a onclick="toggle('M000192-source'); toggleText('M000192-link'); return false;" href="#" id="M000192-link">Show source...</a></p><div class="source" id="M000192-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1862</span>
1862:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">tags</span>
1863:     <span class="ruby-ivar">@tags</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company</span>.<span class="ruby-identifier">tags</span>
1864:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000189"><br/></a>
<div class="method_block"><h3>
<a href='#M000189'>


todo_check_ajax

()

</a>
</h3>

<p class="source_link" id="M000189-show-link"><a onclick="toggle('M000189-source'); toggleText('M000189-link'); return false;" href="#" id="M000189-link">Show source...</a></p><div class="source" id="M000189-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1774</span>
1774:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">todo_check_ajax</span>
1775:     <span class="ruby-keyword kw">begin</span>
1776:       <span class="ruby-ivar">@todo</span> = <span class="ruby-constant">Todo</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>])
1777:     <span class="ruby-keyword kw">rescue</span>
1778:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:nothing</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>
1779:       <span class="ruby-keyword kw">return</span>
1780:     <span class="ruby-keyword kw">end</span>
1781:     <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;id = ? AND project_id IN (#{current_project_ids})&quot;</span>, <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">task_id</span>])
1782:     <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@task</span>
1783:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1784:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-node">&quot;todos-#{params[:id]}&quot;</span>, <span class="ruby-identifier">:duration</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span><span class="ruby-value">.5</span>, <span class="ruby-identifier">:startcolor</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;#ff9999&quot;</span>)
1785:       <span class="ruby-keyword kw">end</span>
1786:       <span class="ruby-keyword kw">return</span>
1787:     <span class="ruby-keyword kw">end</span>
1788: 
1789:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">completed_at</span>
1790:       <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">completed_at</span> = <span class="ruby-keyword kw">nil</span>
1791:     <span class="ruby-keyword kw">else</span>
1792:       <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">completed_by_user</span> = <span class="ruby-identifier">current_user</span>
1793:       <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">completed_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>
1794:     <span class="ruby-keyword kw">end</span>
1795:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">save</span>
1796:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1797:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">completed_at</span>
1798:           <span class="ruby-identifier">page</span>.<span class="ruby-identifier">remove</span> <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">dom_id</span>
1799:           <span class="ruby-identifier">page</span>.<span class="ruby-identifier">insert_html</span> <span class="ruby-identifier">:top</span>, <span class="ruby-node">&quot;todo-done-#{@task.dom_id}&quot;</span>, <span class="ruby-identifier">:partial</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;tasks/todo_row&quot;</span>
1800:           <span class="ruby-identifier">page</span>.<span class="ruby-identifier">replace_html</span> <span class="ruby-node">&quot;todo-status-#{@task.dom_id}&quot;</span>, <span class="ruby-identifier">link_to_function</span>( <span class="ruby-node">&quot;#{@task.todo_status}&quot;</span>, <span class="ruby-node">&quot;Element.toggle('todo-container-#{@task.dom_id}');&quot;</span>, <span class="ruby-identifier">:class</span> =<span class="ruby-operator">&gt;</span> (<span class="ruby-ivar">@task</span>.<span class="ruby-identifier">todos</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-value">? </span><span class="ruby-value str">&quot;todo-status-link-empty&quot;</span> <span class="ruby-operator">:</span><span class="ruby-value str">&quot;todo-status-link&quot;</span>))
1801:         <span class="ruby-keyword kw">else</span>
1802:           <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">move_to_bottom</span>
1803:           <span class="ruby-identifier">page</span>.<span class="ruby-identifier">remove</span> <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">dom_id</span>
1804:           <span class="ruby-identifier">page</span>.<span class="ruby-identifier">insert_html</span> <span class="ruby-identifier">:bottom</span>, <span class="ruby-node">&quot;todo-#{@task.dom_id}&quot;</span>, <span class="ruby-identifier">:partial</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;tasks/todo_row&quot;</span>
1805:           <span class="ruby-identifier">page</span>.<span class="ruby-identifier">replace_html</span> <span class="ruby-node">&quot;todo-status-#{@task.dom_id}&quot;</span>, <span class="ruby-identifier">link_to_function</span>( <span class="ruby-node">&quot;#{@task.todo_status}&quot;</span>, <span class="ruby-node">&quot;Element.toggle('todo-container-#{@task.dom_id}');&quot;</span>, <span class="ruby-identifier">:class</span> =<span class="ruby-operator">&gt;</span> (<span class="ruby-ivar">@task</span>.<span class="ruby-identifier">todos</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-value">? </span><span class="ruby-value str">&quot;todo-status-link-empty&quot;</span> <span class="ruby-operator">:</span><span class="ruby-value str">&quot;todo-status-link&quot;</span>))
1806:         <span class="ruby-keyword kw">end</span>
1807:         <span class="ruby-identifier">page</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;Sortable.create('todo-#{@task.dom_id}', {containment:'todo-#{@task.dom_id}', format:/^[^-]*-(.*)$/, onUpdate:function(){new Ajax.Request('/tasks/order_todos/#{@task.id}', {asynchronous:true, evalScripts:true, parameters:Sortable.serialize('todo-#{@task.dom_id}')})}, only:'todo-active'})&quot;</span>
1808:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">call</span>(<span class="ruby-value str">&quot;updateTooltips&quot;</span>)
1809:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-node">&quot;#{@todo.dom_id}&quot;</span>, <span class="ruby-identifier">:duration</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">1.5</span>)
1810:       <span class="ruby-keyword kw">end</span>
1811:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; @task.id)}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
1812:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'activities', :action =&gt; 'refresh')}');&quot;</span>, [<span class="ruby-node">&quot;activity_#{current_user.company_id}&quot;</span>])
1813:     <span class="ruby-keyword kw">else</span>
1814:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1815:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-node">&quot;#{@todo.dom_id}&quot;</span>, <span class="ruby-identifier">:duration</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span><span class="ruby-value">.5</span>, <span class="ruby-identifier">:startcolor</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;#ff9999&quot;</span>)
1816:       <span class="ruby-keyword kw">end</span>
1817:     <span class="ruby-keyword kw">end</span>
1818: 
1819:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000191"><br/></a>
<div class="method_block"><h3>
<a href='#M000191'>


todo_delete_ajax

()

</a>
</h3>

<p class="source_link" id="M000191-show-link"><a onclick="toggle('M000191-source'); toggleText('M000191-link'); return false;" href="#" id="M000191-link">Show source...</a></p><div class="source" id="M000191-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1833</span>
1833:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">todo_delete_ajax</span>
1834:     <span class="ruby-keyword kw">begin</span>
1835:       <span class="ruby-ivar">@todo</span> = <span class="ruby-constant">Todo</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>])
1836:     <span class="ruby-keyword kw">rescue</span>
1837:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1838:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-node">&quot;todos-#{params[:id]}&quot;</span>, <span class="ruby-identifier">:duration</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span><span class="ruby-value">.5</span>, <span class="ruby-identifier">:startcolor</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;#ff9999&quot;</span>)
1839:       <span class="ruby-keyword kw">end</span>
1840:       <span class="ruby-keyword kw">return</span>
1841:     <span class="ruby-keyword kw">end</span>
1842:     <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;id = ? AND project_id IN (#{current_project_ids})&quot;</span>, <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">task_id</span>])
1843: 
1844:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>
1845:       <span class="ruby-identifier">element</span> = <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">dom_id</span>
1846:       <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">destroy</span>
1847:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1848:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span> <span class="ruby-identifier">:fade</span>, <span class="ruby-identifier">element</span>
1849:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">replace_html</span> <span class="ruby-node">&quot;todo-status-#{@task.dom_id}&quot;</span>, <span class="ruby-identifier">link_to_function</span>( <span class="ruby-node">&quot;#{@task.todo_status}&quot;</span>, <span class="ruby-node">&quot;Element.toggle('todo-container-#{@task.dom_id}');&quot;</span>, <span class="ruby-identifier">:class</span> =<span class="ruby-operator">&gt;</span> (<span class="ruby-ivar">@task</span>.<span class="ruby-identifier">todos</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-value">? </span><span class="ruby-value str">&quot;todo-status-link-empty&quot;</span> <span class="ruby-operator">:</span><span class="ruby-value str">&quot;todo-status-link&quot;</span>))
1850:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">delay</span>(<span class="ruby-value">1.0</span>) <span class="ruby-keyword kw">do</span>
1851:           <span class="ruby-identifier">page</span>.<span class="ruby-identifier">remove</span> <span class="ruby-identifier">element</span>
1852:         <span class="ruby-keyword kw">end</span>
1853:       <span class="ruby-keyword kw">end</span>
1854:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; @task.id)}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
1855:     <span class="ruby-keyword kw">else</span>
1856:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1857:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-node">&quot;todos-#{params[:id]}&quot;</span>, <span class="ruby-identifier">:duration</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span><span class="ruby-value">.5</span>, <span class="ruby-identifier">:startcolor</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;#ff9999&quot;</span>)
1858:       <span class="ruby-keyword kw">end</span>
1859:     <span class="ruby-keyword kw">end</span>
1860:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000182"><br/></a>
<div class="method_block"><h3>
<a href='#M000182'>


toggle_history

()

</a>
</h3>

<p class="source_link" id="M000182-show-link"><a onclick="toggle('M000182-source'); toggleText('M000182-link'); return false;" href="#" id="M000182-link">Show source...</a></p><div class="source" id="M000182-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1574</span>
1574:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">toggle_history</span>
1575:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:only_comments</span>] <span class="ruby-operator">||=</span> <span class="ruby-value">0</span>
1576:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:only_comments</span>] = <span class="ruby-value">1</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:only_comments</span>]
1577: 
1578:     <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;project_id IN (#{current_project_ids})&quot;</span>])
1579:     <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@logs</span> = <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;work_logs.started_at desc,work_logs.id desc&quot;</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;work_logs.task_id = ? #{&quot;AND (work_logs.comment = 1 OR work_logs.log_type=6)&quot; if session[:only_comments].to_i == 1}&quot;</span>, <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">id</span>], <span class="ruby-identifier">:include</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:user</span>, <span class="ruby-identifier">:task</span>, <span class="ruby-identifier">:project</span>])
1580:       <span class="ruby-ivar">@logs</span> = []
1581:     <span class="ruby-keyword kw">end</span>
1582: 
1583:     <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1584:       <span class="ruby-identifier">page</span>.<span class="ruby-identifier">replace_html</span> <span class="ruby-value str">'task_history'</span>, <span class="ruby-identifier">:partial</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'history'</span>
1585:       <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-value str">&quot;task_history&quot;</span>, <span class="ruby-identifier">:duration</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">2.0</span>)
1586:     <span class="ruby-keyword kw">end</span>
1587:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000156"><br/></a>
<div class="method_block"><h3>
<a href='#M000156'>


update

()

</a>
</h3>

<p class="source_link" id="M000156-show-link"><a onclick="toggle('M000156-source'); toggleText('M000156-link'); return false;" href="#" id="M000156-link">Show source...</a></p><div class="source" id="M000156-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 553</span>
553:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">update</span>
554:     <span class="ruby-identifier">projects</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span><span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span>}
555: 
556:     <span class="ruby-identifier">update_type</span> = <span class="ruby-identifier">:updated</span>
557: 
558:     <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;project_id IN (?)&quot;</span>, <span class="ruby-identifier">projects</span>], <span class="ruby-identifier">:include</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:tags</span>])
559:     <span class="ruby-identifier">old_tags</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">tags</span>.<span class="ruby-identifier">collect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">name</span>}.<span class="ruby-identifier">sort</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">', '</span>)
560:     <span class="ruby-identifier">old_deps</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">dependencies</span>.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-node">&quot;[#{t.issue_num}] #{t.name}&quot;</span> }.<span class="ruby-identifier">sort</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">', '</span>)
561:     <span class="ruby-identifier">old_users</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">users</span>.<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">u</span><span class="ruby-operator">|</span> <span class="ruby-identifier">u</span>.<span class="ruby-identifier">id</span>}.<span class="ruby-identifier">sort</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">','</span>)
562:     <span class="ruby-identifier">old_users</span> <span class="ruby-operator">||=</span> <span class="ruby-value str">&quot;0&quot;</span>
563:     <span class="ruby-identifier">old_project_id</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project_id</span>
564:     <span class="ruby-identifier">old_project_name</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">name</span>
565:     <span class="ruby-ivar">@old_task</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">clone</span>
566: 
567:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:status</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">6</span>
568:       <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:status</span>] = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status</span>  <span class="ruby-comment cmt"># We're hiding the task, set the status to what is was.</span>
569:     <span class="ruby-keyword kw">else</span>
570:       <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:hide_until</span>] = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">hide_until</span>
571:     <span class="ruby-keyword kw">end</span>
572: 
573:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">update_attributes</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>])
574: 
575:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">hide_until</span> = <span class="ruby-keyword kw">nil</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:hide_until</span>].<span class="ruby-identifier">nil?</span>
576: 
577:       <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:due_at</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:due_at</span>].<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
578: 
579:         <span class="ruby-identifier">repeat</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">parse_repeat</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:due_at</span>])
580:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">repeat</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">repeat</span> <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;&quot;</span>
581:           <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">repeat</span> = <span class="ruby-identifier">repeat</span>
582:           <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">due_at</span> = <span class="ruby-identifier">tz</span>.<span class="ruby-identifier">local_to_utc</span>(<span class="ruby-ivar">@task</span>.<span class="ruby-identifier">next_repeat_date</span>)
583:         <span class="ruby-keyword kw">else</span>
584:           <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">repeat</span> = <span class="ruby-keyword kw">nil</span>
585:           <span class="ruby-identifier">due_date</span> = <span class="ruby-constant">DateTime</span>.<span class="ruby-identifier">strptime</span>( <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:due_at</span>], <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">date_format</span> ) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">begin</span>
586:                                                                                                       <span class="ruby-identifier">flash</span>[<span class="ruby-value str">'notice'</span>] = <span class="ruby-identifier">_</span>(<span class="ruby-value str">'Invalid due date ignored.'</span>)
587:                                                                                                       <span class="ruby-identifier">due_date</span> = <span class="ruby-keyword kw">nil</span>
588:                                                                                                     <span class="ruby-keyword kw">end</span>
589:           <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">due_at</span> = <span class="ruby-identifier">tz</span>.<span class="ruby-identifier">local_to_utc</span>(<span class="ruby-identifier">due_date</span>.<span class="ruby-identifier">to_time</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>.<span class="ruby-identifier">day</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>.<span class="ruby-identifier">minute</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">due_date</span>.<span class="ruby-identifier">nil?</span>
590:         <span class="ruby-keyword kw">end</span>
591:       <span class="ruby-keyword kw">else</span>
592:         <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">repeat</span> = <span class="ruby-keyword kw">nil</span>
593:       <span class="ruby-keyword kw">end</span>
594: 
595:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">notifications</span>.<span class="ruby-identifier">destroy_all</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">notifications</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
596:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">notify_emails</span> = <span class="ruby-keyword kw">nil</span>
597:       <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:watchers</span>].<span class="ruby-identifier">nil?</span>
598:         <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:watchers</span>].<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">elem</span><span class="ruby-operator">|</span>
599:           <span class="ruby-identifier">elem</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">','</span>).<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">w</span><span class="ruby-operator">|</span>
600:             <span class="ruby-identifier">u</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by_name</span>(<span class="ruby-identifier">w</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;company_id = ?&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>])
601:             <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">u</span>.<span class="ruby-identifier">nil?</span>
602:               <span class="ruby-comment cmt"># Found user</span>
603:               <span class="ruby-identifier">n</span> = <span class="ruby-constant">Notification</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">:user</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">u</span>, <span class="ruby-identifier">:task</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@task</span>)
604:               <span class="ruby-identifier">n</span>.<span class="ruby-identifier">save</span>
605:             <span class="ruby-keyword kw">else</span>
606:               <span class="ruby-comment cmt"># Not a user, check for email address</span>
607:               <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">w</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-value str">'@'</span>)
608:                 <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">notify_emails</span> <span class="ruby-operator">||=</span> <span class="ruby-value str">&quot;&quot;</span>
609:                 <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">notify_emails</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;,&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">notify_emails</span>.<span class="ruby-identifier">empty?</span>
610:                 <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">notify_emails</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">w</span>
611:               <span class="ruby-keyword kw">end</span>
612:             <span class="ruby-keyword kw">end</span>
613:           <span class="ruby-keyword kw">end</span>
614:         <span class="ruby-keyword kw">end</span>
615:       <span class="ruby-keyword kw">end</span>
616: 
617:       <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:users</span>].<span class="ruby-identifier">nil?</span>
618:         <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">task_owners</span>.<span class="ruby-identifier">destroy_all</span>
619:         <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:users</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">o</span><span class="ruby-operator">|</span>
620:           <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
621:           <span class="ruby-identifier">u</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">o</span>.<span class="ruby-identifier">to_i</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;company_id = ?&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>])
622:           <span class="ruby-identifier">to</span> = <span class="ruby-constant">TaskOwner</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">:user</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">u</span>, <span class="ruby-identifier">:task</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@task</span>)
623:           <span class="ruby-identifier">to</span>.<span class="ruby-identifier">save</span>
624:         <span class="ruby-keyword kw">end</span>
625:       <span class="ruby-keyword kw">end</span>
626: 
627:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:dependencies</span>]
628:         
629:         <span class="ruby-identifier">new_dependencies</span> = []
630:         <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:dependencies</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">d</span><span class="ruby-operator">|</span>
631:           <span class="ruby-identifier">deps</span> = <span class="ruby-identifier">d</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">','</span>)
632:           <span class="ruby-identifier">deps</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">dep</span><span class="ruby-operator">|</span>
633:             <span class="ruby-identifier">dep</span>.<span class="ruby-identifier">strip!</span>
634:             <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> [<span class="ruby-value">0</span>, <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">id</span>].<span class="ruby-identifier">include?</span> <span class="ruby-identifier">dep</span>.<span class="ruby-identifier">to_i</span>
635:             <span class="ruby-identifier">new_dependencies</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">dep</span>.<span class="ruby-identifier">to_i</span>]
636:           <span class="ruby-keyword kw">end</span>
637:         <span class="ruby-keyword kw">end</span>
638:         
639:         <span class="ruby-identifier">new_dependenices</span> = []
640:         <span class="ruby-identifier">new_dependencies</span>.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">dep</span><span class="ruby-operator">|</span>
641:           <span class="ruby-identifier">t</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;company_id = ? AND task_num = ?&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>, <span class="ruby-identifier">dep</span>])
642:           <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">nil?</span>
643:             <span class="ruby-identifier">new_dependencies</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">t</span>
644:           <span class="ruby-keyword kw">end</span>
645:         <span class="ruby-keyword kw">end</span>
646:         
647:         <span class="ruby-identifier">removed</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">dependencies</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">new_dependencies</span>
648:         <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">dependencies</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">removed</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">removed</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
649: 
650:         <span class="ruby-identifier">added</span> = (<span class="ruby-identifier">new_dependencies</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">dependencies</span>)
651:         <span class="ruby-identifier">added</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span>
652:           <span class="ruby-identifier">t</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;project_id IN (#{current_project_ids}) AND id = ?&quot;</span>, <span class="ruby-identifier">a</span>])
653:           <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">nil?</span>
654:             <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">dependencies</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">t</span>
655:           <span class="ruby-keyword kw">end</span>
656:         <span class="ruby-keyword kw">end</span>
657:         
658:       <span class="ruby-keyword kw">end</span>
659: 
660:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-identifier">parse_time</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:duration</span>], <span class="ruby-keyword kw">true</span>) <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:duration</span>])
661:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">updated_by_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
662: 
663:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">completed_at</span>.<span class="ruby-identifier">nil?</span>
664:         <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">completed_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>
665: 
666:         <span class="ruby-comment cmt"># Repeat this task every X...</span>
667:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">next_repeat_date</span> <span class="ruby-operator">!=</span> <span class="ruby-keyword kw">nil</span>
668: 
669:           <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">save</span>
670:           <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">reload</span>
671: 
672:           <span class="ruby-identifier">repeat_task</span>(<span class="ruby-ivar">@task</span>)
673:         <span class="ruby-keyword kw">end</span>
674:       <span class="ruby-keyword kw">end</span>
675: 
676:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">2</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@task</span>.<span class="ruby-identifier">completed_at</span>.<span class="ruby-identifier">nil?</span>
677:         <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">completed_at</span> = <span class="ruby-keyword kw">nil</span>
678:       <span class="ruby-keyword kw">end</span>
679: 
680:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">scheduled_duration</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">duration</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">scheduled?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">duration</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">duration</span>
681:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">scheduled_at</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">due_at</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">scheduled?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">due_at</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">due_at</span>
682: 
683:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">save</span>
684: 
685:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">reload</span>
686: 
687:       <span class="ruby-identifier">body</span> = <span class="ruby-value str">&quot;&quot;</span>
688:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@old_task</span>[<span class="ruby-identifier">:name</span>] <span class="ruby-operator">!=</span> <span class="ruby-ivar">@task</span>[<span class="ruby-identifier">:name</span>]
689:         <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Name&lt;/strong&gt;: #{@old_task[:name]} -&gt; #{@task[:name]}\n&quot;</span>
690:       <span class="ruby-keyword kw">end</span>
691: 
692:       <span class="ruby-keyword kw">if</span>(<span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">description</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">description</span>)
693:         <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;- &lt;strong&gt;Description&lt;/strong&gt; changed\n&quot;</span>
694:       <span class="ruby-keyword kw">end</span>
695: 
696:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:users</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">old_users</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:users</span>].<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">u</span><span class="ruby-operator">|</span> <span class="ruby-identifier">u</span>.<span class="ruby-identifier">to_i</span>}.<span class="ruby-identifier">sort</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">','</span>)
697:         <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">users</span>.<span class="ruby-identifier">reload</span>
698:         <span class="ruby-identifier">new_name</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">users</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-value">? </span><span class="ruby-value str">'Unassigned'</span> <span class="ruby-operator">:</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">users</span>.<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">u</span><span class="ruby-operator">|</span> <span class="ruby-identifier">u</span>.<span class="ruby-identifier">name</span>}.<span class="ruby-identifier">join</span>(<span class="ruby-value str">', '</span>)
699:         <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Assignment&lt;/strong&gt;: #{new_name}\n&quot;</span>
700:         <span class="ruby-identifier">update_type</span> = <span class="ruby-identifier">:reassigned</span>
701:       <span class="ruby-keyword kw">end</span>
702: 
703:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">old_project_id</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project_id</span>
704:         <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Project&lt;/strong&gt;: #{old_project_name} -&gt; #{@task.project.name}\n&quot;</span>
705:         <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">update_all</span>(<span class="ruby-node">&quot;customer_id = #{@task.project.customer_id}, project_id = #{@task.project_id}&quot;</span>, <span class="ruby-node">&quot;task_id = #{@task.id}&quot;</span>)
706:         <span class="ruby-constant">ProjectFile</span>.<span class="ruby-identifier">update_all</span>(<span class="ruby-node">&quot;customer_id = #{@task.project.customer_id}, project_id = #{@task.project_id}&quot;</span>, <span class="ruby-node">&quot;task_id = #{@task.id}&quot;</span>)
707:       <span class="ruby-keyword kw">end</span>
708: 
709:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">duration</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">duration</span>
710:         <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Estimate&lt;/strong&gt;: #{worked_nice(@old_task.duration).strip} -&gt; #{worked_nice(@task.duration)}\n&quot;</span>
711:       <span class="ruby-keyword kw">end</span>
712: 
713:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">milestone</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone</span>
714:         <span class="ruby-identifier">old_name</span> = <span class="ruby-value str">&quot;None&quot;</span>
715:         <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">nil?</span>
716:            <span class="ruby-identifier">old_name</span> = <span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">name</span>
717:            <span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">update_counts</span>
718:         <span class="ruby-keyword kw">end</span>
719: 
720:         <span class="ruby-identifier">new_name</span> = <span class="ruby-value str">&quot;None&quot;</span>
721:         <span class="ruby-identifier">new_name</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">name</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">nil?</span>
722: 
723:         <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Milestone&lt;/strong&gt;: #{old_name} -&gt; #{new_name}\n&quot;</span>
724:       <span class="ruby-keyword kw">end</span>
725: 
726:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">due_at</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">due_at</span>
727:         <span class="ruby-identifier">old_name</span> = <span class="ruby-value str">&quot;None&quot;</span>
728:         <span class="ruby-identifier">old_name</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">tz</span>.<span class="ruby-identifier">utc_to_local</span>(<span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">due_at</span>).<span class="ruby-identifier">strftime_localized</span>(<span class="ruby-value str">&quot;%A, %d %B %Y&quot;</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">due_at</span>.<span class="ruby-identifier">nil?</span>
729: 
730:         <span class="ruby-identifier">new_name</span> = <span class="ruby-value str">&quot;None&quot;</span>
731:         <span class="ruby-identifier">new_name</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">tz</span>.<span class="ruby-identifier">utc_to_local</span>(<span class="ruby-ivar">@task</span>.<span class="ruby-identifier">due_at</span>).<span class="ruby-identifier">strftime_localized</span>(<span class="ruby-value str">&quot;%A, %d %B %Y&quot;</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">due_at</span>.<span class="ruby-identifier">nil?</span>
732: 
733:         <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Due&lt;/strong&gt;: #{old_name} -&gt; #{new_name}\n&quot;</span>
734:       <span class="ruby-keyword kw">end</span>
735: 
736:       <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Priority&lt;/strong&gt;: #{@old_task.priority_type} -&gt; #{@task.priority_type}\n&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">priority</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">priority</span>
737:       <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Severity&lt;/strong&gt;: #{@old_task.severity_type} -&gt; #{@task.severity_type}\n&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">severity_id</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">severity_id</span>
738:       <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Type&lt;/strong&gt;: #{@old_task.issue_type} -&gt; #{@task.issue_type}\n&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">type_id</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">type_id</span>
739: 
740:       <span class="ruby-identifier">new_tags</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">tags</span>.<span class="ruby-identifier">collect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">name</span>}.<span class="ruby-identifier">sort</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">', '</span>)
741:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">old_tags</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">new_tags</span>
742:         <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Tags&lt;/strong&gt;: #{new_tags}\n&quot;</span>
743:       <span class="ruby-keyword kw">end</span>
744: 
745:       <span class="ruby-identifier">new_deps</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">dependencies</span>.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-node">&quot;[#{t.issue_num}] #{t.name}&quot;</span>}.<span class="ruby-identifier">sort</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">&quot;, &quot;</span>)
746:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">old_deps</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">new_deps</span>
747:         <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Dependencies&lt;/strong&gt;: #{(new_deps.length &gt; 0) ? new_deps : _(&quot;None&quot;)}&quot;</span>
748:       <span class="ruby-keyword kw">end</span>
749: 
750:       <span class="ruby-identifier">worklog</span> = <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">new</span>
751:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_MODIFIED</span>
752: 
753: 
754:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status</span>
755:         <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Status&lt;/strong&gt;: #{@old_task.status_type} -&gt; #{@task.status_type}\n&quot;</span>
756: 
757:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_COMPLETED</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>
758:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_REVERTED</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> <span class="ruby-operator">||</span> (<span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">2</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>))
759: 
760:         <span class="ruby-keyword kw">if</span>( <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status</span> )
761:           <span class="ruby-identifier">update_type</span> = <span class="ruby-identifier">:status</span>
762:         <span class="ruby-keyword kw">end</span>
763: 
764:         <span class="ruby-keyword kw">if</span>( <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">completed_at</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">completed_at</span>.<span class="ruby-identifier">nil?</span>)
765:           <span class="ruby-identifier">update_type</span> = <span class="ruby-identifier">:completed</span>
766:         <span class="ruby-keyword kw">end</span>
767: 
768:         <span class="ruby-keyword kw">if</span>( <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">2</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span> )
769:           <span class="ruby-identifier">update_type</span> = <span class="ruby-identifier">:reverted</span>
770:         <span class="ruby-keyword kw">end</span>
771: 
772:       <span class="ruby-keyword kw">end</span>
773: 
774: 
775:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value str">'task_file'</span>].<span class="ruby-identifier">respond_to?</span>(<span class="ruby-identifier">:original_filename</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value str">'task_file'</span>].<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
776: 
777:         <span class="ruby-identifier">filename</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task_file</span>].<span class="ruby-identifier">original_filename</span>
778:         <span class="ruby-identifier">filename</span> = <span class="ruby-identifier">filename</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">&quot;/&quot;</span>).<span class="ruby-identifier">last</span>
779:         <span class="ruby-identifier">filename</span> = <span class="ruby-identifier">filename</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">&quot;\\&quot;</span>).<span class="ruby-identifier">last</span>
780:         <span class="ruby-identifier">filename</span> = <span class="ruby-identifier">filename</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/[^a-zA-Z0-9.]/</span>, <span class="ruby-value str">'_'</span>)
781: 
782: 
783:         <span class="ruby-identifier">task_file</span> = <span class="ruby-constant">ProjectFile</span>.<span class="ruby-identifier">new</span>()
784:         <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">company</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company</span>
785:         <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">customer</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">customer</span>
786:         <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">project</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>
787:         <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">task_id</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">id</span>
788:         <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">user_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
789:         <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">filename</span> = <span class="ruby-identifier">filename</span>
790:         <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">name</span> = <span class="ruby-identifier">filename</span>
791:         <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">file_size</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value str">'task_file'</span>].<span class="ruby-identifier">size</span>
792:         <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">save</span>
793: 
794:         <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">reload</span>
795: 
796:         <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-constant">File</span>.<span class="ruby-identifier">directory?</span>(<span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">path</span>)
797:           <span class="ruby-constant">File</span>.<span class="ruby-identifier">umask</span>(<span class="ruby-value">0</span>)
798:           <span class="ruby-constant">Dir</span>.<span class="ruby-identifier">mkdir</span>(<span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">path</span>, <span class="ruby-value">0777</span>) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
799:         <span class="ruby-keyword kw">end</span>
800: 
801:         <span class="ruby-constant">File</span>.<span class="ruby-identifier">umask</span>(<span class="ruby-value">0</span>)
802:         <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">file_path</span>, <span class="ruby-value str">&quot;wb&quot;</span>, <span class="ruby-value">0777</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">write</span>( <span class="ruby-identifier">params</span>[<span class="ruby-value str">'task_file'</span>].<span class="ruby-identifier">read</span> ) } <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">begin</span>
803:                                                                                                         <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">destroy</span>
804:                                                                                                         <span class="ruby-identifier">flash</span>[<span class="ruby-value str">'notice'</span>] = <span class="ruby-identifier">_</span>(<span class="ruby-value str">&quot;Permission denied while saving file.&quot;</span>)
805:                                                                                                         <span class="ruby-identifier">filename</span> = <span class="ruby-keyword kw">nil</span>
806:                                                                                                       <span class="ruby-keyword kw">end</span>
807:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">filename</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">filename</span>[<span class="ruby-regexp re">/\.gif|\.png|\.jpg|\.jpeg|\.tif|\.bmp|\.psd/i</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">file_size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
808:            <span class="ruby-identifier">image</span> = <span class="ruby-constant">Magick</span><span class="ruby-operator">::</span><span class="ruby-constant">Image</span>.<span class="ruby-identifier">read</span>( <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">file_path</span> ).<span class="ruby-identifier">first</span>
809: 
810:            <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">image</span>.<span class="ruby-identifier">columns</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
811:               <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">file_type</span> = <span class="ruby-constant">ProjectFile</span><span class="ruby-operator">::</span><span class="ruby-constant">FILETYPE_IMG</span>
812:               <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">mime_type</span> = <span class="ruby-identifier">image</span>.<span class="ruby-identifier">mime_type</span>
813:               <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">save</span>
814:            <span class="ruby-keyword kw">end</span>
815:            <span class="ruby-identifier">image</span> = <span class="ruby-keyword kw">nil</span>
816:            <span class="ruby-constant">GC</span>.<span class="ruby-identifier">start</span>
817:         <span class="ruby-keyword kw">end</span>
818: 
819:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">filename</span>
820:           <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Attached&lt;/strong&gt;: #{filename}\n&quot;</span>
821:         <span class="ruby-keyword kw">end</span>
822:       <span class="ruby-keyword kw">end</span>
823: 
824:       <span class="ruby-identifier">email_body</span> = <span class="ruby-identifier">body</span>
825: 
826:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:comment</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:comment</span>].<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
827:         <span class="ruby-identifier">update_type</span> = <span class="ruby-identifier">:comment</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">body</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
828:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_COMMENT</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">body</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
829:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">comment</span> = <span class="ruby-keyword kw">true</span>
830:         
831:         <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;\n&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">body</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
832:         <span class="ruby-identifier">email_body</span> = <span class="ruby-identifier">body</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;:\n&quot;</span>
833: 
834:         <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">CGI</span><span class="ruby-operator">::</span><span class="ruby-identifier">escapeHTML</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:comment</span>])
835:         <span class="ruby-identifier">email_body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:comment</span>]
836:       <span class="ruby-keyword kw">end</span>
837: 
838:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">body</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
839:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">user</span> = <span class="ruby-identifier">current_user</span>
840:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">company</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">company</span>
841:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">customer</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">customer</span>
842:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">project</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>
843:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">task</span> = <span class="ruby-ivar">@task</span>
844:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">started_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>
845:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-value">0</span>
846:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">body</span> = <span class="ruby-identifier">body</span>
847:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">save</span>
848: 
849:         <span class="ruby-keyword kw">if</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value str">'notify'</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>)
850:           <span class="ruby-constant">Notifications</span><span class="ruby-operator">::</span><span class="ruby-identifier">deliver_changed</span>( <span class="ruby-identifier">update_type</span>, <span class="ruby-ivar">@task</span>, <span class="ruby-identifier">current_user</span>, <span class="ruby-identifier">email_body</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/&lt;[^&gt;]*&gt;/</span>,<span class="ruby-value str">''</span>)) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
851:         <span class="ruby-keyword kw">end</span>
852:       <span class="ruby-keyword kw">end</span>
853: 
854:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; @task.id)}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
855:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'activities', :action =&gt; 'refresh')}');&quot;</span>, [<span class="ruby-node">&quot;activity_#{current_user.company_id}&quot;</span>])
856: 
857:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">xhr?</span>
858: 
859:       <span class="ruby-identifier">flash</span>[<span class="ruby-value str">'notice'</span>] <span class="ruby-operator">||=</span> <span class="ruby-node">&quot;#{link_to_task(@task)} - #{_('Task was successfully updated.')}&quot;</span>
860:       <span class="ruby-identifier">redirect_from_last</span>
861:     <span class="ruby-keyword kw">else</span>
862:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'edit'</span>
863:     <span class="ruby-keyword kw">end</span>
864:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000157"><br/></a>
<div class="method_block"><h3>
<a href='#M000157'>


update_ajax

()

</a>
</h3>

<p class="source_link" id="M000157-show-link"><a onclick="toggle('M000157-source'); toggleText('M000157-link'); return false;" href="#" id="M000157-link">Show source...</a></p><div class="source" id="M000157-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 866</span>
866:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">update_ajax</span>
867:     <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">update</span>
868:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000171"><br/></a>
<div class="method_block"><h3>
<a href='#M000171'>


update_sheet_info

()

</a>
</h3>

<p class="source_link" id="M000171-show-link"><a onclick="toggle('M000171-source'); toggleText('M000171-link'); return false;" href="#" id="M000171-link">Show source...</a></p><div class="source" id="M000171-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1187</span>
1187:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">update_sheet_info</span>
1188:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000172"><br/></a>
<div class="method_block"><h3>
<a href='#M000172'>


update_tasks

()

</a>
</h3>

<p class="source_link" id="M000172-show-link"><a onclick="toggle('M000172-source'); toggleText('M000172-link'); return false;" href="#" id="M000172-link">Show source...</a></p><div class="source" id="M000172-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1190</span>
1190:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">update_tasks</span>
1191:     <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>( <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;company_id = ?&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>] )
1192:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000170"><br/></a>
<div class="method_block"><h3>
<a href='#M000170'>


updatelog

()

</a>
</h3>

<p class="source_link" id="M000170-show-link"><a onclick="toggle('M000170-source'); toggleText('M000170-link'); return false;" href="#" id="M000170-link">Show source...</a></p><div class="source" id="M000170-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1172</span>
1172:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">updatelog</span>
1173:     <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@current_sheet</span>
1174:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;#{_(&quot;Task not worked on&quot;)} #{current_user.tz.utc_to_local(Time.now.utc).strftime_localized(&quot;%H:%M:%S&quot;)}&quot;</span>
1175:       <span class="ruby-keyword kw">return</span>
1176:     <span class="ruby-keyword kw">end</span> 
1177:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:worklog</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:worklog</span>][<span class="ruby-identifier">:body</span>] 
1178:       <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">body</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:worklog</span>][<span class="ruby-identifier">:body</span>] 
1179:       <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">save</span>
1180:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;#{_(&quot;Saved&quot;)} #{current_user.tz.utc_to_local(Time.now.utc).strftime_localized(&quot;%H:%M:%S&quot;)}&quot;</span>
1181:     <span class="ruby-keyword kw">else</span> 
1182:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;#{_(&quot;Error saving&quot;)} #{current_user.tz.utc_to_local(Time.now.utc).strftime_localized(&quot;%H:%M:%S&quot;)}&quot;</span>
1183:     <span class="ruby-keyword kw">end</span> 
1184:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000153"><br/></a>
<div class="method_block"><h3>
<a href='#M000153'>


view

()

</a>
</h3>

<p class="source_link" id="M000153-show-link"><a onclick="toggle('M000153-source'); toggleText('M000153-link'); return false;" href="#" id="M000153-link">Show source...</a></p><div class="source" id="M000153-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 475</span>
475:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">view</span>
476:     <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;project_id IN (#{current_project_ids}) AND task_num = ?&quot;</span>, <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>]])
477:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>
478:       <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'edit'</span>, <span class="ruby-identifier">:id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">id</span>
479:     <span class="ruby-keyword kw">else</span>
480:       <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">:controller</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'views'</span>, <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'browse'</span>
481:     <span class="ruby-keyword kw">end</span>
482:   <span class="ruby-keyword kw">end</span></pre></div>
</div>





</div><div class="clear" id="footer">Generated on Jan 21, 2008 / Allison 2 &copy; 2007 <a href="http://cloudbur.st">Cloudburst, LLC</a></div></div></body></html>