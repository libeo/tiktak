<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type"/><title>Class: TasksController</title><link type="text/css" href=".././rdoc-style.css" media="screen" rel="stylesheet"/><script type="text/javascript">
// Allison template
// Copyright 2007, 2008 Cloudburst, LLC. Licensed under the AFL 3. See the included LICENSE file.

var href_base = '.././rdoc-style.css'.replace(/(.*\/).*/, '$1'); // inline js is good for something  

function $(id) {
    if (document.getElementById)
      elem = document.getElementById(id);
    else if ( document.all )
      elem = eval("document.all." + id);
    else
      return false;
    return elem;
}

  function toggle(id) {
    elem = $(id);
    elemStyle = elem.style;   
    if (elemStyle.display == "block") {
      elemStyle.display = "none"
    } else {
      elemStyle.display = "block"
    }
    return true;
  }

  function toggleText(id) {
    elem = $(id)
    if (m = elem.innerHTML.match(/(Hide)(.*)/)) {
      elem.innerHTML = "Show" + m[2];
    } else if (m = elem.innerHTML.match(/(Show)(.*)/)) {
      elem.innerHTML = "Hide" + m[2];
    }
    return true;
  }

function span(s, klass) {
  return '<span class="' + klass + '">' + s + '</span>';
}
  
function highlightSymbols() {
  pres = document.getElementsByTagName('pre');
  for(var i = 0; i < pres.length; i++) {
    pre = pres[i];
    spans = pre.getElementsByTagName('span');
    for(var k = 0; k < spans.length; k++) {
      span = spans[k];
      if (span.className.match(/ruby-identifier/)) {
        if (span.innerHTML.match(/^:/)) {
          span.className += " ruby-symbol";
        }
      }
    }
  }
}

 function hasClass(obj) {
     var result = false;
     if (obj.getAttributeNode("class") != null) {
         result = obj.getAttributeNode("class").value;
     }
     return result;
  }   

 function stripe() {
    var even = true;
    var color = "#e4ebed";
    var tables = document.getElementsByTagName('table');
    if (tables.length == 0) { return; }
    for (var h = 0; h < tables.length; h++) {
        var trs = tables[h].getElementsByTagName("tr");
        for (var i = 0; i < trs.length; i++) {
          var tds = trs[i].getElementsByTagName("td");
            for (var j = 0; j < tds.length; j++) {       
              if (hasClass(tds[j]) != "first") {                
              var mytd = tds[j];
              if (even) {
                mytd.style.backgroundColor = color;
              }         
            }
          }
          even =  ! even;
      }
    }
  }
  
function ajaxGet(url) {
  url = (href_base + url).replace('/./', '/')
  var req = false;

  if (window.ActiveXObject) {
    try {
      // stupid hack because IE7 disables local Ajax with the native xmlhttprequest object
      // for security purposes. Yet ActiveX still works. Thanks, Microsoft. I hate you. Die.
      req = new ActiveXObject("MSXML2.XMLHTTP.3.0");
    } catch (e) {
      try {
        /* IE 6 and maybe 5, don't know, don't care */
        req = new ActiveXObject("Msxml2.XMLHTTP");
      } catch (e) {
        try {
          req = new ActiveXObject("Microsoft.XMLHTTP");
        } catch (e) {
          req = false;
        }
      }
    }
  }
    
  /* real browsers */
  if (!req && window.XMLHttpRequest) {
    try {
      req = new XMLHttpRequest();
    } catch (e) {
      req = false;
    }
  } 
  
  if (req) {
    req.open('GET', url, false);
    req.send(null);
    return req.responseText;
  } else {
    return "Ajax error";  
  }
}


function addEvent(elm, evType, fn, useCapture) {
	if (elm.addEventListener) {
	  elm.addEventListener(evType, fn, useCapture);  
  	return true;
	} else if (elm.attachEvent) {
  	var r = elm.attachEvent('on' + evType, fn);  
	  return r;  
	} else {
  	elm['on' + evType] = fn;
	}
}

function insertIndices() {
  pages = ["class", "file", "method"]
  for (x in pages) { 
    $(pages[x]).innerHTML += ajaxGet('fr_' + pages[x] + '_index.html').replace(/(href=")/g, '$1' + href_base);
  }
  /* mouseoverify method links */
  links = $('method').getElementsByTagName('a');
  for (var x = 0; x < links.length; x++) {
    if (m = links[x].innerHTML.match(/(.*)\s\((.*)\)/)) {
      links[x].innerHTML = m[1] + '<br>';
      links[x].title = m[2];
    }
  }
  /* this is stupid */
  $('class').style.display = "block";
  $('file').style.display = "block";
  
  /* has to be here because IE7 does not guarantee the onLoad callback order */
  abbreviateIndicesInner(["class", "file"], 25, "a");
  /* same, linkTitle() depends on the class link list */
  linkTitle();
}

function abbreviateIndices() {
  var ids = ["defined_in", "child_of", "includes", "requires", "method", "methods"];
  abbreviateIndicesInner(ids, 25, 'a');
  abbreviateIndicesInner(ids, 25, 'span');
}

function abbreviateIndicesInner(indices, amount, tag) {
  for (var x = 0; x < indices.length; x++) { 
    var the_index = $(indices[x]);
    if (the_index) {
      links = the_index.getElementsByTagName(tag);
      for (var y = 0; y < links.length; y++) {
        var link = links[y];
        if (link.getElementsByTagName('span').length == 0 && link.getElementsByTagName('a').length == 0) {
          // avoid nesting
          link.innerHTML = link.innerHTML.replace(/<br>|\n/gi, '');
          link.title = link.innerHTML;
          link.innerHTML = abbreviate(link.innerHTML, amount) + '<br>';
        }
      }
    }
  }
}

function linkTitle() {
  
  /* grab the correct title element from the index */
  var index_page = ajaxGet('index.html');
  title_text = index_page.match(/<title>(.*)<\/title>/m)[1];
  document.title = title_text + " - " + document.title;
  var p = $('header').getElementsByTagName('p')[0]
  if (p.innerHTML.match(/^\s*$/)) {
    p.innerHTML = title_text;
  } else {
    p.innerHTML = title_text + ": " + p.innerHTML;
  }
  
  /* set the link properly */
  title_link = index_page.match(/<a\s+href="(.*?)"/)[1];
  var element = $('title');
  var item_type = "";
  var item_name = "";
  if (m = element.innerHTML.match(/(Class:|Module:|File:)\s*(.*)/)) {
    item_type = m[1];
    item_name = m[2];
  } else {
    item_name = element.innerHTML;
  }
  element.innerHTML = '<a href="' + href_base + title_link + '">' + item_type + " " + abbreviate(item_name, 45) + '</a>';
  element.getElementsByTagName('a')[0].title = item_name
  
  /* breadcrumb navigation */
  items = item_name.split("::");
  items_new = item_name.split("::");
  file_links = $('class').getElementsByTagName('a');
  for (var x = 0; x < items.length - 1; x++ ){
    var item = items[x];
    link = ("/classes/" + items.slice(0,x).join("/") + "/" + item + ".html").replace('//', '/');
    regex = new RegExp(RegExp.escape(link) + '$');
    for (var y = 0; y < file_links.length; y++) {
      if (file_links[y].href.match(regex)) {
         items_new[x] = '<a href="' + href_base + link + '">' + item + '</a>';
         break;
      }
    }  
  }
  $('item_name').innerHTML = item_type + ' ' + items_new.join(" :: ");
}

function abbreviate(s, size) {
  while (s.length > size) {
    var old_s = s;
    s = s.replace(/\s|\n/mg, '');
    s = s.replace(/([A-Z])[a-z]+/m, '$1');
    if (!s || old_s == s) {
      return "..." + s.substring(s.length - size, s.length);
    }
  }
  return s;
}

function disableSubmit(event) {
  var keyCode = event.keyCode ? event.keyCode : event.which ? event.which : event.charCode;
  if (keyCode == 13) {
    return false;
  } else {
    return true;
  }
}
  
function filterList(id, s, event) {
  
  /* some weak escaping */
  s = s.replace(/[^\w\d\.\_\-\/\:\=\[\]\?\!]/g, '');
  s = RegExp.escape(s);
  
  var show_all = false;
  if (s.match(/^\s*$/)) {
    show_all = true;
  }
  
  links = $(id).getElementsByTagName('a')
  regex = new RegExp(s, 'i');
  
  for (var x = 0; x < links.length; x++) {
    var link = links[x];
    if (show_all) {
      link.style.display = 'inline';
    } else {
       if (link.innerHTML.match(regex)) {        
         link.style.display = 'inline';
       } else {
         link.style.display = 'none';
       }
    }
  }
  return true;
}

RegExp.escape = function(text) {
  if (!arguments.callee.sRE) {
    var specials = ['/', '.', '*', '+', '?', '|', '(', ')', '[', ']', '{', '}', '\\'];
    arguments.callee.sRE = new RegExp(
      '(\\' + specials.join('|\\') + ')', 'g'
    );
  }
  return text.replace(arguments.callee.sRE, '\\$1');
}

function hacks() {
  // show the spacer if necessary, 
  divs = document.getElementsByTagName('div');
  for(var x = 0; x < divs.length; x++) {
    if (divs[x].className && divs[x].className.match(/top/)) {
      document.getElementById('spacer').style.display = 'block';
    }
  }
  // remove extra colons from tables
  tds = document.getElementsByTagName('td');
  for(var x = 0; x < tds.length; x++) {
    str = tds[x].innerHTML
    if (str.charAt(str.length - 1) == ":") {
      tds[x].innerHTML = str.slice(0, str.length - 1)
    }
  }
}

addEvent(window, 'load', insertIndices, false);
addEvent(window, 'load', abbreviateIndices, false);
addEvent(window, 'load', stripe, false);
addEvent(window, 'load', highlightSymbols, false);
addEvent(window, 'load', hacks, false);
</script></head><body><div id="container"><div class="curve" id="preheader_curve_0"></div><div class="curve" id="preheader_curve_1"></div><div class="curve" id="preheader_curve_2"></div><div class="curve" id="preheader_curve_3"></div><div class="curve" id="preheader_curve_4"></div><div class="curve" id="preheader_curve_5"></div><div id="header"><p>
</p><span><h1 id="title">
Class: TasksController
</h1></span>
</div><div class="clear"></div><div id="left">
<div class="navigation darker top" id="child_of"><h3>Child of</h3><span>

<a href='ApplicationController.html'>
ApplicationController
</a>
</span></div>

<div class="navigation darker top" id="defined_in"><h3>Defined in</h3>

<a href="../files/app/controllers/tasks_controller_rb.html">app/controllers/tasks_controller.rb</a>

</div>



<div class="navigation top" id="methods"><h3>Methods</h3>


<a href='#M000199'>
add_log<br/>
</a>




<a href='#M000188'>
add_work<br/>
</a>




<a href='#M000181'>
ajax_check<br/>
</a>




<a href='#M000178'>
ajax_hide<br/>
</a>




<a href='#M000180'>
ajax_restore<br/>
</a>




<a href='#M000182'>
ajax_uncheck<br/>
</a>




<a href='#M000186'>
cancel_work_ajax<br/>
</a>




<a href='#M000172'>
create<br/>
</a>




<a href='#M000205'>
create_ajax<br/>
</a>




<a href='#M000179'>
create_attachments<br/>
</a>




<a href='#M000206'>
create_shortlist_ajax<br/>
</a>




<a href='#M000209'>
create_todo_ajax<br/>
</a>




<a href='#M000214'>
delete_tag<br/>
</a>




<a href='#M000170'>
dependency_targets<br/>
</a>




<a href='#M000198'>
destroy_log<br/>
</a>




<a href='#M000194'>
do_filter<br/>
</a>




<a href='#M000174'>
edit<br/>
</a>




<a href='#M000197'>
edit_log<br/>
</a>




<a href='#M000195'>
filter<br/>
</a>




<a href='#M000196'>
filter_shortlist<br/>
</a>




<a href='#M000201'>
get_csv<br/>
</a>




<a href='#M000169'>
get_milestones<br/>
</a>




<a href='#M000171'>
get_owners<br/>
</a>




<a href='#M000217'>
group_tasks<br/>
</a>




<a href='#M000167'>
index<br/>
</a>




<a href='#M000168'>
list<br/>
</a>




<a href='#M000202'>
move<br/>
</a>




<a href='#M000166'>
new<br/>
</a>




<a href='#M000211'>
order_todos<br/>
</a>




<a href='#M000208'>
pause_work_ajax<br/>
</a>




<a href='#M000204'>
quick_add<br/>
</a>




<a href='#M000175'>
repeat_task<br/>
</a>




<a href='#M000200'>
save_log<br/>
</a>




<a href='#M000215'>
save_tag<br/>
</a>




<a href='#M000207'>
shortlist<br/>
</a>




<a href='#M000216'>
sort_tasks<br/>
</a>




<a href='#M000183'>
start_work<br/>
</a>




<a href='#M000184'>
start_work_ajax<br/>
</a>




<a href='#M000185'>
start_work_edit_ajax<br/>
</a>




<a href='#M000189'>
stop_work<br/>
</a>




<a href='#M000190'>
stop_work_shortlist<br/>
</a>




<a href='#M000187'>
swap_work_ajax<br/>
</a>




<a href='#M000213'>
tags<br/>
</a>




<a href='#M000210'>
todo_check_ajax<br/>
</a>




<a href='#M000212'>
todo_delete_ajax<br/>
</a>




<a href='#M000203'>
toggle_history<br/>
</a>




<a href='#M000176'>
update<br/>
</a>




<a href='#M000177'>
update_ajax<br/>
</a>




<a href='#M000192'>
update_sheet_info<br/>
</a>




<a href='#M000193'>
update_tasks<br/>
</a>




<a href='#M000191'>
updatelog<br/>
</a>




<a href='#M000173'>
view<br/>
</a>


</div>
<div id="spacer"></div><div class="navigation darker index" id="class_wrapper"><div class="list_header"><h3>All classes</h3></div><div class="list_header_link"><a onclick="toggle('class'); toggleText('class_link'); return false;" href="#" id="class_link">Hide...</a></div><div class="clear"></div><div id="class"><form><label for="filter_class">Filter:&nbsp;&nbsp;</label><input type="text" onKeyUp="return filterList('class', this.value, event);" onKeyPress="return disableSubmit(event);" id="filter_class"></input></form></div></div><div class="navigation darker index" id="file_wrapper"><div class="list_header"><h3>All files</h3></div><div class="list_header_link"><a onclick="toggle('file'); toggleText('file_link'); return false;" href="#" id="file_link">Hide...</a></div><div class="clear"></div><div id="file"><form><label for="filter_file">Filter:&nbsp;&nbsp;</label><input type="text" onKeyUp="return filterList('file', this.value, event);" onKeyPress="return disableSubmit(event);" id="filter_file"></input></form></div></div><div class="navigation darker index" id="method_wrapper"><div class="list_header"><h3>All methods</h3></div><div class="list_header_link"><a onclick="toggle('method'); toggleText('method_link'); return false;" href="#" id="method_link">Show...</a></div><div class="clear"></div><div id="method"><form><label for="filter_method">Filter:&nbsp;&nbsp;</label><input type="text" onKeyUp="return filterList('method', this.value, event);" onKeyPress="return disableSubmit(event);" id="filter_method"></input></form></div></div></div><div id="content">
<h1 id="item_name">Class: TasksController</h1>

<div id="description"><p>
Handle tasks for a <a href="Company.html">Company</a> / <a
href="User.html">User</a>
</p>
<table>
<tr><td valign="top">Author:</td><td>Erlend Simonsen (<a
href="mailto:admin@clockingit.com">admin@clockingit.com</a>)

</td></tr>
</table>
</div>




<p></p>






<h1>Public Instance Methods</h1>


<a class="small" name="M000199"><br/></a>
<div class="method_block"><h3>
<a href='#M000199'>


add_log

()

</a>
</h3>

<p class="source_link" id="M000199-show-link"><a onclick="toggle('M000199-source'); toggleText('M000199-link'); return false;" href="#" id="M000199-link">Show source...</a></p><div class="source" id="M000199-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1159</span>
1159:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">add_log</span>
1160:     <span class="ruby-ivar">@log</span> = <span class="ruby-constant">Worklog</span>.<span class="ruby-identifier">new</span>
1161:     <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">started_at</span> = <span class="ruby-identifier">tz</span>.<span class="ruby-identifier">utc_to_local</span>(<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>)
1162:     <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;company_id = ?&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>])
1163:     <span class="ruby-identifier">render</span> <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'edit_log'</span>
1164:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000188"><br/></a>
<div class="method_block"><h3>
<a href='#M000188'>


add_work

()

</a>
</h3>

<p class="source_link" id="M000188-show-link"><a onclick="toggle('M000188-source'); toggleText('M000188-link'); return false;" href="#" id="M000188-link">Show source...</a></p><div class="source" id="M000188-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 975</span>
975:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">add_work</span>
976:     <span class="ruby-keyword kw">begin</span>
977:       <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>( <span class="ruby-identifier">params</span>[<span class="ruby-value str">'id'</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;tasks.project_id IN (#{current_project_ids})&quot;</span>] )
978:     <span class="ruby-keyword kw">rescue</span>
979:       <span class="ruby-identifier">flash</span>[<span class="ruby-value str">'notice'</span>] = <span class="ruby-identifier">_</span>(<span class="ruby-value str">'Unable to find task belonging to you with that ID.'</span>)
980:       <span class="ruby-identifier">redirect_from_last</span>
981:       <span class="ruby-keyword kw">return</span>
982:     <span class="ruby-keyword kw">end</span>
983: 
984:     <span class="ruby-ivar">@log</span> = <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">new</span>
985:     <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">user</span> = <span class="ruby-identifier">current_user</span>
986:     <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">company</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company</span>
987:     <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">project</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>
988:     <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">task</span> = <span class="ruby-ivar">@task</span>
989:     <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">customer</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">customer</span>
990:     <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">started_at</span> = <span class="ruby-identifier">tz</span>.<span class="ruby-identifier">utc_to_local</span>(<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>)
991:     <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-value">0</span>
992:     <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_WORK_ADDED</span>
993:     
994:     <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">save</span>
995:     <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; @task.id)}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
996: 
997:     <span class="ruby-identifier">render</span> <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'edit_log'</span>
998:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000181"><br/></a>
<div class="method_block"><h3>
<a href='#M000181'>


ajax_check

()

</a>
</h3>

<p class="source_link" id="M000181-show-link"><a onclick="toggle('M000181-source'); toggleText('M000181-link'); return false;" href="#" id="M000181-link">Show source...</a></p><div class="source" id="M000181-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 796</span>
796:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">ajax_check</span>
797:     <span class="ruby-keyword kw">begin</span>
798:       <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;project_id IN (?)&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span><span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span>}], <span class="ruby-identifier">:include</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:project</span>)
799:     <span class="ruby-keyword kw">rescue</span>
800:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:nothing</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>
801:       <span class="ruby-keyword kw">return</span>
802:     <span class="ruby-keyword kw">end</span> 
803: 
804:     <span class="ruby-identifier">old_status</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status_type</span>
805:     
806:     <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">completed_at</span>
807: 
808:       <span class="ruby-identifier">worklog</span> = <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">new</span>
809:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">user</span> = <span class="ruby-identifier">current_user</span>
810:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">company</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">company</span>
811:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">customer</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">customer</span>
812:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">project</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>
813:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">task</span> = <span class="ruby-ivar">@task</span>
814: 
815:       <span class="ruby-identifier">body</span> = <span class="ruby-value str">&quot;&quot;</span>
816: 
817:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@current_sheet</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">task_id</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">id</span>
818:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">started_at</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">created_at</span>
819:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">duration</span>
820:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">paused_duration</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">paused_duration</span>
821:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_COMPLETED</span>
822:         <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">body</span>.<span class="ruby-identifier">blank?</span>
823:           <span class="ruby-identifier">body</span> = <span class="ruby-node">&quot;\n#{@current_sheet.body}&quot;</span>
824:           <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">comment</span> = <span class="ruby-keyword kw">true</span> 
825:         <span class="ruby-keyword kw">end</span> 
826:       <span class="ruby-keyword kw">else</span> 
827:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">started_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>
828:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-value">0</span>
829:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_COMPLETED</span>
830:       <span class="ruby-keyword kw">end</span> 
831: 
832:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">completed_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>
833:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">updated_by_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
834:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status</span> = <span class="ruby-value">2</span>
835:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">save</span>
836:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">reload</span>
837: 
838:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">body</span> = <span class="ruby-node">&quot;- &lt;strong&gt;Status&lt;/strong&gt;: #{old_status} -&gt; #{@task.status_type}\n&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">body</span>
839:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">save</span>
840:         <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">destroy</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@current_sheet</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">task_id</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">id</span>
841:       <span class="ruby-keyword kw">end</span> 
842: 
843: 
844:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">next_repeat_date</span> <span class="ruby-operator">!=</span> <span class="ruby-keyword kw">nil</span>
845:           <span class="ruby-identifier">repeat_task</span>(<span class="ruby-ivar">@task</span>)
846:       <span class="ruby-keyword kw">end</span>
847: 
848:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">send_notifications?</span>
849:         <span class="ruby-constant">Notifications</span><span class="ruby-operator">::</span><span class="ruby-identifier">deliver_changed</span>(<span class="ruby-identifier">:completed</span>, <span class="ruby-ivar">@task</span>, <span class="ruby-identifier">current_user</span>, <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">body</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/&lt;[^&gt;]*&gt;/</span>,<span class="ruby-value str">''</span>) ) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
850:       <span class="ruby-keyword kw">end</span>
851: 
852:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; @task.id)}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
853:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'activities', :action =&gt; 'refresh')}');&quot;</span>, [<span class="ruby-node">&quot;activity_#{current_user.company_id}&quot;</span>])
854:     <span class="ruby-keyword kw">end</span>
855: 
856:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000178"><br/></a>
<div class="method_block"><h3>
<a href='#M000178'>


ajax_hide

()

</a>
</h3>

<p class="source_link" id="M000178-show-link"><a onclick="toggle('M000178-source'); toggleText('M000178-link'); return false;" href="#" id="M000178-link">Show source...</a></p><div class="source" id="M000178-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 693</span>
693:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">ajax_hide</span>
694:     <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;project_id IN (#{current_project_ids})&quot;</span>])
695: 
696:     <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">hidden</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
697:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">hidden</span> = <span class="ruby-value">1</span>
698:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">updated_by_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
699:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">save</span>
700: 
701:       <span class="ruby-identifier">worklog</span> = <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">new</span>
702:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">user</span> = <span class="ruby-identifier">current_user</span>
703:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">company</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">company</span>
704:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">customer</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">customer</span>
705:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">project</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>
706:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">task</span> = <span class="ruby-ivar">@task</span>
707:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">started_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>
708:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-value">0</span>
709:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_ARCHIVED</span>
710:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">body</span> = <span class="ruby-value str">&quot;&quot;</span>
711:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">save</span>
712:     <span class="ruby-keyword kw">end</span>
713: 
714:     <span class="ruby-identifier">render</span> <span class="ruby-identifier">:nothing</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>
715:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000180"><br/></a>
<div class="method_block"><h3>
<a href='#M000180'>


ajax_restore

()

</a>
</h3>

<p class="source_link" id="M000180-show-link"><a onclick="toggle('M000180-source'); toggleText('M000180-link'); return false;" href="#" id="M000180-link">Show source...</a></p><div class="source" id="M000180-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 772</span>
772:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">ajax_restore</span>
773:     <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;project_id IN (#{current_project_ids})&quot;</span>])
774:     <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">hidden</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
775:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">hidden</span> = <span class="ruby-value">0</span>
776:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">updated_by_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
777:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">save</span>
778: 
779:       <span class="ruby-identifier">worklog</span> = <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">new</span>
780:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">user</span> = <span class="ruby-identifier">current_user</span>
781:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">company</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">company</span>
782:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">customer</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">customer</span>
783:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">project</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>
784:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">task</span> = <span class="ruby-ivar">@task</span>
785:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">started_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>
786:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-value">0</span>
787:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-value">1</span>
788:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_RESTORED</span>
789:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">body</span> = <span class="ruby-value str">&quot;&quot;</span>
790:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">save</span>
791:     <span class="ruby-keyword kw">end</span>
792:     <span class="ruby-identifier">render</span> <span class="ruby-identifier">:nothing</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>
793:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000182"><br/></a>
<div class="method_block"><h3>
<a href='#M000182'>


ajax_uncheck

()

</a>
</h3>

<p class="source_link" id="M000182-show-link"><a onclick="toggle('M000182-source'); toggleText('M000182-link'); return false;" href="#" id="M000182-link">Show source...</a></p><div class="source" id="M000182-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 858</span>
858:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">ajax_uncheck</span>
859:     <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;project_id IN (?)&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span><span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span>}], <span class="ruby-identifier">:include</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:project</span>)
860: 
861:     <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">completed_at</span>.<span class="ruby-identifier">nil?</span>
862: 
863:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">completed_at</span> = <span class="ruby-keyword kw">nil</span>
864:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status</span> = <span class="ruby-value">0</span>
865:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">updated_by_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
866:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">save</span>
867: 
868:       <span class="ruby-identifier">worklog</span> = <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">new</span>
869:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">user</span> = <span class="ruby-identifier">current_user</span>
870:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">company</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">company</span>
871:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">customer</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">customer</span>
872:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">project</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>
873:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">task</span> = <span class="ruby-ivar">@task</span>
874:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">started_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>
875:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-value">0</span>
876:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_REVERTED</span>
877:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">body</span> = <span class="ruby-value str">&quot;&quot;</span>
878:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">save</span>
879: 
880:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">send_notifications?</span>
881:         <span class="ruby-constant">Notifications</span><span class="ruby-operator">::</span><span class="ruby-identifier">deliver_changed</span>(<span class="ruby-identifier">:reverted</span>, <span class="ruby-ivar">@task</span>, <span class="ruby-identifier">current_user</span>, <span class="ruby-value str">&quot;&quot;</span> ) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">begin</span> <span class="ruby-keyword kw">end</span>
882:       <span class="ruby-keyword kw">end</span>
883: 
884:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; @task.id)}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
885:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'activities', :action =&gt; 'refresh')}');&quot;</span>, [<span class="ruby-node">&quot;activity_#{current_user.company_id}&quot;</span>])
886:     <span class="ruby-keyword kw">end</span>
887: 
888:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000186"><br/></a>
<div class="method_block"><h3>
<a href='#M000186'>


cancel_work_ajax

()

</a>
</h3>

<p class="source_link" id="M000186-show-link"><a onclick="toggle('M000186-source'); toggleText('M000186-link'); return false;" href="#" id="M000186-link">Show source...</a></p><div class="source" id="M000186-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 923</span>
923:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">cancel_work_ajax</span>
924:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@current_sheet</span> 
925:       <span class="ruby-ivar">@task</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">task</span>
926:       <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">destroy</span>
927:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; @current_sheet.task_id)}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
928:       <span class="ruby-ivar">@current_sheet</span> = <span class="ruby-keyword kw">nil</span>
929:     <span class="ruby-keyword kw">end</span>
930:     <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">xhr?</span>
931:     <span class="ruby-identifier">redirect_from_last</span>
932:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000172"><br/></a>
<div class="method_block"><h3>
<a href='#M000172'>


create

()

</a>
</h3>
<p>
def get_watchers
</p>
<pre>
  @users = Project.find(params[:project_id]).users.find(:all, :order =&gt; 'name' )

  @options = @users.collect{ |u| (' {&quot;text&quot;:&quot;' + u.name.gsub(/&quot;/,'\&quot;') + '&quot;, &quot;value&quot;:&quot;' + u.id.to_s + '&quot;}') }.join( ',' )
  res = '{&quot;options&quot;:['
  res &lt;&lt; &quot;#{@options}&quot; unless @options.nil? || @options.empty?
  res &lt;&lt; ']}'

  render :text =&gt; &quot;#{res}&quot;
</pre>
<p>
end
</p>

<p class="source_link" id="M000172-show-link"><a onclick="toggle('M000172-source'); toggleText('M000172-link'); return false;" href="#" id="M000172-link">Show source...</a></p><div class="source" id="M000172-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 211</span>
211:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">create</span>
212: 
213:     <span class="ruby-identifier">tags</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:set_tags</span>]
214:     <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:set_tags</span>] = <span class="ruby-keyword kw">nil</span>
215: 
216:     <span class="ruby-ivar">@task</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company</span>.<span class="ruby-identifier">tasks</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>])
217: 
218:     <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:due_at</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:due_at</span>].<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
219: 
220:       <span class="ruby-identifier">repeat</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">parse_repeat</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:due_at</span>])
221:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">repeat</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">repeat</span> <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;&quot;</span>
222:         <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">repeat</span> = <span class="ruby-identifier">repeat</span>
223:         <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">due_at</span> = <span class="ruby-identifier">tz</span>.<span class="ruby-identifier">local_to_utc</span>(<span class="ruby-ivar">@task</span>.<span class="ruby-identifier">next_repeat_date</span>)
224:       <span class="ruby-keyword kw">else</span>
225:         <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">repeat</span> = <span class="ruby-keyword kw">nil</span>
226:         <span class="ruby-identifier">due_date</span> = <span class="ruby-constant">DateTime</span>.<span class="ruby-identifier">strptime</span>( <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:due_at</span>], <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">date_format</span> ) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">begin</span>
227:                                                                                                     <span class="ruby-identifier">flash</span>[<span class="ruby-value str">'notice'</span>] = <span class="ruby-identifier">_</span>(<span class="ruby-value str">'Invalid due date ignored.'</span>)
228:                                                                                                     <span class="ruby-identifier">due_date</span> = <span class="ruby-keyword kw">nil</span>
229:                                                                                                   <span class="ruby-keyword kw">end</span>
230:         <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">due_at</span> = <span class="ruby-identifier">tz</span>.<span class="ruby-identifier">local_to_utc</span>(<span class="ruby-identifier">due_date</span>.<span class="ruby-identifier">to_time</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>.<span class="ruby-identifier">day</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>.<span class="ruby-identifier">minute</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">due_date</span>.<span class="ruby-identifier">nil?</span>
231:       <span class="ruby-keyword kw">end</span>
232:     <span class="ruby-keyword kw">else</span>
233:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">repeat</span> = <span class="ruby-keyword kw">nil</span>
234:     <span class="ruby-keyword kw">end</span>
235: 
236:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">company_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>
237:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">updated_by_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
238:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">creator_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
239:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-identifier">parse_time</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:duration</span>], <span class="ruby-keyword kw">true</span>) 
240:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">set_tags</span>(<span class="ruby-identifier">tags</span>) 
241:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">set_task_num</span>(<span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>)
242:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-value">0</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">duration</span>.<span class="ruby-identifier">nil?</span>
243: 
244:     <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">can?</span>(<span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>, <span class="ruby-value str">'create'</span>)
245:       <span class="ruby-identifier">flash</span>[<span class="ruby-value str">'notice'</span>] = <span class="ruby-identifier">_</span>(<span class="ruby-value str">&quot;You don't have access to create tasks on this project.&quot;</span>)
246:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">xhr?</span>
247: 
248:       <span class="ruby-ivar">@projects</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'name'</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;completed_at IS NULL&quot;</span>]).<span class="ruby-identifier">collect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> [ <span class="ruby-node">&quot;#{c.name} / #{c.customer.name}&quot;</span>, <span class="ruby-identifier">c</span>.<span class="ruby-identifier">id</span> ] <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">can?</span>(<span class="ruby-identifier">c</span>, <span class="ruby-value str">'create'</span>)  }.<span class="ruby-identifier">compact</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">nil?</span>
249:       <span class="ruby-ivar">@tags</span> = <span class="ruby-constant">Tag</span>.<span class="ruby-identifier">top_counts</span>({ <span class="ruby-identifier">:company_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>, <span class="ruby-identifier">:project_ids</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">current_project_ids</span>, <span class="ruby-identifier">:filter_hidden</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_hidden</span>]})
250:       <span class="ruby-ivar">@notify_targets</span> = <span class="ruby-identifier">current_projects</span>.<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">users</span>.<span class="ruby-identifier">collect</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">:name</span>) }.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>
251:       <span class="ruby-ivar">@notify_targets</span> <span class="ruby-operator">+=</span> <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;project_id IN (#{current_project_ids}) AND notify_emails IS NOT NULL and notify_emails &lt;&gt; ''&quot;</span>]).<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">notify_emails</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">','</span>).<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">strip</span> } }
252:       <span class="ruby-ivar">@notify_targets</span> = <span class="ruby-ivar">@notify_targets</span>.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>
253:       <span class="ruby-ivar">@notify_targets</span> <span class="ruby-operator">||=</span> []
254: 
255:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'new'</span>
256:       <span class="ruby-keyword kw">return</span>
257:     <span class="ruby-keyword kw">end</span>
258:     
259:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">save</span>
260: 
261:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:last_project_id</span>] = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project_id</span>
262:       
263:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:watchers</span>]
264:         <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:watchers</span>].<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">elem</span><span class="ruby-operator">|</span>
265:           <span class="ruby-identifier">elem</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">','</span>).<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">w</span><span class="ruby-operator">|</span>
266:             <span class="ruby-identifier">u</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by_name</span>(<span class="ruby-identifier">w</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;company_id = ?&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>])
267:             <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">u</span>.<span class="ruby-identifier">nil?</span>
268:               <span class="ruby-comment cmt"># Found user</span>
269:               <span class="ruby-identifier">n</span> = <span class="ruby-constant">Notification</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">:user</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">u</span>, <span class="ruby-identifier">:task</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@task</span>)
270:               <span class="ruby-identifier">n</span>.<span class="ruby-identifier">save</span>
271:             <span class="ruby-keyword kw">else</span>
272:               <span class="ruby-comment cmt"># Not a user, check for email address</span>
273:               <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">w</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-value str">'@'</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span>(<span class="ruby-ivar">@task</span>.<span class="ruby-identifier">notify_emails</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">notify_emails</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">w</span>))
274:                 <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">notify_emails</span> <span class="ruby-operator">||=</span> <span class="ruby-value str">&quot;&quot;</span>
275:                 <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">notify_emails</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;,&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">notify_emails</span>.<span class="ruby-identifier">empty?</span>
276:                 <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">notify_emails</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">w</span>
277:               <span class="ruby-keyword kw">end</span>
278:             <span class="ruby-keyword kw">end</span>
279:           <span class="ruby-keyword kw">end</span>
280:         <span class="ruby-keyword kw">end</span>
281:         <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">save</span>
282:       <span class="ruby-keyword kw">end</span>
283: 
284:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:users</span>]
285:         <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:users</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">o</span><span class="ruby-operator">|</span>
286:           <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
287:           <span class="ruby-identifier">u</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">o</span>.<span class="ruby-identifier">to_i</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;company_id = ?&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>])
288:           <span class="ruby-identifier">to</span> = <span class="ruby-constant">TaskOwner</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">:user</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">u</span>, <span class="ruby-identifier">:task</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@task</span>)
289:           <span class="ruby-identifier">to</span>.<span class="ruby-identifier">save</span>
290:         <span class="ruby-keyword kw">end</span>
291:       <span class="ruby-keyword kw">end</span>
292: 
293:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:dependencies</span>]
294:         <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:dependencies</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">d</span><span class="ruby-operator">|</span>
295:           <span class="ruby-identifier">deps</span> = <span class="ruby-identifier">d</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">','</span>)
296:           <span class="ruby-identifier">deps</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">dep</span><span class="ruby-operator">|</span>
297:             <span class="ruby-identifier">dep</span>.<span class="ruby-identifier">strip!</span>
298:             <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">dep</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
299:             <span class="ruby-identifier">t</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;project_id IN (#{current_project_ids}) AND task_num = ?&quot;</span>, <span class="ruby-identifier">dep</span>])
300:             <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">nil?</span>
301:               <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">dependencies</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">t</span>
302:             <span class="ruby-keyword kw">end</span>
303:           <span class="ruby-keyword kw">end</span>
304:         <span class="ruby-keyword kw">end</span>
305:         <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">save</span>
306:       <span class="ruby-keyword kw">end</span>
307: 
308:       <span class="ruby-identifier">create_attachments</span>(<span class="ruby-ivar">@task</span>)
309: 
310:       <span class="ruby-identifier">worklog</span> = <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">new</span>
311:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">user</span> = <span class="ruby-identifier">current_user</span>
312:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">company</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">company</span>
313:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">customer</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">customer</span>
314:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">project</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>
315:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">task</span> = <span class="ruby-ivar">@task</span>
316:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">started_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>
317:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-value">0</span>
318:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_CREATED</span>
319:       <span class="ruby-keyword kw">if</span> (<span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-identifier">:comment</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:comment</span>].<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>)
320:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">body</span> =  <span class="ruby-constant">CGI</span><span class="ruby-operator">::</span><span class="ruby-identifier">escapeHTML</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:comment</span>])
321:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">comment</span> = <span class="ruby-keyword kw">true</span>
322:       <span class="ruby-keyword kw">end</span> 
323: 
324:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">save</span>
325:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value str">'notify'</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
326:         <span class="ruby-constant">Notifications</span><span class="ruby-operator">::</span><span class="ruby-identifier">deliver_created</span>( <span class="ruby-ivar">@task</span>, <span class="ruby-identifier">current_user</span>, <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:comment</span>]) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">begin</span> <span class="ruby-keyword kw">end</span>
327:       <span class="ruby-keyword kw">end</span>
328: 
329:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'activities', :action =&gt; 'refresh')}');&quot;</span>, [<span class="ruby-node">&quot;activity_#{current_user.company_id}&quot;</span>])
330: 
331:       <span class="ruby-identifier">flash</span>[<span class="ruby-value str">'notice'</span>] <span class="ruby-operator">||=</span> <span class="ruby-node">&quot;#{link_to_task(@task)} - #{_('Task was successfully created.')}&quot;</span>
332: 
333:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">xhr?</span>
334: 
335:       <span class="ruby-identifier">redirect_from_last</span>
336:     <span class="ruby-keyword kw">else</span>
337:       <span class="ruby-ivar">@projects</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'name'</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;completed_at IS NULL&quot;</span>]).<span class="ruby-identifier">collect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> [ <span class="ruby-node">&quot;#{c.name} / #{c.customer.name}&quot;</span>, <span class="ruby-identifier">c</span>.<span class="ruby-identifier">id</span> ] <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">can?</span>(<span class="ruby-identifier">c</span>, <span class="ruby-value str">'create'</span>)  }.<span class="ruby-identifier">compact</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">nil?</span>
338:       <span class="ruby-ivar">@tags</span> = <span class="ruby-constant">Tag</span>.<span class="ruby-identifier">top_counts</span>({ <span class="ruby-identifier">:company_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>, <span class="ruby-identifier">:project_ids</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">current_project_ids</span>, <span class="ruby-identifier">:filter_hidden</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_hidden</span>]})
339:       <span class="ruby-ivar">@notify_targets</span> = <span class="ruby-identifier">current_projects</span>.<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">users</span>.<span class="ruby-identifier">collect</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">:name</span>) }.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>
340:       <span class="ruby-ivar">@notify_targets</span> <span class="ruby-operator">+=</span> <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;project_id IN (#{current_project_ids}) AND notify_emails IS NOT NULL and notify_emails &lt;&gt; ''&quot;</span>]).<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">notify_emails</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">','</span>).<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">strip</span> } }
341:       <span class="ruby-ivar">@notify_targets</span> = <span class="ruby-ivar">@notify_targets</span>.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>
342:       <span class="ruby-ivar">@notify_targets</span> <span class="ruby-operator">||=</span> []
343:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">xhr?</span>
344:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'new'</span>
345:     <span class="ruby-keyword kw">end</span>
346:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000205"><br/></a>
<div class="method_block"><h3>
<a href='#M000205'>


create_ajax

()

</a>
</h3>

<p class="source_link" id="M000205-show-link"><a onclick="toggle('M000205-source'); toggleText('M000205-link'); return false;" href="#" id="M000205-link">Show source...</a></p><div class="source" id="M000205-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1479</span>
1479:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">create_ajax</span>
1480:     <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">create</span>
1481:     <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">id</span>
1482:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1483:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-value str">&quot;quick_add_container&quot;</span>, <span class="ruby-identifier">:duration</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span><span class="ruby-value">.5</span>, <span class="ruby-identifier">:startcolor</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;#ff9999&quot;</span>)
1484:       <span class="ruby-keyword kw">end</span>
1485:     <span class="ruby-keyword kw">else</span>
1486:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">reload</span>
1487:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1488:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">insert_html</span> <span class="ruby-identifier">:top</span>, <span class="ruby-value str">&quot;task_list&quot;</span>, <span class="ruby-identifier">:partial</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'task_row'</span>, <span class="ruby-identifier">:locals</span> =<span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">:task</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@task</span>, <span class="ruby-identifier">:depth</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>}
1489:         [<span class="ruby-value str">'task_name'</span>, <span class="ruby-value str">'task_set_tags'</span>, <span class="ruby-value str">'task_description'</span>, <span class="ruby-value str">'dependencies_input'</span>, <span class="ruby-value str">'task_duration'</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">el</span><span class="ruby-operator">|</span>
1490:           <span class="ruby-identifier">page</span>.<span class="ruby-identifier">call</span> <span class="ruby-node">&quot;$('#{el}').clear&quot;</span>
1491:         <span class="ruby-keyword kw">end</span>
1492:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-node">&quot;task_#{@task.id}&quot;</span>, <span class="ruby-identifier">:duration</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">1.5</span>)
1493:         <span class="ruby-identifier">page</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;$('task_name').focus();&quot;</span>
1494:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">call</span>(<span class="ruby-value str">&quot;updateTooltips&quot;</span>)
1495:       <span class="ruby-keyword kw">end</span>
1496:     <span class="ruby-keyword kw">end</span>
1497:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000179"><br/></a>
<div class="method_block"><h3>
<a href='#M000179'>


create_attachments

(task)

</a>
</h3>

<p class="source_link" id="M000179-show-link"><a onclick="toggle('M000179-source'); toggleText('M000179-link'); return false;" href="#" id="M000179-link">Show source...</a></p><div class="source" id="M000179-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 717</span>
717:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">create_attachments</span>(<span class="ruby-identifier">task</span>)
718:          <span class="ruby-identifier">filenames</span> = []
719:          <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-value str">'tmp_files'</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">params</span>[<span class="ruby-value str">'tmp_files'</span>].<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">f</span> <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;&quot;</span>}.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
720:                  <span class="ruby-identifier">params</span>[<span class="ruby-value str">'tmp_files'</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">tmp_file</span><span class="ruby-operator">|</span>
721:                          <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">tmp_file</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">String</span>)
722:                    <span class="ruby-identifier">filename</span> = <span class="ruby-identifier">tmp_file</span>.<span class="ruby-identifier">original_filename</span>
723:              <span class="ruby-identifier">filename</span> = <span class="ruby-identifier">filename</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">&quot;/&quot;</span>).<span class="ruby-identifier">last</span>
724:              <span class="ruby-identifier">filename</span> = <span class="ruby-identifier">filename</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">&quot;\\&quot;</span>).<span class="ruby-identifier">last</span>
725:              <span class="ruby-identifier">filename</span> = <span class="ruby-identifier">filename</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/[^\w.]/</span>, <span class="ruby-value str">'_'</span>)
726:   
727:              <span class="ruby-identifier">task_file</span> = <span class="ruby-constant">ProjectFile</span>.<span class="ruby-identifier">new</span>()
728:              <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">company</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company</span>
729:              <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">customer</span> = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">customer</span>
730:              <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">project</span> = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">project</span>
731:              <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">task_id</span> = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">id</span>
732:              <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">user_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
733:              <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">filename</span> = <span class="ruby-identifier">filename</span>
734:              <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">name</span> = <span class="ruby-identifier">filename</span>
735:              <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">save</span>
736:              <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">file_size</span> = <span class="ruby-identifier">tmp_file</span>.<span class="ruby-identifier">size</span>
737:   
738:              <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">save</span>
739:              <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">reload</span>
740:   
741:              <span class="ruby-constant">File</span>.<span class="ruby-identifier">umask</span>(<span class="ruby-value">0</span>)
742:              <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-constant">File</span>.<span class="ruby-identifier">directory?</span>(<span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">path</span>)
743:               <span class="ruby-constant">Dir</span>.<span class="ruby-identifier">mkdir</span>(<span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">path</span>, <span class="ruby-value">0777</span>) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
744:              <span class="ruby-keyword kw">end</span>
745:   
746:              <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">file_path</span>, <span class="ruby-value str">&quot;wb&quot;</span>, <span class="ruby-value">0777</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">write</span>( <span class="ruby-identifier">tmp_file</span>.<span class="ruby-identifier">read</span> ) } <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">begin</span>
747:                                                     <span class="ruby-identifier">flash</span>[<span class="ruby-value str">'notice'</span>] = <span class="ruby-identifier">_</span>(<span class="ruby-node">&quot;Permission denied while saving file to #{task_file.file_path}.&quot;</span>)
748:                                                     <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">destroy</span>
749:                                                     <span class="ruby-identifier">task_file</span> = <span class="ruby-keyword kw">nil</span>
750:                                                     <span class="ruby-keyword kw">next</span>
751:                                                     <span class="ruby-keyword kw">end</span>
752:              <span class="ruby-identifier">filenames</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">filename</span>
753:              <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">task_file</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">filename</span>[<span class="ruby-regexp re">/\.gif|\.png|\.jpg|\.jpeg|\.tif|\.bmp|\.psd/i</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">file_size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
754:                <span class="ruby-identifier">image</span> = <span class="ruby-constant">ImageOperations</span><span class="ruby-operator">::</span><span class="ruby-identifier">get_image</span>( <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">file_path</span> )
755:                                  <span class="ruby-keyword kw">if</span> <span class="ruby-constant">ImageOperations</span><span class="ruby-operator">::</span><span class="ruby-identifier">is_image?</span>(<span class="ruby-identifier">image</span>)
756:                  <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">file_type</span> = <span class="ruby-constant">ProjectFile</span><span class="ruby-operator">::</span><span class="ruby-constant">FILETYPE_IMG</span>
757:                  <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">mime_type</span> = <span class="ruby-identifier">image</span>.<span class="ruby-identifier">mime_type</span>
758:                  <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">save</span>
759:                                          <span class="ruby-identifier">thumb</span> = <span class="ruby-constant">ImageOperations</span><span class="ruby-operator">::</span><span class="ruby-identifier">thumbnail</span>(<span class="ruby-identifier">image</span>, <span class="ruby-value">124</span>)
760:                  <span class="ruby-identifier">f</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">thumbnail_path</span>, <span class="ruby-value str">&quot;w&quot;</span>, <span class="ruby-value">0777</span>)
761:                  <span class="ruby-identifier">f</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">thumb</span>.<span class="ruby-identifier">to_blob</span>)
762:                  <span class="ruby-identifier">f</span>.<span class="ruby-identifier">close</span>
763:                <span class="ruby-keyword kw">end</span>
764:                <span class="ruby-identifier">image</span> = <span class="ruby-identifier">thumb</span> = <span class="ruby-keyword kw">nil</span>
765:                <span class="ruby-constant">GC</span>.<span class="ruby-identifier">start</span>
766:              <span class="ruby-keyword kw">end</span>
767:            <span class="ruby-keyword kw">end</span>
768:          <span class="ruby-keyword kw">end</span>
769:          <span class="ruby-identifier">filenames</span>
770:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000206"><br/></a>
<div class="method_block"><h3>
<a href='#M000206'>


create_shortlist_ajax

()

</a>
</h3>

<p class="source_link" id="M000206-show-link"><a onclick="toggle('M000206-source'); toggleText('M000206-link'); return false;" href="#" id="M000206-link">Show source...</a></p><div class="source" id="M000206-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1499</span>
1499:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">create_shortlist_ajax</span>
1500: 
1501:     <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:name</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:name</span>].<span class="ruby-identifier">empty?</span>
1502:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1503:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-value str">&quot;shortlist&quot;</span>, <span class="ruby-identifier">:duration</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span><span class="ruby-value">.5</span>, <span class="ruby-identifier">:startcolor</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;#ff9999&quot;</span>)
1504:       <span class="ruby-keyword kw">end</span>
1505:       <span class="ruby-keyword kw">return</span>
1506:     <span class="ruby-keyword kw">end</span>
1507: 
1508:     <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">new</span>
1509:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">name</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:name</span>]
1510:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">company_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>
1511:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">updated_by_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
1512:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">creator_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
1513:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-value">0</span>
1514:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">set_task_num</span>(<span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>)
1515:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">description</span> = <span class="ruby-value str">&quot;&quot;</span>
1516: 
1517:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_milestone_short</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
1518:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span> = <span class="ruby-constant">Milestone</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;company_id = ? AND id = ?&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>, <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_milestone_short</span>]]).<span class="ruby-identifier">project</span>
1519:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone_id</span> = <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_milestone_short</span>].<span class="ruby-identifier">to_i</span>
1520:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project_short</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
1521:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project_id</span> = <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project_short</span>].<span class="ruby-identifier">to_i</span>
1522:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone_id</span> = <span class="ruby-keyword kw">nil</span>
1523:     <span class="ruby-keyword kw">else</span>
1524:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1525:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-value str">&quot;shortlist&quot;</span>, <span class="ruby-identifier">:duration</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span><span class="ruby-value">.5</span>, <span class="ruby-identifier">:startcolor</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;#ff9999&quot;</span>)
1526:       <span class="ruby-keyword kw">end</span>
1527:       <span class="ruby-keyword kw">return</span>
1528:     <span class="ruby-keyword kw">end</span>
1529: 
1530:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">save</span>
1531:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">reload</span>
1532: 
1533:     <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">id</span>
1534:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1535:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-value str">&quot;quick_add_container&quot;</span>, <span class="ruby-identifier">:duration</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span><span class="ruby-value">.5</span>, <span class="ruby-identifier">:startcolor</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;#ff9999&quot;</span>)
1536:       <span class="ruby-keyword kw">end</span>
1537:     <span class="ruby-keyword kw">else</span>
1538:       <span class="ruby-identifier">to</span> = <span class="ruby-constant">TaskOwner</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">:user</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">current_user</span>, <span class="ruby-identifier">:task</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@task</span>)
1539:       <span class="ruby-identifier">to</span>.<span class="ruby-identifier">save</span>
1540: 
1541:       <span class="ruby-identifier">worklog</span> = <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">new</span>
1542:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">user</span> = <span class="ruby-identifier">current_user</span>
1543:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">company</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">company</span>
1544:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">customer</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">customer</span>
1545:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">project</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>
1546:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">task</span> = <span class="ruby-ivar">@task</span>
1547:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">started_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>
1548:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-value">0</span>
1549:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_CREATED</span>
1550:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">body</span> = <span class="ruby-value str">&quot;&quot;</span>
1551:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">save</span>
1552:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value str">'notify'</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
1553:         <span class="ruby-constant">Notifications</span><span class="ruby-operator">::</span><span class="ruby-identifier">deliver_created</span>( <span class="ruby-ivar">@task</span>, <span class="ruby-identifier">current_user</span>, <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:comment</span>]) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">begin</span> <span class="ruby-keyword kw">end</span>
1554:       <span class="ruby-keyword kw">end</span>
1555: 
1556:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; @task.id)}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
1557:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'activities', :action =&gt; 'refresh')}');&quot;</span>, [<span class="ruby-node">&quot;activity_#{current_user.company_id}&quot;</span>])
1558: 
1559:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1560:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">insert_html</span> <span class="ruby-identifier">:bottom</span>, <span class="ruby-value str">&quot;shortlist-tasks&quot;</span>, <span class="ruby-identifier">:partial</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'task_row'</span>, <span class="ruby-identifier">:locals</span> =<span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">:task</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@task</span>, <span class="ruby-identifier">:depth</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>}
1561:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-node">&quot;task_#{@task.id}&quot;</span>, <span class="ruby-identifier">:duration</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">1.5</span>)
1562:         <span class="ruby-identifier">page</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;$('task_name').focus();&quot;</span>
1563:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">call</span>(<span class="ruby-value str">&quot;fixShortLinks&quot;</span>)
1564:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">call</span>(<span class="ruby-value str">&quot;updateTooltips&quot;</span>)
1565:       <span class="ruby-keyword kw">end</span>
1566:     <span class="ruby-keyword kw">end</span>
1567:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000209"><br/></a>
<div class="method_block"><h3>
<a href='#M000209'>


create_todo_ajax

()

</a>
</h3>

<p class="source_link" id="M000209-show-link"><a onclick="toggle('M000209-source'); toggleText('M000209-link'); return false;" href="#" id="M000209-link">Show source...</a></p><div class="source" id="M000209-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1614</span>
1614:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">create_todo_ajax</span>
1615: 
1616:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:todo</span>][<span class="ruby-identifier">:name</span>].<span class="ruby-identifier">blank?</span>
1617:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1618:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-node">&quot;todo-form-#{params[:id]}&quot;</span>, <span class="ruby-identifier">:duration</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span><span class="ruby-value">.5</span>, <span class="ruby-identifier">:startcolor</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;#ff9999&quot;</span>)
1619:       <span class="ruby-keyword kw">end</span>
1620:       <span class="ruby-keyword kw">return</span>
1621:     <span class="ruby-keyword kw">end</span>
1622: 
1623:     <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;id = ? AND project_id IN (#{current_project_ids})&quot;</span>, <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>]])
1624:     <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@task</span>
1625:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1626:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-node">&quot;todo-form-#{params[:id]}&quot;</span>, <span class="ruby-identifier">:duration</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span><span class="ruby-value">.5</span>, <span class="ruby-identifier">:startcolor</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;#ff9999&quot;</span>)
1627:       <span class="ruby-keyword kw">end</span>
1628:       <span class="ruby-keyword kw">return</span>
1629:     <span class="ruby-keyword kw">end</span>
1630:     <span class="ruby-ivar">@todo</span> = <span class="ruby-constant">Todo</span>.<span class="ruby-identifier">new</span>
1631:     <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">name</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:todo</span>][<span class="ruby-identifier">:name</span>]
1632:     <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">creator_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
1633:     <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">task_id</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">id</span>
1634: 
1635:     <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">save</span>
1636:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1637:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-node">&quot;todo-form-tasks-#{params[:id]}&quot;</span>, <span class="ruby-identifier">:duration</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span><span class="ruby-value">.5</span>, <span class="ruby-identifier">:startcolor</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;#ff9999&quot;</span>)
1638:       <span class="ruby-keyword kw">end</span>
1639:     <span class="ruby-keyword kw">else</span>
1640:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; params[:id])}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
1641:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'activities', :action =&gt; 'refresh')}');&quot;</span>, [<span class="ruby-node">&quot;activity_#{current_user.company_id}&quot;</span>])
1642: 
1643:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1644:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">insert_html</span> <span class="ruby-identifier">:bottom</span>, <span class="ruby-node">&quot;todo-#{@task.dom_id}&quot;</span>, <span class="ruby-identifier">:partial</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;tasks/todo_row&quot;</span>
1645:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">replace_html</span> <span class="ruby-node">&quot;todo-status-#{@task.dom_id}&quot;</span>, <span class="ruby-identifier">link_to_function</span>( <span class="ruby-node">&quot;#{@task.todo_status}&quot;</span>, <span class="ruby-node">&quot;Element.toggle('todo-container-#{@task.dom_id}');&quot;</span>, <span class="ruby-identifier">:class</span> =<span class="ruby-operator">&gt;</span> (<span class="ruby-ivar">@task</span>.<span class="ruby-identifier">todos</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-value">? </span><span class="ruby-value str">&quot;todo-status-link-empty&quot;</span> <span class="ruby-operator">:</span><span class="ruby-value str">&quot;todo-status-link&quot;</span>))
1646:         <span class="ruby-identifier">page</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;$('todo_text_#{@task.id}').clear();&quot;</span>
1647:         <span class="ruby-identifier">page</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;$('todo_text_#{@task.id}').focus();&quot;</span>
1648:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">call</span>(<span class="ruby-value str">&quot;updateTooltips&quot;</span>)
1649:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span> <span class="ruby-identifier">:highlight</span>, <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">dom_id</span>
1650:         <span class="ruby-identifier">page</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;Sortable.create('todo-#{@task.dom_id}', {containment:'todo-#{@task.dom_id}', format:/^[^-]*-(.*)$/, onUpdate:function(){new Ajax.Request('/tasks/order_todos/#{@task.id}', {asynchronous:true, evalScripts:true, parameters:Sortable.serialize('todo-#{@task.dom_id}')})}, only:'todo-active'})&quot;</span>
1651:       <span class="ruby-keyword kw">end</span>
1652:     <span class="ruby-keyword kw">end</span>
1653: 
1654:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000214"><br/></a>
<div class="method_block"><h3>
<a href='#M000214'>


delete_tag

()

</a>
</h3>

<p class="source_link" id="M000214-show-link"><a onclick="toggle('M000214-source'); toggleText('M000214-link'); return false;" href="#" id="M000214-link">Show source...</a></p><div class="source" id="M000214-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1748</span>
1748:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">delete_tag</span>
1749:     <span class="ruby-identifier">tag</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company</span>.<span class="ruby-identifier">tags</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>]) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
1750:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">tag</span>
1751:       <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">destroy</span>
1752:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1753:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">remove</span> <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">dom_id</span>
1754:       <span class="ruby-keyword kw">end</span> 
1755:     <span class="ruby-keyword kw">else</span> 
1756:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:nothing</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>
1757:     <span class="ruby-keyword kw">end</span> 
1758:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000170"><br/></a>
<div class="method_block"><h3>
<a href='#M000170'>


dependency_targets

()

</a>
</h3>

<p class="source_link" id="M000170-show-link"><a onclick="toggle('M000170-source'); toggleText('M000170-link'); return false;" href="#" id="M000170-link">Show source...</a></p><div class="source" id="M000170-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 159</span>
159:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">dependency_targets</span>
160:     <span class="ruby-identifier">value</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:dependencies</span>][<span class="ruby-value">0</span>]
161:     <span class="ruby-identifier">value</span>.<span class="ruby-identifier">gsub!</span>(<span class="ruby-regexp re">/#/</span>, <span class="ruby-value str">''</span>)
162: 
163:     <span class="ruby-identifier">query</span> = <span class="ruby-value str">&quot;&quot;</span>
164:     <span class="ruby-ivar">@keys</span> = <span class="ruby-identifier">value</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">' '</span>)
165:     <span class="ruby-ivar">@keys</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">k</span><span class="ruby-operator">|</span>
166:       <span class="ruby-identifier">query</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;+issue_name:#{k}* &quot;</span>
167:     <span class="ruby-keyword kw">end</span>
168: 
169:     <span class="ruby-comment cmt"># Append project id's the user has access to</span>
170:     <span class="ruby-identifier">projects</span> = <span class="ruby-value str">&quot;0&quot;</span>
171:     <span class="ruby-identifier">current_projects</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span>
172:       <span class="ruby-identifier">projects</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;|#{p.id}&quot;</span>
173:     <span class="ruby-keyword kw">end</span>
174:     <span class="ruby-identifier">projects</span> = <span class="ruby-node">&quot;+project_id:\&quot;#{projects}\&quot;&quot;</span> 
175: 
176:     <span class="ruby-comment cmt"># Find the tasks</span>
177:     <span class="ruby-ivar">@tasks</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find_by_contents</span>(<span class="ruby-node">&quot;+company_id:#{current_user.company_id} #{projects} #{query}&quot;</span>, {<span class="ruby-identifier">:limit</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">13</span>})
178:     <span class="ruby-identifier">render</span> <span class="ruby-identifier">:text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;&lt;ul&gt;#{@tasks.collect{ |t| &quot;&lt;li&gt;[#{ &quot;&lt;strike&gt;&quot; if t.done? }#&lt;span class=\&quot;complete_value\&quot;&gt;#{ t.task_num}&lt;/span&gt;#{ &quot;&lt;/strike&gt;&quot; if t.done? }] #{@keys.nil? ? t.name : highlight_all(t.name, @keys)}&lt;/li&gt;&quot;}.join(&quot;&quot;) }&lt;/ul&gt;&quot;</span>
179:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000198"><br/></a>
<div class="method_block"><h3>
<a href='#M000198'>


destroy_log

()

</a>
</h3>

<p class="source_link" id="M000198-show-link"><a onclick="toggle('M000198-source'); toggleText('M000198-link'); return false;" href="#" id="M000198-link">Show source...</a></p><div class="source" id="M000198-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1152</span>
1152:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">destroy_log</span>
1153:     <span class="ruby-ivar">@log</span> = <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">find</span>( <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;company_id = ?&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>] )
1154:     <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">destroy</span>
1155:     <span class="ruby-identifier">flash</span>[<span class="ruby-value str">'notice'</span>] = <span class="ruby-identifier">_</span>(<span class="ruby-value str">&quot;Log entry deleted...&quot;</span>)
1156:     <span class="ruby-identifier">redirect_from_last</span>
1157:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000194"><br/></a>
<div class="method_block"><h3>
<a href='#M000194'>


do_filter

()

</a>
</h3>

<p class="source_link" id="M000194-show-link"><a onclick="toggle('M000194-source'); toggleText('M000194-link'); return false;" href="#" id="M000194-link">Show source...</a></p><div class="source" id="M000194-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1072</span>
1072:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">do_filter</span>
1073: 
1074:     <span class="ruby-identifier">f</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:filter</span>]
1075: 
1076:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">f</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;0&quot;</span>
1077:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_customer</span>] = <span class="ruby-value str">&quot;0&quot;</span>
1078:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_milestone</span>] = <span class="ruby-value str">&quot;0&quot;</span>
1079:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project</span>] = <span class="ruby-value str">&quot;0&quot;</span>
1080:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">f</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">'c'</span>
1081:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_customer</span>] = <span class="ruby-identifier">f</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>]
1082:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_milestone</span>] = <span class="ruby-value str">&quot;0&quot;</span>
1083:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project</span>] = <span class="ruby-value str">&quot;0&quot;</span>
1084:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">f</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">'p'</span>
1085:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_customer</span>] = <span class="ruby-value str">&quot;0&quot;</span>
1086:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_milestone</span>] = <span class="ruby-value str">&quot;0&quot;</span>
1087:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project</span>] = <span class="ruby-identifier">f</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>]
1088:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">f</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">'m'</span>
1089:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_customer</span>] = <span class="ruby-value str">&quot;0&quot;</span>
1090:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_milestone</span>] = <span class="ruby-identifier">f</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>]
1091:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project</span>] = <span class="ruby-value str">&quot;0&quot;</span>
1092:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">f</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value str">'u'</span>
1093:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_customer</span>] = <span class="ruby-value str">&quot;0&quot;</span>
1094:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_milestone</span>] = <span class="ruby-value str">&quot;-1&quot;</span>
1095:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project</span>] = <span class="ruby-identifier">f</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>]
1096:     <span class="ruby-keyword kw">end</span>
1097: 
1098:     <span class="ruby-identifier">filter_names</span> =  [<span class="ruby-identifier">:filter_user</span>, <span class="ruby-identifier">:filter_hidden</span>, <span class="ruby-identifier">:filter_status</span>, <span class="ruby-identifier">:group_by</span>, <span class="ruby-identifier">:hide_deferred</span>, <span class="ruby-identifier">:hide_dependencies</span>, <span class="ruby-identifier">:sort</span>, <span class="ruby-identifier">:filter_type</span>, <span class="ruby-identifier">:filter_severity</span>, <span class="ruby-identifier">:filter_priority</span>, <span class="ruby-identifier">:colors</span>, <span class="ruby-identifier">:icons</span> ]
1099:     <span class="ruby-identifier">filter_names</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">filter</span><span class="ruby-operator">|</span>
1100:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">filter</span>] = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">filter</span>]
1101:     <span class="ruby-keyword kw">end</span>
1102: 
1103:     <span class="ruby-comment cmt"># set any filters on custom properties</span>
1104:     <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company</span>.<span class="ruby-identifier">properties</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">prop</span><span class="ruby-operator">|</span>
1105:       <span class="ruby-identifier">filter</span> = <span class="ruby-identifier">prop</span>.<span class="ruby-identifier">filter_name</span>
1106:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">filter</span>] = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">filter</span>]
1107:     <span class="ruby-keyword kw">end</span>
1108: 
1109:     <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company</span>.<span class="ruby-identifier">properties</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">prop</span><span class="ruby-operator">|</span>
1110:       <span class="ruby-identifier">filter</span> = <span class="ruby-identifier">prop</span>.<span class="ruby-identifier">filter_name</span>
1111:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">filter</span>] = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">filter</span>]
1112:     <span class="ruby-keyword kw">end</span>
1113: 
1114:     <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">last_filter</span> = <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_hidden</span>]
1115:     <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">last_milestone_id</span> = <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_milestone</span>]
1116:     <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">last_project_id</span> = <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project</span>]
1117:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:last_project_id</span>] = <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project</span>]
1118:     <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">save</span>
1119:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000174"><br/></a>
<div class="method_block"><h3>
<a href='#M000174'>


edit

()

</a>
</h3>

<p class="source_link" id="M000174-show-link"><a onclick="toggle('M000174-source'); toggleText('M000174-link'); return false;" href="#" id="M000174-link">Show source...</a></p><div class="source" id="M000174-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 357</span>
357:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">edit</span>
358:     <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;project_id IN (?)&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span><span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span>}] ) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">begin</span>
359:                                                                                                                            <span class="ruby-identifier">flash</span>[<span class="ruby-value str">'notice'</span>] = <span class="ruby-identifier">_</span>(<span class="ruby-value str">&quot;You don't have access to that task, or it doesn't exist.&quot;</span>)
360:                                                                                                                            <span class="ruby-identifier">redirect_from_last</span>
361:                                                                                                                            <span class="ruby-keyword kw">return</span>
362:                                                                                                                          <span class="ruby-keyword kw">end</span> 
363:                                                                                                                            
364:     
365:     
366:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">due_at</span> = <span class="ruby-identifier">tz</span>.<span class="ruby-identifier">utc_to_local</span>(<span class="ruby-ivar">@task</span>.<span class="ruby-identifier">due_at</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">due_at</span>.<span class="ruby-identifier">nil?</span>
367:     <span class="ruby-ivar">@tags</span> = <span class="ruby-constant">Tag</span>.<span class="ruby-identifier">top_counts</span>({ <span class="ruby-identifier">:company_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>, <span class="ruby-identifier">:project_ids</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">current_project_ids</span>, <span class="ruby-identifier">:filter_hidden</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_hidden</span>]})
368:     <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@logs</span> = <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;work_logs.started_at desc,work_logs.id desc&quot;</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;work_logs.task_id = ? #{&quot;AND (work_logs.comment = 1 OR work_logs.log_type=6)&quot; if session[:only_comments].to_i == 1}&quot;</span>, <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">id</span>], <span class="ruby-identifier">:include</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:user</span>, <span class="ruby-identifier">:task</span>, <span class="ruby-identifier">:project</span>])
369:           <span class="ruby-ivar">@logs</span> = []
370:     <span class="ruby-keyword kw">end</span>
371:     <span class="ruby-ivar">@projects</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>).<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'name'</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;completed_at IS NULL&quot;</span>]).<span class="ruby-identifier">collect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> [ <span class="ruby-node">&quot;#{c.name} / #{c.customer.name}&quot;</span>, <span class="ruby-identifier">c</span>.<span class="ruby-identifier">id</span> ] <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">can?</span>(<span class="ruby-identifier">c</span>, <span class="ruby-value str">'create'</span>)  }.<span class="ruby-identifier">compact</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">nil?</span>
372: 
373:     <span class="ruby-ivar">@notify_targets</span> = <span class="ruby-identifier">current_projects</span>.<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">users</span>.<span class="ruby-identifier">collect</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">:name</span>) }.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>
374:     <span class="ruby-ivar">@notify_targets</span> <span class="ruby-operator">+=</span> <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;project_id IN (#{current_project_ids}) AND notify_emails IS NOT NULL and notify_emails &lt;&gt; ''&quot;</span>]).<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">notify_emails</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">','</span>).<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">strip</span> } }.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>
375:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000197"><br/></a>
<div class="method_block"><h3>
<a href='#M000197'>


edit_log

()

</a>
</h3>

<p class="source_link" id="M000197-show-link"><a onclick="toggle('M000197-source'); toggleText('M000197-link'); return false;" href="#" id="M000197-link">Show source...</a></p><div class="source" id="M000197-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1146</span>
1146:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">edit_log</span>
1147:     <span class="ruby-ivar">@log</span> = <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">find</span>( <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;company_id = ?&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>] )
1148:     <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">started_at</span> = <span class="ruby-identifier">tz</span>.<span class="ruby-identifier">utc_to_local</span>(<span class="ruby-ivar">@log</span>.<span class="ruby-identifier">started_at</span>)
1149:     <span class="ruby-ivar">@task</span> = <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">task</span>
1150:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000195"><br/></a>
<div class="method_block"><h3>
<a href='#M000195'>


filter

()

</a>
</h3>

<p class="source_link" id="M000195-show-link"><a onclick="toggle('M000195-source'); toggleText('M000195-link'); return false;" href="#" id="M000195-link">Show source...</a></p><div class="source" id="M000195-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1121</span>
1121:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">filter</span>
1122:     <span class="ruby-identifier">do_filter</span>
1123:     <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">:controller</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'tasks'</span>, <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'list'</span>
1124:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000196"><br/></a>
<div class="method_block"><h3>
<a href='#M000196'>


filter_shortlist

()

</a>
</h3>

<p class="source_link" id="M000196-show-link"><a onclick="toggle('M000196-source'); toggleText('M000196-link'); return false;" href="#" id="M000196-link">Show source...</a></p><div class="source" id="M000196-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1126</span>
1126:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">filter_shortlist</span>
1127: 
1128:     <span class="ruby-identifier">tmp</span> = { }
1129:     [<span class="ruby-identifier">:filter_customer</span>, <span class="ruby-identifier">:filter_milestone</span>, <span class="ruby-identifier">:filter_project</span>, <span class="ruby-identifier">:filter_user</span>, <span class="ruby-identifier">:filter_hidden</span>, <span class="ruby-identifier">:filter_status</span>, <span class="ruby-identifier">:group_by</span>, <span class="ruby-identifier">:hide_deferred</span>, <span class="ruby-identifier">:hide_dependencies</span>, <span class="ruby-identifier">:sort</span>, <span class="ruby-identifier">:filter_type</span>, <span class="ruby-identifier">:filter_severity</span>, <span class="ruby-identifier">:filter_priority</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
1130:       <span class="ruby-identifier">tmp</span>[<span class="ruby-identifier">v</span>] = <span class="ruby-identifier">session</span>[<span class="ruby-identifier">v</span>]
1131:     <span class="ruby-keyword kw">end</span>
1132: 
1133:     <span class="ruby-identifier">do_filter</span>
1134: 
1135:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project_short</span>] = <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project</span>]
1136:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_customer_short</span>] = <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_customer</span>]
1137:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_milestone_short</span>] = <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_milestone</span>]
1138: 
1139:     [<span class="ruby-identifier">:filter_customer</span>, <span class="ruby-identifier">:filter_milestone</span>, <span class="ruby-identifier">:filter_project</span>, <span class="ruby-identifier">:filter_user</span>, <span class="ruby-identifier">:filter_hidden</span>, <span class="ruby-identifier">:filter_status</span>, <span class="ruby-identifier">:group_by</span>, <span class="ruby-identifier">:hide_deferred</span>, <span class="ruby-identifier">:hide_dependencies</span>, <span class="ruby-identifier">:sort</span>, <span class="ruby-identifier">:filter_type</span>, <span class="ruby-identifier">:filter_severity</span>, <span class="ruby-identifier">:filter_priority</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
1140:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">v</span>] = <span class="ruby-identifier">tmp</span>[<span class="ruby-identifier">v</span>]
1141:     <span class="ruby-keyword kw">end</span>
1142: 
1143:     <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">:controller</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'tasks'</span>, <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'shortlist'</span>
1144:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000201"><br/></a>
<div class="method_block"><h3>
<a href='#M000201'>


get_csv

()

</a>
</h3>

<p class="source_link" id="M000201-show-link"><a onclick="toggle('M000201-source'); toggleText('M000201-link'); return false;" href="#" id="M000201-link">Show source...</a></p><div class="source" id="M000201-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1232</span>
1232:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">get_csv</span>
1233:     <span class="ruby-identifier">list</span>
1234: 
1235:     <span class="ruby-identifier">filename</span> = <span class="ruby-value str">&quot;clockingit_tasks&quot;</span>
1236: 
1237:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_customer</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
1238:       <span class="ruby-identifier">filename</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;_&quot;</span>
1239:       <span class="ruby-identifier">filename</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">Customer</span>.<span class="ruby-identifier">find</span>( <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_customer</span>] ).<span class="ruby-identifier">name</span>
1240:     <span class="ruby-keyword kw">end</span>
1241: 
1242:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
1243:       <span class="ruby-identifier">p</span> = <span class="ruby-constant">Project</span>.<span class="ruby-identifier">find</span>( <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project</span>] )
1244:       <span class="ruby-identifier">filename</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;_&quot;</span>
1245:       <span class="ruby-identifier">filename</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;#{p.customer.name}_#{p.name}&quot;</span>
1246:     <span class="ruby-keyword kw">end</span>
1247: 
1248:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_milestone</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
1249:       <span class="ruby-identifier">m</span> = <span class="ruby-constant">Milestone</span>.<span class="ruby-identifier">find</span>( <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_milestone</span>] )
1250:       <span class="ruby-identifier">filename</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;_&quot;</span>
1251:       <span class="ruby-identifier">filename</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;#{m.project.customer.name}_#{m.project.name}_#{m.name}&quot;</span>
1252:     <span class="ruby-keyword kw">end</span>
1253: 
1254:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_user</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
1255:       <span class="ruby-identifier">filename</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;_&quot;</span>
1256:       <span class="ruby-identifier">filename</span> <span class="ruby-operator">&lt;&lt;</span>  <span class="ruby-constant">User</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_user</span>]).<span class="ruby-identifier">name</span>
1257:     <span class="ruby-keyword kw">end</span>
1258: 
1259:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_status</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
1260:       <span class="ruby-identifier">filename</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;_&quot;</span>
1261:       <span class="ruby-identifier">filename</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">Task</span>.<span class="ruby-identifier">status_type</span>(<span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_status</span>].<span class="ruby-identifier">to_i</span>)
1262:     <span class="ruby-keyword kw">end</span>
1263: 
1264:     <span class="ruby-identifier">filename</span> = <span class="ruby-identifier">filename</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/ /</span>, <span class="ruby-value str">&quot;_&quot;</span>).<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/[&quot;']/</span>, <span class="ruby-value str">''</span>).<span class="ruby-identifier">downcase</span>
1265:     <span class="ruby-identifier">filename</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;.csv&quot;</span>
1266: 
1267:     <span class="ruby-identifier">csv_string</span> = <span class="ruby-constant">FasterCSV</span>.<span class="ruby-identifier">generate</span>( <span class="ruby-identifier">:col_sep</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;,&quot;</span> ) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">csv</span><span class="ruby-operator">|</span>
1268: 
1269:       <span class="ruby-identifier">header</span> = [<span class="ruby-value str">'Client'</span>, <span class="ruby-value str">'Project'</span>, <span class="ruby-value str">'Num'</span>, <span class="ruby-value str">'Name'</span>, <span class="ruby-value str">'Tags'</span>, <span class="ruby-value str">'User'</span>, <span class="ruby-value str">'Milestone'</span>, <span class="ruby-value str">'Due'</span>, <span class="ruby-value str">'Created'</span>, <span class="ruby-value str">'Completed'</span>, <span class="ruby-value str">'Worked'</span>, <span class="ruby-value str">'Estimated'</span>, <span class="ruby-value str">'Status'</span>, <span class="ruby-value str">'Priority'</span>, <span class="ruby-value str">'Severity'</span>]
1270:       <span class="ruby-identifier">csv</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">header</span>
1271: 
1272:       <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">t</span> <span class="ruby-keyword kw">in</span> <span class="ruby-ivar">@tasks</span>
1273:         <span class="ruby-identifier">csv</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">t</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">customer</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">t</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">t</span>.<span class="ruby-identifier">task_num</span>, <span class="ruby-identifier">t</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">t</span>.<span class="ruby-identifier">tags</span>.<span class="ruby-identifier">collect</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">:name</span>).<span class="ruby-identifier">join</span>(<span class="ruby-value str">','</span>), <span class="ruby-identifier">t</span>.<span class="ruby-identifier">owners</span>, <span class="ruby-identifier">t</span>.<span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-value">? </span><span class="ruby-keyword kw">nil</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">t</span>.<span class="ruby-identifier">due_at</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-value">? </span><span class="ruby-identifier">t</span>.<span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-value">? </span><span class="ruby-keyword kw">nil</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">due_at</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">due_at</span>, <span class="ruby-identifier">t</span>.<span class="ruby-identifier">created_at</span>, <span class="ruby-identifier">t</span>.<span class="ruby-identifier">completed_at</span>, <span class="ruby-identifier">t</span>.<span class="ruby-identifier">worked_minutes</span>, <span class="ruby-identifier">t</span>.<span class="ruby-identifier">duration</span>, <span class="ruby-identifier">t</span>.<span class="ruby-identifier">status_type</span>, <span class="ruby-identifier">t</span>.<span class="ruby-identifier">priority_type</span>, <span class="ruby-identifier">t</span>.<span class="ruby-identifier">severity_type</span>]
1274:       <span class="ruby-keyword kw">end</span>
1275: 
1276:     <span class="ruby-keyword kw">end</span>
1277:     <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span>(<span class="ruby-node">&quot;Seinding[#{filename}]&quot;</span>)
1278: 
1279:     <span class="ruby-identifier">send_data</span>(<span class="ruby-identifier">csv_string</span>,
1280:               <span class="ruby-identifier">:type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'text/csv; charset=utf-8; header=present'</span>,
1281:               <span class="ruby-identifier">:filename</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">filename</span>)
1282:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000169"><br/></a>
<div class="method_block"><h3>
<a href='#M000169'>


get_milestones

()

</a>
</h3>
<p>
Return a json formatted <a href="TasksController.html#M000168">list</a> of
options to refresh the <a href="Milestone.html">Milestone</a> dropdown
</p>

<p class="source_link" id="M000169-show-link"><a onclick="toggle('M000169-source'); toggleText('M000169-link'); return false;" href="#" id="M000169-link">Show source...</a></p><div class="source" id="M000169-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 141</span>
141:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">get_milestones</span>
142:     <span class="ruby-ivar">@milestones</span> = <span class="ruby-constant">Milestone</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'milestones.due_at, milestones.name'</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">'company_id = ? AND project_id = ? AND completed_at IS NULL'</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>, <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:project_id</span>]]).<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-node">&quot;{\&quot;text\&quot;:\&quot;#{m.name.gsub(/&quot;/,'\&quot;')}\&quot;, \&quot;value\&quot;:\&quot;#{m.id}\&quot;}&quot;</span> }.<span class="ruby-identifier">join</span>(<span class="ruby-value str">','</span>)
143: 
144:     <span class="ruby-comment cmt"># {&quot;options&quot;:[{&quot;value&quot;:&quot;1&quot;,&quot;text&quot;:&quot;Test Page&quot;}]}</span>
145:     <span class="ruby-identifier">res</span> = <span class="ruby-value str">'{&quot;options&quot;:[{&quot;value&quot;:&quot;0&quot;, &quot;text&quot;:&quot;'</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">_</span>(<span class="ruby-value str">'[None]'</span>) <span class="ruby-operator">+</span> <span class="ruby-value str">'&quot;}'</span>
146:     <span class="ruby-identifier">res</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;, #{@milestones}&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@milestones</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@milestones</span>.<span class="ruby-identifier">empty?</span>
147:     <span class="ruby-identifier">res</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">']}'</span>
148:   
149:     <span class="ruby-identifier">p</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:project_id</span>]) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
150:     <span class="ruby-identifier">script</span> = <span class="ruby-value str">&quot;&quot;</span>
151:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">p</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">can?</span>(<span class="ruby-identifier">p</span>, <span class="ruby-value str">'milestone'</span>)
152:       <span class="ruby-identifier">script</span> = <span class="ruby-value str">&quot;\n&lt;script type=\&quot;text/javascript\&quot;&gt;if($('add_milestone')){$('add_milestone').show();}&lt;/script&gt;&quot;</span>
153:     <span class="ruby-keyword kw">else</span> 
154:       <span class="ruby-identifier">script</span> = <span class="ruby-value str">&quot;\n&lt;script type=\&quot;text/javascript\&quot;&gt;if($('add_milestone')){$('add_milestone').hide();}&lt;/script&gt;&quot;</span>
155:     <span class="ruby-keyword kw">end</span> 
156:     <span class="ruby-identifier">render</span> <span class="ruby-identifier">:text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;#{res}#{script}&quot;</span>
157:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000171"><br/></a>
<div class="method_block"><h3>
<a href='#M000171'>


get_owners

()

</a>
</h3>
<p>
Return a json formatted <a href="TasksController.html#M000168">list</a> of
users to refresh the <a href="User.html">User</a> dropdown This a bit
tricky, as it also updates a JavaScript variable with the current drop-down
box.
</p>

<p class="source_link" id="M000171-show-link"><a onclick="toggle('M000171-source'); toggleText('M000171-link'); return false;" href="#" id="M000171-link">Show source...</a></p><div class="source" id="M000171-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 183</span>
183:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">get_owners</span>
184: 
185:     <span class="ruby-ivar">@users</span> = <span class="ruby-constant">Project</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:project_id</span>]).<span class="ruby-identifier">users</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'name'</span> )
186: 
187:     <span class="ruby-ivar">@resource_string</span> = <span class="ruby-node">&quot;&lt;option value=\&quot;\&quot;&gt;[#{_('No one')}]&lt;/option&gt;&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@users</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">us</span><span class="ruby-operator">|</span> <span class="ruby-node">&quot;&lt;option value=\&quot;#{us.id}\&quot;&gt;#{us.name}&lt;/option&gt;&quot;</span>}.<span class="ruby-identifier">join</span>(<span class="ruby-value str">''</span>)
188:     <span class="ruby-ivar">@resource_string</span> = <span class="ruby-ivar">@resource_string</span>.<span class="ruby-identifier">split</span>(<span class="ruby-regexp re">/\n/</span>).<span class="ruby-identifier">join</span>(<span class="ruby-value str">''</span>).<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/'/</span>, <span class="ruby-value str">&quot;\\\\\'&quot;</span>)
189: 
190:     <span class="ruby-ivar">@options</span> = <span class="ruby-ivar">@users</span>.<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">u</span><span class="ruby-operator">|</span> (<span class="ruby-value str">' {&quot;text&quot;:&quot;'</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">u</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/&quot;/</span>,<span class="ruby-value str">'\&quot;'</span>) <span class="ruby-operator">+</span> <span class="ruby-value str">'&quot;, &quot;value&quot;:&quot;'</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">u</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-value str">'&quot;}'</span>) }.<span class="ruby-identifier">join</span>( <span class="ruby-value str">','</span> )
191:     <span class="ruby-identifier">res</span> = <span class="ruby-value str">'{&quot;options&quot;:[{&quot;value&quot;:&quot;0&quot;, &quot;text&quot;:&quot;[None]&quot;}'</span>
192:     <span class="ruby-identifier">res</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;, #{@options}&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@options</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@options</span>.<span class="ruby-identifier">empty?</span>
193:     <span class="ruby-identifier">res</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">']}'</span>
194: 
195:     <span class="ruby-identifier">render</span> <span class="ruby-identifier">:text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;#{res}\n&lt;script type=\&quot;text/javascript\&quot;&gt;resource = '&lt;select name=\&quot;users[]\&quot; id=\&quot;task_users\&quot;&gt;#{@resource_string}&lt;/select&gt;';&lt;/script&gt;&quot;</span>
196:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000167"><br/></a>
<div class="method_block"><h3>
<a href='#M000167'>


index

()

</a>
</h3>

<p class="source_link" id="M000167-show-link"><a onclick="toggle('M000167-source'); toggleText('M000167-link'); return false;" href="#" id="M000167-link">Show source...</a></p><div class="source" id="M000167-source"><pre>    <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 42</span>
42:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">index</span>
43:     <span class="ruby-identifier">redirect_to</span> <span class="ruby-value str">'list'</span>
44:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000168"><br/></a>
<div class="method_block"><h3>
<a href='#M000168'>


list

()

</a>
</h3>

<p class="source_link" id="M000168-show-link"><a onclick="toggle('M000168-source'); toggleText('M000168-link'); return false;" href="#" id="M000168-link">Show source...</a></p><div class="source" id="M000168-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 46</span>
 46:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">list</span>
 47:     <span class="ruby-comment cmt"># Subscribe to the juggernaut channel for Task updates</span>
 48:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:channels</span>] <span class="ruby-operator">+=</span> [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>]
 49: 
 50:     <span class="ruby-ivar">@tags</span> = {}
 51:     <span class="ruby-ivar">@tags</span>.<span class="ruby-identifier">default</span> = <span class="ruby-value">0</span>
 52:     <span class="ruby-ivar">@tags_total</span> = <span class="ruby-value">0</span>
 53:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
 54:       <span class="ruby-identifier">project_ids</span> = <span class="ruby-identifier">current_project_ids</span>
 55:     <span class="ruby-keyword kw">else</span>
 56:       <span class="ruby-identifier">project_ids</span> = <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project</span>]
 57:     <span class="ruby-keyword kw">end</span>
 58: 
 59:     <span class="ruby-identifier">filter</span> = <span class="ruby-value str">&quot;&quot;</span>
 60: 
 61:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_user</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
 62:       <span class="ruby-identifier">task_ids</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_user</span>].<span class="ruby-identifier">to_i</span>).<span class="ruby-identifier">tasks</span>.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">id</span> }.<span class="ruby-identifier">join</span>(<span class="ruby-value str">','</span>)
 63:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">task_ids</span> <span class="ruby-operator">==</span> <span class="ruby-value str">''</span>
 64:         <span class="ruby-identifier">filter</span> = <span class="ruby-value str">&quot;tasks.id IN (0) AND &quot;</span>
 65:       <span class="ruby-keyword kw">else</span>
 66:         <span class="ruby-identifier">filter</span> = <span class="ruby-node">&quot;tasks.id IN (#{task_ids}) AND &quot;</span>
 67:       <span class="ruby-keyword kw">end</span>
 68:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_user</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">0</span>
 69:       <span class="ruby-identifier">not_task_ids</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:select</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;tasks.*&quot;</span>, <span class="ruby-identifier">:joins</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;LEFT OUTER JOIN task_owners t_o ON tasks.id = t_o.task_id&quot;</span>, <span class="ruby-identifier">:readonly</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">false</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;tasks.company_id = ? AND t_o.id IS NULL&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>]).<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">id</span> }.<span class="ruby-identifier">join</span>(<span class="ruby-value str">','</span>)
 70:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">not_task_ids</span> <span class="ruby-operator">==</span> <span class="ruby-value str">''</span>
 71:         <span class="ruby-identifier">filter</span> = <span class="ruby-value str">&quot;tasks.id = 0 AND &quot;</span>
 72:       <span class="ruby-keyword kw">else</span>
 73:         <span class="ruby-identifier">filter</span> = <span class="ruby-node">&quot;tasks.id IN (#{not_task_ids}) AND &quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">not_task_ids</span> <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;&quot;</span>
 74:       <span class="ruby-keyword kw">end</span>
 75:     <span class="ruby-keyword kw">end</span>
 76: 
 77:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_milestone</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
 78:       <span class="ruby-identifier">filter</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;tasks.milestone_id = #{session[:filter_milestone]} AND &quot;</span>
 79:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_milestone</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">0</span>
 80:       <span class="ruby-identifier">filter</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;(tasks.milestone_id IS NULL OR tasks.milestone_id = 0) AND &quot;</span>
 81:     <span class="ruby-keyword kw">end</span>
 82: 
 83:     <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_status</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">-1</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_status</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">-2</span>
 84:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_status</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
 85:         <span class="ruby-identifier">filter</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;(tasks.status = 0 OR tasks.status = 1) AND &quot;</span>
 86:       <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_status</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span>
 87:         <span class="ruby-identifier">filter</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;(tasks.status &gt; 1) AND &quot;</span>
 88:       <span class="ruby-keyword kw">else</span>
 89:         <span class="ruby-identifier">filter</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;tasks.status = #{session[:filter_status].to_i} AND &quot;</span>
 90:       <span class="ruby-keyword kw">end</span>
 91:     <span class="ruby-keyword kw">end</span>
 92: 
 93:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_status</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">-2</span>
 94:       <span class="ruby-identifier">filter</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;tasks.hidden = 1 AND &quot;</span>
 95:     <span class="ruby-keyword kw">else</span>
 96:       <span class="ruby-identifier">filter</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;tasks.hidden = 0 AND &quot;</span>
 97:     <span class="ruby-keyword kw">end</span>
 98: 
 99:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:hide_deferred</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
100:       <span class="ruby-identifier">filter</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;(tasks.hide_until IS NULL OR tasks.hide_until &lt; '#{tz.now.utc.to_s(:db)}') AND &quot;</span>
101:     <span class="ruby-keyword kw">end</span> 
102: 
103:     <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_customer</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
104:       <span class="ruby-identifier">filter</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;tasks.project_id IN (#{current_user.projects.find(:all, :conditions =&gt; [&quot;customer_id = ?&quot;, session[:filter_customer]]).collect(&amp;:id).compact.join(',') }) AND &quot;</span>
105:     <span class="ruby-keyword kw">end</span>
106:     
107:     <span class="ruby-identifier">filter</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;(tasks.milestone_id NOT IN (#{completed_milestone_ids}) OR tasks.milestone_id IS NULL) &quot;</span>
108: 
109:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:tag</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:tag</span>].<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
110:       <span class="ruby-comment cmt"># Looking for tasks based on tags</span>
111:       <span class="ruby-ivar">@selected_tags</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:tag</span>].<span class="ruby-identifier">downcase</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">','</span>).<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">strip</span>}
112:       <span class="ruby-ivar">@tasks</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">tagged_with</span>(<span class="ruby-ivar">@selected_tags</span>, { <span class="ruby-identifier">:company_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>, <span class="ruby-identifier">:project_ids</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">project_ids</span>, <span class="ruby-identifier">:filter_hidden</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_hidden</span>], <span class="ruby-identifier">:filter_user</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_user</span>], <span class="ruby-identifier">:filter_milestone</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_milestone</span>], <span class="ruby-identifier">:filter_status</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_status</span>], <span class="ruby-identifier">:filter_customer</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_customer</span>] })
113:     <span class="ruby-keyword kw">else</span>
114:       <span class="ruby-comment cmt"># Looking for tasks based on filters</span>
115:       <span class="ruby-ivar">@selected_tags</span> = []
116:       <span class="ruby-ivar">@tasks</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, 
117:                          <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;tasks.project_id IN (#{project_ids}) AND &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">filter</span>], 
118:                          <span class="ruby-identifier">:include</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:users</span>, <span class="ruby-identifier">:tags</span>, <span class="ruby-identifier">:sheets</span>, <span class="ruby-identifier">:todos</span>, <span class="ruby-identifier">:dependencies</span>, 
119:                                       {<span class="ruby-identifier">:dependants</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:users</span>, <span class="ruby-identifier">:tags</span>, <span class="ruby-identifier">:sheets</span>, <span class="ruby-identifier">:todos</span>, { <span class="ruby-identifier">:project</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:customer</span> }, <span class="ruby-identifier">:milestone</span>]}, { <span class="ruby-identifier">:project</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:customer</span>}, <span class="ruby-identifier">:milestone</span> ])
120:     <span class="ruby-keyword kw">end</span>
121: 
122:     <span class="ruby-comment cmt"># trim tasks based on custom properties</span>
123:     <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company</span>.<span class="ruby-identifier">properties</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">prop</span><span class="ruby-operator">|</span>
124:       <span class="ruby-identifier">filter_value</span> = <span class="ruby-identifier">session</span>[<span class="ruby-identifier">prop</span>.<span class="ruby-identifier">filter_name</span>]
125:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">filter_value</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
126:         <span class="ruby-ivar">@tasks</span> = <span class="ruby-ivar">@tasks</span>.<span class="ruby-identifier">delete_if</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> 
127:           <span class="ruby-identifier">val</span> = <span class="ruby-identifier">t</span>.<span class="ruby-identifier">property_value</span>(<span class="ruby-identifier">prop</span>)
128:           <span class="ruby-identifier">val</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">val</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">filter_value</span>.<span class="ruby-identifier">to_i</span>
129:         <span class="ruby-keyword kw">end</span>
130:       <span class="ruby-keyword kw">end</span>
131:     <span class="ruby-keyword kw">end</span>
132: 
133: 
134:     <span class="ruby-ivar">@tasks</span> = <span class="ruby-identifier">sort_tasks</span>(<span class="ruby-ivar">@tasks</span>)
135:     <span class="ruby-comment cmt"># Most popular tags, currently unlimited.</span>
136:     <span class="ruby-ivar">@all_tags</span> = <span class="ruby-constant">Tag</span>.<span class="ruby-identifier">top_counts</span>({ <span class="ruby-identifier">:company_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>, <span class="ruby-identifier">:project_ids</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">project_ids</span>, <span class="ruby-identifier">:filter_hidden</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_hidden</span>], <span class="ruby-identifier">:filter_customer</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_customer</span>]})
137:     <span class="ruby-ivar">@group_ids</span>, <span class="ruby-ivar">@groups</span> = <span class="ruby-identifier">group_tasks</span>(<span class="ruby-ivar">@tasks</span>)
138:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000202"><br/></a>
<div class="method_block"><h3>
<a href='#M000202'>


move

()

</a>
</h3>

<p class="source_link" id="M000202-show-link"><a onclick="toggle('M000202-source'); toggleText('M000202-link'); return false;" href="#" id="M000202-link">Show source...</a></p><div class="source" id="M000202-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1284</span>
1284:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">move</span>
1285:     <span class="ruby-keyword kw">begin</span>
1286:       <span class="ruby-identifier">body</span> = <span class="ruby-value str">&quot;&quot;</span>
1287:       <span class="ruby-identifier">elems</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>].<span class="ruby-identifier">split</span>(<span class="ruby-value str">' '</span>)
1288:       <span class="ruby-identifier">element</span> = <span class="ruby-identifier">elems</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">split</span>(<span class="ruby-value str">'_'</span>)[<span class="ruby-value">1</span>]
1289: 
1290:       <span class="ruby-ivar">@group</span> = <span class="ruby-identifier">elems</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">split</span>(<span class="ruby-value str">'_'</span>)[<span class="ruby-value">1</span>].<span class="ruby-identifier">to_i</span>
1291: 
1292:       <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">element</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;project_id IN (#{current_project_ids})&quot;</span>])
1293: 
1294:       <span class="ruby-identifier">worklog</span> = <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">new</span>
1295:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_MODIFIED</span>
1296: 
1297:       <span class="ruby-identifier">update_type</span> = <span class="ruby-identifier">:updated</span>
1298: 
1299:       <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:group_by</span>].<span class="ruby-identifier">to_i</span>
1300:       <span class="ruby-keyword kw">when</span> <span class="ruby-value">3</span>
1301:         <span class="ruby-comment cmt"># Project</span>
1302:         <span class="ruby-identifier">project</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">find</span>(<span class="ruby-ivar">@group</span>)
1303:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project_id</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">project</span>.<span class="ruby-identifier">id</span>
1304:           <span class="ruby-identifier">body</span> = <span class="ruby-node">&quot;- &lt;strong&gt;Project&lt;/strong&gt;: #{@task.project.name} -&gt; #{project.name}\n&quot;</span>
1305:           <span class="ruby-identifier">old_milestone</span> = <span class="ruby-keyword kw">nil</span>
1306:           <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone</span>
1307:             <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Milestone&lt;/strong&gt;: #{@task.milestone.name} -&gt; None&quot;</span>
1308:             <span class="ruby-identifier">old_milestone</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone</span>
1309:             <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone</span> = <span class="ruby-keyword kw">nil</span>
1310:           <span class="ruby-keyword kw">end</span>
1311:           <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project_id</span> = <span class="ruby-identifier">project</span>.<span class="ruby-identifier">id</span>
1312:           <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">save</span>
1313: 
1314:           <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">update_all</span>(<span class="ruby-node">&quot;customer_id = #{project.customer_id}, project_id = #{@task.project_id}&quot;</span>, <span class="ruby-node">&quot;task_id = #{@task.id}&quot;</span>)
1315:           <span class="ruby-constant">ProjectFile</span>.<span class="ruby-identifier">update_all</span>(<span class="ruby-node">&quot;customer_id = #{project.customer_id}, project_id = #{@task.project_id}&quot;</span>, <span class="ruby-node">&quot;task_id = #{@task.id}&quot;</span>)
1316: 
1317:           <span class="ruby-identifier">old_milestone</span>.<span class="ruby-identifier">update_counts</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">old_milestone</span>
1318:         <span class="ruby-keyword kw">end</span>
1319:       <span class="ruby-keyword kw">when</span> <span class="ruby-value">4</span>
1320:         <span class="ruby-comment cmt"># Milestone</span>
1321:         <span class="ruby-identifier">milestone</span> = <span class="ruby-constant">Milestone</span>.<span class="ruby-identifier">find</span>(<span class="ruby-ivar">@group</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;project_id IN (#{current_project_ids})&quot;</span>]) <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@group</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
1322: 
1323:         <span class="ruby-keyword kw">if</span>(<span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone_id</span>.<span class="ruby-identifier">to_i</span>) <span class="ruby-operator">!=</span> <span class="ruby-ivar">@group</span>
1324:           <span class="ruby-keyword kw">if</span>( <span class="ruby-identifier">milestone</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">project_id</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project_id</span> )
1325:             <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Project&lt;/strong&gt;: #{@task.project.name} -&gt; #{milestone.project.name}\n&quot;</span>
1326:             <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project_id</span> = <span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">project_id</span>
1327:             <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">update_all</span>(<span class="ruby-node">&quot;customer_id = #{milestone.project.customer_id}, project_id = #{milestone.project_id}&quot;</span>, <span class="ruby-node">&quot;task_id = #{@task.id}&quot;</span>)
1328:             <span class="ruby-constant">ProjectFile</span>.<span class="ruby-identifier">update_all</span>(<span class="ruby-node">&quot;customer_id = #{milestone.project.customer_id}, project_id = #{milestone.project_id}&quot;</span>, <span class="ruby-node">&quot;task_id = #{@task.id}&quot;</span>)
1329:           <span class="ruby-keyword kw">end</span>
1330: 
1331:           <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone_id</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@group</span>
1332:             <span class="ruby-identifier">old_milestone</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-value">? </span><span class="ruby-value str">&quot;None&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">name</span>
1333:             <span class="ruby-identifier">new_milestone</span> = <span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-value">? </span><span class="ruby-value str">&quot;None&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">name</span>
1334: 
1335:             <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Milestone&lt;/strong&gt;: #{old_milestone} -&gt; #{new_milestone}&quot;</span>
1336: 
1337:             <span class="ruby-identifier">old</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone</span>
1338: 
1339:             <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone</span> = <span class="ruby-identifier">milestone</span>
1340:             <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">save</span>
1341: 
1342:             <span class="ruby-identifier">old</span>.<span class="ruby-identifier">update_counts</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">old</span>
1343: 
1344:           <span class="ruby-keyword kw">end</span>
1345:         <span class="ruby-keyword kw">end</span>
1346:       <span class="ruby-keyword kw">when</span> <span class="ruby-value">5</span>
1347:         <span class="ruby-comment cmt"># User</span>
1348: 
1349:         <span class="ruby-identifier">old_users</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">users</span>.<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">u</span><span class="ruby-operator">|</span> <span class="ruby-identifier">u</span>.<span class="ruby-identifier">id</span>}.<span class="ruby-identifier">sort</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">','</span>)
1350:         <span class="ruby-identifier">old_users</span> = <span class="ruby-value str">&quot;0&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">old_users</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">old_users</span>.<span class="ruby-identifier">empty?</span>
1351: 
1352:         <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">task_owners</span>.<span class="ruby-identifier">destroy_all</span>
1353:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@group</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
1354:           <span class="ruby-identifier">u</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find</span>(<span class="ruby-ivar">@group</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;company_id = ?&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>])
1355:           <span class="ruby-identifier">to</span> = <span class="ruby-constant">TaskOwner</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">:user</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">u</span>, <span class="ruby-identifier">:task</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@task</span>)
1356:           <span class="ruby-identifier">to</span>.<span class="ruby-identifier">save</span>
1357: 
1358:           <span class="ruby-keyword kw">if</span>( <span class="ruby-identifier">old_users</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">u</span>.<span class="ruby-identifier">name</span> )
1359:             <span class="ruby-identifier">new_name</span> = <span class="ruby-identifier">u</span>.<span class="ruby-identifier">name</span>
1360:             <span class="ruby-identifier">body</span> = <span class="ruby-node">&quot;- &lt;strong&gt;Assignment&lt;/strong&gt;: #{new_name}\n&quot;</span>
1361:             <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">users</span>.<span class="ruby-identifier">reload</span>
1362:             <span class="ruby-identifier">update_type</span> = <span class="ruby-identifier">:reassigned</span>
1363:           <span class="ruby-keyword kw">end</span>
1364: 
1365:         <span class="ruby-keyword kw">end</span>
1366:         <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">save</span>
1367:       <span class="ruby-keyword kw">when</span> <span class="ruby-value">7</span>
1368:         <span class="ruby-comment cmt"># Status</span>
1369:         <span class="ruby-keyword kw">if</span>( <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@group</span> )
1370:           <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@group</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">2</span>
1371:             <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">completed_at</span> = <span class="ruby-keyword kw">nil</span>
1372:             <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>
1373:               <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_REVERTED</span>
1374:               <span class="ruby-identifier">update_type</span> = <span class="ruby-identifier">:reverted</span>
1375:             <span class="ruby-keyword kw">end</span>
1376:           <span class="ruby-keyword kw">else</span>
1377:             <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">completed_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">completed_at</span>.<span class="ruby-identifier">nil?</span>
1378:             <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">2</span>
1379:               <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_COMPLETED</span>
1380:               <span class="ruby-identifier">update_type</span> = <span class="ruby-identifier">:completed</span>
1381:             <span class="ruby-keyword kw">end</span>
1382:           <span class="ruby-keyword kw">end</span>
1383:           <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Status&lt;/strong&gt;: #{@task.status_type} -&gt; #{Task.status_types[@group]}\n&quot;</span>
1384:           <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status</span> = <span class="ruby-ivar">@group</span>
1385:           <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">save</span>
1386:         <span class="ruby-keyword kw">end</span>
1387:       <span class="ruby-keyword kw">when</span> <span class="ruby-value">10</span>
1388:         <span class="ruby-comment cmt"># Project / Milestone</span>
1389:         <span class="ruby-comment cmt"># task-group_44_15</span>
1390: 
1391:         <span class="ruby-identifier">project</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">find</span>(<span class="ruby-ivar">@group</span>)
1392:         <span class="ruby-identifier">old</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone</span>
1393: 
1394:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project_id</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@group</span>
1395:           <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Project&lt;/strong&gt;: #{@task.project.name} -&gt; #{project.name}\n&quot;</span>
1396:           <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project_id</span> = <span class="ruby-ivar">@group</span>
1397:         <span class="ruby-keyword kw">end</span>
1398: 
1399:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">elems</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">split</span>(<span class="ruby-value str">'_'</span>).<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">2</span>
1400:           <span class="ruby-identifier">milestone</span> = <span class="ruby-constant">Milestone</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">elems</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">split</span>(<span class="ruby-value str">'_'</span>)[<span class="ruby-value">2</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;project_id IN (#{current_project_ids})&quot;</span>])
1401: 
1402:           
1403:           <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone_id</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">id</span>
1404:             <span class="ruby-identifier">old_milestone</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-value">? </span><span class="ruby-value str">&quot;None&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">name</span>
1405:             <span class="ruby-identifier">new_milestone</span> = <span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-value">? </span><span class="ruby-value str">&quot;None&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">name</span>
1406:             <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Milestone&lt;/strong&gt;: #{old_milestone} -&gt; #{new_milestone}&quot;</span>
1407: 
1408:             <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone_id</span> = <span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">id</span>
1409: 
1410:           <span class="ruby-keyword kw">end</span>
1411:           <span class="ruby-ivar">@group</span> = <span class="ruby-node">&quot;#{@group}_#{milestone.id}&quot;</span>
1412:         <span class="ruby-keyword kw">else</span>
1413:           <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone_id</span>.<span class="ruby-identifier">nil?</span>
1414:             <span class="ruby-identifier">old_milestone</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-value">? </span><span class="ruby-value str">&quot;None&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">name</span>
1415:             <span class="ruby-identifier">new_milestone</span> = <span class="ruby-value str">&quot;None&quot;</span>
1416:             <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Milestone&lt;/strong&gt;: #{old_milestone} -&gt; #{new_milestone}&quot;</span>
1417:             <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone_id</span> = <span class="ruby-keyword kw">nil</span>
1418:           <span class="ruby-keyword kw">end</span>
1419:         <span class="ruby-keyword kw">end</span>
1420: 
1421:         <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">update_all</span>(<span class="ruby-node">&quot;customer_id = #{project.customer_id}, project_id = #{project.id}&quot;</span>, <span class="ruby-node">&quot;task_id = #{@task.id}&quot;</span>)
1422:         <span class="ruby-constant">ProjectFile</span>.<span class="ruby-identifier">update_all</span>(<span class="ruby-node">&quot;customer_id = #{project.customer_id}, project_id = #{project.id}&quot;</span>, <span class="ruby-node">&quot;task_id = #{@task.id}&quot;</span>)
1423: 
1424:         <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">save</span>
1425:         <span class="ruby-identifier">old</span>.<span class="ruby-identifier">update_counts</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">old</span>
1426:       <span class="ruby-keyword kw">end</span>
1427: 
1428:       <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">property</span> = <span class="ruby-constant">Property</span>.<span class="ruby-identifier">find_by_group_by</span>(<span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company</span>, <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:group_by</span>]))
1429:         <span class="ruby-identifier">old_value</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">property_value</span>(<span class="ruby-identifier">property</span>)
1430:         <span class="ruby-identifier">new_value</span> = <span class="ruby-identifier">property</span>.<span class="ruby-identifier">property_values</span>.<span class="ruby-identifier">find</span>(<span class="ruby-ivar">@group</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@group</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
1431:         <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">set_property_value</span>(<span class="ruby-identifier">property</span>, <span class="ruby-identifier">new_value</span>)
1432:         <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span>  <span class="ruby-node">&quot; - &lt;strong&gt;#{ property }&lt;/strong&gt;: #{ old_value } -&gt; #{ new_value }&quot;</span>
1433:       <span class="ruby-keyword kw">end</span>
1434: 
1435: 
1436:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">body</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
1437:         <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">reload</span>
1438:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">user</span> = <span class="ruby-identifier">current_user</span>
1439:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">company</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">company</span>
1440:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">customer</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">customer</span>
1441:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">project</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>
1442:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">task</span> = <span class="ruby-ivar">@task</span>
1443:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">started_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>
1444:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-value">0</span>
1445:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">body</span> = <span class="ruby-identifier">body</span>
1446:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">save</span>
1447:         <span class="ruby-constant">Notifications</span><span class="ruby-operator">::</span><span class="ruby-identifier">deliver_changed</span>( <span class="ruby-identifier">update_type</span>, <span class="ruby-ivar">@task</span>, <span class="ruby-identifier">current_user</span>, <span class="ruby-identifier">body</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/&lt;[^&gt;]*&gt;/</span>,<span class="ruby-value str">''</span>)) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">send_notifications?</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
1448:         <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; @task.id)}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
1449:       <span class="ruby-keyword kw">end</span>
1450: 
1451:     <span class="ruby-keyword kw">end</span>
1452: 
1453:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000166"><br/></a>
<div class="method_block"><h3>
<a href='#M000166'>


new

()

</a>
</h3>

<p class="source_link" id="M000166-show-link"><a onclick="toggle('M000166-source'); toggleText('M000166-link'); return false;" href="#" id="M000166-link">Show source...</a></p><div class="source" id="M000166-source"><pre>    <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 13</span>
13:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">new</span>
14:     <span class="ruby-ivar">@projects</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'name'</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;completed_at IS NULL&quot;</span>]).<span class="ruby-identifier">collect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> [ <span class="ruby-node">&quot;#{c.name} / #{c.customer.name}&quot;</span>, <span class="ruby-identifier">c</span>.<span class="ruby-identifier">id</span> ] <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">can?</span>(<span class="ruby-identifier">c</span>, <span class="ruby-value str">'create'</span>)  }.<span class="ruby-identifier">compact</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">nil?</span>
15: 
16:     <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@projects</span>.<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">1</span>] }.<span class="ruby-identifier">include?</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:last_project_id</span>].<span class="ruby-identifier">to_i</span>
17:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:last_project_id</span>] = <span class="ruby-keyword kw">nil</span>
18:     <span class="ruby-keyword kw">end</span>
19: 
20:     <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@projects</span>.<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">1</span>] }.<span class="ruby-identifier">include?</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project</span>].<span class="ruby-identifier">to_i</span>
21:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project</span>] = <span class="ruby-keyword kw">nil</span>
22:     <span class="ruby-keyword kw">end</span>
23:     
24:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@projects</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@projects</span>.<span class="ruby-identifier">empty?</span>
25:       <span class="ruby-identifier">flash</span>[<span class="ruby-value str">'notice'</span>] = <span class="ruby-identifier">_</span>(<span class="ruby-value str">&quot;You need to create a project to hold your tasks, or get access to create tasks in an existing project...&quot;</span>)
26:       <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">:controller</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'projects'</span>, <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'new'</span>
27:       <span class="ruby-keyword kw">return</span>
28:     <span class="ruby-keyword kw">else</span>
29:       <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">new</span>
30:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">company</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company</span>
31:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-value">0</span>
32:       <span class="ruby-ivar">@tags</span> = <span class="ruby-constant">Tag</span>.<span class="ruby-identifier">top_counts</span>({ <span class="ruby-identifier">:company_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>, <span class="ruby-identifier">:project_ids</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">current_project_ids</span>, <span class="ruby-identifier">:filter_hidden</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_hidden</span>]})
33:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">watchers</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">current_user</span>
34:     <span class="ruby-keyword kw">end</span>
35: 
36:     <span class="ruby-ivar">@notify_targets</span> = <span class="ruby-identifier">current_projects</span>.<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">users</span>.<span class="ruby-identifier">collect</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">:name</span>) }.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>
37:     <span class="ruby-ivar">@notify_targets</span> <span class="ruby-operator">+=</span> <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;project_id IN (#{current_project_ids}) AND notify_emails IS NOT NULL and notify_emails &lt;&gt; ''&quot;</span>]).<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">notify_emails</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">','</span>).<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">strip</span> } }
38:     <span class="ruby-ivar">@notify_targets</span> = <span class="ruby-ivar">@notify_targets</span>.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>
39:     <span class="ruby-ivar">@notify_targets</span> <span class="ruby-operator">||=</span> []
40:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000211"><br/></a>
<div class="method_block"><h3>
<a href='#M000211'>


order_todos

()

</a>
</h3>

<p class="source_link" id="M000211-show-link"><a onclick="toggle('M000211-source'); toggleText('M000211-link'); return false;" href="#" id="M000211-link">Show source...</a></p><div class="source" id="M000211-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1703</span>
1703:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">order_todos</span>
1704:     <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;id = ? AND project_id IN (#{current_project_ids})&quot;</span>, <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>]])
1705:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">todos</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;completed_at IS NULL&quot;</span>]).<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">todo</span><span class="ruby-operator">|</span>
1706:       <span class="ruby-identifier">todo</span>.<span class="ruby-identifier">position</span> = <span class="ruby-identifier">params</span>[<span class="ruby-node">&quot;todo-tasks-#{@task.id}&quot;</span>].<span class="ruby-identifier">index</span>(<span class="ruby-identifier">todo</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span>) <span class="ruby-operator">+</span> <span class="ruby-value">1</span>
1707:       <span class="ruby-identifier">todo</span>.<span class="ruby-identifier">save</span>
1708:     <span class="ruby-keyword kw">end</span>
1709:     <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1710:       <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-node">&quot;todo-#{@task.dom_id}&quot;</span>)
1711:     <span class="ruby-keyword kw">end</span>
1712:     <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; @task.id)}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
1713:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000208"><br/></a>
<div class="method_block"><h3>
<a href='#M000208'>


pause_work_ajax

()

</a>
</h3>

<p class="source_link" id="M000208-show-link"><a onclick="toggle('M000208-source'); toggleText('M000208-link'); return false;" href="#" id="M000208-link">Show source...</a></p><div class="source" id="M000208-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1597</span>
1597:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">pause_work_ajax</span>
1598:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@current_sheet</span> 
1599:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">paused_at</span>
1600:         <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">paused_duration</span> <span class="ruby-operator">+=</span> (<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">paused_at</span>).<span class="ruby-identifier">to_i</span>
1601:         <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">paused_at</span> = <span class="ruby-keyword kw">nil</span>
1602:       <span class="ruby-keyword kw">else</span>
1603:         <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">paused_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>
1604:       <span class="ruby-keyword kw">end</span>
1605:       <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">save</span>
1606:     <span class="ruby-keyword kw">else</span> 
1607:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:nothing</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>
1608:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(0, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; params[:id])}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
1609:       <span class="ruby-keyword kw">return</span>
1610:     <span class="ruby-keyword kw">end</span>
1611:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000204"><br/></a>
<div class="method_block"><h3>
<a href='#M000204'>


quick_add

()

</a>
</h3>

<p class="source_link" id="M000204-show-link"><a onclick="toggle('M000204-source'); toggleText('M000204-link'); return false;" href="#" id="M000204-link">Show source...</a></p><div class="source" id="M000204-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1470</span>
1470:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">quick_add</span>
1471:     <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">new</span>
1472:     <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1473:       <span class="ruby-identifier">page</span>.<span class="ruby-identifier">replace_html</span> <span class="ruby-value str">'quick_add_container'</span>, <span class="ruby-identifier">:partial</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'quick_add'</span>
1474:       <span class="ruby-identifier">page</span>.<span class="ruby-identifier">show</span>(<span class="ruby-value str">'quick_add_container'</span>)
1475:       <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-value str">&quot;quick_add_container&quot;</span>, <span class="ruby-identifier">:duration</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span><span class="ruby-value">.5</span>)
1476:     <span class="ruby-keyword kw">end</span>
1477:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000175"><br/></a>
<div class="method_block"><h3>
<a href='#M000175'>


repeat_task

(task)

</a>
</h3>
<p>
def edit_ajax
</p>
<pre>
  self.edit
  render :action =&gt; 'edit', :layout =&gt; false
</pre>
<p>
end
</p>

<p class="source_link" id="M000175-show-link"><a onclick="toggle('M000175-source'); toggleText('M000175-link'); return false;" href="#" id="M000175-link">Show source...</a></p><div class="source" id="M000175-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 382</span>
382:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">repeat_task</span>(<span class="ruby-identifier">task</span>)
383:     <span class="ruby-ivar">@repeat</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">new</span>
384:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">status</span> = <span class="ruby-value">0</span>
385:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">project_id</span> = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">project_id</span>
386:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">company_id</span> = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">company_id</span>
387:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">name</span> = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">name</span>
388:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">repeat</span> = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">repeat</span>
389:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">requested_by</span> = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">requested_by</span>
390:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">creator_id</span> = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">creator_id</span>
391:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">set_tags</span>(<span class="ruby-identifier">task</span>.<span class="ruby-identifier">tags</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">name</span>}.<span class="ruby-identifier">join</span>(<span class="ruby-value str">', '</span>))
392:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">set_task_num</span>(<span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>)
393:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">duration</span>
394:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">notify_emails</span> = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">notify_emails</span>
395:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">milestone_id</span> = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">milestone_id</span>
396:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">hidden</span> = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">hidden</span>
397:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">due_at</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">due_at</span>
398:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">due_at</span> = <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">next_repeat_date</span>
399:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">description</span> = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">description</span>
400: 
401:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">save</span>
402:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">reload</span>
403: 
404:     <span class="ruby-identifier">task</span>.<span class="ruby-identifier">notifications</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">w</span><span class="ruby-operator">|</span>
405:       <span class="ruby-identifier">n</span> = <span class="ruby-constant">Notification</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">:user</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">w</span>.<span class="ruby-identifier">user</span>, <span class="ruby-identifier">:task</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@repeat</span>)
406:       <span class="ruby-identifier">n</span>.<span class="ruby-identifier">save</span>
407:     <span class="ruby-keyword kw">end</span>
408: 
409:     <span class="ruby-identifier">task</span>.<span class="ruby-identifier">task_owners</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">o</span><span class="ruby-operator">|</span>
410:       <span class="ruby-identifier">to</span> = <span class="ruby-constant">TaskOwner</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">:user</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">user</span>, <span class="ruby-identifier">:task</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@repeat</span>)
411:       <span class="ruby-identifier">to</span>.<span class="ruby-identifier">save</span>
412:     <span class="ruby-keyword kw">end</span>
413: 
414:     <span class="ruby-identifier">task</span>.<span class="ruby-identifier">dependencies</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">d</span><span class="ruby-operator">|</span>
415:         <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">dependencies</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">d</span>
416:     <span class="ruby-keyword kw">end</span>
417: 
418:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">save</span>
419: 
420:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000200"><br/></a>
<div class="method_block"><h3>
<a href='#M000200'>


save_log

()

</a>
</h3>

<p class="source_link" id="M000200-show-link"><a onclick="toggle('M000200-source'); toggleText('M000200-link'); return false;" href="#" id="M000200-link">Show source...</a></p><div class="source" id="M000200-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1166</span>
1166:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">save_log</span>
1167:     <span class="ruby-ivar">@log</span> = <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">find</span>( <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;company_id = ?&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>] )
1168:     
1169:     <span class="ruby-identifier">old_duration</span> = <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">duration</span>
1170:     <span class="ruby-identifier">old_note</span> = <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">body</span>
1171:     
1172:     <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-identifier">:log</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-identifier">:log</span>][<span class="ruby-identifier">:started_at</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:log</span>][<span class="ruby-identifier">:started_at</span>].<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
1173:       <span class="ruby-keyword kw">begin</span>
1174:         <span class="ruby-identifier">due_date</span> = <span class="ruby-constant">DateTime</span>.<span class="ruby-identifier">strptime</span>( <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:log</span>][<span class="ruby-identifier">:started_at</span>], <span class="ruby-node">&quot;#{current_user.date_format} #{current_user.time_format}&quot;</span> )
1175:         <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:log</span>][<span class="ruby-identifier">:started_at</span>] = <span class="ruby-identifier">tz</span>.<span class="ruby-identifier">local_to_utc</span>(<span class="ruby-identifier">due_date</span>)
1176:       <span class="ruby-keyword kw">rescue</span>
1177:         <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:log</span>][<span class="ruby-identifier">:started_at</span>] = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>
1178:       <span class="ruby-keyword kw">end</span>
1179:     <span class="ruby-keyword kw">end</span>
1180: 
1181:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">update_attributes</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:log</span>])
1182: 
1183: 
1184:       <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">started_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span> <span class="ruby-keyword kw">if</span>(<span class="ruby-ivar">@log</span>.<span class="ruby-identifier">started_at</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> (<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:log</span>] <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:log</span>][<span class="ruby-identifier">:started_at</span>].<span class="ruby-identifier">blank?</span>)) )
1185: 
1186:       <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-identifier">parse_time</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:log</span>][<span class="ruby-identifier">:duration</span>])
1187:       <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-identifier">old_duration</span> <span class="ruby-keyword kw">if</span>((<span class="ruby-identifier">old_duration</span> <span class="ruby-operator">/</span> <span class="ruby-value">60</span>) <span class="ruby-operator">==</span> (<span class="ruby-ivar">@log</span>.<span class="ruby-identifier">duration</span> <span class="ruby-operator">/</span> <span class="ruby-value">60</span>)) 
1188: 
1189:       <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">task</span>.<span class="ruby-identifier">updated_by_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
1190: 
1191:       <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">comment</span> = <span class="ruby-operator">!</span><span class="ruby-ivar">@log</span>.<span class="ruby-identifier">body</span>.<span class="ruby-identifier">blank?</span>
1192:       
1193:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:status</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">task</span>.<span class="ruby-identifier">status</span>
1194: 
1195:         <span class="ruby-identifier">status_type</span> = <span class="ruby-identifier">:completed</span>
1196: 
1197:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:status</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">2</span>
1198:           <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_WORK_ADDED</span> 
1199:           <span class="ruby-identifier">status_type</span> = <span class="ruby-identifier">:updated</span>
1200:         <span class="ruby-keyword kw">end</span> 
1201:         
1202:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:status</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">2</span>
1203:           <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_COMPLETED</span> 
1204:           <span class="ruby-identifier">status_type</span> = <span class="ruby-identifier">:completed</span>
1205:         <span class="ruby-keyword kw">end</span> 
1206: 
1207:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:status</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">2</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>
1208:           <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_REVERTED</span> 
1209:           <span class="ruby-identifier">status_type</span>= <span class="ruby-identifier">:reverted</span>
1210:         <span class="ruby-keyword kw">end</span> 
1211:         
1212:         <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">task</span>.<span class="ruby-identifier">status</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:status</span>].<span class="ruby-identifier">to_i</span>
1213:         <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">task</span>.<span class="ruby-identifier">updated_by_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
1214:         <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">task</span>.<span class="ruby-identifier">completed_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>
1215:         <span class="ruby-constant">Notifications</span><span class="ruby-operator">::</span><span class="ruby-identifier">deliver_changed</span>( <span class="ruby-identifier">status_type</span>, <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">task</span>, <span class="ruby-identifier">current_user</span>, <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:log</span>][<span class="ruby-identifier">:body</span>] ) <span class="ruby-keyword kw">if</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value str">'notify'</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
1216: 
1217:       <span class="ruby-keyword kw">elsif</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-identifier">:log</span>][<span class="ruby-identifier">:body</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:log</span>][<span class="ruby-identifier">:body</span>] <span class="ruby-operator">!=</span> <span class="ruby-identifier">old_note</span> <span class="ruby-operator">&amp;&amp;</span>  <span class="ruby-identifier">params</span>[<span class="ruby-value str">'notify'</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
1218:         <span class="ruby-constant">Notifications</span><span class="ruby-operator">::</span><span class="ruby-identifier">deliver_changed</span>( <span class="ruby-identifier">:comment</span>, <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">task</span>, <span class="ruby-identifier">current_user</span>, <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:log</span>][<span class="ruby-identifier">:body</span>].<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/&lt;[^&gt;]*&gt;/</span>,<span class="ruby-value str">''</span>)) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
1219:       <span class="ruby-keyword kw">end</span>
1220: 
1221:       <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">task</span>.<span class="ruby-identifier">save</span>
1222:       <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">save</span>
1223: 
1224:       <span class="ruby-identifier">flash</span>[<span class="ruby-value str">'notice'</span>] = <span class="ruby-identifier">_</span>(<span class="ruby-value str">&quot;Log entry saved...&quot;</span>)
1225:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; @log.task.id)}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
1226:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'activities', :action =&gt; 'refresh')}');&quot;</span>, [<span class="ruby-node">&quot;activity_#{current_user.company_id}&quot;</span>])
1227: 
1228:     <span class="ruby-keyword kw">end</span>
1229:     <span class="ruby-identifier">redirect_from_last</span>
1230:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000215"><br/></a>
<div class="method_block"><h3>
<a href='#M000215'>


save_tag

()

</a>
</h3>

<p class="source_link" id="M000215-show-link"><a onclick="toggle('M000215-source'); toggleText('M000215-link'); return false;" href="#" id="M000215-link">Show source...</a></p><div class="source" id="M000215-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1760</span>
1760:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">save_tag</span>
1761:     <span class="ruby-ivar">@tag</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company</span>.<span class="ruby-identifier">tags</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>]) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
1762:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@tag</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-value str">'tag-name'</span>].<span class="ruby-identifier">blank?</span>
1763:       <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Tag</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-identifier">:company_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>, <span class="ruby-identifier">:name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value str">'tag-name'</span>])
1764:         
1765:         <span class="ruby-ivar">@existing</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company</span>.<span class="ruby-identifier">tags</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;name = ?&quot;</span>, <span class="ruby-identifier">params</span>[<span class="ruby-value str">'tag-name'</span>]] )
1766:         <span class="ruby-ivar">@tag</span>.<span class="ruby-identifier">tasks</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
1767:           <span class="ruby-ivar">@existing</span>.<span class="ruby-identifier">tasks</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">t</span>
1768:         <span class="ruby-keyword kw">end</span> 
1769:         <span class="ruby-ivar">@tag</span>.<span class="ruby-identifier">destroy</span>
1770: 
1771:         <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1772:           <span class="ruby-identifier">page</span>[<span class="ruby-ivar">@tag</span>.<span class="ruby-identifier">dom_id</span>].<span class="ruby-identifier">remove</span>
1773:           <span class="ruby-ivar">@tag</span> = <span class="ruby-ivar">@existing</span>
1774:           <span class="ruby-identifier">page</span>[<span class="ruby-ivar">@tag</span>.<span class="ruby-identifier">dom_id</span>].<span class="ruby-identifier">replace</span> <span class="ruby-identifier">:partial</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'edit_tag_row'</span>
1775:         <span class="ruby-keyword kw">end</span> 
1776:         
1777:       <span class="ruby-keyword kw">else</span> 
1778:         <span class="ruby-ivar">@tag</span>.<span class="ruby-identifier">name</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value str">'tag-name'</span>]
1779:         <span class="ruby-ivar">@tag</span>.<span class="ruby-identifier">save</span>
1780:         <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1781:           <span class="ruby-identifier">page</span>[<span class="ruby-ivar">@tag</span>.<span class="ruby-identifier">dom_id</span>].<span class="ruby-identifier">replace</span> <span class="ruby-identifier">:partial</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'edit_tag_row'</span>
1782:         <span class="ruby-keyword kw">end</span> 
1783:       <span class="ruby-keyword kw">end</span> 
1784:     <span class="ruby-keyword kw">else</span> 
1785:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:nothing</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>
1786:     <span class="ruby-keyword kw">end</span> 
1787:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000207"><br/></a>
<div class="method_block"><h3>
<a href='#M000207'>


shortlist

()

</a>
</h3>

<p class="source_link" id="M000207-show-link"><a onclick="toggle('M000207-source'); toggleText('M000207-link'); return false;" href="#" id="M000207-link">Show source...</a></p><div class="source" id="M000207-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1569</span>
1569:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">shortlist</span>
1570:     <span class="ruby-identifier">tmp</span> = { }
1571:     <span class="ruby-comment cmt"># Save filtering</span>
1572:     [<span class="ruby-identifier">:filter_customer</span>, <span class="ruby-identifier">:filter_milestone</span>, <span class="ruby-identifier">:filter_project</span>, <span class="ruby-identifier">:filter_user</span>, <span class="ruby-identifier">:filter_hidden</span>, <span class="ruby-identifier">:filter_status</span>, <span class="ruby-identifier">:group_by</span>, <span class="ruby-identifier">:hide_deferred</span>, <span class="ruby-identifier">:hide_dependencies</span>, <span class="ruby-identifier">:sort</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
1573:       <span class="ruby-identifier">tmp</span>[<span class="ruby-identifier">v</span>] = <span class="ruby-identifier">session</span>[<span class="ruby-identifier">v</span>]
1574:     <span class="ruby-keyword kw">end</span>
1575: 
1576:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project</span>] = <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project_short</span>] <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project_short</span>]
1577:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_customer</span>] = <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_customer_short</span>] <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project_short</span>]
1578:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_milestone</span>] = <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_milestone_short</span>] <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project_short</span>]
1579:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_user</span>] = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span>
1580:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_hidden</span>] = <span class="ruby-value str">&quot;0&quot;</span>
1581:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_status</span>] = <span class="ruby-value str">&quot;0&quot;</span>
1582:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:group_by</span>] = <span class="ruby-value str">&quot;0&quot;</span>
1583:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:hide_deferred</span>] = <span class="ruby-value str">&quot;1&quot;</span>
1584:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:hide_dependencies</span>] = <span class="ruby-value str">&quot;1&quot;</span>
1585:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:sort</span>] = <span class="ruby-value str">&quot;0&quot;</span>
1586: 
1587:     <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">list</span>
1588: 
1589:     <span class="ruby-comment cmt"># Restore filtering</span>
1590:     [<span class="ruby-identifier">:filter_customer</span>, <span class="ruby-identifier">:filter_milestone</span>, <span class="ruby-identifier">:filter_project</span>, <span class="ruby-identifier">:filter_user</span>, <span class="ruby-identifier">:filter_hidden</span>, <span class="ruby-identifier">:filter_status</span>, <span class="ruby-identifier">:group_by</span>, <span class="ruby-identifier">:hide_deferred</span>, <span class="ruby-identifier">:hide_dependencies</span>, <span class="ruby-identifier">:sort</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
1591:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">v</span>] = <span class="ruby-identifier">tmp</span>[<span class="ruby-identifier">v</span>]
1592:     <span class="ruby-keyword kw">end</span>
1593: 
1594:     <span class="ruby-identifier">render</span> <span class="ruby-identifier">:layout</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'shortlist'</span>
1595:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000183"><br/></a>
<div class="method_block"><h3>
<a href='#M000183'>


start_work

()

</a>
</h3>

<p class="source_link" id="M000183-show-link"><a onclick="toggle('M000183-source'); toggleText('M000183-link'); return false;" href="#" id="M000183-link">Show source...</a></p><div class="source" id="M000183-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 891</span>
891:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">start_work</span>
892:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@current_sheet</span>
893:       <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">swap_work_ajax</span>
894:     <span class="ruby-keyword kw">end</span>
895:     
896:     <span class="ruby-identifier">task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;company_id = ?&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>])
897:     <span class="ruby-identifier">sheet</span> = <span class="ruby-constant">Sheet</span>.<span class="ruby-identifier">new</span>
898: 
899:     <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">task</span> = <span class="ruby-identifier">task</span>
900:     <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">user</span> = <span class="ruby-identifier">current_user</span>
901:     <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">project</span> = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">project</span>
902:     <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">save</span>
903: 
904:     <span class="ruby-identifier">task</span>.<span class="ruby-identifier">status</span> = <span class="ruby-value">1</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
905:     <span class="ruby-identifier">task</span>.<span class="ruby-identifier">save</span>
906: 
907:     <span class="ruby-ivar">@current_sheet</span> = <span class="ruby-identifier">sheet</span>
908: 
909:     <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; task.id)}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
910: 
911:     <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">xhr?</span>
912:     <span class="ruby-identifier">redirect_from_last</span>
913:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000184"><br/></a>
<div class="method_block"><h3>
<a href='#M000184'>


start_work_ajax

()

</a>
</h3>

<p class="source_link" id="M000184-show-link"><a onclick="toggle('M000184-source'); toggleText('M000184-link'); return false;" href="#" id="M000184-link">Show source...</a></p><div class="source" id="M000184-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 915</span>
915:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">start_work_ajax</span>
916:     <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">start_work</span>
917:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000185"><br/></a>
<div class="method_block"><h3>
<a href='#M000185'>


start_work_edit_ajax

()

</a>
</h3>

<p class="source_link" id="M000185-show-link"><a onclick="toggle('M000185-source'); toggleText('M000185-link'); return false;" href="#" id="M000185-link">Show source...</a></p><div class="source" id="M000185-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 919</span>
919:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">start_work_edit_ajax</span>
920:     <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">start_work</span>
921:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000189"><br/></a>
<div class="method_block"><h3>
<a href='#M000189'>


stop_work

()

</a>
</h3>

<p class="source_link" id="M000189-show-link"><a onclick="toggle('M000189-source'); toggleText('M000189-link'); return false;" href="#" id="M000189-link">Show source...</a></p><div class="source" id="M000189-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1000</span>
1000:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">stop_work</span>
1001:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@current_sheet</span>
1002:       <span class="ruby-identifier">worklog</span> = <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">new</span>
1003:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">user</span> = <span class="ruby-identifier">current_user</span>
1004:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">company</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company</span>
1005:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">project</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">project</span>
1006:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">task</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">task</span>
1007:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">customer</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">customer</span>
1008:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">started_at</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">created_at</span>
1009:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">duration</span>
1010:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">paused_duration</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">paused_duration</span>
1011:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">body</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">body</span>
1012:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_WORK_ADDED</span>
1013:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">comment</span> = <span class="ruby-keyword kw">true</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">body</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">body</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span> 
1014:       
1015:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">save</span>
1016:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">task</span>.<span class="ruby-identifier">updated_by_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
1017:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">task</span>.<span class="ruby-identifier">save</span>
1018: 
1019:         <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">destroy</span>
1020:         <span class="ruby-identifier">flash</span>[<span class="ruby-value str">'notice'</span>] = <span class="ruby-identifier">_</span>(<span class="ruby-value str">&quot;Log entry saved...&quot;</span>)
1021:         <span class="ruby-ivar">@log</span> = <span class="ruby-identifier">worklog</span>
1022:         <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">started_at</span> = <span class="ruby-identifier">tz</span>.<span class="ruby-identifier">utc_to_local</span>(<span class="ruby-ivar">@log</span>.<span class="ruby-identifier">started_at</span>)
1023:         <span class="ruby-ivar">@task</span> = <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">task</span>
1024:         <span class="ruby-identifier">render</span> <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'edit_log'</span>
1025:         <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; @task.id)}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
1026:       <span class="ruby-keyword kw">else</span>
1027:         <span class="ruby-identifier">flash</span>[<span class="ruby-value str">'notice'</span>] = <span class="ruby-identifier">_</span>(<span class="ruby-value str">&quot;Unable to save log entry...&quot;</span>)
1028:         <span class="ruby-identifier">redirect_from_last</span>
1029:       <span class="ruby-keyword kw">end</span>
1030:     <span class="ruby-keyword kw">else</span>
1031:       <span class="ruby-ivar">@current_sheet</span> = <span class="ruby-keyword kw">nil</span>
1032:       <span class="ruby-identifier">flash</span>[<span class="ruby-value str">'notice'</span>] = <span class="ruby-identifier">_</span>(<span class="ruby-value str">&quot;Log entry already saved from another browser instance.&quot;</span>)
1033:       <span class="ruby-identifier">redirect_from_last</span>
1034:     <span class="ruby-keyword kw">end</span>
1035: 
1036:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000190"><br/></a>
<div class="method_block"><h3>
<a href='#M000190'>


stop_work_shortlist

()

</a>
</h3>

<p class="source_link" id="M000190-show-link"><a onclick="toggle('M000190-source'); toggleText('M000190-link'); return false;" href="#" id="M000190-link">Show source...</a></p><div class="source" id="M000190-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1038</span>
1038:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">stop_work_shortlist</span>
1039:     <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@current_sheet</span>
1040:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:nothing</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>
1041:       <span class="ruby-keyword kw">return</span>
1042:     <span class="ruby-keyword kw">end</span>
1043: 
1044:     <span class="ruby-ivar">@task</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">task</span>
1045:     <span class="ruby-identifier">swap_work_ajax</span>
1046:     <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; @task.id)}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
1047: <span class="ruby-comment cmt">#    redirect_to :action =&gt; 'shortlist'</span>
1048:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000187"><br/></a>
<div class="method_block"><h3>
<a href='#M000187'>


swap_work_ajax

()

</a>
</h3>

<p class="source_link" id="M000187-show-link"><a onclick="toggle('M000187-source'); toggleText('M000187-link'); return false;" href="#" id="M000187-link">Show source...</a></p><div class="source" id="M000187-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 935</span>
935:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">swap_work_ajax</span>
936:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@current_sheet</span>
937: 
938:       <span class="ruby-ivar">@old_task</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">task</span>
939: 
940:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">nil?</span>
941:         <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">destroy</span>
942:         <span class="ruby-ivar">@current_sheet</span> = <span class="ruby-keyword kw">nil</span>
943:         <span class="ruby-identifier">redirect_from_last</span>
944:       <span class="ruby-keyword kw">end</span>
945: 
946: <span class="ruby-comment cmt">#      @old_task.updated_by_id = current_user.id</span>
947: <span class="ruby-comment cmt">#      @old_task.save</span>
948: 
949:       <span class="ruby-identifier">worklog</span> = <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">new</span>
950:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">user</span> = <span class="ruby-identifier">current_user</span>
951:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">company</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company</span>
952:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">project</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">project</span>
953:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">task</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">task</span>
954:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">customer</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">customer</span>
955:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">started_at</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">created_at</span>
956:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">duration</span>
957:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">paused_duration</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">paused_duration</span>
958:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">body</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">body</span>
959:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">comment</span> = <span class="ruby-keyword kw">true</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">body</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">body</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
960:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_WORK_ADDED</span>
961:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">save</span>
962:         <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">destroy</span>
963:         <span class="ruby-identifier">flash</span>[<span class="ruby-value str">'notice'</span>] = <span class="ruby-identifier">_</span>(<span class="ruby-value str">&quot;Log entry saved...&quot;</span>)
964:         <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; @old_task.id)}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
965:         <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'activities', :action =&gt; 'refresh')}');&quot;</span>, [<span class="ruby-node">&quot;activity_#{current_user.company_id}&quot;</span>])
966:         <span class="ruby-ivar">@current_sheet</span> = <span class="ruby-keyword kw">nil</span>
967:       <span class="ruby-keyword kw">else</span>
968:         <span class="ruby-identifier">flash</span>[<span class="ruby-value str">'notice'</span>] = <span class="ruby-identifier">_</span>(<span class="ruby-value str">&quot;Unable to save log entry...&quot;</span>)
969:         <span class="ruby-identifier">redirect_from_last</span>
970:       <span class="ruby-keyword kw">end</span>
971: 
972:     <span class="ruby-keyword kw">end</span>
973:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000213"><br/></a>
<div class="method_block"><h3>
<a href='#M000213'>


tags

()

</a>
</h3>

<p class="source_link" id="M000213-show-link"><a onclick="toggle('M000213-source'); toggleText('M000213-link'); return false;" href="#" id="M000213-link">Show source...</a></p><div class="source" id="M000213-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1744</span>
1744:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">tags</span>
1745:     <span class="ruby-ivar">@tags</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company</span>.<span class="ruby-identifier">tags</span>
1746:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000210"><br/></a>
<div class="method_block"><h3>
<a href='#M000210'>


todo_check_ajax

()

</a>
</h3>

<p class="source_link" id="M000210-show-link"><a onclick="toggle('M000210-source'); toggleText('M000210-link'); return false;" href="#" id="M000210-link">Show source...</a></p><div class="source" id="M000210-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1656</span>
1656:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">todo_check_ajax</span>
1657:     <span class="ruby-keyword kw">begin</span>
1658:       <span class="ruby-ivar">@todo</span> = <span class="ruby-constant">Todo</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>])
1659:     <span class="ruby-keyword kw">rescue</span>
1660:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:nothing</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>
1661:       <span class="ruby-keyword kw">return</span>
1662:     <span class="ruby-keyword kw">end</span>
1663:     <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;id = ? AND project_id IN (#{current_project_ids})&quot;</span>, <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">task_id</span>])
1664:     <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@task</span>
1665:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1666:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-node">&quot;todos-#{params[:id]}&quot;</span>, <span class="ruby-identifier">:duration</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span><span class="ruby-value">.5</span>, <span class="ruby-identifier">:startcolor</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;#ff9999&quot;</span>)
1667:       <span class="ruby-keyword kw">end</span>
1668:       <span class="ruby-keyword kw">return</span>
1669:     <span class="ruby-keyword kw">end</span>
1670: 
1671:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">completed_at</span>
1672:       <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">completed_at</span> = <span class="ruby-keyword kw">nil</span>
1673:     <span class="ruby-keyword kw">else</span>
1674:       <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">completed_by_user</span> = <span class="ruby-identifier">current_user</span>
1675:       <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">completed_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>
1676:     <span class="ruby-keyword kw">end</span>
1677:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">save</span>
1678:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1679:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">completed_at</span>
1680:           <span class="ruby-identifier">page</span>.<span class="ruby-identifier">remove</span> <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">dom_id</span>
1681:           <span class="ruby-identifier">page</span>.<span class="ruby-identifier">insert_html</span> <span class="ruby-identifier">:top</span>, <span class="ruby-node">&quot;todo-done-#{@task.dom_id}&quot;</span>, <span class="ruby-identifier">:partial</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;tasks/todo_row&quot;</span>
1682:           <span class="ruby-identifier">page</span>.<span class="ruby-identifier">replace_html</span> <span class="ruby-node">&quot;todo-status-#{@task.dom_id}&quot;</span>, <span class="ruby-identifier">link_to_function</span>( <span class="ruby-node">&quot;#{@task.todo_status}&quot;</span>, <span class="ruby-node">&quot;Element.toggle('todo-container-#{@task.dom_id}');&quot;</span>, <span class="ruby-identifier">:class</span> =<span class="ruby-operator">&gt;</span> (<span class="ruby-ivar">@task</span>.<span class="ruby-identifier">todos</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-value">? </span><span class="ruby-value str">&quot;todo-status-link-empty&quot;</span> <span class="ruby-operator">:</span><span class="ruby-value str">&quot;todo-status-link&quot;</span>))
1683:         <span class="ruby-keyword kw">else</span>
1684:           <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">move_to_bottom</span>
1685:           <span class="ruby-identifier">page</span>.<span class="ruby-identifier">remove</span> <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">dom_id</span>
1686:           <span class="ruby-identifier">page</span>.<span class="ruby-identifier">insert_html</span> <span class="ruby-identifier">:bottom</span>, <span class="ruby-node">&quot;todo-#{@task.dom_id}&quot;</span>, <span class="ruby-identifier">:partial</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;tasks/todo_row&quot;</span>
1687:           <span class="ruby-identifier">page</span>.<span class="ruby-identifier">replace_html</span> <span class="ruby-node">&quot;todo-status-#{@task.dom_id}&quot;</span>, <span class="ruby-identifier">link_to_function</span>( <span class="ruby-node">&quot;#{@task.todo_status}&quot;</span>, <span class="ruby-node">&quot;Element.toggle('todo-container-#{@task.dom_id}');&quot;</span>, <span class="ruby-identifier">:class</span> =<span class="ruby-operator">&gt;</span> (<span class="ruby-ivar">@task</span>.<span class="ruby-identifier">todos</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-value">? </span><span class="ruby-value str">&quot;todo-status-link-empty&quot;</span> <span class="ruby-operator">:</span><span class="ruby-value str">&quot;todo-status-link&quot;</span>))
1688:         <span class="ruby-keyword kw">end</span>
1689:         <span class="ruby-identifier">page</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;Sortable.create('todo-#{@task.dom_id}', {containment:'todo-#{@task.dom_id}', format:/^[^-]*-(.*)$/, onUpdate:function(){new Ajax.Request('/tasks/order_todos/#{@task.id}', {asynchronous:true, evalScripts:true, parameters:Sortable.serialize('todo-#{@task.dom_id}')})}, only:'todo-active'})&quot;</span>
1690:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">call</span>(<span class="ruby-value str">&quot;updateTooltips&quot;</span>)
1691:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-node">&quot;#{@todo.dom_id}&quot;</span>, <span class="ruby-identifier">:duration</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">1.5</span>)
1692:       <span class="ruby-keyword kw">end</span>
1693:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; @task.id)}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
1694:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'activities', :action =&gt; 'refresh')}');&quot;</span>, [<span class="ruby-node">&quot;activity_#{current_user.company_id}&quot;</span>])
1695:     <span class="ruby-keyword kw">else</span>
1696:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1697:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-node">&quot;#{@todo.dom_id}&quot;</span>, <span class="ruby-identifier">:duration</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span><span class="ruby-value">.5</span>, <span class="ruby-identifier">:startcolor</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;#ff9999&quot;</span>)
1698:       <span class="ruby-keyword kw">end</span>
1699:     <span class="ruby-keyword kw">end</span>
1700: 
1701:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000212"><br/></a>
<div class="method_block"><h3>
<a href='#M000212'>


todo_delete_ajax

()

</a>
</h3>

<p class="source_link" id="M000212-show-link"><a onclick="toggle('M000212-source'); toggleText('M000212-link'); return false;" href="#" id="M000212-link">Show source...</a></p><div class="source" id="M000212-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1715</span>
1715:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">todo_delete_ajax</span>
1716:     <span class="ruby-keyword kw">begin</span>
1717:       <span class="ruby-ivar">@todo</span> = <span class="ruby-constant">Todo</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>])
1718:     <span class="ruby-keyword kw">rescue</span>
1719:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1720:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-node">&quot;todos-#{params[:id]}&quot;</span>, <span class="ruby-identifier">:duration</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span><span class="ruby-value">.5</span>, <span class="ruby-identifier">:startcolor</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;#ff9999&quot;</span>)
1721:       <span class="ruby-keyword kw">end</span>
1722:       <span class="ruby-keyword kw">return</span>
1723:     <span class="ruby-keyword kw">end</span>
1724:     <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;id = ? AND project_id IN (#{current_project_ids})&quot;</span>, <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">task_id</span>])
1725: 
1726:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>
1727:       <span class="ruby-identifier">element</span> = <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">dom_id</span>
1728:       <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">destroy</span>
1729:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1730:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span> <span class="ruby-identifier">:fade</span>, <span class="ruby-identifier">element</span>
1731:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">replace_html</span> <span class="ruby-node">&quot;todo-status-#{@task.dom_id}&quot;</span>, <span class="ruby-identifier">link_to_function</span>( <span class="ruby-node">&quot;#{@task.todo_status}&quot;</span>, <span class="ruby-node">&quot;Element.toggle('todo-container-#{@task.dom_id}');&quot;</span>, <span class="ruby-identifier">:class</span> =<span class="ruby-operator">&gt;</span> (<span class="ruby-ivar">@task</span>.<span class="ruby-identifier">todos</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-value">? </span><span class="ruby-value str">&quot;todo-status-link-empty&quot;</span> <span class="ruby-operator">:</span><span class="ruby-value str">&quot;todo-status-link&quot;</span>))
1732:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">delay</span>(<span class="ruby-value">1.0</span>) <span class="ruby-keyword kw">do</span>
1733:           <span class="ruby-identifier">page</span>.<span class="ruby-identifier">remove</span> <span class="ruby-identifier">element</span>
1734:         <span class="ruby-keyword kw">end</span>
1735:       <span class="ruby-keyword kw">end</span>
1736:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; @task.id)}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
1737:     <span class="ruby-keyword kw">else</span>
1738:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1739:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-node">&quot;todos-#{params[:id]}&quot;</span>, <span class="ruby-identifier">:duration</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span><span class="ruby-value">.5</span>, <span class="ruby-identifier">:startcolor</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;#ff9999&quot;</span>)
1740:       <span class="ruby-keyword kw">end</span>
1741:     <span class="ruby-keyword kw">end</span>
1742:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000203"><br/></a>
<div class="method_block"><h3>
<a href='#M000203'>


toggle_history

()

</a>
</h3>

<p class="source_link" id="M000203-show-link"><a onclick="toggle('M000203-source'); toggleText('M000203-link'); return false;" href="#" id="M000203-link">Show source...</a></p><div class="source" id="M000203-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1455</span>
1455:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">toggle_history</span>
1456:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:only_comments</span>] <span class="ruby-operator">||=</span> <span class="ruby-value">0</span>
1457:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:only_comments</span>] = <span class="ruby-value">1</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:only_comments</span>]
1458: 
1459:     <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;project_id IN (#{current_project_ids})&quot;</span>])
1460:     <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@logs</span> = <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;work_logs.started_at desc,work_logs.id desc&quot;</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;work_logs.task_id = ? #{&quot;AND (work_logs.comment = 1 OR work_logs.log_type=6)&quot; if session[:only_comments].to_i == 1}&quot;</span>, <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">id</span>], <span class="ruby-identifier">:include</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:user</span>, <span class="ruby-identifier">:task</span>, <span class="ruby-identifier">:project</span>])
1461:       <span class="ruby-ivar">@logs</span> = []
1462:     <span class="ruby-keyword kw">end</span>
1463: 
1464:     <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1465:       <span class="ruby-identifier">page</span>.<span class="ruby-identifier">replace_html</span> <span class="ruby-value str">'task_history'</span>, <span class="ruby-identifier">:partial</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'history'</span>
1466:       <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-value str">&quot;task_history&quot;</span>, <span class="ruby-identifier">:duration</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">2.0</span>)
1467:     <span class="ruby-keyword kw">end</span>
1468:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000176"><br/></a>
<div class="method_block"><h3>
<a href='#M000176'>


update

()

</a>
</h3>

<p class="source_link" id="M000176-show-link"><a onclick="toggle('M000176-source'); toggleText('M000176-link'); return false;" href="#" id="M000176-link">Show source...</a></p><div class="source" id="M000176-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 422</span>
422:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">update</span>
423:     <span class="ruby-identifier">projects</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span><span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span>}
424: 
425:     <span class="ruby-identifier">update_type</span> = <span class="ruby-identifier">:updated</span>
426: 
427:     <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;project_id IN (?)&quot;</span>, <span class="ruby-identifier">projects</span>], <span class="ruby-identifier">:include</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:tags</span>])
428:     <span class="ruby-identifier">old_tags</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">tags</span>.<span class="ruby-identifier">collect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">name</span>}.<span class="ruby-identifier">sort</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">', '</span>)
429:     <span class="ruby-identifier">old_deps</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">dependencies</span>.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-node">&quot;[#{t.issue_num}] #{t.name}&quot;</span> }.<span class="ruby-identifier">sort</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">', '</span>)
430:     <span class="ruby-identifier">old_users</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">users</span>.<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">u</span><span class="ruby-operator">|</span> <span class="ruby-identifier">u</span>.<span class="ruby-identifier">id</span>}.<span class="ruby-identifier">sort</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">','</span>)
431:     <span class="ruby-identifier">old_users</span> <span class="ruby-operator">||=</span> <span class="ruby-value str">&quot;0&quot;</span>
432:     <span class="ruby-identifier">old_project_id</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project_id</span>
433:     <span class="ruby-identifier">old_project_name</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">name</span>
434:     <span class="ruby-ivar">@old_task</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">clone</span>
435: 
436:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:status</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">6</span>
437:       <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:status</span>] = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status</span>  <span class="ruby-comment cmt"># We're hiding the task, set the status to what is was.</span>
438:     <span class="ruby-keyword kw">else</span>
439:       <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:hide_until</span>] = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">hide_until</span>
440:     <span class="ruby-keyword kw">end</span>
441: 
442:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">update_attributes</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>])
443: 
444:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">hide_until</span> = <span class="ruby-keyword kw">nil</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:hide_until</span>].<span class="ruby-identifier">nil?</span>
445: 
446:       <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:due_at</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:due_at</span>].<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
447: 
448:         <span class="ruby-identifier">repeat</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">parse_repeat</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:due_at</span>])
449:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">repeat</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">repeat</span> <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;&quot;</span>
450:           <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">repeat</span> = <span class="ruby-identifier">repeat</span>
451:           <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">due_at</span> = <span class="ruby-identifier">tz</span>.<span class="ruby-identifier">local_to_utc</span>(<span class="ruby-ivar">@task</span>.<span class="ruby-identifier">next_repeat_date</span>)
452:         <span class="ruby-keyword kw">else</span>
453:           <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">repeat</span> = <span class="ruby-keyword kw">nil</span>
454:           <span class="ruby-identifier">due_date</span> = <span class="ruby-constant">DateTime</span>.<span class="ruby-identifier">strptime</span>( <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:due_at</span>], <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">date_format</span> ) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">begin</span>
455:                                                                                                       <span class="ruby-identifier">flash</span>[<span class="ruby-value str">'notice'</span>] = <span class="ruby-identifier">_</span>(<span class="ruby-value str">'Invalid due date ignored.'</span>)
456:                                                                                                       <span class="ruby-identifier">due_date</span> = <span class="ruby-keyword kw">nil</span>
457:                                                                                                     <span class="ruby-keyword kw">end</span>
458:           <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">due_at</span> = <span class="ruby-identifier">tz</span>.<span class="ruby-identifier">local_to_utc</span>(<span class="ruby-identifier">due_date</span>.<span class="ruby-identifier">to_time</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>.<span class="ruby-identifier">day</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>.<span class="ruby-identifier">minute</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">due_date</span>.<span class="ruby-identifier">nil?</span>
459:         <span class="ruby-keyword kw">end</span>
460:       <span class="ruby-keyword kw">else</span>
461:         <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">repeat</span> = <span class="ruby-keyword kw">nil</span>
462:       <span class="ruby-keyword kw">end</span>
463: 
464:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">notifications</span>.<span class="ruby-identifier">destroy_all</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">notifications</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
465:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">notify_emails</span> = <span class="ruby-keyword kw">nil</span>
466:       <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:watchers</span>].<span class="ruby-identifier">nil?</span>
467:         <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:watchers</span>].<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">elem</span><span class="ruby-operator">|</span>
468:           <span class="ruby-identifier">elem</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">','</span>).<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">w</span><span class="ruby-operator">|</span>
469:             <span class="ruby-identifier">u</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find_by_name</span>(<span class="ruby-identifier">w</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;company_id = ?&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>])
470:             <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">u</span>.<span class="ruby-identifier">nil?</span>
471:               <span class="ruby-comment cmt"># Found user</span>
472:               <span class="ruby-identifier">n</span> = <span class="ruby-constant">Notification</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">:user</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">u</span>, <span class="ruby-identifier">:task</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@task</span>)
473:               <span class="ruby-identifier">n</span>.<span class="ruby-identifier">save</span>
474:             <span class="ruby-keyword kw">else</span>
475:               <span class="ruby-comment cmt"># Not a user, check for email address</span>
476:               <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">w</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-value str">'@'</span>)
477:                 <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">notify_emails</span> <span class="ruby-operator">||=</span> <span class="ruby-value str">&quot;&quot;</span>
478:                 <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">notify_emails</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;,&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">notify_emails</span>.<span class="ruby-identifier">empty?</span>
479:                 <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">notify_emails</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">w</span>
480:               <span class="ruby-keyword kw">end</span>
481:             <span class="ruby-keyword kw">end</span>
482:           <span class="ruby-keyword kw">end</span>
483:         <span class="ruby-keyword kw">end</span>
484:       <span class="ruby-keyword kw">end</span>
485: 
486:       <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:users</span>].<span class="ruby-identifier">nil?</span>
487:         <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">task_owners</span>.<span class="ruby-identifier">destroy_all</span>
488:         <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:users</span>].<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">o</span><span class="ruby-operator">|</span>
489:           <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span>(<span class="ruby-node">&quot;Adding user #{o} to #{@task.id}&quot;</span>)
490:           <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
491:           <span class="ruby-identifier">u</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">o</span>.<span class="ruby-identifier">to_i</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;company_id = ?&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>])
492:           <span class="ruby-identifier">to</span> = <span class="ruby-constant">TaskOwner</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">:user</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">u</span>, <span class="ruby-identifier">:task</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@task</span>)
493:           <span class="ruby-identifier">to</span>.<span class="ruby-identifier">save</span>
494:         <span class="ruby-keyword kw">end</span>
495:       <span class="ruby-keyword kw">end</span>
496: 
497:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:dependencies</span>]
498:         
499:         <span class="ruby-identifier">in_deps</span> = []
500:         <span class="ruby-identifier">new_dependencies</span> = []
501: 
502:         <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:dependencies</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">d</span><span class="ruby-operator">|</span>
503:           <span class="ruby-identifier">deps</span> = <span class="ruby-identifier">d</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">','</span>)
504:           <span class="ruby-identifier">deps</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">dep</span><span class="ruby-operator">|</span>
505:             <span class="ruby-identifier">dep</span>.<span class="ruby-identifier">strip!</span>
506:             <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> [<span class="ruby-value">0</span>, <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">id</span>].<span class="ruby-identifier">include?</span> <span class="ruby-identifier">dep</span>.<span class="ruby-identifier">to_i</span>
507:             <span class="ruby-identifier">in_deps</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">dep</span>.<span class="ruby-identifier">to_i</span>]
508:           <span class="ruby-keyword kw">end</span>
509:         <span class="ruby-keyword kw">end</span>
510:         
511:         <span class="ruby-identifier">in_deps</span>.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">dep</span><span class="ruby-operator">|</span>
512:           <span class="ruby-identifier">t</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;company_id = ? AND task_num = ?&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>, <span class="ruby-identifier">dep</span>])
513:           <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">nil?</span>
514:             <span class="ruby-identifier">new_dependencies</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">t</span>
515:           <span class="ruby-keyword kw">end</span>
516:         <span class="ruby-keyword kw">end</span>
517:         
518:         <span class="ruby-identifier">removed</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">dependencies</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">new_dependencies</span>
519:         <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">dependencies</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">removed</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">removed</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
520: 
521:         <span class="ruby-identifier">added</span> = (<span class="ruby-identifier">new_dependencies</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">dependencies</span>)
522:         <span class="ruby-identifier">added</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">a</span><span class="ruby-operator">|</span>
523:           <span class="ruby-identifier">t</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;project_id IN (#{current_project_ids}) AND id = ?&quot;</span>, <span class="ruby-identifier">a</span>])
524:           <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">nil?</span>
525:             <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">dependencies</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">t</span>
526:           <span class="ruby-keyword kw">end</span>
527:         <span class="ruby-keyword kw">end</span>
528:         
529:       <span class="ruby-keyword kw">end</span>
530: 
531:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-identifier">parse_time</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:duration</span>], <span class="ruby-keyword kw">true</span>) <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:duration</span>])
532:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">updated_by_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
533: 
534:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">completed_at</span>.<span class="ruby-identifier">nil?</span>
535:         <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">completed_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>
536: 
537:         <span class="ruby-comment cmt"># Repeat this task every X...</span>
538:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">next_repeat_date</span> <span class="ruby-operator">!=</span> <span class="ruby-keyword kw">nil</span>
539: 
540:           <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">save</span>
541:           <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">reload</span>
542: 
543:           <span class="ruby-identifier">repeat_task</span>(<span class="ruby-ivar">@task</span>)
544:         <span class="ruby-keyword kw">end</span>
545:       <span class="ruby-keyword kw">end</span>
546: 
547:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">2</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@task</span>.<span class="ruby-identifier">completed_at</span>.<span class="ruby-identifier">nil?</span>
548:         <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">completed_at</span> = <span class="ruby-keyword kw">nil</span>
549:       <span class="ruby-keyword kw">end</span>
550: 
551:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">scheduled_duration</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">duration</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">scheduled?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">duration</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">duration</span>
552:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">scheduled_at</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">due_at</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">scheduled?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">due_at</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">due_at</span>
553: 
554:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">save</span>
555: 
556:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">reload</span>
557: 
558:       <span class="ruby-identifier">body</span> = <span class="ruby-value str">&quot;&quot;</span>
559:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@old_task</span>[<span class="ruby-identifier">:name</span>] <span class="ruby-operator">!=</span> <span class="ruby-ivar">@task</span>[<span class="ruby-identifier">:name</span>]
560:         <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Name&lt;/strong&gt;: #{@old_task[:name]} -&gt; #{@task[:name]}\n&quot;</span>
561:       <span class="ruby-keyword kw">end</span>
562: 
563:       <span class="ruby-keyword kw">if</span>(<span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">description</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">description</span>)
564:         <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;- &lt;strong&gt;Description&lt;/strong&gt; changed\n&quot;</span>
565:       <span class="ruby-keyword kw">end</span>
566: 
567:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:users</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">old_users</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:users</span>].<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">u</span><span class="ruby-operator">|</span> <span class="ruby-identifier">u</span>.<span class="ruby-identifier">to_i</span>}.<span class="ruby-identifier">sort</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">','</span>)
568:         <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span>(<span class="ruby-node">&quot;#{old_users} != #{params[:users].collect{|u| u.to_i}.sort.join(',')}&quot;</span>)
569:         <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">users</span>.<span class="ruby-identifier">reload</span>
570:         <span class="ruby-identifier">new_name</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">users</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-value">? </span><span class="ruby-value str">'Unassigned'</span> <span class="ruby-operator">:</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">users</span>.<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">u</span><span class="ruby-operator">|</span> <span class="ruby-identifier">u</span>.<span class="ruby-identifier">name</span>}.<span class="ruby-identifier">join</span>(<span class="ruby-value str">', '</span>)
571:         <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Assignment&lt;/strong&gt;: #{new_name}\n&quot;</span>
572:         <span class="ruby-identifier">update_type</span> = <span class="ruby-identifier">:reassigned</span>
573:       <span class="ruby-keyword kw">end</span>
574: 
575:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">old_project_id</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project_id</span>
576:         <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Project&lt;/strong&gt;: #{old_project_name} -&gt; #{@task.project.name}\n&quot;</span>
577:         <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">update_all</span>(<span class="ruby-node">&quot;customer_id = #{@task.project.customer_id}, project_id = #{@task.project_id}&quot;</span>, <span class="ruby-node">&quot;task_id = #{@task.id}&quot;</span>)
578:         <span class="ruby-constant">ProjectFile</span>.<span class="ruby-identifier">update_all</span>(<span class="ruby-node">&quot;customer_id = #{@task.project.customer_id}, project_id = #{@task.project_id}&quot;</span>, <span class="ruby-node">&quot;task_id = #{@task.id}&quot;</span>)
579:       <span class="ruby-keyword kw">end</span>
580: 
581:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">duration</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">duration</span>
582:         <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Estimate&lt;/strong&gt;: #{worked_nice(@old_task.duration).strip} -&gt; #{worked_nice(@task.duration)}\n&quot;</span>
583:       <span class="ruby-keyword kw">end</span>
584: 
585:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">milestone</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone</span>
586:         <span class="ruby-identifier">old_name</span> = <span class="ruby-value str">&quot;None&quot;</span>
587:         <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">nil?</span>
588:            <span class="ruby-identifier">old_name</span> = <span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">name</span>
589:            <span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">update_counts</span>
590:         <span class="ruby-keyword kw">end</span>
591: 
592:         <span class="ruby-identifier">new_name</span> = <span class="ruby-value str">&quot;None&quot;</span>
593:         <span class="ruby-identifier">new_name</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">name</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">nil?</span>
594: 
595:         <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Milestone&lt;/strong&gt;: #{old_name} -&gt; #{new_name}\n&quot;</span>
596:       <span class="ruby-keyword kw">end</span>
597: 
598:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">due_at</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">due_at</span>
599:         <span class="ruby-identifier">old_name</span> = <span class="ruby-value str">&quot;None&quot;</span>
600:         <span class="ruby-identifier">old_name</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">tz</span>.<span class="ruby-identifier">utc_to_local</span>(<span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">due_at</span>).<span class="ruby-identifier">strftime_localized</span>(<span class="ruby-value str">&quot;%A, %d %B %Y&quot;</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">due_at</span>.<span class="ruby-identifier">nil?</span>
601: 
602:         <span class="ruby-identifier">new_name</span> = <span class="ruby-value str">&quot;None&quot;</span>
603:         <span class="ruby-identifier">new_name</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">tz</span>.<span class="ruby-identifier">utc_to_local</span>(<span class="ruby-ivar">@task</span>.<span class="ruby-identifier">due_at</span>).<span class="ruby-identifier">strftime_localized</span>(<span class="ruby-value str">&quot;%A, %d %B %Y&quot;</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">due_at</span>.<span class="ruby-identifier">nil?</span>
604: 
605:         <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Due&lt;/strong&gt;: #{old_name} -&gt; #{new_name}\n&quot;</span>
606:       <span class="ruby-keyword kw">end</span>
607: 
608:       <span class="ruby-identifier">new_tags</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">tags</span>.<span class="ruby-identifier">collect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">name</span>}.<span class="ruby-identifier">sort</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">', '</span>)
609:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">old_tags</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">new_tags</span>
610:         <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Tags&lt;/strong&gt;: #{new_tags}\n&quot;</span>
611:       <span class="ruby-keyword kw">end</span>
612: 
613:       <span class="ruby-identifier">new_deps</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">dependencies</span>.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-node">&quot;[#{t.issue_num}] #{t.name}&quot;</span>}.<span class="ruby-identifier">sort</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">&quot;, &quot;</span>)
614:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">old_deps</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">new_deps</span>
615:         <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Dependencies&lt;/strong&gt;: #{(new_deps.length &gt; 0) ? new_deps : _(&quot;None&quot;)}&quot;</span>
616:       <span class="ruby-keyword kw">end</span>
617: 
618:       <span class="ruby-identifier">worklog</span> = <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">new</span>
619:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_MODIFIED</span>
620: 
621: 
622:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status</span>
623:         <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Status&lt;/strong&gt;: #{@old_task.status_type} -&gt; #{@task.status_type}\n&quot;</span>
624: 
625:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_COMPLETED</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>
626:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_REVERTED</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> <span class="ruby-operator">||</span> (<span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">2</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>))
627: 
628:         <span class="ruby-keyword kw">if</span>( <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status</span> )
629:           <span class="ruby-identifier">update_type</span> = <span class="ruby-identifier">:status</span>
630:         <span class="ruby-keyword kw">end</span>
631: 
632:         <span class="ruby-keyword kw">if</span>( <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">completed_at</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">completed_at</span>.<span class="ruby-identifier">nil?</span>)
633:           <span class="ruby-identifier">update_type</span> = <span class="ruby-identifier">:completed</span>
634:         <span class="ruby-keyword kw">end</span>
635: 
636:         <span class="ruby-keyword kw">if</span>( <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">2</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span> )
637:           <span class="ruby-identifier">update_type</span> = <span class="ruby-identifier">:reverted</span>
638:         <span class="ruby-keyword kw">end</span>
639: 
640:       <span class="ruby-keyword kw">end</span>
641: 
642:       <span class="ruby-identifier">files</span> = <span class="ruby-identifier">create_attachments</span>(<span class="ruby-ivar">@task</span>)
643:       <span class="ruby-identifier">files</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">filename</span><span class="ruby-operator">|</span>
644:         <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Attached&lt;/strong&gt;: #{filename}\n&quot;</span>
645:       <span class="ruby-keyword kw">end</span>
646: 
647:       <span class="ruby-identifier">email_body</span> = <span class="ruby-identifier">body</span>
648: 
649:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:comment</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:comment</span>].<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
650:         <span class="ruby-identifier">update_type</span> = <span class="ruby-identifier">:comment</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">body</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
651:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_COMMENT</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">body</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
652:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">comment</span> = <span class="ruby-keyword kw">true</span>
653:         
654:         <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;\n&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">body</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
655:         <span class="ruby-identifier">email_body</span> = <span class="ruby-identifier">body</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;:\n&quot;</span>
656: 
657:         <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">CGI</span><span class="ruby-operator">::</span><span class="ruby-identifier">escapeHTML</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:comment</span>])
658:         <span class="ruby-identifier">email_body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:comment</span>]
659:       <span class="ruby-keyword kw">end</span>
660: 
661:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">body</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
662:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">user</span> = <span class="ruby-identifier">current_user</span>
663:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">company</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">company</span>
664:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">customer</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">customer</span>
665:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">project</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>
666:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">task</span> = <span class="ruby-ivar">@task</span>
667:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">started_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>
668:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-value">0</span>
669:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">body</span> = <span class="ruby-identifier">body</span>
670:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">save</span>
671: 
672:         <span class="ruby-keyword kw">if</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value str">'notify'</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>)
673:           <span class="ruby-constant">Notifications</span><span class="ruby-operator">::</span><span class="ruby-identifier">deliver_changed</span>( <span class="ruby-identifier">update_type</span>, <span class="ruby-ivar">@task</span>, <span class="ruby-identifier">current_user</span>, <span class="ruby-identifier">email_body</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/&lt;[^&gt;]*&gt;/</span>,<span class="ruby-value str">''</span>)) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
674:         <span class="ruby-keyword kw">end</span>
675:       <span class="ruby-keyword kw">end</span>
676: 
677:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; @task.id)}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
678:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'activities', :action =&gt; 'refresh')}');&quot;</span>, [<span class="ruby-node">&quot;activity_#{current_user.company_id}&quot;</span>])
679: 
680:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">xhr?</span>
681: 
682:       <span class="ruby-identifier">flash</span>[<span class="ruby-value str">'notice'</span>] <span class="ruby-operator">||=</span> <span class="ruby-node">&quot;#{link_to_task(@task)} - #{_('Task was successfully updated.')}&quot;</span>
683:       <span class="ruby-identifier">redirect_from_last</span>
684:     <span class="ruby-keyword kw">else</span>
685:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'edit'</span>
686:     <span class="ruby-keyword kw">end</span>
687:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000177"><br/></a>
<div class="method_block"><h3>
<a href='#M000177'>


update_ajax

()

</a>
</h3>

<p class="source_link" id="M000177-show-link"><a onclick="toggle('M000177-source'); toggleText('M000177-link'); return false;" href="#" id="M000177-link">Show source...</a></p><div class="source" id="M000177-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 689</span>
689:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">update_ajax</span>
690:     <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">update</span>
691:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000192"><br/></a>
<div class="method_block"><h3>
<a href='#M000192'>


update_sheet_info

()

</a>
</h3>

<p class="source_link" id="M000192-show-link"><a onclick="toggle('M000192-source'); toggleText('M000192-link'); return false;" href="#" id="M000192-link">Show source...</a></p><div class="source" id="M000192-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1065</span>
1065:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">update_sheet_info</span>
1066:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000193"><br/></a>
<div class="method_block"><h3>
<a href='#M000193'>


update_tasks

()

</a>
</h3>

<p class="source_link" id="M000193-show-link"><a onclick="toggle('M000193-source'); toggleText('M000193-link'); return false;" href="#" id="M000193-link">Show source...</a></p><div class="source" id="M000193-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1068</span>
1068:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">update_tasks</span>
1069:     <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>( <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;company_id = ?&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>] )
1070:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000191"><br/></a>
<div class="method_block"><h3>
<a href='#M000191'>


updatelog

()

</a>
</h3>

<p class="source_link" id="M000191-show-link"><a onclick="toggle('M000191-source'); toggleText('M000191-link'); return false;" href="#" id="M000191-link">Show source...</a></p><div class="source" id="M000191-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1050</span>
1050:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">updatelog</span>
1051:     <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@current_sheet</span>
1052:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;#{_(&quot;Task not worked on&quot;)} #{current_user.tz.utc_to_local(Time.now.utc).strftime_localized(&quot;%H:%M:%S&quot;)}&quot;</span>
1053:       <span class="ruby-keyword kw">return</span>
1054:     <span class="ruby-keyword kw">end</span> 
1055:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:worklog</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:worklog</span>][<span class="ruby-identifier">:body</span>] 
1056:       <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">body</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:worklog</span>][<span class="ruby-identifier">:body</span>] 
1057:       <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">save</span>
1058:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;#{_(&quot;Saved&quot;)} #{current_user.tz.utc_to_local(Time.now.utc).strftime_localized(&quot;%H:%M:%S&quot;)}&quot;</span>
1059:     <span class="ruby-keyword kw">else</span> 
1060:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;#{_(&quot;Error saving&quot;)} #{current_user.tz.utc_to_local(Time.now.utc).strftime_localized(&quot;%H:%M:%S&quot;)}&quot;</span>
1061:     <span class="ruby-keyword kw">end</span> 
1062:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000173"><br/></a>
<div class="method_block"><h3>
<a href='#M000173'>


view

()

</a>
</h3>

<p class="source_link" id="M000173-show-link"><a onclick="toggle('M000173-source'); toggleText('M000173-link'); return false;" href="#" id="M000173-link">Show source...</a></p><div class="source" id="M000173-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 348</span>
348:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">view</span>
349:     <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;project_id IN (#{current_project_ids}) AND task_num = ?&quot;</span>, <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>]])
350:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>
351:       <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'edit'</span>, <span class="ruby-identifier">:id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">id</span>
352:     <span class="ruby-keyword kw">else</span>
353:       <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">:controller</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'views'</span>, <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'browse'</span>
354:     <span class="ruby-keyword kw">end</span>
355:   <span class="ruby-keyword kw">end</span></pre></div>
</div>


<h1>Private Instance Methods</h1>


<a class="small" name="M000217"><br/></a>
<div class="method_block"><h3>
<a href='#M000217'>


group_tasks

(tasks)

</a>
</h3>
<p>
Returns a two element array containing the grouped tasks. The first element
is an in-order array of group ids / names The second element is a hash
mapping group ids / names to arrays of tasks.
</p>

<p class="source_link" id="M000217-show-link"><a onclick="toggle('M000217-source'); toggleText('M000217-link'); return false;" href="#" id="M000217-link">Show source...</a></p><div class="source" id="M000217-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1818</span>
1818:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">group_tasks</span>(<span class="ruby-identifier">tasks</span>)
1819:     <span class="ruby-identifier">group_ids</span> = {}
1820:     <span class="ruby-identifier">groups</span> = []
1821:     
1822:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:group_by</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span> <span class="ruby-comment cmt"># tags</span>
1823:       <span class="ruby-ivar">@tag_names</span> = <span class="ruby-ivar">@all_tags</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span>,<span class="ruby-identifier">j</span><span class="ruby-operator">|</span> <span class="ruby-identifier">i</span>}
1824:       <span class="ruby-identifier">groups</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">tag_groups</span>(<span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>, <span class="ruby-ivar">@tag_names</span>, <span class="ruby-identifier">tasks</span>)
1825:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:group_by</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span> <span class="ruby-comment cmt"># Clients</span>
1826:       <span class="ruby-identifier">clients</span> = <span class="ruby-constant">Customer</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;company_id = ?&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>], <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;name&quot;</span>)
1827:       <span class="ruby-identifier">clients</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-identifier">group_ids</span>[<span class="ruby-identifier">c</span>.<span class="ruby-identifier">name</span>] = <span class="ruby-identifier">c</span>.<span class="ruby-identifier">id</span> }
1828:       <span class="ruby-identifier">items</span> = <span class="ruby-identifier">clients</span>.<span class="ruby-identifier">collect</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">:name</span>).<span class="ruby-identifier">sort</span>
1829:       <span class="ruby-identifier">groups</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">group_by</span>(<span class="ruby-identifier">tasks</span>, <span class="ruby-identifier">items</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">t</span>,<span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">customer</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">i</span> }
1830:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:group_by</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">3</span> <span class="ruby-comment cmt"># Projects</span>
1831:       <span class="ruby-identifier">projects</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>
1832:       <span class="ruby-identifier">projects</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-identifier">group_ids</span>[<span class="ruby-identifier">p</span>.<span class="ruby-identifier">full_name</span>] = <span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span> }
1833:       <span class="ruby-identifier">items</span> = <span class="ruby-identifier">projects</span>.<span class="ruby-identifier">collect</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">:full_name</span>).<span class="ruby-identifier">sort</span>
1834:       <span class="ruby-identifier">groups</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">group_by</span>(<span class="ruby-identifier">tasks</span>, <span class="ruby-identifier">items</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">t</span>,<span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">full_name</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">i</span> }
1835:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:group_by</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">4</span> <span class="ruby-comment cmt"># Milestones</span>
1836:       <span class="ruby-identifier">filter</span> = <span class="ruby-value str">&quot;&quot;</span>
1837:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_milestone</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
1838:         <span class="ruby-identifier">m</span> = <span class="ruby-constant">Milestone</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_milestone</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;project_id IN (#{current_project_ids}) AND completed_at IS NULL&quot;</span>], <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;due_at, name&quot;</span>) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
1839:         <span class="ruby-identifier">filter</span> = <span class="ruby-node">&quot; AND project_id = #{m.project_id}&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">m</span>
1840:       <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
1841:         <span class="ruby-identifier">filter</span> = <span class="ruby-node">&quot; AND project_id = #{session[:filter_project]}&quot;</span>
1842:       <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_customer</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
1843:         <span class="ruby-identifier">pids</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company</span>.<span class="ruby-identifier">customers</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_customer</span>]).<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span>}.<span class="ruby-identifier">join</span>(<span class="ruby-value str">','</span>) <span class="ruby-keyword kw">rescue</span> <span class="ruby-value str">'0'</span>
1844:         <span class="ruby-identifier">filter</span> = <span class="ruby-node">&quot; AND project_id IN (#{pids})&quot;</span>
1845:       <span class="ruby-keyword kw">end</span>
1846:       <span class="ruby-identifier">milestones</span> = <span class="ruby-constant">Milestone</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;company_id = ? AND project_id IN (#{current_project_ids})#{filter} AND completed_at IS NULL&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>], <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;due_at, name&quot;</span>)
1847:       <span class="ruby-identifier">milestones</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-identifier">group_ids</span>[<span class="ruby-identifier">m</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot; / &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">name</span>] = <span class="ruby-identifier">m</span>.<span class="ruby-identifier">id</span> }
1848:       <span class="ruby-identifier">group_ids</span>[<span class="ruby-value str">'Unassigned'</span>] = <span class="ruby-value">0</span>
1849:       <span class="ruby-identifier">items</span> = [<span class="ruby-value str">&quot;Unassigned&quot;</span>] <span class="ruby-operator">+</span>  <span class="ruby-identifier">milestones</span>.<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot; / &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">name</span> }
1850:       <span class="ruby-identifier">groups</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">group_by</span>(<span class="ruby-identifier">tasks</span>, <span class="ruby-identifier">items</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">t</span>,<span class="ruby-identifier">i</span><span class="ruby-operator">|</span> (<span class="ruby-identifier">t</span>.<span class="ruby-identifier">milestone</span> <span class="ruby-value">? </span>(<span class="ruby-identifier">t</span>.<span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot; / &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">name</span>) <span class="ruby-operator">:</span> <span class="ruby-value str">&quot;Unassigned&quot;</span> ) <span class="ruby-operator">==</span> <span class="ruby-identifier">i</span> }
1851:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:group_by</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">5</span> <span class="ruby-comment cmt"># Users</span>
1852:       <span class="ruby-identifier">users</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company</span>.<span class="ruby-identifier">users</span>
1853:       <span class="ruby-identifier">users</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">u</span><span class="ruby-operator">|</span> <span class="ruby-identifier">group_ids</span>[<span class="ruby-identifier">u</span>.<span class="ruby-identifier">name</span>] = <span class="ruby-identifier">u</span>.<span class="ruby-identifier">id</span> }
1854:       <span class="ruby-identifier">group_ids</span>[<span class="ruby-identifier">_</span>(<span class="ruby-value str">'Unassigned'</span>)] = <span class="ruby-value">0</span>
1855:       <span class="ruby-identifier">items</span> = [<span class="ruby-identifier">_</span>(<span class="ruby-value str">&quot;Unassigned&quot;</span>)] <span class="ruby-operator">+</span> <span class="ruby-identifier">users</span>.<span class="ruby-identifier">collect</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">:name</span>).<span class="ruby-identifier">sort</span>
1856:       <span class="ruby-identifier">groups</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">group_by</span>(<span class="ruby-identifier">tasks</span>, <span class="ruby-identifier">items</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">t</span>,<span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
1857:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">users</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
1858:           <span class="ruby-identifier">res</span> = <span class="ruby-identifier">t</span>.<span class="ruby-identifier">users</span>.<span class="ruby-identifier">collect</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">:name</span>).<span class="ruby-identifier">include?</span> <span class="ruby-identifier">i</span>
1859:         <span class="ruby-keyword kw">else</span>
1860:           <span class="ruby-identifier">res</span> = (<span class="ruby-identifier">_</span>(<span class="ruby-value str">&quot;Unassigned&quot;</span>) <span class="ruby-operator">==</span> <span class="ruby-identifier">i</span>)
1861:         <span class="ruby-keyword kw">end</span>
1862:         <span class="ruby-identifier">res</span>
1863:       }
1864:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:group_by</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">7</span> <span class="ruby-comment cmt"># Status</span>
1865:       <span class="ruby-value">0</span>.<span class="ruby-identifier">upto</span>(<span class="ruby-value">5</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">group_ids</span>[ <span class="ruby-identifier">_</span>(<span class="ruby-constant">Task</span>.<span class="ruby-identifier">status_types</span>[<span class="ruby-identifier">i</span>]) ] = <span class="ruby-identifier">i</span> }
1866:       <span class="ruby-identifier">items</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">status_types</span>.<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">_</span>(<span class="ruby-identifier">i</span>) }
1867:       <span class="ruby-identifier">groups</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">group_by</span>(<span class="ruby-identifier">tasks</span>, <span class="ruby-identifier">items</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">t</span>,<span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">_</span>(<span class="ruby-identifier">t</span>.<span class="ruby-identifier">status_type</span>) <span class="ruby-operator">==</span> <span class="ruby-identifier">i</span> }
1868:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:group_by</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">10</span> <span class="ruby-comment cmt"># Projects / Milestones</span>
1869:       <span class="ruby-identifier">milestones</span> = <span class="ruby-constant">Milestone</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;company_id = ? AND project_id IN (#{current_project_ids}) AND completed_at IS NULL&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>], <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;due_at, name&quot;</span>)
1870:       <span class="ruby-identifier">projects</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>
1871: 
1872:       <span class="ruby-identifier">milestones</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-identifier">group_ids</span>[<span class="ruby-node">&quot;#{m.project.name} / #{m.name}&quot;</span>] = <span class="ruby-node">&quot;#{m.project_id}_#{m.id}&quot;</span> }
1873:       <span class="ruby-identifier">projects</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-identifier">group_ids</span>[<span class="ruby-node">&quot;#{p.name}&quot;</span>] = <span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span> }
1874: 
1875:       <span class="ruby-identifier">items</span> = <span class="ruby-identifier">milestones</span>.<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-node">&quot;#{m.project.name} / #{m.name}&quot;</span> }.<span class="ruby-identifier">flatten</span>
1876:       <span class="ruby-identifier">items</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">projects</span>.<span class="ruby-identifier">collect</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">:name</span>)
1877:       <span class="ruby-identifier">items</span> = <span class="ruby-identifier">items</span>.<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">sort</span>
1878: 
1879:       <span class="ruby-identifier">groups</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">group_by</span>(<span class="ruby-identifier">tasks</span>, <span class="ruby-identifier">items</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">t</span>,<span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">milestone</span> <span class="ruby-value">? </span>(<span class="ruby-node">&quot;#{t.project.name} / #{t.milestone.name}&quot;</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">i</span>) <span class="ruby-operator">:</span> (<span class="ruby-identifier">t</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">i</span>)  }
1880:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:group_by</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">11</span> <span class="ruby-comment cmt"># Requested By</span>
1881:       <span class="ruby-identifier">requested_by</span> = <span class="ruby-identifier">tasks</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">requested_by</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-value">? </span><span class="ruby-keyword kw">nil</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">requested_by</span> }.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">sort</span>
1882:       <span class="ruby-identifier">requested_by</span> = [<span class="ruby-identifier">_</span>(<span class="ruby-value str">'No one'</span>)] <span class="ruby-operator">+</span> <span class="ruby-identifier">requested_by</span>
1883:       <span class="ruby-identifier">groups</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">group_by</span>(<span class="ruby-identifier">tasks</span>, <span class="ruby-identifier">requested_by</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">t</span>,<span class="ruby-identifier">i</span><span class="ruby-operator">|</span> (<span class="ruby-identifier">t</span>.<span class="ruby-identifier">requested_by</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-value">? </span><span class="ruby-identifier">_</span>(<span class="ruby-value str">'No one'</span>) <span class="ruby-operator">:</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">requested_by</span>) <span class="ruby-operator">==</span> <span class="ruby-identifier">i</span> }
1884:     <span class="ruby-keyword kw">elsif</span> (<span class="ruby-identifier">property</span> = <span class="ruby-constant">Property</span>.<span class="ruby-identifier">find_by_group_by</span>(<span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company</span>, <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:group_by</span>]))
1885:       <span class="ruby-identifier">items</span> = <span class="ruby-identifier">property</span>.<span class="ruby-identifier">property_values</span>
1886:       <span class="ruby-identifier">items</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">pbv</span><span class="ruby-operator">|</span> <span class="ruby-identifier">group_ids</span>[<span class="ruby-identifier">pbv</span>] = <span class="ruby-identifier">pbv</span>.<span class="ruby-identifier">id</span> }
1887: 
1888:       <span class="ruby-comment cmt"># add in for tasks without values</span>
1889:       <span class="ruby-identifier">unassigned</span> = <span class="ruby-identifier">_</span>(<span class="ruby-value str">&quot;Unassigned&quot;</span>)
1890:       <span class="ruby-identifier">group_ids</span>[<span class="ruby-identifier">unassigned</span>] = <span class="ruby-value">0</span>
1891:       <span class="ruby-identifier">items</span> = [ <span class="ruby-identifier">unassigned</span> ] <span class="ruby-operator">+</span> <span class="ruby-identifier">items</span>
1892: 
1893:       <span class="ruby-identifier">groups</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">group_by</span>(<span class="ruby-identifier">tasks</span>, <span class="ruby-identifier">items</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">task</span>, <span class="ruby-identifier">match_value</span><span class="ruby-operator">|</span>
1894:         <span class="ruby-identifier">value</span> = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">property_value</span>(<span class="ruby-identifier">property</span>)
1895:         <span class="ruby-identifier">group</span> = (<span class="ruby-identifier">value</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">value</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">match_value</span>)
1896:         <span class="ruby-identifier">group</span> <span class="ruby-operator">||=</span> (<span class="ruby-identifier">value</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">match_value</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">unassigned</span>)
1897:         <span class="ruby-identifier">group</span>
1898:       <span class="ruby-keyword kw">end</span>
1899:     <span class="ruby-keyword kw">else</span>
1900:       <span class="ruby-identifier">groups</span> = [<span class="ruby-identifier">tasks</span>]
1901:     <span class="ruby-keyword kw">end</span>
1902: 
1903: 
1904:     <span class="ruby-keyword kw">return</span> [ <span class="ruby-identifier">group_ids</span>, <span class="ruby-identifier">groups</span> ]
1905:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000216"><br/></a>
<div class="method_block"><h3>
<a href='#M000216'>


sort_tasks

(tasks)

</a>
</h3>
<p>
Returns an array of tasks sorted according to the value in the session.
</p>

<p class="source_link" id="M000216-show-link"><a onclick="toggle('M000216-source'); toggleText('M000216-link'); return false;" href="#" id="M000216-link">Show source...</a></p><div class="source" id="M000216-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1795</span>
1795:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">sort_tasks</span>(<span class="ruby-identifier">tasks</span>)
1796:     <span class="ruby-identifier">sort_by</span> = <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:sort</span>].<span class="ruby-identifier">to_i</span>
1797:     <span class="ruby-identifier">res</span> = <span class="ruby-identifier">tasks</span>
1798: 
1799:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">sort_by</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> <span class="ruby-comment cmt"># default sorting</span>
1800:       <span class="ruby-identifier">res</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company</span>.<span class="ruby-identifier">sort</span>(<span class="ruby-identifier">tasks</span>)
1801:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">sort_by</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
1802:       <span class="ruby-identifier">res</span> = <span class="ruby-identifier">tasks</span>.<span class="ruby-identifier">sort_by</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> [<span class="ruby-operator">-</span><span class="ruby-identifier">t</span>.<span class="ruby-identifier">completed_at</span>.<span class="ruby-identifier">to_i</span>, (<span class="ruby-identifier">t</span>.<span class="ruby-identifier">due_date</span> <span class="ruby-operator">||</span> <span class="ruby-value">9999999999</span>).<span class="ruby-identifier">to_i</span>, <span class="ruby-operator">-</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">sort_rank</span>,  <span class="ruby-operator">-</span><span class="ruby-identifier">t</span>.<span class="ruby-identifier">task_num</span>] }
1803:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">sort_by</span> <span class="ruby-operator">==</span>  <span class="ruby-value">2</span>
1804:       <span class="ruby-identifier">res</span> = <span class="ruby-identifier">tasks</span>.<span class="ruby-identifier">sort_by</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> [<span class="ruby-operator">-</span><span class="ruby-identifier">t</span>.<span class="ruby-identifier">completed_at</span>.<span class="ruby-identifier">to_i</span>, <span class="ruby-identifier">t</span>.<span class="ruby-identifier">created_at</span>.<span class="ruby-identifier">to_i</span>, <span class="ruby-operator">-</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">sort_rank</span>,  <span class="ruby-operator">-</span><span class="ruby-identifier">t</span>.<span class="ruby-identifier">task_num</span>] }
1805:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">sort_by</span> <span class="ruby-operator">==</span> <span class="ruby-value">3</span>
1806:       <span class="ruby-identifier">res</span> = <span class="ruby-identifier">tasks</span>.<span class="ruby-identifier">sort_by</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> [<span class="ruby-operator">-</span><span class="ruby-identifier">t</span>.<span class="ruby-identifier">completed_at</span>.<span class="ruby-identifier">to_i</span>, <span class="ruby-identifier">t</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">downcase</span>, <span class="ruby-operator">-</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">sort_rank</span>,  <span class="ruby-operator">-</span><span class="ruby-identifier">t</span>.<span class="ruby-identifier">task_num</span>] }
1807:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">sort_by</span> <span class="ruby-operator">==</span>  <span class="ruby-value">4</span>
1808:       <span class="ruby-identifier">res</span> = <span class="ruby-identifier">tasks</span>.<span class="ruby-identifier">sort_by</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> [<span class="ruby-operator">-</span><span class="ruby-identifier">t</span>.<span class="ruby-identifier">completed_at</span>.<span class="ruby-identifier">to_i</span>, <span class="ruby-identifier">t</span>.<span class="ruby-identifier">updated_at</span>.<span class="ruby-identifier">to_i</span>, <span class="ruby-operator">-</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">sort_rank</span>,  <span class="ruby-operator">-</span><span class="ruby-identifier">t</span>.<span class="ruby-identifier">task_num</span>] }.<span class="ruby-identifier">reverse</span>
1809:     <span class="ruby-keyword kw">end</span>
1810: 
1811:     <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">res</span>
1812:   <span class="ruby-keyword kw">end</span></pre></div>
</div>





</div><div class="clear" id="footer">Generated on Jan 21, 2008 / Allison 2 &copy; 2007 <a href="http://cloudbur.st">Cloudburst, LLC</a></div></div></body></html>