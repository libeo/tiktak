<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type"/><title>Class: TasksController</title><link type="text/css" href=".././rdoc-style.css" media="screen" rel="stylesheet"/><script type="text/javascript">
// Allison template
// Copyright 2007, 2008 Cloudburst, LLC. Licensed under the AFL 3. See the included LICENSE file.

var href_base = '.././rdoc-style.css'.replace(/(.*\/).*/, '$1'); // inline js is good for something  

function $(id) {
    if (document.getElementById)
      elem = document.getElementById(id);
    else if ( document.all )
      elem = eval("document.all." + id);
    else
      return false;
    return elem;
}

  function toggle(id) {
    elem = $(id);
    elemStyle = elem.style;   
    if (elemStyle.display == "block") {
      elemStyle.display = "none"
    } else {
      elemStyle.display = "block"
    }
    return true;
  }

  function toggleText(id) {
    elem = $(id)
    if (m = elem.innerHTML.match(/(Hide)(.*)/)) {
      elem.innerHTML = "Show" + m[2];
    } else if (m = elem.innerHTML.match(/(Show)(.*)/)) {
      elem.innerHTML = "Hide" + m[2];
    }
    return true;
  }

function span(s, klass) {
  return '<span class="' + klass + '">' + s + '</span>';
}
  
function highlightSymbols() {
  pres = document.getElementsByTagName('pre');
  for(var i = 0; i < pres.length; i++) {
    pre = pres[i];
    spans = pre.getElementsByTagName('span');
    for(var k = 0; k < spans.length; k++) {
      span = spans[k];
      if (span.className.match(/ruby-identifier/)) {
        if (span.innerHTML.match(/^:/)) {
          span.className += " ruby-symbol";
        }
      }
    }
  }
}

 function hasClass(obj) {
     var result = false;
     if (obj.getAttributeNode("class") != null) {
         result = obj.getAttributeNode("class").value;
     }
     return result;
  }   

 function stripe() {
    var even = true;
    var color = "#e4ebed";
    var tables = document.getElementsByTagName('table');
    if (tables.length == 0) { return; }
    for (var h = 0; h < tables.length; h++) {
        var trs = tables[h].getElementsByTagName("tr");
        for (var i = 0; i < trs.length; i++) {
          var tds = trs[i].getElementsByTagName("td");
            for (var j = 0; j < tds.length; j++) {       
              if (hasClass(tds[j]) != "first") {                
              var mytd = tds[j];
              if (even) {
                mytd.style.backgroundColor = color;
              }         
            }
          }
          even =  ! even;
      }
    }
  }
  
function ajaxGet(url) {
  url = (href_base + url).replace('/./', '/')
  var req = false;

  if (window.ActiveXObject) {
    try {
      // stupid hack because IE7 disables local Ajax with the native xmlhttprequest object
      // for security purposes. Yet ActiveX still works. Thanks, Microsoft. I hate you. Die.
      req = new ActiveXObject("MSXML2.XMLHTTP.3.0");
    } catch (e) {
      try {
        /* IE 6 and maybe 5, don't know, don't care */
        req = new ActiveXObject("Msxml2.XMLHTTP");
      } catch (e) {
        try {
          req = new ActiveXObject("Microsoft.XMLHTTP");
        } catch (e) {
          req = false;
        }
      }
    }
  }
    
  /* real browsers */
  if (!req && window.XMLHttpRequest) {
    try {
      req = new XMLHttpRequest();
    } catch (e) {
      req = false;
    }
  } 
  
  if (req) {
    req.open('GET', url, false);
    req.send(null);
    return req.responseText;
  } else {
    return "Ajax error";  
  }
}


function addEvent(elm, evType, fn, useCapture) {
	if (elm.addEventListener) {
	  elm.addEventListener(evType, fn, useCapture);  
  	return true;
	} else if (elm.attachEvent) {
  	var r = elm.attachEvent('on' + evType, fn);  
	  return r;  
	} else {
  	elm['on' + evType] = fn;
	}
}

function insertIndices() {
  pages = ["class", "file", "method"]
  for (x in pages) { 
    $(pages[x]).innerHTML += ajaxGet('fr_' + pages[x] + '_index.html').replace(/(href=")/g, '$1' + href_base);
  }
  /* mouseoverify method links */
  links = $('method').getElementsByTagName('a');
  for (var x = 0; x < links.length; x++) {
    if (m = links[x].innerHTML.match(/(.*)\s\((.*)\)/)) {
      links[x].innerHTML = m[1] + '<br>';
      links[x].title = m[2];
    }
  }
  /* this is stupid */
  $('class').style.display = "block";
  $('file').style.display = "block";
  
  /* has to be here because IE7 does not guarantee the onLoad callback order */
  abbreviateIndicesInner(["class", "file"], 25, "a");
  /* same, linkTitle() depends on the class link list */
  linkTitle();
}

function abbreviateIndices() {
  var ids = ["defined_in", "child_of", "includes", "requires", "method", "methods"];
  abbreviateIndicesInner(ids, 25, 'a');
  abbreviateIndicesInner(ids, 25, 'span');
}

function abbreviateIndicesInner(indices, amount, tag) {
  for (var x = 0; x < indices.length; x++) { 
    var the_index = $(indices[x]);
    if (the_index) {
      links = the_index.getElementsByTagName(tag);
      for (var y = 0; y < links.length; y++) {
        var link = links[y];
        if (link.getElementsByTagName('span').length == 0 && link.getElementsByTagName('a').length == 0) {
          // avoid nesting
          link.innerHTML = link.innerHTML.replace(/<br>|\n/gi, '');
          link.title = link.innerHTML;
          link.innerHTML = abbreviate(link.innerHTML, amount) + '<br>';
        }
      }
    }
  }
}

function linkTitle() {
  
  /* grab the correct title element from the index */
  var index_page = ajaxGet('index.html');
  title_text = index_page.match(/<title>(.*)<\/title>/m)[1];
  document.title = title_text + " - " + document.title;
  var p = $('header').getElementsByTagName('p')[0]
  if (p.innerHTML.match(/^\s*$/)) {
    p.innerHTML = title_text;
  } else {
    p.innerHTML = title_text + ": " + p.innerHTML;
  }
  
  /* set the link properly */
  title_link = index_page.match(/<a\s+href="(.*?)"/)[1];
  var element = $('title');
  var item_type = "";
  var item_name = "";
  if (m = element.innerHTML.match(/(Class:|Module:|File:)\s*(.*)/)) {
    item_type = m[1];
    item_name = m[2];
  } else {
    item_name = element.innerHTML;
  }
  element.innerHTML = '<a href="' + href_base + title_link + '">' + item_type + " " + abbreviate(item_name, 45) + '</a>';
  element.getElementsByTagName('a')[0].title = item_name
  
  /* breadcrumb navigation */
  items = item_name.split("::");
  items_new = item_name.split("::");
  file_links = $('class').getElementsByTagName('a');
  for (var x = 0; x < items.length - 1; x++ ){
    var item = items[x];
    link = ("/classes/" + items.slice(0,x).join("/") + "/" + item + ".html").replace('//', '/');
    regex = new RegExp(RegExp.escape(link) + '$');
    for (var y = 0; y < file_links.length; y++) {
      if (file_links[y].href.match(regex)) {
         items_new[x] = '<a href="' + href_base + link + '">' + item + '</a>';
         break;
      }
    }  
  }
  $('item_name').innerHTML = item_type + ' ' + items_new.join(" :: ");
}

function abbreviate(s, size) {
  while (s.length > size) {
    var old_s = s;
    s = s.replace(/\s|\n/mg, '');
    s = s.replace(/([A-Z])[a-z]+/m, '$1');
    if (!s || old_s == s) {
      return "..." + s.substring(s.length - size, s.length);
    }
  }
  return s;
}

function disableSubmit(event) {
  var keyCode = event.keyCode ? event.keyCode : event.which ? event.which : event.charCode;
  if (keyCode == 13) {
    return false;
  } else {
    return true;
  }
}
  
function filterList(id, s, event) {
  
  /* some weak escaping */
  s = s.replace(/[^\w\d\.\_\-\/\:\=\[\]\?\!]/g, '');
  s = RegExp.escape(s);
  
  var show_all = false;
  if (s.match(/^\s*$/)) {
    show_all = true;
  }
  
  links = $(id).getElementsByTagName('a')
  regex = new RegExp(s, 'i');
  
  for (var x = 0; x < links.length; x++) {
    var link = links[x];
    if (show_all) {
      link.style.display = 'inline';
    } else {
       if (link.innerHTML.match(regex)) {        
         link.style.display = 'inline';
       } else {
         link.style.display = 'none';
       }
    }
  }
  return true;
}

RegExp.escape = function(text) {
  if (!arguments.callee.sRE) {
    var specials = ['/', '.', '*', '+', '?', '|', '(', ')', '[', ']', '{', '}', '\\'];
    arguments.callee.sRE = new RegExp(
      '(\\' + specials.join('|\\') + ')', 'g'
    );
  }
  return text.replace(arguments.callee.sRE, '\\$1');
}

function hacks() {
  // show the spacer if necessary, 
  divs = document.getElementsByTagName('div');
  for(var x = 0; x < divs.length; x++) {
    if (divs[x].className && divs[x].className.match(/top/)) {
      document.getElementById('spacer').style.display = 'block';
    }
  }
  // remove extra colons from tables
  tds = document.getElementsByTagName('td');
  for(var x = 0; x < tds.length; x++) {
    str = tds[x].innerHTML
    if (str.charAt(str.length - 1) == ":") {
      tds[x].innerHTML = str.slice(0, str.length - 1)
    }
  }
}

addEvent(window, 'load', insertIndices, false);
addEvent(window, 'load', abbreviateIndices, false);
addEvent(window, 'load', stripe, false);
addEvent(window, 'load', highlightSymbols, false);
addEvent(window, 'load', hacks, false);
</script></head><body><div id="container"><div class="curve" id="preheader_curve_0"></div><div class="curve" id="preheader_curve_1"></div><div class="curve" id="preheader_curve_2"></div><div class="curve" id="preheader_curve_3"></div><div class="curve" id="preheader_curve_4"></div><div class="curve" id="preheader_curve_5"></div><div id="header"><p>
</p><span><h1 id="title">
Class: TasksController
</h1></span>
</div><div class="clear"></div><div id="left">
<div class="navigation darker top" id="child_of"><h3>Child of</h3><span>

<a href='ApplicationController.html'>
ApplicationController
</a>
</span></div>

<div class="navigation darker top" id="defined_in"><h3>Defined in</h3>

<a href="../files/app/controllers/tasks_controller_rb.html">app/controllers/tasks_controller.rb</a>

</div>



<div class="navigation top" id="methods"><h3>Methods</h3>


<a href='#M000222'>
add_log<br/>
</a>




<a href='#M000213'>
add_work<br/>
</a>




<a href='#M000206'>
ajax_check<br/>
</a>




<a href='#M000203'>
ajax_hide<br/>
</a>




<a href='#M000205'>
ajax_restore<br/>
</a>




<a href='#M000207'>
ajax_uncheck<br/>
</a>




<a href='#M000193'>
auto_complete_for_resource_name<br/>
</a>




<a href='#M000211'>
cancel_work_ajax<br/>
</a>




<a href='#M000197'>
create<br/>
</a>




<a href='#M000228'>
create_ajax<br/>
</a>




<a href='#M000204'>
create_attachments<br/>
</a>




<a href='#M000229'>
create_shortlist_ajax<br/>
</a>




<a href='#M000232'>
create_todo_ajax<br/>
</a>




<a href='#M000237'>
delete_tag<br/>
</a>




<a href='#M000195'>
dependency<br/>
</a>




<a href='#M000192'>
dependency_targets<br/>
</a>




<a href='#M000221'>
destroy_log<br/>
</a>




<a href='#M000199'>
edit<br/>
</a>




<a href='#M000220'>
edit_log<br/>
</a>




<a href='#M000219'>
filter_shortlist<br/>
</a>




<a href='#M000239'>
get_comment<br/>
</a>




<a href='#M000224'>
get_csv<br/>
</a>




<a href='#M000191'>
get_milestones<br/>
</a>




<a href='#M000196'>
get_owners<br/>
</a>




<a href='#M000241'>
group_tasks<br/>
</a>




<a href='#M000189'>
index<br/>
</a>




<a href='#M000190'>
list<br/>
</a>




<a href='#M000225'>
move<br/>
</a>




<a href='#M000188'>
new<br/>
</a>




<a href='#M000234'>
order_todos<br/>
</a>




<a href='#M000231'>
pause_work_ajax<br/>
</a>




<a href='#M000227'>
quick_add<br/>
</a>




<a href='#M000200'>
repeat_task<br/>
</a>




<a href='#M000194'>
resource<br/>
</a>




<a href='#M000223'>
save_log<br/>
</a>




<a href='#M000238'>
save_tag<br/>
</a>




<a href='#M000240'>
set_unread<br/>
</a>




<a href='#M000230'>
shortlist<br/>
</a>




<a href='#M000208'>
start_work<br/>
</a>




<a href='#M000209'>
start_work_ajax<br/>
</a>




<a href='#M000210'>
start_work_edit_ajax<br/>
</a>




<a href='#M000214'>
stop_work<br/>
</a>




<a href='#M000215'>
stop_work_shortlist<br/>
</a>




<a href='#M000212'>
swap_work_ajax<br/>
</a>




<a href='#M000236'>
tags<br/>
</a>




<a href='#M000233'>
todo_check_ajax<br/>
</a>




<a href='#M000235'>
todo_delete_ajax<br/>
</a>




<a href='#M000226'>
toggle_history<br/>
</a>




<a href='#M000201'>
update<br/>
</a>




<a href='#M000202'>
update_ajax<br/>
</a>




<a href='#M000217'>
update_sheet_info<br/>
</a>




<a href='#M000218'>
update_tasks<br/>
</a>




<a href='#M000216'>
updatelog<br/>
</a>




<a href='#M000198'>
view<br/>
</a>


</div>
<div id="spacer"></div><div class="navigation darker index" id="class_wrapper"><div class="list_header"><h3>All classes</h3></div><div class="list_header_link"><a onclick="toggle('class'); toggleText('class_link'); return false;" href="#" id="class_link">Hide...</a></div><div class="clear"></div><div id="class"><form><label for="filter_class">Filter:&nbsp;&nbsp;</label><input type="text" onKeyUp="return filterList('class', this.value, event);" onKeyPress="return disableSubmit(event);" id="filter_class"></input></form></div></div><div class="navigation darker index" id="file_wrapper"><div class="list_header"><h3>All files</h3></div><div class="list_header_link"><a onclick="toggle('file'); toggleText('file_link'); return false;" href="#" id="file_link">Hide...</a></div><div class="clear"></div><div id="file"><form><label for="filter_file">Filter:&nbsp;&nbsp;</label><input type="text" onKeyUp="return filterList('file', this.value, event);" onKeyPress="return disableSubmit(event);" id="filter_file"></input></form></div></div><div class="navigation darker index" id="method_wrapper"><div class="list_header"><h3>All methods</h3></div><div class="list_header_link"><a onclick="toggle('method'); toggleText('method_link'); return false;" href="#" id="method_link">Show...</a></div><div class="clear"></div><div id="method"><form><label for="filter_method">Filter:&nbsp;&nbsp;</label><input type="text" onKeyUp="return filterList('method', this.value, event);" onKeyPress="return disableSubmit(event);" id="filter_method"></input></form></div></div></div><div id="content">
<h1 id="item_name">Class: TasksController</h1>

<div id="description"><p>
Handle tasks for a <a href="Company.html">Company</a> / <a
href="User.html">User</a>
</p>
<table>
<tr><td valign="top">Author:</td><td>Erlend Simonsen (<a
href="mailto:admin@clockingit.com">admin@clockingit.com</a>)

</td></tr>
</table>
</div>




<p></p>






<h1>Public Instance Methods</h1>


<a class="small" name="M000222"><br/></a>
<div class="method_block"><h3>
<a href='#M000222'>


add_log

()

</a>
</h3>

<p class="source_link" id="M000222-show-link"><a onclick="toggle('M000222-source'); toggleText('M000222-link'); return false;" href="#" id="M000222-link">Show source...</a></p><div class="source" id="M000222-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 964</span>
964:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">add_log</span>
965:     <span class="ruby-ivar">@log</span> = <span class="ruby-constant">Worklog</span>.<span class="ruby-identifier">new</span>
966:     <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">started_at</span> = <span class="ruby-identifier">tz</span>.<span class="ruby-identifier">utc_to_local</span>(<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>)
967:     <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;company_id = ?&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>])
968:     <span class="ruby-identifier">render</span> <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'edit_log'</span>
969:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000213"><br/></a>
<div class="method_block"><h3>
<a href='#M000213'>


add_work

()

</a>
</h3>

<p class="source_link" id="M000213-show-link"><a onclick="toggle('M000213-source'); toggleText('M000213-link'); return false;" href="#" id="M000213-link">Show source...</a></p><div class="source" id="M000213-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 834</span>
834:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">add_work</span>
835:     <span class="ruby-keyword kw">begin</span>
836:       <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>( <span class="ruby-identifier">params</span>[<span class="ruby-value str">'id'</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;tasks.project_id IN (#{current_project_ids})&quot;</span>] )
837:     <span class="ruby-keyword kw">rescue</span>
838:       <span class="ruby-identifier">flash</span>[<span class="ruby-value str">'notice'</span>] = <span class="ruby-identifier">_</span>(<span class="ruby-value str">'Unable to find task belonging to you with that ID.'</span>)
839:       <span class="ruby-identifier">redirect_from_last</span>
840:       <span class="ruby-keyword kw">return</span>
841:     <span class="ruby-keyword kw">end</span>
842: 
843:     <span class="ruby-ivar">@log</span> = <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">new</span>
844:     <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">user</span> = <span class="ruby-identifier">current_user</span>
845:     <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">company</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company</span>
846:     <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">project</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>
847:     <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">task</span> = <span class="ruby-ivar">@task</span>
848:     <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">customer</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">customer</span>
849:     <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">started_at</span> = <span class="ruby-identifier">tz</span>.<span class="ruby-identifier">utc_to_local</span>(<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>)
850:     <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-value">0</span>
851:     <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_WORK_ADDED</span>
852:     
853:     <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">save</span>
854:     <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; @task.id)}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
855: 
856:     <span class="ruby-identifier">render</span> <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'edit_log'</span>
857:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000206"><br/></a>
<div class="method_block"><h3>
<a href='#M000206'>


ajax_check

()

</a>
</h3>

<p class="source_link" id="M000206-show-link"><a onclick="toggle('M000206-source'); toggleText('M000206-link'); return false;" href="#" id="M000206-link">Show source...</a></p><div class="source" id="M000206-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 655</span>
655:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">ajax_check</span>
656:     <span class="ruby-keyword kw">begin</span>
657:       <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;project_id IN (?)&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span><span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span>}], <span class="ruby-identifier">:include</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:project</span>)
658:     <span class="ruby-keyword kw">rescue</span>
659:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:nothing</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>
660:       <span class="ruby-keyword kw">return</span>
661:     <span class="ruby-keyword kw">end</span> 
662: 
663:     <span class="ruby-identifier">old_status</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status_type</span>
664:     
665:     <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">completed_at</span>
666: 
667:       <span class="ruby-identifier">worklog</span> = <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">new</span>
668:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">user</span> = <span class="ruby-identifier">current_user</span>
669:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">company</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">company</span>
670:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">customer</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">customer</span>
671:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">project</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>
672:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">task</span> = <span class="ruby-ivar">@task</span>
673: 
674:       <span class="ruby-identifier">body</span> = <span class="ruby-value str">&quot;&quot;</span>
675: 
676:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@current_sheet</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">task_id</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">id</span>
677:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">started_at</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">created_at</span>
678:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">duration</span>
679:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">paused_duration</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">paused_duration</span>
680:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_COMPLETED</span>
681:         <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">body</span>.<span class="ruby-identifier">blank?</span>
682:           <span class="ruby-identifier">body</span> = <span class="ruby-node">&quot;\n#{@current_sheet.body}&quot;</span>
683:           <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">comment</span> = <span class="ruby-keyword kw">true</span> 
684:         <span class="ruby-keyword kw">end</span> 
685:       <span class="ruby-keyword kw">else</span> 
686:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">started_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>
687:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-value">0</span>
688:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_COMPLETED</span>
689:       <span class="ruby-keyword kw">end</span> 
690: 
691:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">completed_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>
692:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">updated_by_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
693:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status</span> = <span class="ruby-value">2</span>
694:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">save</span>
695:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">reload</span>
696: 
697:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">body</span> = <span class="ruby-node">&quot;- &lt;strong&gt;Status&lt;/strong&gt;: #{old_status} -&gt; #{@task.status_type}\n&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">body</span>
698:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">save</span>
699:         <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">destroy</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@current_sheet</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">task_id</span> <span class="ruby-operator">==</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">id</span>
700:       <span class="ruby-keyword kw">end</span> 
701: 
702: 
703:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">next_repeat_date</span> <span class="ruby-operator">!=</span> <span class="ruby-keyword kw">nil</span>
704:           <span class="ruby-identifier">repeat_task</span>(<span class="ruby-ivar">@task</span>)
705:       <span class="ruby-keyword kw">end</span>
706: 
707:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">send_notifications?</span>
708:         <span class="ruby-constant">Notifications</span><span class="ruby-operator">::</span><span class="ruby-identifier">deliver_changed</span>(<span class="ruby-identifier">:completed</span>, <span class="ruby-ivar">@task</span>, <span class="ruby-identifier">current_user</span>, <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">body</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/&lt;[^&gt;]*&gt;/</span>,<span class="ruby-value str">''</span>) ) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
709:       <span class="ruby-keyword kw">end</span>
710: 
711:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; @task.id)}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
712:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'activities', :action =&gt; 'refresh')}');&quot;</span>, [<span class="ruby-node">&quot;activity_#{current_user.company_id}&quot;</span>])
713:     <span class="ruby-keyword kw">end</span>
714: 
715:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000203"><br/></a>
<div class="method_block"><h3>
<a href='#M000203'>


ajax_hide

()

</a>
</h3>

<p class="source_link" id="M000203-show-link"><a onclick="toggle('M000203-source'); toggleText('M000203-link'); return false;" href="#" id="M000203-link">Show source...</a></p><div class="source" id="M000203-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 552</span>
552:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">ajax_hide</span>
553:     <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;project_id IN (#{current_project_ids})&quot;</span>])
554: 
555:     <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">hidden</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
556:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">hidden</span> = <span class="ruby-value">1</span>
557:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">updated_by_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
558:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">save</span>
559: 
560:       <span class="ruby-identifier">worklog</span> = <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">new</span>
561:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">user</span> = <span class="ruby-identifier">current_user</span>
562:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">company</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">company</span>
563:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">customer</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">customer</span>
564:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">project</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>
565:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">task</span> = <span class="ruby-ivar">@task</span>
566:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">started_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>
567:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-value">0</span>
568:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_ARCHIVED</span>
569:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">body</span> = <span class="ruby-value str">&quot;&quot;</span>
570:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">save</span>
571:     <span class="ruby-keyword kw">end</span>
572: 
573:     <span class="ruby-identifier">render</span> <span class="ruby-identifier">:nothing</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>
574:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000205"><br/></a>
<div class="method_block"><h3>
<a href='#M000205'>


ajax_restore

()

</a>
</h3>

<p class="source_link" id="M000205-show-link"><a onclick="toggle('M000205-source'); toggleText('M000205-link'); return false;" href="#" id="M000205-link">Show source...</a></p><div class="source" id="M000205-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 631</span>
631:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">ajax_restore</span>
632:     <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;project_id IN (#{current_project_ids})&quot;</span>])
633:     <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">hidden</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
634:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">hidden</span> = <span class="ruby-value">0</span>
635:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">updated_by_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
636:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">save</span>
637: 
638:       <span class="ruby-identifier">worklog</span> = <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">new</span>
639:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">user</span> = <span class="ruby-identifier">current_user</span>
640:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">company</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">company</span>
641:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">customer</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">customer</span>
642:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">project</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>
643:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">task</span> = <span class="ruby-ivar">@task</span>
644:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">started_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>
645:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-value">0</span>
646:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-value">1</span>
647:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_RESTORED</span>
648:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">body</span> = <span class="ruby-value str">&quot;&quot;</span>
649:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">save</span>
650:     <span class="ruby-keyword kw">end</span>
651:     <span class="ruby-identifier">render</span> <span class="ruby-identifier">:nothing</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>
652:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000207"><br/></a>
<div class="method_block"><h3>
<a href='#M000207'>


ajax_uncheck

()

</a>
</h3>

<p class="source_link" id="M000207-show-link"><a onclick="toggle('M000207-source'); toggleText('M000207-link'); return false;" href="#" id="M000207-link">Show source...</a></p><div class="source" id="M000207-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 717</span>
717:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">ajax_uncheck</span>
718:     <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;project_id IN (?)&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span><span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span>}], <span class="ruby-identifier">:include</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:project</span>)
719: 
720:     <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">completed_at</span>.<span class="ruby-identifier">nil?</span>
721: 
722:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">completed_at</span> = <span class="ruby-keyword kw">nil</span>
723:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status</span> = <span class="ruby-value">0</span>
724:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">updated_by_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
725:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">save</span>
726: 
727:       <span class="ruby-identifier">worklog</span> = <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">new</span>
728:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">user</span> = <span class="ruby-identifier">current_user</span>
729:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">company</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">company</span>
730:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">customer</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">customer</span>
731:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">project</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>
732:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">task</span> = <span class="ruby-ivar">@task</span>
733:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">started_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>
734:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-value">0</span>
735:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_REVERTED</span>
736:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">body</span> = <span class="ruby-value str">&quot;&quot;</span>
737:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">save</span>
738: 
739:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">send_notifications?</span>
740:         <span class="ruby-constant">Notifications</span><span class="ruby-operator">::</span><span class="ruby-identifier">deliver_changed</span>(<span class="ruby-identifier">:reverted</span>, <span class="ruby-ivar">@task</span>, <span class="ruby-identifier">current_user</span>, <span class="ruby-value str">&quot;&quot;</span> ) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">begin</span> <span class="ruby-keyword kw">end</span>
741:       <span class="ruby-keyword kw">end</span>
742: 
743:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; @task.id)}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
744:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'activities', :action =&gt; 'refresh')}');&quot;</span>, [<span class="ruby-node">&quot;activity_#{current_user.company_id}&quot;</span>])
745:     <span class="ruby-keyword kw">end</span>
746: 
747:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000193"><br/></a>
<div class="method_block"><h3>
<a href='#M000193'>


auto_complete_for_resource_name

()

</a>
</h3>

<p class="source_link" id="M000193-show-link"><a onclick="toggle('M000193-source'); toggleText('M000193-link'); return false;" href="#" id="M000193-link">Show source...</a></p><div class="source" id="M000193-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 113</span>
113:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">auto_complete_for_resource_name</span>
114:     <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">use_resources?</span>
115: 
116:     <span class="ruby-identifier">search</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:resource</span>]
117:     <span class="ruby-identifier">search</span> = <span class="ruby-identifier">search</span>[<span class="ruby-identifier">:name</span>] <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">search</span>
118:     <span class="ruby-identifier">search</span> = <span class="ruby-identifier">search</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">&quot;,&quot;</span>).<span class="ruby-identifier">last</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">search</span>
119:     <span class="ruby-ivar">@resources</span> = []
120: 
121:     <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">search</span>.<span class="ruby-identifier">blank?</span>
122:       <span class="ruby-identifier">conds</span> = <span class="ruby-value str">&quot;lower(name) like ?&quot;</span>
123:       <span class="ruby-identifier">cond_params</span> = [ <span class="ruby-node">&quot;%#{ search.downcase }%&quot;</span> ]
124:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:customer_id</span>]
125:         <span class="ruby-identifier">conds</span> <span class="ruby-operator">+=</span> <span class="ruby-value str">&quot;and (customer_id is null or customer_id = ?)&quot;</span>
126:         <span class="ruby-identifier">cond_params</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:customer_id</span>]
127:       <span class="ruby-keyword kw">end</span>
128: 
129:       <span class="ruby-identifier">conds</span> = [ <span class="ruby-identifier">conds</span> ] <span class="ruby-operator">+</span> <span class="ruby-identifier">cond_params</span>
130:       <span class="ruby-ivar">@resources</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company</span>.<span class="ruby-identifier">resources</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, 
131:                                                        <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">conds</span>)
132:     <span class="ruby-keyword kw">end</span>
133:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000211"><br/></a>
<div class="method_block"><h3>
<a href='#M000211'>


cancel_work_ajax

()

</a>
</h3>

<p class="source_link" id="M000211-show-link"><a onclick="toggle('M000211-source'); toggleText('M000211-link'); return false;" href="#" id="M000211-link">Show source...</a></p><div class="source" id="M000211-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 782</span>
782:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">cancel_work_ajax</span>
783:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@current_sheet</span> 
784:       <span class="ruby-ivar">@task</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">task</span>
785:       <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">destroy</span>
786:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; @current_sheet.task_id)}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
787:       <span class="ruby-ivar">@current_sheet</span> = <span class="ruby-keyword kw">nil</span>
788:     <span class="ruby-keyword kw">end</span>
789:     <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">xhr?</span>
790:     <span class="ruby-identifier">redirect_from_last</span>
791:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000197"><br/></a>
<div class="method_block"><h3>
<a href='#M000197'>


create

()

</a>
</h3>
<p>
def get_watchers
</p>
<pre>
  @users = Project.find(params[:project_id]).users.find(:all, :order =&gt; 'name' )

  @options = @users.collect{ |u| (' {&quot;text&quot;:&quot;' + u.name.gsub(/&quot;/,'\&quot;') + '&quot;, &quot;value&quot;:&quot;' + u.id.to_s + '&quot;}') }.join( ',' )
  res = '{&quot;options&quot;:['
  res &lt;&lt; &quot;#{@options}&quot; unless @options.nil? || @options.empty?
  res &lt;&lt; ']}'

  render :text =&gt; &quot;#{res}&quot;
</pre>
<p>
end
</p>

<p class="source_link" id="M000197-show-link"><a onclick="toggle('M000197-source'); toggleText('M000197-link'); return false;" href="#" id="M000197-link">Show source...</a></p><div class="source" id="M000197-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 179</span>
179:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">create</span>
180: 
181:     <span class="ruby-identifier">tags</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:set_tags</span>]
182:     <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:set_tags</span>] = <span class="ruby-keyword kw">nil</span>
183: 
184:     <span class="ruby-ivar">@task</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company</span>.<span class="ruby-identifier">tasks</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>])
185: 
186:     <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:due_at</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:due_at</span>].<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
187: 
188:       <span class="ruby-identifier">repeat</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">parse_repeat</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:due_at</span>])
189:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">repeat</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">repeat</span> <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;&quot;</span>
190:         <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">repeat</span> = <span class="ruby-identifier">repeat</span>
191:         <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">due_at</span> = <span class="ruby-identifier">tz</span>.<span class="ruby-identifier">local_to_utc</span>(<span class="ruby-ivar">@task</span>.<span class="ruby-identifier">next_repeat_date</span>)
192:       <span class="ruby-keyword kw">else</span>
193:         <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">repeat</span> = <span class="ruby-keyword kw">nil</span>
194:         <span class="ruby-identifier">due_date</span> = <span class="ruby-constant">DateTime</span>.<span class="ruby-identifier">strptime</span>( <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:due_at</span>], <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">date_format</span> ) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">begin</span>
195:                                                                                                     <span class="ruby-identifier">flash</span>[<span class="ruby-value str">'notice'</span>] = <span class="ruby-identifier">_</span>(<span class="ruby-value str">'Invalid due date ignored.'</span>)
196:                                                                                                     <span class="ruby-identifier">due_date</span> = <span class="ruby-keyword kw">nil</span>
197:                                                                                                   <span class="ruby-keyword kw">end</span>
198:         <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">due_at</span> = <span class="ruby-identifier">tz</span>.<span class="ruby-identifier">local_to_utc</span>(<span class="ruby-identifier">due_date</span>.<span class="ruby-identifier">to_time</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>.<span class="ruby-identifier">day</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>.<span class="ruby-identifier">minute</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">due_date</span>.<span class="ruby-identifier">nil?</span>
199:       <span class="ruby-keyword kw">end</span>
200:     <span class="ruby-keyword kw">else</span>
201:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">repeat</span> = <span class="ruby-keyword kw">nil</span>
202:     <span class="ruby-keyword kw">end</span>
203: 
204:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">company_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>
205:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">updated_by_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
206:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">creator_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
207:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-identifier">parse_time</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:duration</span>], <span class="ruby-keyword kw">true</span>) 
208:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">set_tags</span>(<span class="ruby-identifier">tags</span>) 
209:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">set_task_num</span>(<span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>)
210:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-value">0</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">duration</span>.<span class="ruby-identifier">nil?</span>
211: 
212:     <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">can?</span>(<span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>, <span class="ruby-value str">'create'</span>)
213:       <span class="ruby-identifier">flash</span>[<span class="ruby-value str">'notice'</span>] = <span class="ruby-identifier">_</span>(<span class="ruby-value str">&quot;You don't have access to create tasks on this project.&quot;</span>)
214:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">xhr?</span>
215: 
216:       <span class="ruby-ivar">@projects</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'name'</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;completed_at IS NULL&quot;</span>]).<span class="ruby-identifier">collect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> [ <span class="ruby-node">&quot;#{c.name} / #{c.customer.name}&quot;</span>, <span class="ruby-identifier">c</span>.<span class="ruby-identifier">id</span> ] <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">can?</span>(<span class="ruby-identifier">c</span>, <span class="ruby-value str">'create'</span>)  }.<span class="ruby-identifier">compact</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">nil?</span>
217:       <span class="ruby-ivar">@tags</span> = <span class="ruby-constant">Tag</span>.<span class="ruby-identifier">top_counts</span>({ <span class="ruby-identifier">:company_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>, <span class="ruby-identifier">:project_ids</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">current_project_ids</span>, <span class="ruby-identifier">:filter_hidden</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_hidden</span>]})
218:       <span class="ruby-ivar">@notify_targets</span> = <span class="ruby-identifier">current_projects</span>.<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">users</span>.<span class="ruby-identifier">collect</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">:name</span>) }.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>
219:       <span class="ruby-ivar">@notify_targets</span> <span class="ruby-operator">+=</span> <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;project_id IN (#{current_project_ids}) AND notify_emails IS NOT NULL and notify_emails &lt;&gt; ''&quot;</span>]).<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">notify_emails</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">','</span>).<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">strip</span> } }
220:       <span class="ruby-ivar">@notify_targets</span> = <span class="ruby-ivar">@notify_targets</span>.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>
221:       <span class="ruby-ivar">@notify_targets</span> <span class="ruby-operator">||=</span> []
222: 
223:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'new'</span>
224:       <span class="ruby-keyword kw">return</span>
225:     <span class="ruby-keyword kw">end</span>
226:     
227:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">save</span>
228:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:last_project_id</span>] = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project_id</span>
229: 
230:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">set_watcher_attributes</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:watchers</span>], <span class="ruby-identifier">current_user</span>)
231:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">set_owner_attributes</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:users</span>])
232:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">set_dependency_attributes</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:dependencies</span>], <span class="ruby-identifier">current_project_ids</span>)
233:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">set_resource_attributes</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:resource</span>])
234: 
235:       <span class="ruby-identifier">create_attachments</span>(<span class="ruby-ivar">@task</span>)
236:       <span class="ruby-identifier">worklog</span> = <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">create_for_task</span>(<span class="ruby-ivar">@task</span>, <span class="ruby-identifier">current_user</span>, <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:comment</span>])
237: 
238:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value str">'notify'</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
239:         <span class="ruby-keyword kw">begin</span>
240:           <span class="ruby-constant">Notifications</span><span class="ruby-operator">::</span><span class="ruby-identifier">deliver_created</span>(<span class="ruby-ivar">@task</span>, <span class="ruby-identifier">current_user</span>, <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:comment</span>])
241:         <span class="ruby-keyword kw">rescue</span>
242:           <span class="ruby-comment cmt"># TODO: (from BW) why is this here? </span>
243:           <span class="ruby-comment cmt"># If deliver_created throws an exception don't we want to know about it?</span>
244:         <span class="ruby-keyword kw">end</span>
245:       <span class="ruby-keyword kw">end</span>
246: 
247:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>(<span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'activities', :action =&gt; 'refresh')}');&quot;</span>, [<span class="ruby-node">&quot;activity_#{current_user.company_id}&quot;</span>])
248: 
249:       <span class="ruby-identifier">flash</span>[<span class="ruby-value str">'notice'</span>] <span class="ruby-operator">||=</span> <span class="ruby-node">&quot;#{link_to_task(@task)} - #{_('Task was successfully created.')}&quot;</span>
250: 
251:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">xhr?</span>
252:       <span class="ruby-identifier">redirect_from_last</span>
253:     <span class="ruby-keyword kw">else</span>
254:       <span class="ruby-ivar">@projects</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'name'</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;completed_at IS NULL&quot;</span>]).<span class="ruby-identifier">collect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> [ <span class="ruby-node">&quot;#{c.name} / #{c.customer.name}&quot;</span>, <span class="ruby-identifier">c</span>.<span class="ruby-identifier">id</span> ] <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">can?</span>(<span class="ruby-identifier">c</span>, <span class="ruby-value str">'create'</span>)  }.<span class="ruby-identifier">compact</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">nil?</span>
255:       <span class="ruby-ivar">@tags</span> = <span class="ruby-constant">Tag</span>.<span class="ruby-identifier">top_counts</span>({ <span class="ruby-identifier">:company_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>, <span class="ruby-identifier">:project_ids</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">current_project_ids</span>, <span class="ruby-identifier">:filter_hidden</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_hidden</span>]})
256:       <span class="ruby-ivar">@notify_targets</span> = <span class="ruby-identifier">current_projects</span>.<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">users</span>.<span class="ruby-identifier">collect</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">:name</span>) }.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>
257:       <span class="ruby-ivar">@notify_targets</span> <span class="ruby-operator">+=</span> <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;project_id IN (#{current_project_ids}) AND notify_emails IS NOT NULL and notify_emails &lt;&gt; ''&quot;</span>]).<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">notify_emails</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">','</span>).<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">strip</span> } }
258:       <span class="ruby-ivar">@notify_targets</span> = <span class="ruby-ivar">@notify_targets</span>.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>
259:       <span class="ruby-ivar">@notify_targets</span> <span class="ruby-operator">||=</span> []
260:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">xhr?</span>
261:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'new'</span>
262:     <span class="ruby-keyword kw">end</span>
263:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000228"><br/></a>
<div class="method_block"><h3>
<a href='#M000228'>


create_ajax

()

</a>
</h3>

<p class="source_link" id="M000228-show-link"><a onclick="toggle('M000228-source'); toggleText('M000228-link'); return false;" href="#" id="M000228-link">Show source...</a></p><div class="source" id="M000228-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1286</span>
1286:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">create_ajax</span>
1287:     <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">create</span>
1288:     <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">id</span>
1289:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1290:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-value str">&quot;quick_add_container&quot;</span>, <span class="ruby-identifier">:duration</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span><span class="ruby-value">.5</span>, <span class="ruby-identifier">:startcolor</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;#ff9999&quot;</span>)
1291:       <span class="ruby-keyword kw">end</span>
1292:     <span class="ruby-keyword kw">else</span>
1293:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">reload</span>
1294:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1295:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">insert_html</span> <span class="ruby-identifier">:top</span>, <span class="ruby-value str">&quot;task_list&quot;</span>, <span class="ruby-identifier">:partial</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'task_row'</span>, <span class="ruby-identifier">:locals</span> =<span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">:task</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@task</span>, <span class="ruby-identifier">:depth</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>}
1296:         [<span class="ruby-value str">'task_name'</span>, <span class="ruby-value str">'task_set_tags'</span>, <span class="ruby-value str">'task_description'</span>, <span class="ruby-value str">'dependencies_input'</span>, <span class="ruby-value str">'task_duration'</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">el</span><span class="ruby-operator">|</span>
1297:           <span class="ruby-identifier">page</span>.<span class="ruby-identifier">call</span> <span class="ruby-node">&quot;$('#{el}').clear&quot;</span>
1298:         <span class="ruby-keyword kw">end</span>
1299:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-node">&quot;task_#{@task.id}&quot;</span>, <span class="ruby-identifier">:duration</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">1.5</span>)
1300:         <span class="ruby-identifier">page</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;$('task_name').focus();&quot;</span>
1301:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">call</span>(<span class="ruby-value str">&quot;updateTooltips&quot;</span>)
1302:       <span class="ruby-keyword kw">end</span>
1303:     <span class="ruby-keyword kw">end</span>
1304:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000204"><br/></a>
<div class="method_block"><h3>
<a href='#M000204'>


create_attachments

(task)

</a>
</h3>

<p class="source_link" id="M000204-show-link"><a onclick="toggle('M000204-source'); toggleText('M000204-link'); return false;" href="#" id="M000204-link">Show source...</a></p><div class="source" id="M000204-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 576</span>
576:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">create_attachments</span>(<span class="ruby-identifier">task</span>)
577:          <span class="ruby-identifier">filenames</span> = []
578:          <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">params</span>[<span class="ruby-value str">'tmp_files'</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">params</span>[<span class="ruby-value str">'tmp_files'</span>].<span class="ruby-identifier">select</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">f</span> <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;&quot;</span>}.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
579:                  <span class="ruby-identifier">params</span>[<span class="ruby-value str">'tmp_files'</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">tmp_file</span><span class="ruby-operator">|</span>
580:                          <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">tmp_file</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">String</span>)
581:                    <span class="ruby-identifier">filename</span> = <span class="ruby-identifier">tmp_file</span>.<span class="ruby-identifier">original_filename</span>
582:              <span class="ruby-identifier">filename</span> = <span class="ruby-identifier">filename</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">&quot;/&quot;</span>).<span class="ruby-identifier">last</span>
583:              <span class="ruby-identifier">filename</span> = <span class="ruby-identifier">filename</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">&quot;\\&quot;</span>).<span class="ruby-identifier">last</span>
584:              <span class="ruby-identifier">filename</span> = <span class="ruby-identifier">filename</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/[^\w.]/</span>, <span class="ruby-value str">'_'</span>)
585:   
586:              <span class="ruby-identifier">task_file</span> = <span class="ruby-constant">ProjectFile</span>.<span class="ruby-identifier">new</span>()
587:              <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">company</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company</span>
588:              <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">customer</span> = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">customer</span>
589:              <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">project</span> = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">project</span>
590:              <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">task_id</span> = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">id</span>
591:              <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">user_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
592:              <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">filename</span> = <span class="ruby-identifier">filename</span>
593:              <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">name</span> = <span class="ruby-identifier">filename</span>
594:              <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">save</span>
595:              <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">file_size</span> = <span class="ruby-identifier">tmp_file</span>.<span class="ruby-identifier">size</span>
596:   
597:              <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">save</span>
598:              <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">reload</span>
599:   
600:              <span class="ruby-constant">File</span>.<span class="ruby-identifier">umask</span>(<span class="ruby-value">0</span>)
601:              <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-constant">File</span>.<span class="ruby-identifier">directory?</span>(<span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">path</span>)
602:               <span class="ruby-constant">Dir</span>.<span class="ruby-identifier">mkdir</span>(<span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">path</span>, <span class="ruby-value">0777</span>) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
603:              <span class="ruby-keyword kw">end</span>
604:   
605:              <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">file_path</span>, <span class="ruby-value str">&quot;wb&quot;</span>, <span class="ruby-value">0777</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">f</span><span class="ruby-operator">|</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">write</span>( <span class="ruby-identifier">tmp_file</span>.<span class="ruby-identifier">read</span> ) } <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">begin</span>
606:                                                     <span class="ruby-identifier">flash</span>[<span class="ruby-value str">'notice'</span>] = <span class="ruby-identifier">_</span>(<span class="ruby-node">&quot;Permission denied while saving file to #{task_file.file_path}.&quot;</span>)
607:                                                     <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">destroy</span>
608:                                                     <span class="ruby-identifier">task_file</span> = <span class="ruby-keyword kw">nil</span>
609:                                                     <span class="ruby-keyword kw">next</span>
610:                                                     <span class="ruby-keyword kw">end</span>
611:              <span class="ruby-identifier">filenames</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">filename</span>
612:              <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">task_file</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">filename</span>[<span class="ruby-regexp re">/\.gif|\.png|\.jpg|\.jpeg|\.tif|\.bmp|\.psd/i</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">file_size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
613:                <span class="ruby-identifier">image</span> = <span class="ruby-constant">ImageOperations</span><span class="ruby-operator">::</span><span class="ruby-identifier">get_image</span>( <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">file_path</span> )
614:                                  <span class="ruby-keyword kw">if</span> <span class="ruby-constant">ImageOperations</span><span class="ruby-operator">::</span><span class="ruby-identifier">is_image?</span>(<span class="ruby-identifier">image</span>)
615:                  <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">file_type</span> = <span class="ruby-constant">ProjectFile</span><span class="ruby-operator">::</span><span class="ruby-constant">FILETYPE_IMG</span>
616:                  <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">mime_type</span> = <span class="ruby-identifier">image</span>.<span class="ruby-identifier">mime_type</span>
617:                  <span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">save</span>
618:                                          <span class="ruby-identifier">thumb</span> = <span class="ruby-constant">ImageOperations</span><span class="ruby-operator">::</span><span class="ruby-identifier">thumbnail</span>(<span class="ruby-identifier">image</span>, <span class="ruby-value">124</span>)
619:                  <span class="ruby-identifier">f</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">task_file</span>.<span class="ruby-identifier">thumbnail_path</span>, <span class="ruby-value str">&quot;w&quot;</span>, <span class="ruby-value">0777</span>)
620:                  <span class="ruby-identifier">f</span>.<span class="ruby-identifier">write</span>(<span class="ruby-identifier">thumb</span>.<span class="ruby-identifier">to_blob</span>)
621:                  <span class="ruby-identifier">f</span>.<span class="ruby-identifier">close</span>
622:                <span class="ruby-keyword kw">end</span>
623:                <span class="ruby-identifier">image</span> = <span class="ruby-identifier">thumb</span> = <span class="ruby-keyword kw">nil</span>
624:                <span class="ruby-constant">GC</span>.<span class="ruby-identifier">start</span>
625:              <span class="ruby-keyword kw">end</span>
626:            <span class="ruby-keyword kw">end</span>
627:          <span class="ruby-keyword kw">end</span>
628:          <span class="ruby-identifier">filenames</span>
629:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000229"><br/></a>
<div class="method_block"><h3>
<a href='#M000229'>


create_shortlist_ajax

()

</a>
</h3>

<p class="source_link" id="M000229-show-link"><a onclick="toggle('M000229-source'); toggleText('M000229-link'); return false;" href="#" id="M000229-link">Show source...</a></p><div class="source" id="M000229-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1306</span>
1306:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">create_shortlist_ajax</span>
1307: 
1308:     <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:name</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:name</span>].<span class="ruby-identifier">empty?</span>
1309:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1310:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-value str">&quot;shortlist&quot;</span>, <span class="ruby-identifier">:duration</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span><span class="ruby-value">.5</span>, <span class="ruby-identifier">:startcolor</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;#ff9999&quot;</span>)
1311:       <span class="ruby-keyword kw">end</span>
1312:       <span class="ruby-keyword kw">return</span>
1313:     <span class="ruby-keyword kw">end</span>
1314: 
1315:     <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">new</span>
1316:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">name</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:name</span>]
1317:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">company_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>
1318:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">updated_by_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
1319:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">creator_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
1320:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-value">0</span>
1321:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">set_task_num</span>(<span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>)
1322:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">description</span> = <span class="ruby-value str">&quot;&quot;</span>
1323: 
1324:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_milestone_short</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
1325:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span> = <span class="ruby-constant">Milestone</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;company_id = ? AND id = ?&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>, <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_milestone_short</span>]]).<span class="ruby-identifier">project</span>
1326:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone_id</span> = <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_milestone_short</span>].<span class="ruby-identifier">to_i</span>
1327:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project_short</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
1328:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project_id</span> = <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project_short</span>].<span class="ruby-identifier">to_i</span>
1329:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone_id</span> = <span class="ruby-keyword kw">nil</span>
1330:     <span class="ruby-keyword kw">else</span>
1331:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1332:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-value str">&quot;shortlist&quot;</span>, <span class="ruby-identifier">:duration</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span><span class="ruby-value">.5</span>, <span class="ruby-identifier">:startcolor</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;#ff9999&quot;</span>)
1333:       <span class="ruby-keyword kw">end</span>
1334:       <span class="ruby-keyword kw">return</span>
1335:     <span class="ruby-keyword kw">end</span>
1336: 
1337:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">save</span>
1338:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">reload</span>
1339: 
1340:     <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">id</span>
1341:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1342:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-value str">&quot;quick_add_container&quot;</span>, <span class="ruby-identifier">:duration</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span><span class="ruby-value">.5</span>, <span class="ruby-identifier">:startcolor</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;#ff9999&quot;</span>)
1343:       <span class="ruby-keyword kw">end</span>
1344:     <span class="ruby-keyword kw">else</span>
1345:       <span class="ruby-identifier">to</span> = <span class="ruby-constant">TaskOwner</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">:user</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">current_user</span>, <span class="ruby-identifier">:task</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@task</span>)
1346:       <span class="ruby-identifier">to</span>.<span class="ruby-identifier">save</span>
1347: 
1348:       <span class="ruby-identifier">worklog</span> = <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">new</span>
1349:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">user</span> = <span class="ruby-identifier">current_user</span>
1350:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">company</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">company</span>
1351:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">customer</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">customer</span>
1352:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">project</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>
1353:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">task</span> = <span class="ruby-ivar">@task</span>
1354:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">started_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>
1355:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-value">0</span>
1356:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_CREATED</span>
1357:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">body</span> = <span class="ruby-value str">&quot;&quot;</span>
1358:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">save</span>
1359:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-value str">'notify'</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
1360:         <span class="ruby-constant">Notifications</span><span class="ruby-operator">::</span><span class="ruby-identifier">deliver_created</span>( <span class="ruby-ivar">@task</span>, <span class="ruby-identifier">current_user</span>, <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:comment</span>]) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">begin</span> <span class="ruby-keyword kw">end</span>
1361:       <span class="ruby-keyword kw">end</span>
1362: 
1363:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; @task.id)}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
1364:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'activities', :action =&gt; 'refresh')}');&quot;</span>, [<span class="ruby-node">&quot;activity_#{current_user.company_id}&quot;</span>])
1365: 
1366:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1367:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">insert_html</span> <span class="ruby-identifier">:bottom</span>, <span class="ruby-value str">&quot;shortlist-tasks&quot;</span>, <span class="ruby-identifier">:partial</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'task_row'</span>, <span class="ruby-identifier">:locals</span> =<span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">:task</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@task</span>, <span class="ruby-identifier">:depth</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>}
1368:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-node">&quot;task_#{@task.id}&quot;</span>, <span class="ruby-identifier">:duration</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">1.5</span>)
1369:         <span class="ruby-identifier">page</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;$('task_name').focus();&quot;</span>
1370:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">call</span>(<span class="ruby-value str">&quot;fixShortLinks&quot;</span>)
1371:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">call</span>(<span class="ruby-value str">&quot;updateTooltips&quot;</span>)
1372:       <span class="ruby-keyword kw">end</span>
1373:     <span class="ruby-keyword kw">end</span>
1374:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000232"><br/></a>
<div class="method_block"><h3>
<a href='#M000232'>


create_todo_ajax

()

</a>
</h3>

<p class="source_link" id="M000232-show-link"><a onclick="toggle('M000232-source'); toggleText('M000232-link'); return false;" href="#" id="M000232-link">Show source...</a></p><div class="source" id="M000232-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1421</span>
1421:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">create_todo_ajax</span>
1422: 
1423:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:todo</span>][<span class="ruby-identifier">:name</span>].<span class="ruby-identifier">blank?</span>
1424:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1425:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-node">&quot;todo-form-#{params[:id]}&quot;</span>, <span class="ruby-identifier">:duration</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span><span class="ruby-value">.5</span>, <span class="ruby-identifier">:startcolor</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;#ff9999&quot;</span>)
1426:       <span class="ruby-keyword kw">end</span>
1427:       <span class="ruby-keyword kw">return</span>
1428:     <span class="ruby-keyword kw">end</span>
1429: 
1430:     <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;id = ? AND project_id IN (#{current_project_ids})&quot;</span>, <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>]])
1431:     <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@task</span>
1432:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1433:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-node">&quot;todo-form-#{params[:id]}&quot;</span>, <span class="ruby-identifier">:duration</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span><span class="ruby-value">.5</span>, <span class="ruby-identifier">:startcolor</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;#ff9999&quot;</span>)
1434:       <span class="ruby-keyword kw">end</span>
1435:       <span class="ruby-keyword kw">return</span>
1436:     <span class="ruby-keyword kw">end</span>
1437:     <span class="ruby-ivar">@todo</span> = <span class="ruby-constant">Todo</span>.<span class="ruby-identifier">new</span>
1438:     <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">name</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:todo</span>][<span class="ruby-identifier">:name</span>]
1439:     <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">creator_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
1440:     <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">task_id</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">id</span>
1441: 
1442:     <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">save</span>
1443:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1444:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-node">&quot;todo-form-tasks-#{params[:id]}&quot;</span>, <span class="ruby-identifier">:duration</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span><span class="ruby-value">.5</span>, <span class="ruby-identifier">:startcolor</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;#ff9999&quot;</span>)
1445:       <span class="ruby-keyword kw">end</span>
1446:     <span class="ruby-keyword kw">else</span>
1447:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; params[:id])}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
1448:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'activities', :action =&gt; 'refresh')}');&quot;</span>, [<span class="ruby-node">&quot;activity_#{current_user.company_id}&quot;</span>])
1449: 
1450:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1451:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">insert_html</span> <span class="ruby-identifier">:bottom</span>, <span class="ruby-node">&quot;todo-#{@task.dom_id}&quot;</span>, <span class="ruby-identifier">:partial</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;tasks/todo_row&quot;</span>
1452:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">replace_html</span> <span class="ruby-node">&quot;todo-status-#{@task.dom_id}&quot;</span>, <span class="ruby-identifier">link_to_function</span>( <span class="ruby-node">&quot;#{@task.todo_status}&quot;</span>, <span class="ruby-node">&quot;Element.toggle('todo-container-#{@task.dom_id}');&quot;</span>, <span class="ruby-identifier">:class</span> =<span class="ruby-operator">&gt;</span> (<span class="ruby-ivar">@task</span>.<span class="ruby-identifier">todos</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-value">? </span><span class="ruby-value str">&quot;todo-status-link-empty&quot;</span> <span class="ruby-operator">:</span><span class="ruby-value str">&quot;todo-status-link&quot;</span>))
1453:         <span class="ruby-identifier">page</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;$('todo_text_#{@task.id}').clear();&quot;</span>
1454:         <span class="ruby-identifier">page</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;$('todo_text_#{@task.id}').focus();&quot;</span>
1455:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">call</span>(<span class="ruby-value str">&quot;updateTooltips&quot;</span>)
1456:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span> <span class="ruby-identifier">:highlight</span>, <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">dom_id</span>
1457:         <span class="ruby-identifier">page</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;Sortable.create('todo-#{@task.dom_id}', {containment:'todo-#{@task.dom_id}', format:/^[^-]*-(.*)$/, onUpdate:function(){new Ajax.Request('/tasks/order_todos/#{@task.id}', {asynchronous:true, evalScripts:true, parameters:Sortable.serialize('todo-#{@task.dom_id}')})}, only:'todo-active'})&quot;</span>
1458:       <span class="ruby-keyword kw">end</span>
1459:     <span class="ruby-keyword kw">end</span>
1460: 
1461:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000237"><br/></a>
<div class="method_block"><h3>
<a href='#M000237'>


delete_tag

()

</a>
</h3>

<p class="source_link" id="M000237-show-link"><a onclick="toggle('M000237-source'); toggleText('M000237-link'); return false;" href="#" id="M000237-link">Show source...</a></p><div class="source" id="M000237-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1555</span>
1555:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">delete_tag</span>
1556:     <span class="ruby-identifier">tag</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company</span>.<span class="ruby-identifier">tags</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>]) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
1557:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">tag</span>
1558:       <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">destroy</span>
1559:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1560:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">remove</span> <span class="ruby-identifier">tag</span>.<span class="ruby-identifier">dom_id</span>
1561:       <span class="ruby-keyword kw">end</span> 
1562:     <span class="ruby-keyword kw">else</span> 
1563:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:nothing</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>
1564:     <span class="ruby-keyword kw">end</span> 
1565:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000195"><br/></a>
<div class="method_block"><h3>
<a href='#M000195'>


dependency

()

</a>
</h3>

<p class="source_link" id="M000195-show-link"><a onclick="toggle('M000195-source'); toggleText('M000195-link'); return false;" href="#" id="M000195-link">Show source...</a></p><div class="source" id="M000195-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 140</span>
140:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">dependency</span>
141:     <span class="ruby-identifier">id</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:dependency_id</span>]
142:     <span class="ruby-identifier">conditions</span> = { <span class="ruby-identifier">:project_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">current_projects</span> }
143:     <span class="ruby-identifier">dependency</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company</span>.<span class="ruby-identifier">tasks</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">id</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">conditions</span>)
144: 
145:     <span class="ruby-identifier">render</span>(<span class="ruby-identifier">:partial</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;dependency&quot;</span>, 
146:            <span class="ruby-identifier">:locals</span> =<span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">:dependency</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">dependency</span>, <span class="ruby-identifier">:perms</span> =<span class="ruby-operator">&gt;</span> {} })
147:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000192"><br/></a>
<div class="method_block"><h3>
<a href='#M000192'>


dependency_targets

()

</a>
</h3>

<p class="source_link" id="M000192-show-link"><a onclick="toggle('M000192-source'); toggleText('M000192-link'); return false;" href="#" id="M000192-link">Show source...</a></p><div class="source" id="M000192-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 91</span>
 91:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">dependency_targets</span>
 92:     <span class="ruby-identifier">value</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:dependencies</span>][<span class="ruby-value">0</span>]
 93:     <span class="ruby-identifier">value</span>.<span class="ruby-identifier">gsub!</span>(<span class="ruby-regexp re">/#/</span>, <span class="ruby-value str">''</span>)
 94: 
 95:     <span class="ruby-identifier">query</span> = <span class="ruby-value str">&quot;&quot;</span>
 96:     <span class="ruby-ivar">@keys</span> = <span class="ruby-identifier">value</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">' '</span>)
 97:     <span class="ruby-ivar">@keys</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">k</span><span class="ruby-operator">|</span>
 98:       <span class="ruby-identifier">query</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;+issue_name:#{k}* &quot;</span>
 99:     <span class="ruby-keyword kw">end</span>
100: 
101:     <span class="ruby-comment cmt"># Append project id's the user has access to</span>
102:     <span class="ruby-identifier">projects</span> = <span class="ruby-value str">&quot;0&quot;</span>
103:     <span class="ruby-identifier">current_projects</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span>
104:       <span class="ruby-identifier">projects</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;|#{p.id}&quot;</span>
105:     <span class="ruby-keyword kw">end</span>
106:     <span class="ruby-identifier">projects</span> = <span class="ruby-node">&quot;+project_id:\&quot;#{projects}\&quot;&quot;</span> 
107: 
108:     <span class="ruby-comment cmt"># Find the tasks</span>
109:     <span class="ruby-ivar">@tasks</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find_by_contents</span>(<span class="ruby-node">&quot;+company_id:#{current_user.company_id} #{projects} #{query}&quot;</span>, {<span class="ruby-identifier">:limit</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">13</span>})
110:     <span class="ruby-identifier">render</span> <span class="ruby-identifier">:text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;&lt;ul&gt;#{@tasks.collect{ |t| &quot;&lt;li&gt;[#{ &quot;&lt;strike&gt;&quot; if t.done? }#&lt;span class=\&quot;complete_value\&quot;&gt;#{ t.task_num}&lt;/span&gt;#{ &quot;&lt;/strike&gt;&quot; if t.done? }] #{@keys.nil? ? t.name : highlight_all(t.name, @keys)}&lt;/li&gt;&quot;}.join(&quot;&quot;) }&lt;/ul&gt;&quot;</span>
111:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000221"><br/></a>
<div class="method_block"><h3>
<a href='#M000221'>


destroy_log

()

</a>
</h3>

<p class="source_link" id="M000221-show-link"><a onclick="toggle('M000221-source'); toggleText('M000221-link'); return false;" href="#" id="M000221-link">Show source...</a></p><div class="source" id="M000221-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 957</span>
957:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">destroy_log</span>
958:     <span class="ruby-ivar">@log</span> = <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">find</span>( <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;company_id = ?&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>] )
959:     <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">destroy</span>
960:     <span class="ruby-identifier">flash</span>[<span class="ruby-value str">'notice'</span>] = <span class="ruby-identifier">_</span>(<span class="ruby-value str">&quot;Log entry deleted...&quot;</span>)
961:     <span class="ruby-identifier">redirect_from_last</span>
962:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000199"><br/></a>
<div class="method_block"><h3>
<a href='#M000199'>


edit

()

</a>
</h3>

<p class="source_link" id="M000199-show-link"><a onclick="toggle('M000199-source'); toggleText('M000199-link'); return false;" href="#" id="M000199-link">Show source...</a></p><div class="source" id="M000199-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 274</span>
274:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">edit</span>
275:     <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;project_id IN (?)&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span><span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span>}] ) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">begin</span>
276:                                                                                                                            <span class="ruby-identifier">flash</span>[<span class="ruby-value str">'notice'</span>] = <span class="ruby-identifier">_</span>(<span class="ruby-value str">&quot;You don't have access to that task, or it doesn't exist.&quot;</span>)
277:                                                                                                                            <span class="ruby-identifier">redirect_from_last</span>
278:                                                                                                                            <span class="ruby-keyword kw">return</span>
279:                                                                                                                          <span class="ruby-keyword kw">end</span> 
280:                                                                                                                            
281:     
282:     
283:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">due_at</span> = <span class="ruby-identifier">tz</span>.<span class="ruby-identifier">utc_to_local</span>(<span class="ruby-ivar">@task</span>.<span class="ruby-identifier">due_at</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">due_at</span>.<span class="ruby-identifier">nil?</span>
284:     <span class="ruby-ivar">@tags</span> = <span class="ruby-constant">Tag</span>.<span class="ruby-identifier">top_counts</span>({ <span class="ruby-identifier">:company_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>, <span class="ruby-identifier">:project_ids</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">current_project_ids</span>, <span class="ruby-identifier">:filter_hidden</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_hidden</span>]})
285:     <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@logs</span> = <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;work_logs.started_at desc,work_logs.id desc&quot;</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;work_logs.task_id = ? #{&quot;AND (work_logs.comment = 1 OR work_logs.log_type=6)&quot; if session[:only_comments].to_i == 1}&quot;</span>, <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">id</span>], <span class="ruby-identifier">:include</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:user</span>, <span class="ruby-identifier">:task</span>, <span class="ruby-identifier">:project</span>])
286:           <span class="ruby-ivar">@logs</span> = []
287:     <span class="ruby-keyword kw">end</span>
288:     <span class="ruby-ivar">@projects</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>).<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'name'</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;completed_at IS NULL&quot;</span>]).<span class="ruby-identifier">collect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> [ <span class="ruby-node">&quot;#{c.name} / #{c.customer.name}&quot;</span>, <span class="ruby-identifier">c</span>.<span class="ruby-identifier">id</span> ] <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">can?</span>(<span class="ruby-identifier">c</span>, <span class="ruby-value str">'create'</span>)  }.<span class="ruby-identifier">compact</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">nil?</span>
289: 
290:     <span class="ruby-ivar">@notify_targets</span> = <span class="ruby-identifier">current_projects</span>.<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">users</span>.<span class="ruby-identifier">collect</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">:name</span>) }.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>
291:     <span class="ruby-ivar">@notify_targets</span> <span class="ruby-operator">+=</span> <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;project_id IN (#{current_project_ids}) AND notify_emails IS NOT NULL and notify_emails &lt;&gt; ''&quot;</span>]).<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">notify_emails</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">','</span>).<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">strip</span> } }.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>
292:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000220"><br/></a>
<div class="method_block"><h3>
<a href='#M000220'>


edit_log

()

</a>
</h3>

<p class="source_link" id="M000220-show-link"><a onclick="toggle('M000220-source'); toggleText('M000220-link'); return false;" href="#" id="M000220-link">Show source...</a></p><div class="source" id="M000220-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 951</span>
951:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">edit_log</span>
952:     <span class="ruby-ivar">@log</span> = <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">find</span>( <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;company_id = ?&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>] )
953:     <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">started_at</span> = <span class="ruby-identifier">tz</span>.<span class="ruby-identifier">utc_to_local</span>(<span class="ruby-ivar">@log</span>.<span class="ruby-identifier">started_at</span>)
954:     <span class="ruby-ivar">@task</span> = <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">task</span>
955:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000219"><br/></a>
<div class="method_block"><h3>
<a href='#M000219'>


filter_shortlist

()

</a>
</h3>

<p class="source_link" id="M000219-show-link"><a onclick="toggle('M000219-source'); toggleText('M000219-link'); return false;" href="#" id="M000219-link">Show source...</a></p><div class="source" id="M000219-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 931</span>
931:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">filter_shortlist</span>
932: 
933:     <span class="ruby-identifier">tmp</span> = { }
934:     [<span class="ruby-identifier">:filter_customer</span>, <span class="ruby-identifier">:filter_milestone</span>, <span class="ruby-identifier">:filter_project</span>, <span class="ruby-identifier">:filter_user</span>, <span class="ruby-identifier">:filter_hidden</span>, <span class="ruby-identifier">:filter_status</span>, <span class="ruby-identifier">:group_by</span>, <span class="ruby-identifier">:hide_deferred</span>, <span class="ruby-identifier">:hide_dependencies</span>, <span class="ruby-identifier">:sort</span>, <span class="ruby-identifier">:filter_type</span>, <span class="ruby-identifier">:filter_severity</span>, <span class="ruby-identifier">:filter_priority</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
935:       <span class="ruby-identifier">tmp</span>[<span class="ruby-identifier">v</span>] = <span class="ruby-identifier">session</span>[<span class="ruby-identifier">v</span>]
936:     <span class="ruby-keyword kw">end</span>
937: 
938:     <span class="ruby-identifier">do_filter</span>
939: 
940:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project_short</span>] = <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project</span>]
941:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_customer_short</span>] = <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_customer</span>]
942:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_milestone_short</span>] = <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_milestone</span>]
943: 
944:     [<span class="ruby-identifier">:filter_customer</span>, <span class="ruby-identifier">:filter_milestone</span>, <span class="ruby-identifier">:filter_project</span>, <span class="ruby-identifier">:filter_user</span>, <span class="ruby-identifier">:filter_hidden</span>, <span class="ruby-identifier">:filter_status</span>, <span class="ruby-identifier">:group_by</span>, <span class="ruby-identifier">:hide_deferred</span>, <span class="ruby-identifier">:hide_dependencies</span>, <span class="ruby-identifier">:sort</span>, <span class="ruby-identifier">:filter_type</span>, <span class="ruby-identifier">:filter_severity</span>, <span class="ruby-identifier">:filter_priority</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
945:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">v</span>] = <span class="ruby-identifier">tmp</span>[<span class="ruby-identifier">v</span>]
946:     <span class="ruby-keyword kw">end</span>
947: 
948:     <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">:controller</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'tasks'</span>, <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'shortlist'</span>
949:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000239"><br/></a>
<div class="method_block"><h3>
<a href='#M000239'>


get_comment

()

</a>
</h3>

<p class="source_link" id="M000239-show-link"><a onclick="toggle('M000239-source'); toggleText('M000239-link'); return false;" href="#" id="M000239-link">Show source...</a></p><div class="source" id="M000239-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1602</span>
1602:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">get_comment</span>
1603:     <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;project_id IN (#{current_project_ids})&quot;</span>) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
1604:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>
1605:       <span class="ruby-ivar">@comment</span> = <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;work_logs.started_at desc,work_logs.id desc&quot;</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;work_logs.task_id = ? AND work_logs.comment = 1&quot;</span>, <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">id</span>], <span class="ruby-identifier">:include</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:user</span>, <span class="ruby-identifier">:task</span>, <span class="ruby-identifier">:project</span>])
1606:     <span class="ruby-keyword kw">end</span> 
1607:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000224"><br/></a>
<div class="method_block"><h3>
<a href='#M000224'>


get_csv

()

</a>
</h3>

<p class="source_link" id="M000224-show-link"><a onclick="toggle('M000224-source'); toggleText('M000224-link'); return false;" href="#" id="M000224-link">Show source...</a></p><div class="source" id="M000224-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1037</span>
1037:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">get_csv</span>
1038:     <span class="ruby-identifier">list</span>
1039: 
1040:     <span class="ruby-identifier">filename</span> = <span class="ruby-value str">&quot;clockingit_tasks&quot;</span>
1041:     <span class="ruby-identifier">filename_extras</span> = []
1042: 
1043:     <span class="ruby-identifier">tf</span> = <span class="ruby-constant">TaskFilter</span>.<span class="ruby-identifier">new</span>(<span class="ruby-keyword kw">self</span>, <span class="ruby-identifier">session</span>)
1044:     <span class="ruby-identifier">tf</span>.<span class="ruby-identifier">customer_ids</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">id</span><span class="ruby-operator">|</span>
1045:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">id</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">0</span>
1046:       <span class="ruby-identifier">filename_extras</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company</span>.<span class="ruby-identifier">customers</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">id</span>).<span class="ruby-identifier">name</span>
1047:     <span class="ruby-keyword kw">end</span>
1048:     <span class="ruby-identifier">tf</span>.<span class="ruby-identifier">project_ids</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">id</span><span class="ruby-operator">|</span>
1049:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">id</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">0</span>
1050:       <span class="ruby-identifier">p</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">id</span>)
1051:       <span class="ruby-identifier">filename_extras</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;#{p.customer.name}_#{p.name}&quot;</span>
1052:     <span class="ruby-keyword kw">end</span>
1053:     <span class="ruby-identifier">tf</span>.<span class="ruby-identifier">milestone_ids</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">id</span><span class="ruby-operator">|</span>
1054:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">id</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">0</span>
1055:       <span class="ruby-identifier">m</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company</span>.<span class="ruby-identifier">milestones</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">id</span>)
1056: 
1057:       <span class="ruby-identifier">filename_extras</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;#{m.project.customer.name}_#{m.project.name}_#{m.name}&quot;</span>
1058:     <span class="ruby-keyword kw">end</span>
1059:     <span class="ruby-constant">TaskFilter</span>.<span class="ruby-identifier">filter_user_ids</span>(<span class="ruby-identifier">session</span>, <span class="ruby-constant">TaskFilter</span><span class="ruby-operator">::</span><span class="ruby-constant">ALL_USERS</span>).<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">id</span><span class="ruby-operator">|</span>
1060:       <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">id</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">0</span>
1061:       <span class="ruby-identifier">filename_extras</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company</span>.<span class="ruby-identifier">users</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">id</span>).<span class="ruby-identifier">name</span>
1062:     <span class="ruby-keyword kw">end</span>
1063:     <span class="ruby-constant">TaskFilter</span>.<span class="ruby-identifier">filter_status_ids</span>(<span class="ruby-identifier">session</span>).<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">id</span><span class="ruby-operator">|</span>
1064:       <span class="ruby-identifier">value</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">status_type</span>(<span class="ruby-identifier">id</span>)
1065:       <span class="ruby-identifier">filename_extras</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">value</span> <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">value</span>.<span class="ruby-identifier">blank?</span>
1066:     <span class="ruby-keyword kw">end</span>
1067: 
1068:     <span class="ruby-identifier">filename_extras</span> = <span class="ruby-identifier">filename_extras</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">&quot;_&quot;</span>)
1069:     <span class="ruby-identifier">filename</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;_#{ filename_extras }&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">filename_extras</span>.<span class="ruby-identifier">blank?</span>
1070: 
1071:     <span class="ruby-identifier">filename</span> = <span class="ruby-identifier">filename</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/ /</span>, <span class="ruby-value str">&quot;_&quot;</span>).<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/[&quot;']/</span>, <span class="ruby-value str">''</span>).<span class="ruby-identifier">downcase</span>
1072:     <span class="ruby-identifier">filename</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;.csv&quot;</span>
1073: 
1074:     <span class="ruby-identifier">csv_string</span> = <span class="ruby-constant">FasterCSV</span>.<span class="ruby-identifier">generate</span>( <span class="ruby-identifier">:col_sep</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;,&quot;</span> ) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">csv</span><span class="ruby-operator">|</span>
1075: 
1076:       <span class="ruby-identifier">header</span> = [<span class="ruby-value str">'Client'</span>, <span class="ruby-value str">'Project'</span>, <span class="ruby-value str">'Num'</span>, <span class="ruby-value str">'Name'</span>, <span class="ruby-value str">'Tags'</span>, <span class="ruby-value str">'User'</span>, <span class="ruby-value str">'Milestone'</span>, <span class="ruby-value str">'Due'</span>, <span class="ruby-value str">'Created'</span>, <span class="ruby-value str">'Completed'</span>, <span class="ruby-value str">'Worked'</span>, <span class="ruby-value str">'Estimated'</span>, <span class="ruby-value str">'Status'</span>, <span class="ruby-value str">'Priority'</span>, <span class="ruby-value str">'Severity'</span>]
1077:       <span class="ruby-identifier">csv</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">header</span>
1078: 
1079:       <span class="ruby-keyword kw">for</span> <span class="ruby-identifier">t</span> <span class="ruby-keyword kw">in</span> <span class="ruby-ivar">@tasks</span>
1080:         <span class="ruby-identifier">csv</span> <span class="ruby-operator">&lt;&lt;</span> [<span class="ruby-identifier">t</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">customer</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">t</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">t</span>.<span class="ruby-identifier">task_num</span>, <span class="ruby-identifier">t</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">t</span>.<span class="ruby-identifier">tags</span>.<span class="ruby-identifier">collect</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">:name</span>).<span class="ruby-identifier">join</span>(<span class="ruby-value str">','</span>), <span class="ruby-identifier">t</span>.<span class="ruby-identifier">owners</span>, <span class="ruby-identifier">t</span>.<span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-value">? </span><span class="ruby-keyword kw">nil</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">t</span>.<span class="ruby-identifier">due_at</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-value">? </span><span class="ruby-identifier">t</span>.<span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-value">? </span><span class="ruby-keyword kw">nil</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">due_at</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">due_at</span>, <span class="ruby-identifier">t</span>.<span class="ruby-identifier">created_at</span>, <span class="ruby-identifier">t</span>.<span class="ruby-identifier">completed_at</span>, <span class="ruby-identifier">t</span>.<span class="ruby-identifier">worked_minutes</span>, <span class="ruby-identifier">t</span>.<span class="ruby-identifier">duration</span>, <span class="ruby-identifier">t</span>.<span class="ruby-identifier">status_type</span>, <span class="ruby-identifier">t</span>.<span class="ruby-identifier">priority_type</span>, <span class="ruby-identifier">t</span>.<span class="ruby-identifier">severity_type</span>]
1081:       <span class="ruby-keyword kw">end</span>
1082: 
1083:     <span class="ruby-keyword kw">end</span>
1084:     <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span>(<span class="ruby-node">&quot;Seinding[#{filename}]&quot;</span>)
1085: 
1086:     <span class="ruby-identifier">send_data</span>(<span class="ruby-identifier">csv_string</span>,
1087:               <span class="ruby-identifier">:type</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'text/csv; charset=utf-8; header=present'</span>,
1088:               <span class="ruby-identifier">:filename</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">filename</span>)
1089:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000191"><br/></a>
<div class="method_block"><h3>
<a href='#M000191'>


get_milestones

()

</a>
</h3>
<p>
Return a json formatted <a href="TasksController.html#M000190">list</a> of
options to refresh the <a href="Milestone.html">Milestone</a> dropdown
</p>

<p class="source_link" id="M000191-show-link"><a onclick="toggle('M000191-source'); toggleText('M000191-link'); return false;" href="#" id="M000191-link">Show source...</a></p><div class="source" id="M000191-source"><pre>    <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 73</span>
73:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">get_milestones</span>
74:     <span class="ruby-ivar">@milestones</span> = <span class="ruby-constant">Milestone</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'milestones.due_at, milestones.name'</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">'company_id = ? AND project_id = ? AND completed_at IS NULL'</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>, <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:project_id</span>]]).<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-node">&quot;{\&quot;text\&quot;:\&quot;#{m.name.gsub(/&quot;/,'\&quot;')}\&quot;, \&quot;value\&quot;:\&quot;#{m.id}\&quot;}&quot;</span> }.<span class="ruby-identifier">join</span>(<span class="ruby-value str">','</span>)
75: 
76:     <span class="ruby-comment cmt"># {&quot;options&quot;:[{&quot;value&quot;:&quot;1&quot;,&quot;text&quot;:&quot;Test Page&quot;}]}</span>
77:     <span class="ruby-identifier">res</span> = <span class="ruby-value str">'{&quot;options&quot;:[{&quot;value&quot;:&quot;0&quot;, &quot;text&quot;:&quot;'</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">_</span>(<span class="ruby-value str">'[None]'</span>) <span class="ruby-operator">+</span> <span class="ruby-value str">'&quot;}'</span>
78:     <span class="ruby-identifier">res</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;, #{@milestones}&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@milestones</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@milestones</span>.<span class="ruby-identifier">empty?</span>
79:     <span class="ruby-identifier">res</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">']}'</span>
80:   
81:     <span class="ruby-identifier">p</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:project_id</span>]) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
82:     <span class="ruby-identifier">script</span> = <span class="ruby-value str">&quot;&quot;</span>
83:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">p</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">can?</span>(<span class="ruby-identifier">p</span>, <span class="ruby-value str">'milestone'</span>)
84:       <span class="ruby-identifier">script</span> = <span class="ruby-value str">&quot;\n&lt;script type=\&quot;text/javascript\&quot;&gt;if($('add_milestone')){$('add_milestone').show();}&lt;/script&gt;&quot;</span>
85:     <span class="ruby-keyword kw">else</span> 
86:       <span class="ruby-identifier">script</span> = <span class="ruby-value str">&quot;\n&lt;script type=\&quot;text/javascript\&quot;&gt;if($('add_milestone')){$('add_milestone').hide();}&lt;/script&gt;&quot;</span>
87:     <span class="ruby-keyword kw">end</span> 
88:     <span class="ruby-identifier">render</span> <span class="ruby-identifier">:text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;#{res}#{script}&quot;</span>
89:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000196"><br/></a>
<div class="method_block"><h3>
<a href='#M000196'>


get_owners

()

</a>
</h3>
<p>
Return a json formatted <a href="TasksController.html#M000190">list</a> of
users to refresh the <a href="User.html">User</a> dropdown This a bit
tricky, as it also updates a JavaScript variable with the current drop-down
box.
</p>

<p class="source_link" id="M000196-show-link"><a onclick="toggle('M000196-source'); toggleText('M000196-link'); return false;" href="#" id="M000196-link">Show source...</a></p><div class="source" id="M000196-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 151</span>
151:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">get_owners</span>
152: 
153:     <span class="ruby-ivar">@users</span> = <span class="ruby-constant">Project</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:project_id</span>]).<span class="ruby-identifier">users</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'name'</span> )
154: 
155:     <span class="ruby-ivar">@resource_string</span> = <span class="ruby-node">&quot;&lt;option value=\&quot;\&quot;&gt;[#{_('No one')}]&lt;/option&gt;&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@users</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">us</span><span class="ruby-operator">|</span> <span class="ruby-node">&quot;&lt;option value=\&quot;#{us.id}\&quot;&gt;#{us.name}&lt;/option&gt;&quot;</span>}.<span class="ruby-identifier">join</span>(<span class="ruby-value str">''</span>)
156:     <span class="ruby-ivar">@resource_string</span> = <span class="ruby-ivar">@resource_string</span>.<span class="ruby-identifier">split</span>(<span class="ruby-regexp re">/\n/</span>).<span class="ruby-identifier">join</span>(<span class="ruby-value str">''</span>).<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/'/</span>, <span class="ruby-value str">&quot;\\\\\'&quot;</span>)
157: 
158:     <span class="ruby-ivar">@options</span> = <span class="ruby-ivar">@users</span>.<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">u</span><span class="ruby-operator">|</span> (<span class="ruby-value str">' {&quot;text&quot;:&quot;'</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">u</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/&quot;/</span>,<span class="ruby-value str">'\&quot;'</span>) <span class="ruby-operator">+</span> <span class="ruby-value str">'&quot;, &quot;value&quot;:&quot;'</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">u</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-value str">'&quot;}'</span>) }.<span class="ruby-identifier">join</span>( <span class="ruby-value str">','</span> )
159:     <span class="ruby-identifier">res</span> = <span class="ruby-value str">'{&quot;options&quot;:[{&quot;value&quot;:&quot;0&quot;, &quot;text&quot;:&quot;[None]&quot;}'</span>
160:     <span class="ruby-identifier">res</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;, #{@options}&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@options</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@options</span>.<span class="ruby-identifier">empty?</span>
161:     <span class="ruby-identifier">res</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">']}'</span>
162: 
163:     <span class="ruby-identifier">render</span> <span class="ruby-identifier">:text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;#{res}\n&lt;script type=\&quot;text/javascript\&quot;&gt;resource = '&lt;select name=\&quot;users[]\&quot; id=\&quot;task_users\&quot;&gt;#{@resource_string}&lt;/select&gt;';&lt;/script&gt;&quot;</span>
164:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000189"><br/></a>
<div class="method_block"><h3>
<a href='#M000189'>


index

()

</a>
</h3>

<p class="source_link" id="M000189-show-link"><a onclick="toggle('M000189-source'); toggleText('M000189-link'); return false;" href="#" id="M000189-link">Show source...</a></p><div class="source" id="M000189-source"><pre>    <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 44</span>
44:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">index</span>
45:     <span class="ruby-identifier">redirect_to</span> <span class="ruby-value str">'list'</span>
46:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000190"><br/></a>
<div class="method_block"><h3>
<a href='#M000190'>


list

()

</a>
</h3>

<p class="source_link" id="M000190-show-link"><a onclick="toggle('M000190-source'); toggleText('M000190-link'); return false;" href="#" id="M000190-link">Show source...</a></p><div class="source" id="M000190-source"><pre>    <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 48</span>
48:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">list</span>
49:     <span class="ruby-comment cmt"># Subscribe to the juggernaut channel for Task updates</span>
50:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:channels</span>] <span class="ruby-operator">+=</span> [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>]
51: 
52:     <span class="ruby-ivar">@tags</span> = {}
53:     <span class="ruby-ivar">@tags</span>.<span class="ruby-identifier">default</span> = <span class="ruby-value">0</span>
54:     <span class="ruby-ivar">@tags_total</span> = <span class="ruby-value">0</span>
55:     <span class="ruby-identifier">project_ids</span> = <span class="ruby-constant">TaskFilter</span>.<span class="ruby-identifier">filter_ids</span>(<span class="ruby-identifier">session</span>, <span class="ruby-identifier">:filter_project</span>)
56: 
57:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">project_ids</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-value">0</span>) <span class="ruby-keyword kw">or</span> <span class="ruby-identifier">project_ids</span>.<span class="ruby-identifier">empty?</span>
58:       <span class="ruby-identifier">project_ids</span> = <span class="ruby-identifier">current_project_ids</span>
59:     <span class="ruby-keyword kw">else</span>
60:       <span class="ruby-identifier">project_ids</span> = <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project</span>]
61:     <span class="ruby-keyword kw">end</span>
62: 
63:     <span class="ruby-identifier">task_filter</span> = <span class="ruby-constant">TaskFilter</span>.<span class="ruby-identifier">new</span>(<span class="ruby-keyword kw">self</span>, <span class="ruby-identifier">params</span>)
64:     <span class="ruby-ivar">@selected_tags</span> = <span class="ruby-identifier">task_filter</span>.<span class="ruby-identifier">selected_tags</span> <span class="ruby-operator">||</span> []
65:     <span class="ruby-ivar">@tasks</span> = <span class="ruby-identifier">task_filter</span>.<span class="ruby-identifier">tasks</span>
66: 
67:     <span class="ruby-comment cmt"># Most popular tags, currently unlimited.</span>
68:     <span class="ruby-ivar">@all_tags</span> = <span class="ruby-constant">Tag</span>.<span class="ruby-identifier">top_counts</span>({ <span class="ruby-identifier">:company_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>, <span class="ruby-identifier">:project_ids</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">project_ids</span>, <span class="ruby-identifier">:filter_hidden</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_hidden</span>], <span class="ruby-identifier">:filter_customer</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_customer</span>]})
69:     <span class="ruby-ivar">@group_ids</span>, <span class="ruby-ivar">@groups</span> = <span class="ruby-identifier">group_tasks</span>(<span class="ruby-ivar">@tasks</span>)
70:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000225"><br/></a>
<div class="method_block"><h3>
<a href='#M000225'>


move

()

</a>
</h3>

<p class="source_link" id="M000225-show-link"><a onclick="toggle('M000225-source'); toggleText('M000225-link'); return false;" href="#" id="M000225-link">Show source...</a></p><div class="source" id="M000225-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1091</span>
1091:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">move</span>
1092:     <span class="ruby-keyword kw">begin</span>
1093:       <span class="ruby-identifier">body</span> = <span class="ruby-value str">&quot;&quot;</span>
1094:       <span class="ruby-identifier">elems</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>].<span class="ruby-identifier">split</span>(<span class="ruby-value str">' '</span>)
1095:       <span class="ruby-identifier">element</span> = <span class="ruby-identifier">elems</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">split</span>(<span class="ruby-value str">'_'</span>)[<span class="ruby-value">1</span>]
1096: 
1097:       <span class="ruby-ivar">@group</span> = <span class="ruby-identifier">elems</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">split</span>(<span class="ruby-value str">'_'</span>)[<span class="ruby-value">1</span>].<span class="ruby-identifier">to_i</span>
1098: 
1099:       <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">element</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;project_id IN (#{current_project_ids})&quot;</span>])
1100: 
1101:       <span class="ruby-identifier">worklog</span> = <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">new</span>
1102:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_MODIFIED</span>
1103: 
1104:       <span class="ruby-identifier">update_type</span> = <span class="ruby-identifier">:updated</span>
1105: 
1106:       <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:group_by</span>].<span class="ruby-identifier">to_i</span>
1107:       <span class="ruby-keyword kw">when</span> <span class="ruby-value">3</span>
1108:         <span class="ruby-comment cmt"># Project</span>
1109:         <span class="ruby-identifier">project</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">find</span>(<span class="ruby-ivar">@group</span>)
1110:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project_id</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">project</span>.<span class="ruby-identifier">id</span>
1111:           <span class="ruby-identifier">body</span> = <span class="ruby-node">&quot;- &lt;strong&gt;Project&lt;/strong&gt;: #{@task.project.name} -&gt; #{project.name}\n&quot;</span>
1112:           <span class="ruby-identifier">old_milestone</span> = <span class="ruby-keyword kw">nil</span>
1113:           <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone</span>
1114:             <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Milestone&lt;/strong&gt;: #{@task.milestone.name} -&gt; None&quot;</span>
1115:             <span class="ruby-identifier">old_milestone</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone</span>
1116:             <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone</span> = <span class="ruby-keyword kw">nil</span>
1117:           <span class="ruby-keyword kw">end</span>
1118:           <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project_id</span> = <span class="ruby-identifier">project</span>.<span class="ruby-identifier">id</span>
1119:           <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">save</span>
1120: 
1121:           <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">update_all</span>(<span class="ruby-node">&quot;customer_id = #{project.customer_id}, project_id = #{@task.project_id}&quot;</span>, <span class="ruby-node">&quot;task_id = #{@task.id}&quot;</span>)
1122:           <span class="ruby-constant">ProjectFile</span>.<span class="ruby-identifier">update_all</span>(<span class="ruby-node">&quot;customer_id = #{project.customer_id}, project_id = #{@task.project_id}&quot;</span>, <span class="ruby-node">&quot;task_id = #{@task.id}&quot;</span>)
1123: 
1124:           <span class="ruby-identifier">old_milestone</span>.<span class="ruby-identifier">update_counts</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">old_milestone</span>
1125:         <span class="ruby-keyword kw">end</span>
1126:       <span class="ruby-keyword kw">when</span> <span class="ruby-value">4</span>
1127:         <span class="ruby-comment cmt"># Milestone</span>
1128:         <span class="ruby-identifier">milestone</span> = <span class="ruby-constant">Milestone</span>.<span class="ruby-identifier">find</span>(<span class="ruby-ivar">@group</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;project_id IN (#{current_project_ids})&quot;</span>]) <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@group</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
1129: 
1130:         <span class="ruby-keyword kw">if</span>(<span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone_id</span>.<span class="ruby-identifier">to_i</span>) <span class="ruby-operator">!=</span> <span class="ruby-ivar">@group</span>
1131:           <span class="ruby-keyword kw">if</span>( <span class="ruby-identifier">milestone</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">project_id</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project_id</span> )
1132:             <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Project&lt;/strong&gt;: #{@task.project.name} -&gt; #{milestone.project.name}\n&quot;</span>
1133:             <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project_id</span> = <span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">project_id</span>
1134:             <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">update_all</span>(<span class="ruby-node">&quot;customer_id = #{milestone.project.customer_id}, project_id = #{milestone.project_id}&quot;</span>, <span class="ruby-node">&quot;task_id = #{@task.id}&quot;</span>)
1135:             <span class="ruby-constant">ProjectFile</span>.<span class="ruby-identifier">update_all</span>(<span class="ruby-node">&quot;customer_id = #{milestone.project.customer_id}, project_id = #{milestone.project_id}&quot;</span>, <span class="ruby-node">&quot;task_id = #{@task.id}&quot;</span>)
1136:           <span class="ruby-keyword kw">end</span>
1137: 
1138:           <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone_id</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@group</span>
1139:             <span class="ruby-identifier">old_milestone</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-value">? </span><span class="ruby-value str">&quot;None&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">name</span>
1140:             <span class="ruby-identifier">new_milestone</span> = <span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-value">? </span><span class="ruby-value str">&quot;None&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">name</span>
1141: 
1142:             <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Milestone&lt;/strong&gt;: #{old_milestone} -&gt; #{new_milestone}&quot;</span>
1143: 
1144:             <span class="ruby-identifier">old</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone</span>
1145: 
1146:             <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone</span> = <span class="ruby-identifier">milestone</span>
1147:             <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">save</span>
1148: 
1149:             <span class="ruby-identifier">old</span>.<span class="ruby-identifier">update_counts</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">old</span>
1150: 
1151:           <span class="ruby-keyword kw">end</span>
1152:         <span class="ruby-keyword kw">end</span>
1153:       <span class="ruby-keyword kw">when</span> <span class="ruby-value">5</span>
1154:         <span class="ruby-comment cmt"># User</span>
1155: 
1156:         <span class="ruby-identifier">old_users</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">users</span>.<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">u</span><span class="ruby-operator">|</span> <span class="ruby-identifier">u</span>.<span class="ruby-identifier">id</span>}.<span class="ruby-identifier">sort</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">','</span>)
1157:         <span class="ruby-identifier">old_users</span> = <span class="ruby-value str">&quot;0&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">old_users</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">old_users</span>.<span class="ruby-identifier">empty?</span>
1158: 
1159:         <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">task_owners</span>.<span class="ruby-identifier">destroy_all</span>
1160:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@group</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
1161:           <span class="ruby-identifier">u</span> = <span class="ruby-constant">User</span>.<span class="ruby-identifier">find</span>(<span class="ruby-ivar">@group</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;company_id = ?&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>])
1162:           <span class="ruby-identifier">to</span> = <span class="ruby-constant">TaskOwner</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">:user</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">u</span>, <span class="ruby-identifier">:task</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@task</span>)
1163:           <span class="ruby-identifier">to</span>.<span class="ruby-identifier">save</span>
1164: 
1165:           <span class="ruby-keyword kw">if</span>( <span class="ruby-identifier">old_users</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">u</span>.<span class="ruby-identifier">name</span> )
1166:             <span class="ruby-identifier">new_name</span> = <span class="ruby-identifier">u</span>.<span class="ruby-identifier">name</span>
1167:             <span class="ruby-identifier">body</span> = <span class="ruby-node">&quot;- &lt;strong&gt;Assignment&lt;/strong&gt;: #{new_name}\n&quot;</span>
1168:             <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">users</span>.<span class="ruby-identifier">reload</span>
1169:             <span class="ruby-identifier">update_type</span> = <span class="ruby-identifier">:reassigned</span>
1170:           <span class="ruby-keyword kw">end</span>
1171: 
1172:         <span class="ruby-keyword kw">end</span>
1173:         <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">save</span>
1174:       <span class="ruby-keyword kw">when</span> <span class="ruby-value">7</span>
1175:         <span class="ruby-comment cmt"># Status</span>
1176:         <span class="ruby-keyword kw">if</span>( <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@group</span> )
1177:           <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@group</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">2</span>
1178:             <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">completed_at</span> = <span class="ruby-keyword kw">nil</span>
1179:             <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>
1180:               <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_REVERTED</span>
1181:               <span class="ruby-identifier">update_type</span> = <span class="ruby-identifier">:reverted</span>
1182:             <span class="ruby-keyword kw">end</span>
1183:           <span class="ruby-keyword kw">else</span>
1184:             <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">completed_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">completed_at</span>.<span class="ruby-identifier">nil?</span>
1185:             <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">2</span>
1186:               <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_COMPLETED</span>
1187:               <span class="ruby-identifier">update_type</span> = <span class="ruby-identifier">:completed</span>
1188:             <span class="ruby-keyword kw">end</span>
1189:           <span class="ruby-keyword kw">end</span>
1190:           <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Status&lt;/strong&gt;: #{@task.status_type} -&gt; #{Task.status_types[@group]}\n&quot;</span>
1191:           <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status</span> = <span class="ruby-ivar">@group</span>
1192:           <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">save</span>
1193:         <span class="ruby-keyword kw">end</span>
1194:       <span class="ruby-keyword kw">when</span> <span class="ruby-value">10</span>
1195:         <span class="ruby-comment cmt"># Project / Milestone</span>
1196:         <span class="ruby-comment cmt"># task-group_44_15</span>
1197: 
1198:         <span class="ruby-identifier">project</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">find</span>(<span class="ruby-ivar">@group</span>)
1199:         <span class="ruby-identifier">old</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone</span>
1200: 
1201:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project_id</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@group</span>
1202:           <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Project&lt;/strong&gt;: #{@task.project.name} -&gt; #{project.name}\n&quot;</span>
1203:           <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project_id</span> = <span class="ruby-ivar">@group</span>
1204:         <span class="ruby-keyword kw">end</span>
1205: 
1206:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">elems</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">split</span>(<span class="ruby-value str">'_'</span>).<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">2</span>
1207:           <span class="ruby-identifier">milestone</span> = <span class="ruby-constant">Milestone</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">elems</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">split</span>(<span class="ruby-value str">'_'</span>)[<span class="ruby-value">2</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;project_id IN (#{current_project_ids})&quot;</span>])
1208: 
1209:           
1210:           <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone_id</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">id</span>
1211:             <span class="ruby-identifier">old_milestone</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-value">? </span><span class="ruby-value str">&quot;None&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">name</span>
1212:             <span class="ruby-identifier">new_milestone</span> = <span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-value">? </span><span class="ruby-value str">&quot;None&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">name</span>
1213:             <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Milestone&lt;/strong&gt;: #{old_milestone} -&gt; #{new_milestone}&quot;</span>
1214: 
1215:             <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone_id</span> = <span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">id</span>
1216: 
1217:           <span class="ruby-keyword kw">end</span>
1218:           <span class="ruby-ivar">@group</span> = <span class="ruby-node">&quot;#{@group}_#{milestone.id}&quot;</span>
1219:         <span class="ruby-keyword kw">else</span>
1220:           <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone_id</span>.<span class="ruby-identifier">nil?</span>
1221:             <span class="ruby-identifier">old_milestone</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-value">? </span><span class="ruby-value str">&quot;None&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">name</span>
1222:             <span class="ruby-identifier">new_milestone</span> = <span class="ruby-value str">&quot;None&quot;</span>
1223:             <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Milestone&lt;/strong&gt;: #{old_milestone} -&gt; #{new_milestone}&quot;</span>
1224:             <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone_id</span> = <span class="ruby-keyword kw">nil</span>
1225:           <span class="ruby-keyword kw">end</span>
1226:         <span class="ruby-keyword kw">end</span>
1227: 
1228:         <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">update_all</span>(<span class="ruby-node">&quot;customer_id = #{project.customer_id}, project_id = #{project.id}&quot;</span>, <span class="ruby-node">&quot;task_id = #{@task.id}&quot;</span>)
1229:         <span class="ruby-constant">ProjectFile</span>.<span class="ruby-identifier">update_all</span>(<span class="ruby-node">&quot;customer_id = #{project.customer_id}, project_id = #{project.id}&quot;</span>, <span class="ruby-node">&quot;task_id = #{@task.id}&quot;</span>)
1230: 
1231:         <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">save</span>
1232:         <span class="ruby-identifier">old</span>.<span class="ruby-identifier">update_counts</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">old</span>
1233:       <span class="ruby-keyword kw">end</span>
1234: 
1235:       <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">property</span> = <span class="ruby-constant">Property</span>.<span class="ruby-identifier">find_by_group_by</span>(<span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company</span>, <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:group_by</span>]))
1236:         <span class="ruby-identifier">old_value</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">property_value</span>(<span class="ruby-identifier">property</span>)
1237:         <span class="ruby-identifier">new_value</span> = <span class="ruby-identifier">property</span>.<span class="ruby-identifier">property_values</span>.<span class="ruby-identifier">find</span>(<span class="ruby-ivar">@group</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@group</span>.<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
1238:         <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">set_property_value</span>(<span class="ruby-identifier">property</span>, <span class="ruby-identifier">new_value</span>)
1239:         <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span>  <span class="ruby-node">&quot; - &lt;strong&gt;#{ property }&lt;/strong&gt;: #{ old_value } -&gt; #{ new_value }&quot;</span>
1240:       <span class="ruby-keyword kw">end</span>
1241: 
1242: 
1243:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">body</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
1244:         <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">reload</span>
1245:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">user</span> = <span class="ruby-identifier">current_user</span>
1246:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">company</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">company</span>
1247:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">customer</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">customer</span>
1248:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">project</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>
1249:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">task</span> = <span class="ruby-ivar">@task</span>
1250:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">started_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>
1251:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-value">0</span>
1252:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">body</span> = <span class="ruby-identifier">body</span>
1253:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">save</span>
1254:         <span class="ruby-constant">Notifications</span><span class="ruby-operator">::</span><span class="ruby-identifier">deliver_changed</span>( <span class="ruby-identifier">update_type</span>, <span class="ruby-ivar">@task</span>, <span class="ruby-identifier">current_user</span>, <span class="ruby-identifier">body</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/&lt;[^&gt;]*&gt;/</span>,<span class="ruby-value str">''</span>)) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">send_notifications?</span> <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
1255:         <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; @task.id)}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
1256:       <span class="ruby-keyword kw">end</span>
1257: 
1258:     <span class="ruby-keyword kw">end</span>
1259: 
1260:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000188"><br/></a>
<div class="method_block"><h3>
<a href='#M000188'>


new

()

</a>
</h3>

<p class="source_link" id="M000188-show-link"><a onclick="toggle('M000188-source'); toggleText('M000188-link'); return false;" href="#" id="M000188-link">Show source...</a></p><div class="source" id="M000188-source"><pre>    <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 12</span>
12:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">new</span>
13:     <span class="ruby-ivar">@projects</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'name'</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;completed_at IS NULL&quot;</span>]).<span class="ruby-identifier">collect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> [ <span class="ruby-node">&quot;#{c.name} / #{c.customer.name}&quot;</span>, <span class="ruby-identifier">c</span>.<span class="ruby-identifier">id</span> ] <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">can?</span>(<span class="ruby-identifier">c</span>, <span class="ruby-value str">'create'</span>)  }.<span class="ruby-identifier">compact</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">nil?</span>
14:  
15:     <span class="ruby-identifier">tf</span> = <span class="ruby-constant">TaskFilter</span>.<span class="ruby-identifier">new</span>(<span class="ruby-keyword kw">self</span>, <span class="ruby-ivar">@session</span>)
16:     <span class="ruby-identifier">project_ids</span> = <span class="ruby-ivar">@projects</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-identifier">p</span>[<span class="ruby-value">1</span>] }
17: 
18:     <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">project_ids</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">tf</span>.<span class="ruby-identifier">project_ids</span>.<span class="ruby-identifier">first</span>)
19:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:last_project_id</span>] = <span class="ruby-keyword kw">nil</span>
20:     <span class="ruby-keyword kw">end</span>
21: 
22:     <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">project_ids</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">tf</span>.<span class="ruby-identifier">project_ids</span>.<span class="ruby-identifier">first</span>)
23:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project</span>] = <span class="ruby-keyword kw">nil</span>
24:     <span class="ruby-keyword kw">end</span>
25:     
26:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@projects</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-ivar">@projects</span>.<span class="ruby-identifier">empty?</span>
27:       <span class="ruby-identifier">flash</span>[<span class="ruby-value str">'notice'</span>] = <span class="ruby-identifier">_</span>(<span class="ruby-value str">&quot;You need to create a project to hold your tasks, or get access to create tasks in an existing project...&quot;</span>)
28:       <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">:controller</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'projects'</span>, <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'new'</span>
29:       <span class="ruby-keyword kw">return</span>
30:     <span class="ruby-keyword kw">else</span>
31:       <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">new</span>
32:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">company</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company</span>
33:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-value">0</span>
34:       <span class="ruby-ivar">@tags</span> = <span class="ruby-constant">Tag</span>.<span class="ruby-identifier">top_counts</span>({ <span class="ruby-identifier">:company_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>, <span class="ruby-identifier">:project_ids</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">current_project_ids</span>, <span class="ruby-identifier">:filter_hidden</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_hidden</span>]})
35:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">watchers</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">current_user</span>
36:     <span class="ruby-keyword kw">end</span>
37: 
38:     <span class="ruby-ivar">@notify_targets</span> = <span class="ruby-identifier">current_projects</span>.<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">users</span>.<span class="ruby-identifier">collect</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">:name</span>) }.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>
39:     <span class="ruby-ivar">@notify_targets</span> <span class="ruby-operator">+=</span> <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;project_id IN (#{current_project_ids}) AND notify_emails IS NOT NULL and notify_emails &lt;&gt; ''&quot;</span>]).<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">notify_emails</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">','</span>).<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">i</span>.<span class="ruby-identifier">strip</span> } }
40:     <span class="ruby-ivar">@notify_targets</span> = <span class="ruby-ivar">@notify_targets</span>.<span class="ruby-identifier">flatten</span>.<span class="ruby-identifier">uniq</span>
41:     <span class="ruby-ivar">@notify_targets</span> <span class="ruby-operator">||=</span> []
42:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000234"><br/></a>
<div class="method_block"><h3>
<a href='#M000234'>


order_todos

()

</a>
</h3>

<p class="source_link" id="M000234-show-link"><a onclick="toggle('M000234-source'); toggleText('M000234-link'); return false;" href="#" id="M000234-link">Show source...</a></p><div class="source" id="M000234-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1510</span>
1510:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">order_todos</span>
1511:     <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;id = ? AND project_id IN (#{current_project_ids})&quot;</span>, <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>]])
1512:     <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">todos</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;completed_at IS NULL&quot;</span>]).<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">todo</span><span class="ruby-operator">|</span>
1513:       <span class="ruby-identifier">todo</span>.<span class="ruby-identifier">position</span> = <span class="ruby-identifier">params</span>[<span class="ruby-node">&quot;todo-tasks-#{@task.id}&quot;</span>].<span class="ruby-identifier">index</span>(<span class="ruby-identifier">todo</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span>) <span class="ruby-operator">+</span> <span class="ruby-value">1</span>
1514:       <span class="ruby-identifier">todo</span>.<span class="ruby-identifier">save</span>
1515:     <span class="ruby-keyword kw">end</span>
1516:     <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1517:       <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-node">&quot;todo-#{@task.dom_id}&quot;</span>)
1518:     <span class="ruby-keyword kw">end</span>
1519:     <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; @task.id)}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
1520:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000231"><br/></a>
<div class="method_block"><h3>
<a href='#M000231'>


pause_work_ajax

()

</a>
</h3>

<p class="source_link" id="M000231-show-link"><a onclick="toggle('M000231-source'); toggleText('M000231-link'); return false;" href="#" id="M000231-link">Show source...</a></p><div class="source" id="M000231-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1404</span>
1404:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">pause_work_ajax</span>
1405:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@current_sheet</span> 
1406:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">paused_at</span>
1407:         <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">paused_duration</span> <span class="ruby-operator">+=</span> (<span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span> <span class="ruby-operator">-</span> <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">paused_at</span>).<span class="ruby-identifier">to_i</span>
1408:         <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">paused_at</span> = <span class="ruby-keyword kw">nil</span>
1409:       <span class="ruby-keyword kw">else</span>
1410:         <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">paused_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>
1411:       <span class="ruby-keyword kw">end</span>
1412:       <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">save</span>
1413:     <span class="ruby-keyword kw">else</span> 
1414:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:nothing</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>
1415:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(0, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; params[:id])}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
1416:       <span class="ruby-keyword kw">return</span>
1417:     <span class="ruby-keyword kw">end</span>
1418:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000227"><br/></a>
<div class="method_block"><h3>
<a href='#M000227'>


quick_add

()

</a>
</h3>

<p class="source_link" id="M000227-show-link"><a onclick="toggle('M000227-source'); toggleText('M000227-link'); return false;" href="#" id="M000227-link">Show source...</a></p><div class="source" id="M000227-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1277</span>
1277:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">quick_add</span>
1278:     <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">new</span>
1279:     <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1280:       <span class="ruby-identifier">page</span>.<span class="ruby-identifier">replace_html</span> <span class="ruby-value str">'quick_add_container'</span>, <span class="ruby-identifier">:partial</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'quick_add'</span>
1281:       <span class="ruby-identifier">page</span>.<span class="ruby-identifier">show</span>(<span class="ruby-value str">'quick_add_container'</span>)
1282:       <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-value str">&quot;quick_add_container&quot;</span>, <span class="ruby-identifier">:duration</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span><span class="ruby-value">.5</span>)
1283:     <span class="ruby-keyword kw">end</span>
1284:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000200"><br/></a>
<div class="method_block"><h3>
<a href='#M000200'>


repeat_task

(task)

</a>
</h3>
<p>
def edit_ajax
</p>
<pre>
  self.edit
  render :action =&gt; 'edit', :layout =&gt; false
</pre>
<p>
end
</p>

<p class="source_link" id="M000200-show-link"><a onclick="toggle('M000200-source'); toggleText('M000200-link'); return false;" href="#" id="M000200-link">Show source...</a></p><div class="source" id="M000200-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 299</span>
299:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">repeat_task</span>(<span class="ruby-identifier">task</span>)
300:     <span class="ruby-ivar">@repeat</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">new</span>
301:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">status</span> = <span class="ruby-value">0</span>
302:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">project_id</span> = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">project_id</span>
303:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">company_id</span> = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">company_id</span>
304:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">name</span> = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">name</span>
305:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">repeat</span> = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">repeat</span>
306:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">requested_by</span> = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">requested_by</span>
307:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">creator_id</span> = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">creator_id</span>
308:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">set_tags</span>(<span class="ruby-identifier">task</span>.<span class="ruby-identifier">tags</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">name</span>}.<span class="ruby-identifier">join</span>(<span class="ruby-value str">', '</span>))
309:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">set_task_num</span>(<span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>)
310:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">duration</span>
311:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">notify_emails</span> = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">notify_emails</span>
312:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">milestone_id</span> = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">milestone_id</span>
313:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">hidden</span> = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">hidden</span>
314:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">due_at</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">due_at</span>
315:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">due_at</span> = <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">next_repeat_date</span>
316:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">description</span> = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">description</span>
317: 
318:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">save</span>
319:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">reload</span>
320: 
321:     <span class="ruby-identifier">task</span>.<span class="ruby-identifier">notifications</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">w</span><span class="ruby-operator">|</span>
322:       <span class="ruby-identifier">n</span> = <span class="ruby-constant">Notification</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">:user</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">w</span>.<span class="ruby-identifier">user</span>, <span class="ruby-identifier">:task</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@repeat</span>)
323:       <span class="ruby-identifier">n</span>.<span class="ruby-identifier">save</span>
324:     <span class="ruby-keyword kw">end</span>
325: 
326:     <span class="ruby-identifier">task</span>.<span class="ruby-identifier">task_owners</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">o</span><span class="ruby-operator">|</span>
327:       <span class="ruby-identifier">to</span> = <span class="ruby-constant">TaskOwner</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">:user</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">o</span>.<span class="ruby-identifier">user</span>, <span class="ruby-identifier">:task</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@repeat</span>)
328:       <span class="ruby-identifier">to</span>.<span class="ruby-identifier">save</span>
329:     <span class="ruby-keyword kw">end</span>
330: 
331:     <span class="ruby-identifier">task</span>.<span class="ruby-identifier">dependencies</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">d</span><span class="ruby-operator">|</span>
332:         <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">dependencies</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">d</span>
333:     <span class="ruby-keyword kw">end</span>
334: 
335:     <span class="ruby-ivar">@repeat</span>.<span class="ruby-identifier">save</span>
336: 
337:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000194"><br/></a>
<div class="method_block"><h3>
<a href='#M000194'>


resource

()

</a>
</h3>

<p class="source_link" id="M000194-show-link"><a onclick="toggle('M000194-source'); toggleText('M000194-link'); return false;" href="#" id="M000194-link">Show source...</a></p><div class="source" id="M000194-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 135</span>
135:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">resource</span>
136:     <span class="ruby-identifier">resource</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company</span>.<span class="ruby-identifier">resources</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:resource_id</span>])
137:     <span class="ruby-identifier">render</span>(<span class="ruby-identifier">:partial</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;resource&quot;</span>, <span class="ruby-identifier">:locals</span> =<span class="ruby-operator">&gt;</span> { <span class="ruby-identifier">:resource</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">resource</span> })
138:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000223"><br/></a>
<div class="method_block"><h3>
<a href='#M000223'>


save_log

()

</a>
</h3>

<p class="source_link" id="M000223-show-link"><a onclick="toggle('M000223-source'); toggleText('M000223-link'); return false;" href="#" id="M000223-link">Show source...</a></p><div class="source" id="M000223-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 971</span>
 971:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">save_log</span>
 972:     <span class="ruby-ivar">@log</span> = <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">find</span>( <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;company_id = ?&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>] )
 973:     
 974:     <span class="ruby-identifier">old_duration</span> = <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">duration</span>
 975:     <span class="ruby-identifier">old_note</span> = <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">body</span>
 976:     
 977:     <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-identifier">:log</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-identifier">:log</span>][<span class="ruby-identifier">:started_at</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:log</span>][<span class="ruby-identifier">:started_at</span>].<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
 978:       <span class="ruby-keyword kw">begin</span>
 979:         <span class="ruby-identifier">due_date</span> = <span class="ruby-constant">DateTime</span>.<span class="ruby-identifier">strptime</span>( <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:log</span>][<span class="ruby-identifier">:started_at</span>], <span class="ruby-node">&quot;#{current_user.date_format} #{current_user.time_format}&quot;</span> )
 980:         <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:log</span>][<span class="ruby-identifier">:started_at</span>] = <span class="ruby-identifier">tz</span>.<span class="ruby-identifier">local_to_utc</span>(<span class="ruby-identifier">due_date</span>)
 981:       <span class="ruby-keyword kw">rescue</span>
 982:         <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:log</span>][<span class="ruby-identifier">:started_at</span>] = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>
 983:       <span class="ruby-keyword kw">end</span>
 984:     <span class="ruby-keyword kw">end</span>
 985: 
 986:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">update_attributes</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:log</span>])
 987: 
 988: 
 989:       <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">started_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span> <span class="ruby-keyword kw">if</span>(<span class="ruby-ivar">@log</span>.<span class="ruby-identifier">started_at</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-operator">||</span> (<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:log</span>] <span class="ruby-operator">&amp;&amp;</span> (<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:log</span>][<span class="ruby-identifier">:started_at</span>].<span class="ruby-identifier">blank?</span>)) )
 990: 
 991:       <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-identifier">parse_time</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:log</span>][<span class="ruby-identifier">:duration</span>])
 992:       <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-identifier">old_duration</span> <span class="ruby-keyword kw">if</span>((<span class="ruby-identifier">old_duration</span> <span class="ruby-operator">/</span> <span class="ruby-value">60</span>) <span class="ruby-operator">==</span> (<span class="ruby-ivar">@log</span>.<span class="ruby-identifier">duration</span> <span class="ruby-operator">/</span> <span class="ruby-value">60</span>)) 
 993: 
 994:       <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">task</span>.<span class="ruby-identifier">updated_by_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
 995: 
 996:       <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">comment</span> = <span class="ruby-operator">!</span><span class="ruby-ivar">@log</span>.<span class="ruby-identifier">body</span>.<span class="ruby-identifier">blank?</span>
 997:       
 998:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:status</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">task</span>.<span class="ruby-identifier">status</span>
 999: 
1000:         <span class="ruby-identifier">status_type</span> = <span class="ruby-identifier">:completed</span>
1001: 
1002:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:status</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">2</span>
1003:           <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_WORK_ADDED</span> 
1004:           <span class="ruby-identifier">status_type</span> = <span class="ruby-identifier">:updated</span>
1005:         <span class="ruby-keyword kw">end</span> 
1006:         
1007:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:status</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">2</span>
1008:           <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_COMPLETED</span> 
1009:           <span class="ruby-identifier">status_type</span> = <span class="ruby-identifier">:completed</span>
1010:         <span class="ruby-keyword kw">end</span> 
1011: 
1012:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:status</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">2</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>
1013:           <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_REVERTED</span> 
1014:           <span class="ruby-identifier">status_type</span>= <span class="ruby-identifier">:reverted</span>
1015:         <span class="ruby-keyword kw">end</span> 
1016:         
1017:         <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">task</span>.<span class="ruby-identifier">status</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:status</span>].<span class="ruby-identifier">to_i</span>
1018:         <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">task</span>.<span class="ruby-identifier">updated_by_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
1019:         <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">task</span>.<span class="ruby-identifier">completed_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>
1020:         <span class="ruby-constant">Notifications</span><span class="ruby-operator">::</span><span class="ruby-identifier">deliver_changed</span>( <span class="ruby-identifier">status_type</span>, <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">task</span>, <span class="ruby-identifier">current_user</span>, <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:log</span>][<span class="ruby-identifier">:body</span>] ) <span class="ruby-keyword kw">if</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value str">'notify'</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
1021: 
1022:       <span class="ruby-keyword kw">elsif</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-identifier">:log</span>][<span class="ruby-identifier">:body</span>].<span class="ruby-identifier">blank?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:log</span>][<span class="ruby-identifier">:body</span>] <span class="ruby-operator">!=</span> <span class="ruby-identifier">old_note</span> <span class="ruby-operator">&amp;&amp;</span>  <span class="ruby-identifier">params</span>[<span class="ruby-value str">'notify'</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>
1023:         <span class="ruby-constant">Notifications</span><span class="ruby-operator">::</span><span class="ruby-identifier">deliver_changed</span>( <span class="ruby-identifier">:comment</span>, <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">task</span>, <span class="ruby-identifier">current_user</span>, <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:log</span>][<span class="ruby-identifier">:body</span>].<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/&lt;[^&gt;]*&gt;/</span>,<span class="ruby-value str">''</span>)) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
1024:       <span class="ruby-keyword kw">end</span>
1025: 
1026:       <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">task</span>.<span class="ruby-identifier">save</span>
1027:       <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">save</span>
1028: 
1029:       <span class="ruby-identifier">flash</span>[<span class="ruby-value str">'notice'</span>] = <span class="ruby-identifier">_</span>(<span class="ruby-value str">&quot;Log entry saved...&quot;</span>)
1030:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; @log.task.id)}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
1031:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'activities', :action =&gt; 'refresh')}');&quot;</span>, [<span class="ruby-node">&quot;activity_#{current_user.company_id}&quot;</span>])
1032: 
1033:     <span class="ruby-keyword kw">end</span>
1034:     <span class="ruby-identifier">redirect_from_last</span>
1035:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000238"><br/></a>
<div class="method_block"><h3>
<a href='#M000238'>


save_tag

()

</a>
</h3>

<p class="source_link" id="M000238-show-link"><a onclick="toggle('M000238-source'); toggleText('M000238-link'); return false;" href="#" id="M000238-link">Show source...</a></p><div class="source" id="M000238-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1567</span>
1567:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">save_tag</span>
1568:     <span class="ruby-ivar">@tag</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company</span>.<span class="ruby-identifier">tags</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>]) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
1569:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@tag</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-value str">'tag-name'</span>].<span class="ruby-identifier">blank?</span>
1570:       <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Tag</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-identifier">:company_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>, <span class="ruby-identifier">:name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-value str">'tag-name'</span>])
1571:         
1572:         <span class="ruby-ivar">@existing</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company</span>.<span class="ruby-identifier">tags</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;name = ?&quot;</span>, <span class="ruby-identifier">params</span>[<span class="ruby-value str">'tag-name'</span>]] )
1573:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@existing</span>.<span class="ruby-identifier">id</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@tag</span>.<span class="ruby-identifier">id</span>
1574:           <span class="ruby-ivar">@tag</span>.<span class="ruby-identifier">tasks</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span>
1575:             <span class="ruby-ivar">@existing</span>.<span class="ruby-identifier">tasks</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">t</span>
1576:           <span class="ruby-keyword kw">end</span> 
1577:           <span class="ruby-ivar">@tag</span>.<span class="ruby-identifier">destroy</span>
1578:           <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1579:             <span class="ruby-identifier">page</span>[<span class="ruby-ivar">@tag</span>.<span class="ruby-identifier">dom_id</span>].<span class="ruby-identifier">remove</span>
1580:             <span class="ruby-ivar">@tag</span> = <span class="ruby-ivar">@existing</span>
1581:             <span class="ruby-identifier">page</span>[<span class="ruby-ivar">@tag</span>.<span class="ruby-identifier">dom_id</span>].<span class="ruby-identifier">replace</span> <span class="ruby-identifier">:partial</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'edit_tag_row'</span>
1582:           <span class="ruby-keyword kw">end</span> 
1583:         <span class="ruby-keyword kw">else</span>
1584:           <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1585:             <span class="ruby-identifier">page</span>[<span class="ruby-ivar">@tag</span>.<span class="ruby-identifier">dom_id</span>].<span class="ruby-identifier">replace</span> <span class="ruby-identifier">:partial</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'edit_tag_row'</span>
1586:           <span class="ruby-keyword kw">end</span> 
1587: 
1588:         <span class="ruby-keyword kw">end</span> 
1589: 
1590:       <span class="ruby-keyword kw">else</span> 
1591:         <span class="ruby-ivar">@tag</span>.<span class="ruby-identifier">name</span> = <span class="ruby-identifier">params</span>[<span class="ruby-value str">'tag-name'</span>]
1592:         <span class="ruby-ivar">@tag</span>.<span class="ruby-identifier">save</span>
1593:         <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1594:           <span class="ruby-identifier">page</span>[<span class="ruby-ivar">@tag</span>.<span class="ruby-identifier">dom_id</span>].<span class="ruby-identifier">replace</span> <span class="ruby-identifier">:partial</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'edit_tag_row'</span>
1595:         <span class="ruby-keyword kw">end</span> 
1596:       <span class="ruby-keyword kw">end</span> 
1597:     <span class="ruby-keyword kw">else</span> 
1598:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:nothing</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>
1599:     <span class="ruby-keyword kw">end</span> 
1600:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000240"><br/></a>
<div class="method_block"><h3>
<a href='#M000240'>


set_unread

()

</a>
</h3>
<p>
This action just sets the unread status for a task.
</p>

<p class="source_link" id="M000240-show-link"><a onclick="toggle('M000240-source'); toggleText('M000240-link'); return false;" href="#" id="M000240-link">Show source...</a></p><div class="source" id="M000240-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1612</span>
1612:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">set_unread</span>
1613:     <span class="ruby-identifier">task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>], 
1614:                      <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;project_id IN (#{current_project_ids})&quot;</span>)
1615: 
1616:     <span class="ruby-identifier">read</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:read</span>] <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;false&quot;</span>
1617:     <span class="ruby-identifier">task</span>.<span class="ruby-identifier">set_task_read</span>(<span class="ruby-identifier">current_user</span>, <span class="ruby-identifier">read</span>)
1618: 
1619:     <span class="ruby-identifier">render</span> <span class="ruby-identifier">:text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;&quot;</span>, <span class="ruby-identifier">:layout</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">false</span>
1620:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000230"><br/></a>
<div class="method_block"><h3>
<a href='#M000230'>


shortlist

()

</a>
</h3>

<p class="source_link" id="M000230-show-link"><a onclick="toggle('M000230-source'); toggleText('M000230-link'); return false;" href="#" id="M000230-link">Show source...</a></p><div class="source" id="M000230-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1376</span>
1376:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">shortlist</span>
1377:     <span class="ruby-identifier">tmp</span> = { }
1378:     <span class="ruby-comment cmt"># Save filtering</span>
1379:     [<span class="ruby-identifier">:filter_customer</span>, <span class="ruby-identifier">:filter_milestone</span>, <span class="ruby-identifier">:filter_project</span>, <span class="ruby-identifier">:filter_user</span>, <span class="ruby-identifier">:filter_hidden</span>, <span class="ruby-identifier">:filter_status</span>, <span class="ruby-identifier">:group_by</span>, <span class="ruby-identifier">:hide_deferred</span>, <span class="ruby-identifier">:hide_dependencies</span>, <span class="ruby-identifier">:sort</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
1380:       <span class="ruby-identifier">tmp</span>[<span class="ruby-identifier">v</span>] = <span class="ruby-identifier">session</span>[<span class="ruby-identifier">v</span>]
1381:     <span class="ruby-keyword kw">end</span>
1382: 
1383:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project</span>] = <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project_short</span>] <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project_short</span>]
1384:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_customer</span>] = <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_customer_short</span>] <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project_short</span>]
1385:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_milestone</span>] = <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_milestone_short</span>] <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_project_short</span>]
1386:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_user</span>] = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span>
1387:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_hidden</span>] = <span class="ruby-value str">&quot;0&quot;</span>
1388:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:filter_status</span>] = <span class="ruby-value str">&quot;0&quot;</span>
1389:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:group_by</span>] = <span class="ruby-value str">&quot;0&quot;</span>
1390:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:hide_deferred</span>] = <span class="ruby-value str">&quot;1&quot;</span>
1391:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:hide_dependencies</span>] = <span class="ruby-value str">&quot;1&quot;</span>
1392:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:sort</span>] = <span class="ruby-value str">&quot;0&quot;</span>
1393: 
1394:     <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">list</span>
1395: 
1396:     <span class="ruby-comment cmt"># Restore filtering</span>
1397:     [<span class="ruby-identifier">:filter_customer</span>, <span class="ruby-identifier">:filter_milestone</span>, <span class="ruby-identifier">:filter_project</span>, <span class="ruby-identifier">:filter_user</span>, <span class="ruby-identifier">:filter_hidden</span>, <span class="ruby-identifier">:filter_status</span>, <span class="ruby-identifier">:group_by</span>, <span class="ruby-identifier">:hide_deferred</span>, <span class="ruby-identifier">:hide_dependencies</span>, <span class="ruby-identifier">:sort</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">v</span><span class="ruby-operator">|</span>
1398:       <span class="ruby-identifier">session</span>[<span class="ruby-identifier">v</span>] = <span class="ruby-identifier">tmp</span>[<span class="ruby-identifier">v</span>]
1399:     <span class="ruby-keyword kw">end</span>
1400: 
1401:     <span class="ruby-identifier">render</span> <span class="ruby-identifier">:layout</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'shortlist'</span>
1402:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000208"><br/></a>
<div class="method_block"><h3>
<a href='#M000208'>


start_work

()

</a>
</h3>

<p class="source_link" id="M000208-show-link"><a onclick="toggle('M000208-source'); toggleText('M000208-link'); return false;" href="#" id="M000208-link">Show source...</a></p><div class="source" id="M000208-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 750</span>
750:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">start_work</span>
751:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@current_sheet</span>
752:       <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">swap_work_ajax</span>
753:     <span class="ruby-keyword kw">end</span>
754:     
755:     <span class="ruby-identifier">task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;company_id = ?&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>])
756:     <span class="ruby-identifier">sheet</span> = <span class="ruby-constant">Sheet</span>.<span class="ruby-identifier">new</span>
757: 
758:     <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">task</span> = <span class="ruby-identifier">task</span>
759:     <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">user</span> = <span class="ruby-identifier">current_user</span>
760:     <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">project</span> = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">project</span>
761:     <span class="ruby-identifier">sheet</span>.<span class="ruby-identifier">save</span>
762: 
763:     <span class="ruby-identifier">task</span>.<span class="ruby-identifier">status</span> = <span class="ruby-value">1</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
764:     <span class="ruby-identifier">task</span>.<span class="ruby-identifier">save</span>
765: 
766:     <span class="ruby-ivar">@current_sheet</span> = <span class="ruby-identifier">sheet</span>
767: 
768:     <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; task.id)}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
769: 
770:     <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">xhr?</span>
771:     <span class="ruby-identifier">redirect_from_last</span>
772:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000209"><br/></a>
<div class="method_block"><h3>
<a href='#M000209'>


start_work_ajax

()

</a>
</h3>

<p class="source_link" id="M000209-show-link"><a onclick="toggle('M000209-source'); toggleText('M000209-link'); return false;" href="#" id="M000209-link">Show source...</a></p><div class="source" id="M000209-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 774</span>
774:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">start_work_ajax</span>
775:     <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">start_work</span>
776:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000210"><br/></a>
<div class="method_block"><h3>
<a href='#M000210'>


start_work_edit_ajax

()

</a>
</h3>

<p class="source_link" id="M000210-show-link"><a onclick="toggle('M000210-source'); toggleText('M000210-link'); return false;" href="#" id="M000210-link">Show source...</a></p><div class="source" id="M000210-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 778</span>
778:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">start_work_edit_ajax</span>
779:     <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">start_work</span>
780:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000214"><br/></a>
<div class="method_block"><h3>
<a href='#M000214'>


stop_work

()

</a>
</h3>

<p class="source_link" id="M000214-show-link"><a onclick="toggle('M000214-source'); toggleText('M000214-link'); return false;" href="#" id="M000214-link">Show source...</a></p><div class="source" id="M000214-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 859</span>
859:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">stop_work</span>
860:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@current_sheet</span>
861:       <span class="ruby-identifier">worklog</span> = <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">new</span>
862:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">user</span> = <span class="ruby-identifier">current_user</span>
863:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">company</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company</span>
864:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">project</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">project</span>
865:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">task</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">task</span>
866:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">customer</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">customer</span>
867:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">started_at</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">created_at</span>
868:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">duration</span>
869:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">paused_duration</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">paused_duration</span>
870:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">body</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">body</span>
871:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_WORK_ADDED</span>
872:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">comment</span> = <span class="ruby-keyword kw">true</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">body</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">body</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span> 
873:       
874:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">save</span>
875:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">task</span>.<span class="ruby-identifier">updated_by_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
876:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">task</span>.<span class="ruby-identifier">save</span>
877: 
878:         <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">destroy</span>
879:         <span class="ruby-identifier">flash</span>[<span class="ruby-value str">'notice'</span>] = <span class="ruby-identifier">_</span>(<span class="ruby-value str">&quot;Log entry saved...&quot;</span>)
880:         <span class="ruby-ivar">@log</span> = <span class="ruby-identifier">worklog</span>
881:         <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">started_at</span> = <span class="ruby-identifier">tz</span>.<span class="ruby-identifier">utc_to_local</span>(<span class="ruby-ivar">@log</span>.<span class="ruby-identifier">started_at</span>)
882:         <span class="ruby-ivar">@task</span> = <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">task</span>
883:         <span class="ruby-identifier">render</span> <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'edit_log'</span>
884:         <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; @task.id)}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
885:       <span class="ruby-keyword kw">else</span>
886:         <span class="ruby-identifier">flash</span>[<span class="ruby-value str">'notice'</span>] = <span class="ruby-identifier">_</span>(<span class="ruby-value str">&quot;Unable to save log entry...&quot;</span>)
887:         <span class="ruby-identifier">redirect_from_last</span>
888:       <span class="ruby-keyword kw">end</span>
889:     <span class="ruby-keyword kw">else</span>
890:       <span class="ruby-ivar">@current_sheet</span> = <span class="ruby-keyword kw">nil</span>
891:       <span class="ruby-identifier">flash</span>[<span class="ruby-value str">'notice'</span>] = <span class="ruby-identifier">_</span>(<span class="ruby-value str">&quot;Log entry already saved from another browser instance.&quot;</span>)
892:       <span class="ruby-identifier">redirect_from_last</span>
893:     <span class="ruby-keyword kw">end</span>
894: 
895:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000215"><br/></a>
<div class="method_block"><h3>
<a href='#M000215'>


stop_work_shortlist

()

</a>
</h3>

<p class="source_link" id="M000215-show-link"><a onclick="toggle('M000215-source'); toggleText('M000215-link'); return false;" href="#" id="M000215-link">Show source...</a></p><div class="source" id="M000215-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 897</span>
897:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">stop_work_shortlist</span>
898:     <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@current_sheet</span>
899:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:nothing</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>
900:       <span class="ruby-keyword kw">return</span>
901:     <span class="ruby-keyword kw">end</span>
902: 
903:     <span class="ruby-ivar">@task</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">task</span>
904:     <span class="ruby-identifier">swap_work_ajax</span>
905:     <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; @task.id)}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
906: <span class="ruby-comment cmt">#    redirect_to :action =&gt; 'shortlist'</span>
907:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000212"><br/></a>
<div class="method_block"><h3>
<a href='#M000212'>


swap_work_ajax

()

</a>
</h3>

<p class="source_link" id="M000212-show-link"><a onclick="toggle('M000212-source'); toggleText('M000212-link'); return false;" href="#" id="M000212-link">Show source...</a></p><div class="source" id="M000212-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 794</span>
794:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">swap_work_ajax</span>
795:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@current_sheet</span>
796: 
797:       <span class="ruby-ivar">@old_task</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">task</span>
798: 
799:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">nil?</span>
800:         <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">destroy</span>
801:         <span class="ruby-ivar">@current_sheet</span> = <span class="ruby-keyword kw">nil</span>
802:         <span class="ruby-identifier">redirect_from_last</span>
803:       <span class="ruby-keyword kw">end</span>
804: 
805: <span class="ruby-comment cmt">#      @old_task.updated_by_id = current_user.id</span>
806: <span class="ruby-comment cmt">#      @old_task.save</span>
807: 
808:       <span class="ruby-identifier">worklog</span> = <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">new</span>
809:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">user</span> = <span class="ruby-identifier">current_user</span>
810:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">company</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company</span>
811:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">project</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">project</span>
812:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">task</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">task</span>
813:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">customer</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">customer</span>
814:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">started_at</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">created_at</span>
815:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">duration</span>
816:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">paused_duration</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">paused_duration</span>
817:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">body</span> = <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">body</span>
818:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">comment</span> = <span class="ruby-keyword kw">true</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">body</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">body</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
819:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_WORK_ADDED</span>
820:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">save</span>
821:         <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">destroy</span>
822:         <span class="ruby-identifier">flash</span>[<span class="ruby-value str">'notice'</span>] = <span class="ruby-identifier">_</span>(<span class="ruby-value str">&quot;Log entry saved...&quot;</span>)
823:         <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; @old_task.id)}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
824:         <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'activities', :action =&gt; 'refresh')}');&quot;</span>, [<span class="ruby-node">&quot;activity_#{current_user.company_id}&quot;</span>])
825:         <span class="ruby-ivar">@current_sheet</span> = <span class="ruby-keyword kw">nil</span>
826:       <span class="ruby-keyword kw">else</span>
827:         <span class="ruby-identifier">flash</span>[<span class="ruby-value str">'notice'</span>] = <span class="ruby-identifier">_</span>(<span class="ruby-value str">&quot;Unable to save log entry...&quot;</span>)
828:         <span class="ruby-identifier">redirect_from_last</span>
829:       <span class="ruby-keyword kw">end</span>
830: 
831:     <span class="ruby-keyword kw">end</span>
832:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000236"><br/></a>
<div class="method_block"><h3>
<a href='#M000236'>


tags

()

</a>
</h3>

<p class="source_link" id="M000236-show-link"><a onclick="toggle('M000236-source'); toggleText('M000236-link'); return false;" href="#" id="M000236-link">Show source...</a></p><div class="source" id="M000236-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1551</span>
1551:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">tags</span>
1552:     <span class="ruby-ivar">@tags</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company</span>.<span class="ruby-identifier">tags</span>
1553:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000233"><br/></a>
<div class="method_block"><h3>
<a href='#M000233'>


todo_check_ajax

()

</a>
</h3>

<p class="source_link" id="M000233-show-link"><a onclick="toggle('M000233-source'); toggleText('M000233-link'); return false;" href="#" id="M000233-link">Show source...</a></p><div class="source" id="M000233-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1463</span>
1463:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">todo_check_ajax</span>
1464:     <span class="ruby-keyword kw">begin</span>
1465:       <span class="ruby-ivar">@todo</span> = <span class="ruby-constant">Todo</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>])
1466:     <span class="ruby-keyword kw">rescue</span>
1467:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:nothing</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">true</span>
1468:       <span class="ruby-keyword kw">return</span>
1469:     <span class="ruby-keyword kw">end</span>
1470:     <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;id = ? AND project_id IN (#{current_project_ids})&quot;</span>, <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">task_id</span>])
1471:     <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@task</span>
1472:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1473:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-node">&quot;todos-#{params[:id]}&quot;</span>, <span class="ruby-identifier">:duration</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span><span class="ruby-value">.5</span>, <span class="ruby-identifier">:startcolor</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;#ff9999&quot;</span>)
1474:       <span class="ruby-keyword kw">end</span>
1475:       <span class="ruby-keyword kw">return</span>
1476:     <span class="ruby-keyword kw">end</span>
1477: 
1478:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">completed_at</span>
1479:       <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">completed_at</span> = <span class="ruby-keyword kw">nil</span>
1480:     <span class="ruby-keyword kw">else</span>
1481:       <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">completed_by_user</span> = <span class="ruby-identifier">current_user</span>
1482:       <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">completed_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>
1483:     <span class="ruby-keyword kw">end</span>
1484:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">save</span>
1485:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1486:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">completed_at</span>
1487:           <span class="ruby-identifier">page</span>.<span class="ruby-identifier">remove</span> <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">dom_id</span>
1488:           <span class="ruby-identifier">page</span>.<span class="ruby-identifier">insert_html</span> <span class="ruby-identifier">:top</span>, <span class="ruby-node">&quot;todo-done-#{@task.dom_id}&quot;</span>, <span class="ruby-identifier">:partial</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;tasks/todo_row&quot;</span>
1489:           <span class="ruby-identifier">page</span>.<span class="ruby-identifier">replace_html</span> <span class="ruby-node">&quot;todo-status-#{@task.dom_id}&quot;</span>, <span class="ruby-identifier">link_to_function</span>( <span class="ruby-node">&quot;#{@task.todo_status}&quot;</span>, <span class="ruby-node">&quot;Element.toggle('todo-container-#{@task.dom_id}');&quot;</span>, <span class="ruby-identifier">:class</span> =<span class="ruby-operator">&gt;</span> (<span class="ruby-ivar">@task</span>.<span class="ruby-identifier">todos</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-value">? </span><span class="ruby-value str">&quot;todo-status-link-empty&quot;</span> <span class="ruby-operator">:</span><span class="ruby-value str">&quot;todo-status-link&quot;</span>))
1490:         <span class="ruby-keyword kw">else</span>
1491:           <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">move_to_bottom</span>
1492:           <span class="ruby-identifier">page</span>.<span class="ruby-identifier">remove</span> <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">dom_id</span>
1493:           <span class="ruby-identifier">page</span>.<span class="ruby-identifier">insert_html</span> <span class="ruby-identifier">:bottom</span>, <span class="ruby-node">&quot;todo-#{@task.dom_id}&quot;</span>, <span class="ruby-identifier">:partial</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;tasks/todo_row&quot;</span>
1494:           <span class="ruby-identifier">page</span>.<span class="ruby-identifier">replace_html</span> <span class="ruby-node">&quot;todo-status-#{@task.dom_id}&quot;</span>, <span class="ruby-identifier">link_to_function</span>( <span class="ruby-node">&quot;#{@task.todo_status}&quot;</span>, <span class="ruby-node">&quot;Element.toggle('todo-container-#{@task.dom_id}');&quot;</span>, <span class="ruby-identifier">:class</span> =<span class="ruby-operator">&gt;</span> (<span class="ruby-ivar">@task</span>.<span class="ruby-identifier">todos</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-value">? </span><span class="ruby-value str">&quot;todo-status-link-empty&quot;</span> <span class="ruby-operator">:</span><span class="ruby-value str">&quot;todo-status-link&quot;</span>))
1495:         <span class="ruby-keyword kw">end</span>
1496:         <span class="ruby-identifier">page</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;Sortable.create('todo-#{@task.dom_id}', {containment:'todo-#{@task.dom_id}', format:/^[^-]*-(.*)$/, onUpdate:function(){new Ajax.Request('/tasks/order_todos/#{@task.id}', {asynchronous:true, evalScripts:true, parameters:Sortable.serialize('todo-#{@task.dom_id}')})}, only:'todo-active'})&quot;</span>
1497:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">call</span>(<span class="ruby-value str">&quot;updateTooltips&quot;</span>)
1498:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-node">&quot;#{@todo.dom_id}&quot;</span>, <span class="ruby-identifier">:duration</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">1.5</span>)
1499:       <span class="ruby-keyword kw">end</span>
1500:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; @task.id)}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
1501:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'activities', :action =&gt; 'refresh')}');&quot;</span>, [<span class="ruby-node">&quot;activity_#{current_user.company_id}&quot;</span>])
1502:     <span class="ruby-keyword kw">else</span>
1503:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1504:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-node">&quot;#{@todo.dom_id}&quot;</span>, <span class="ruby-identifier">:duration</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span><span class="ruby-value">.5</span>, <span class="ruby-identifier">:startcolor</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;#ff9999&quot;</span>)
1505:       <span class="ruby-keyword kw">end</span>
1506:     <span class="ruby-keyword kw">end</span>
1507: 
1508:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000235"><br/></a>
<div class="method_block"><h3>
<a href='#M000235'>


todo_delete_ajax

()

</a>
</h3>

<p class="source_link" id="M000235-show-link"><a onclick="toggle('M000235-source'); toggleText('M000235-link'); return false;" href="#" id="M000235-link">Show source...</a></p><div class="source" id="M000235-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1522</span>
1522:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">todo_delete_ajax</span>
1523:     <span class="ruby-keyword kw">begin</span>
1524:       <span class="ruby-ivar">@todo</span> = <span class="ruby-constant">Todo</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>])
1525:     <span class="ruby-keyword kw">rescue</span>
1526:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1527:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-node">&quot;todos-#{params[:id]}&quot;</span>, <span class="ruby-identifier">:duration</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span><span class="ruby-value">.5</span>, <span class="ruby-identifier">:startcolor</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;#ff9999&quot;</span>)
1528:       <span class="ruby-keyword kw">end</span>
1529:       <span class="ruby-keyword kw">return</span>
1530:     <span class="ruby-keyword kw">end</span>
1531:     <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;id = ? AND project_id IN (#{current_project_ids})&quot;</span>, <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">task_id</span>])
1532: 
1533:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>
1534:       <span class="ruby-identifier">element</span> = <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">dom_id</span>
1535:       <span class="ruby-ivar">@todo</span>.<span class="ruby-identifier">destroy</span>
1536:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1537:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span> <span class="ruby-identifier">:fade</span>, <span class="ruby-identifier">element</span>
1538:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">replace_html</span> <span class="ruby-node">&quot;todo-status-#{@task.dom_id}&quot;</span>, <span class="ruby-identifier">link_to_function</span>( <span class="ruby-node">&quot;#{@task.todo_status}&quot;</span>, <span class="ruby-node">&quot;Element.toggle('todo-container-#{@task.dom_id}');&quot;</span>, <span class="ruby-identifier">:class</span> =<span class="ruby-operator">&gt;</span> (<span class="ruby-ivar">@task</span>.<span class="ruby-identifier">todos</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-value">? </span><span class="ruby-value str">&quot;todo-status-link-empty&quot;</span> <span class="ruby-operator">:</span><span class="ruby-value str">&quot;todo-status-link&quot;</span>))
1539:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">delay</span>(<span class="ruby-value">1.0</span>) <span class="ruby-keyword kw">do</span>
1540:           <span class="ruby-identifier">page</span>.<span class="ruby-identifier">remove</span> <span class="ruby-identifier">element</span>
1541:         <span class="ruby-keyword kw">end</span>
1542:       <span class="ruby-keyword kw">end</span>
1543:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; @task.id)}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
1544:     <span class="ruby-keyword kw">else</span>
1545:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1546:         <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-node">&quot;todos-#{params[:id]}&quot;</span>, <span class="ruby-identifier">:duration</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span><span class="ruby-value">.5</span>, <span class="ruby-identifier">:startcolor</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;#ff9999&quot;</span>)
1547:       <span class="ruby-keyword kw">end</span>
1548:     <span class="ruby-keyword kw">end</span>
1549:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000226"><br/></a>
<div class="method_block"><h3>
<a href='#M000226'>


toggle_history

()

</a>
</h3>

<p class="source_link" id="M000226-show-link"><a onclick="toggle('M000226-source'); toggleText('M000226-link'); return false;" href="#" id="M000226-link">Show source...</a></p><div class="source" id="M000226-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1262</span>
1262:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">toggle_history</span>
1263:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:only_comments</span>] <span class="ruby-operator">||=</span> <span class="ruby-value">0</span>
1264:     <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:only_comments</span>] = <span class="ruby-value">1</span> <span class="ruby-operator">-</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:only_comments</span>]
1265: 
1266:     <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;project_id IN (#{current_project_ids})&quot;</span>])
1267:     <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@logs</span> = <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;work_logs.started_at desc,work_logs.id desc&quot;</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;work_logs.task_id = ? #{&quot;AND (work_logs.comment = 1 OR work_logs.log_type=6)&quot; if session[:only_comments].to_i == 1}&quot;</span>, <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">id</span>], <span class="ruby-identifier">:include</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:user</span>, <span class="ruby-identifier">:task</span>, <span class="ruby-identifier">:project</span>])
1268:       <span class="ruby-ivar">@logs</span> = []
1269:     <span class="ruby-keyword kw">end</span>
1270: 
1271:     <span class="ruby-identifier">render</span> <span class="ruby-identifier">:update</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">page</span><span class="ruby-operator">|</span>
1272:       <span class="ruby-identifier">page</span>.<span class="ruby-identifier">replace_html</span> <span class="ruby-value str">'task_history'</span>, <span class="ruby-identifier">:partial</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'history'</span>
1273:       <span class="ruby-identifier">page</span>.<span class="ruby-identifier">visual_effect</span>(<span class="ruby-identifier">:highlight</span>, <span class="ruby-value str">&quot;task_history&quot;</span>, <span class="ruby-identifier">:duration</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">2.0</span>)
1274:     <span class="ruby-keyword kw">end</span>
1275:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000201"><br/></a>
<div class="method_block"><h3>
<a href='#M000201'>


update

()

</a>
</h3>

<p class="source_link" id="M000201-show-link"><a onclick="toggle('M000201-source'); toggleText('M000201-link'); return false;" href="#" id="M000201-link">Show source...</a></p><div class="source" id="M000201-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 339</span>
339:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">update</span>
340:     <span class="ruby-identifier">projects</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span><span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span>}
341: 
342:     <span class="ruby-identifier">update_type</span> = <span class="ruby-identifier">:updated</span>
343: 
344:     <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;project_id IN (?)&quot;</span>, <span class="ruby-identifier">projects</span>], <span class="ruby-identifier">:include</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">:tags</span>])
345:     <span class="ruby-identifier">old_tags</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">tags</span>.<span class="ruby-identifier">collect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">name</span>}.<span class="ruby-identifier">sort</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">', '</span>)
346:     <span class="ruby-identifier">old_deps</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">dependencies</span>.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-node">&quot;[#{t.issue_num}] #{t.name}&quot;</span> }.<span class="ruby-identifier">sort</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">', '</span>)
347:     <span class="ruby-identifier">old_users</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">users</span>.<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">u</span><span class="ruby-operator">|</span> <span class="ruby-identifier">u</span>.<span class="ruby-identifier">id</span>}.<span class="ruby-identifier">sort</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">','</span>)
348:     <span class="ruby-identifier">old_users</span> <span class="ruby-operator">||=</span> <span class="ruby-value str">&quot;0&quot;</span>
349:     <span class="ruby-identifier">old_project_id</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project_id</span>
350:     <span class="ruby-identifier">old_project_name</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">name</span>
351:     <span class="ruby-ivar">@old_task</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">clone</span>
352: 
353:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:status</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">6</span>
354:       <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:status</span>] = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status</span>  <span class="ruby-comment cmt"># We're hiding the task, set the status to what is was.</span>
355:     <span class="ruby-keyword kw">else</span>
356:       <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:hide_until</span>] = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">hide_until</span>
357:     <span class="ruby-keyword kw">end</span>
358: 
359:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">update_attributes</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>])
360: 
361:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">hide_until</span> = <span class="ruby-keyword kw">nil</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:hide_until</span>].<span class="ruby-identifier">nil?</span>
362: 
363:       <span class="ruby-keyword kw">if</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:due_at</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:due_at</span>].<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
364: 
365:         <span class="ruby-identifier">repeat</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">parse_repeat</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:due_at</span>])
366:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">repeat</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">repeat</span> <span class="ruby-operator">!=</span> <span class="ruby-value str">&quot;&quot;</span>
367:           <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">repeat</span> = <span class="ruby-identifier">repeat</span>
368:           <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">due_at</span> = <span class="ruby-identifier">tz</span>.<span class="ruby-identifier">local_to_utc</span>(<span class="ruby-ivar">@task</span>.<span class="ruby-identifier">next_repeat_date</span>)
369:         <span class="ruby-keyword kw">else</span>
370:           <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">repeat</span> = <span class="ruby-keyword kw">nil</span>
371:           <span class="ruby-identifier">due_date</span> = <span class="ruby-constant">DateTime</span>.<span class="ruby-identifier">strptime</span>( <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:due_at</span>], <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">date_format</span> ) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">begin</span>
372:                                                                                                       <span class="ruby-identifier">flash</span>[<span class="ruby-value str">'notice'</span>] = <span class="ruby-identifier">_</span>(<span class="ruby-value str">'Invalid due date ignored.'</span>)
373:                                                                                                       <span class="ruby-identifier">due_date</span> = <span class="ruby-keyword kw">nil</span>
374:                                                                                                     <span class="ruby-keyword kw">end</span>
375:           <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">due_at</span> = <span class="ruby-identifier">tz</span>.<span class="ruby-identifier">local_to_utc</span>(<span class="ruby-identifier">due_date</span>.<span class="ruby-identifier">to_time</span> <span class="ruby-operator">+</span> <span class="ruby-value">1</span>.<span class="ruby-identifier">day</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>.<span class="ruby-identifier">minute</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">due_date</span>.<span class="ruby-identifier">nil?</span>
376:         <span class="ruby-keyword kw">end</span>
377:       <span class="ruby-keyword kw">else</span>
378:         <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">repeat</span> = <span class="ruby-keyword kw">nil</span>
379:       <span class="ruby-keyword kw">end</span>
380: 
381:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">set_watcher_attributes</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:watchers</span>], <span class="ruby-identifier">current_user</span>)
382:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">set_owner_attributes</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:users</span>])
383:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">set_dependency_attributes</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:dependencies</span>], <span class="ruby-identifier">current_project_ids</span>)
384:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">set_resource_attributes</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:resource</span>])
385: 
386:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-identifier">parse_time</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:duration</span>], <span class="ruby-keyword kw">true</span>) <span class="ruby-keyword kw">if</span> (<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:task</span>][<span class="ruby-identifier">:duration</span>])
387:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">updated_by_id</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">id</span>
388: 
389:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">completed_at</span>.<span class="ruby-identifier">nil?</span>
390:         <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">completed_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>
391: 
392:         <span class="ruby-comment cmt"># Repeat this task every X...</span>
393:         <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">next_repeat_date</span> <span class="ruby-operator">!=</span> <span class="ruby-keyword kw">nil</span>
394: 
395:           <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">save</span>
396:           <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">reload</span>
397: 
398:           <span class="ruby-identifier">repeat_task</span>(<span class="ruby-ivar">@task</span>)
399:         <span class="ruby-keyword kw">end</span>
400:       <span class="ruby-keyword kw">end</span>
401: 
402:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">2</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-ivar">@task</span>.<span class="ruby-identifier">completed_at</span>.<span class="ruby-identifier">nil?</span>
403:         <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">completed_at</span> = <span class="ruby-keyword kw">nil</span>
404:       <span class="ruby-keyword kw">end</span>
405: 
406:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">scheduled_duration</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">duration</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">scheduled?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">duration</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">duration</span>
407:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">scheduled_at</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">due_at</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">scheduled?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">due_at</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">due_at</span>
408: 
409:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">save</span>
410: 
411:       <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">reload</span>
412: 
413:       <span class="ruby-identifier">body</span> = <span class="ruby-value str">&quot;&quot;</span>
414:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@old_task</span>[<span class="ruby-identifier">:name</span>] <span class="ruby-operator">!=</span> <span class="ruby-ivar">@task</span>[<span class="ruby-identifier">:name</span>]
415:         <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Name&lt;/strong&gt;: #{@old_task[:name]} -&gt; #{@task[:name]}\n&quot;</span>
416:       <span class="ruby-keyword kw">end</span>
417: 
418:       <span class="ruby-keyword kw">if</span>(<span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">description</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">description</span>)
419:         <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;- &lt;strong&gt;Description&lt;/strong&gt; changed\n&quot;</span>
420:       <span class="ruby-keyword kw">end</span>
421: 
422:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:users</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">old_users</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:users</span>].<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">u</span><span class="ruby-operator">|</span> <span class="ruby-identifier">u</span>.<span class="ruby-identifier">to_i</span>}.<span class="ruby-identifier">sort</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">','</span>)
423:         <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span>(<span class="ruby-node">&quot;#{old_users} != #{params[:users].collect{|u| u.to_i}.sort.join(',')}&quot;</span>)
424:         <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">users</span>.<span class="ruby-identifier">reload</span>
425:         <span class="ruby-identifier">new_name</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">users</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-value">? </span><span class="ruby-value str">'Unassigned'</span> <span class="ruby-operator">:</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">users</span>.<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">u</span><span class="ruby-operator">|</span> <span class="ruby-identifier">u</span>.<span class="ruby-identifier">name</span>}.<span class="ruby-identifier">join</span>(<span class="ruby-value str">', '</span>)
426:         <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Assignment&lt;/strong&gt;: #{new_name}\n&quot;</span>
427:         <span class="ruby-identifier">update_type</span> = <span class="ruby-identifier">:reassigned</span>
428:       <span class="ruby-keyword kw">end</span>
429: 
430:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">old_project_id</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project_id</span>
431:         <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Project&lt;/strong&gt;: #{old_project_name} -&gt; #{@task.project.name}\n&quot;</span>
432:         <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">update_all</span>(<span class="ruby-node">&quot;customer_id = #{@task.project.customer_id}, project_id = #{@task.project_id}&quot;</span>, <span class="ruby-node">&quot;task_id = #{@task.id}&quot;</span>)
433:         <span class="ruby-constant">ProjectFile</span>.<span class="ruby-identifier">update_all</span>(<span class="ruby-node">&quot;customer_id = #{@task.project.customer_id}, project_id = #{@task.project_id}&quot;</span>, <span class="ruby-node">&quot;task_id = #{@task.id}&quot;</span>)
434:       <span class="ruby-keyword kw">end</span>
435: 
436:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">duration</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">duration</span>
437:         <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Estimate&lt;/strong&gt;: #{worked_nice(@old_task.duration).strip} -&gt; #{worked_nice(@task.duration)}\n&quot;</span>
438:       <span class="ruby-keyword kw">end</span>
439: 
440:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">milestone</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone</span>
441:         <span class="ruby-identifier">old_name</span> = <span class="ruby-value str">&quot;None&quot;</span>
442:         <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">nil?</span>
443:            <span class="ruby-identifier">old_name</span> = <span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">name</span>
444:            <span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">update_counts</span>
445:         <span class="ruby-keyword kw">end</span>
446: 
447:         <span class="ruby-identifier">new_name</span> = <span class="ruby-value str">&quot;None&quot;</span>
448:         <span class="ruby-identifier">new_name</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">name</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">nil?</span>
449: 
450:         <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Milestone&lt;/strong&gt;: #{old_name} -&gt; #{new_name}\n&quot;</span>
451:       <span class="ruby-keyword kw">end</span>
452: 
453:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">due_at</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">due_at</span>
454:         <span class="ruby-identifier">old_name</span> = <span class="ruby-value str">&quot;None&quot;</span>
455:         <span class="ruby-identifier">old_name</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">tz</span>.<span class="ruby-identifier">utc_to_local</span>(<span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">due_at</span>).<span class="ruby-identifier">strftime_localized</span>(<span class="ruby-value str">&quot;%A, %d %B %Y&quot;</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">due_at</span>.<span class="ruby-identifier">nil?</span>
456: 
457:         <span class="ruby-identifier">new_name</span> = <span class="ruby-value str">&quot;None&quot;</span>
458:         <span class="ruby-identifier">new_name</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">tz</span>.<span class="ruby-identifier">utc_to_local</span>(<span class="ruby-ivar">@task</span>.<span class="ruby-identifier">due_at</span>).<span class="ruby-identifier">strftime_localized</span>(<span class="ruby-value str">&quot;%A, %d %B %Y&quot;</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">due_at</span>.<span class="ruby-identifier">nil?</span>
459: 
460:         <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Due&lt;/strong&gt;: #{old_name} -&gt; #{new_name}\n&quot;</span>
461:       <span class="ruby-keyword kw">end</span>
462: 
463:       <span class="ruby-identifier">new_tags</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">tags</span>.<span class="ruby-identifier">collect</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">name</span>}.<span class="ruby-identifier">sort</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">', '</span>)
464:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">old_tags</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">new_tags</span>
465:         <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Tags&lt;/strong&gt;: #{new_tags}\n&quot;</span>
466:       <span class="ruby-keyword kw">end</span>
467: 
468:       <span class="ruby-identifier">new_deps</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">dependencies</span>.<span class="ruby-identifier">collect</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-node">&quot;[#{t.issue_num}] #{t.name}&quot;</span>}.<span class="ruby-identifier">sort</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">&quot;, &quot;</span>)
469:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">old_deps</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">new_deps</span>
470:         <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Dependencies&lt;/strong&gt;: #{(new_deps.length &gt; 0) ? new_deps : _(&quot;None&quot;)}&quot;</span>
471:       <span class="ruby-keyword kw">end</span>
472: 
473:       <span class="ruby-identifier">worklog</span> = <span class="ruby-constant">WorkLog</span>.<span class="ruby-identifier">new</span>
474:       <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_MODIFIED</span>
475: 
476: 
477:       <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status</span>
478:         <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Status&lt;/strong&gt;: #{@old_task.status_type} -&gt; #{@task.status_type}\n&quot;</span>
479: 
480:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_COMPLETED</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>
481:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_REVERTED</span> <span class="ruby-keyword kw">if</span> (<span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> <span class="ruby-operator">||</span> (<span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">2</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>))
482: 
483:         <span class="ruby-keyword kw">if</span>( <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">!=</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status</span> )
484:           <span class="ruby-identifier">update_type</span> = <span class="ruby-identifier">:status</span>
485:         <span class="ruby-keyword kw">end</span>
486: 
487:         <span class="ruby-keyword kw">if</span>( <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">completed_at</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">completed_at</span>.<span class="ruby-identifier">nil?</span>)
488:           <span class="ruby-identifier">update_type</span> = <span class="ruby-identifier">:completed</span>
489:         <span class="ruby-keyword kw">end</span>
490: 
491:         <span class="ruby-keyword kw">if</span>( <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">2</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span> )
492:           <span class="ruby-identifier">update_type</span> = <span class="ruby-identifier">:reverted</span>
493:         <span class="ruby-keyword kw">end</span>
494: 
495:         <span class="ruby-keyword kw">if</span>( <span class="ruby-ivar">@old_task</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">==</span> <span class="ruby-value">6</span> )
496:           <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">hide_until</span> = <span class="ruby-keyword kw">nil</span>
497:         <span class="ruby-keyword kw">end</span> 
498: 
499:       <span class="ruby-keyword kw">end</span>
500: 
501:       <span class="ruby-identifier">files</span> = <span class="ruby-identifier">create_attachments</span>(<span class="ruby-ivar">@task</span>)
502:       <span class="ruby-identifier">files</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">filename</span><span class="ruby-operator">|</span>
503:         <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;- &lt;strong&gt;Attached&lt;/strong&gt;: #{filename}\n&quot;</span>
504:       <span class="ruby-keyword kw">end</span>
505: 
506:       <span class="ruby-identifier">email_body</span> = <span class="ruby-identifier">body</span>
507: 
508:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:comment</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:comment</span>].<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
509:         <span class="ruby-identifier">update_type</span> = <span class="ruby-identifier">:comment</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">body</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
510:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">log_type</span> = <span class="ruby-constant">EventLog</span><span class="ruby-operator">::</span><span class="ruby-constant">TASK_COMMENT</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">body</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
511:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">comment</span> = <span class="ruby-keyword kw">true</span>
512:         
513:         <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value str">&quot;\n&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">body</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
514:         <span class="ruby-identifier">email_body</span> = <span class="ruby-identifier">body</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot;:\n&quot;</span>
515: 
516:         <span class="ruby-identifier">body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-constant">CGI</span><span class="ruby-operator">::</span><span class="ruby-identifier">escapeHTML</span>(<span class="ruby-identifier">params</span>[<span class="ruby-identifier">:comment</span>])
517:         <span class="ruby-identifier">email_body</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:comment</span>]
518:       <span class="ruby-keyword kw">end</span>
519: 
520:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">body</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
521:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">user</span> = <span class="ruby-identifier">current_user</span>
522:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">company</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">company</span>
523:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">customer</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">customer</span>
524:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">project</span> = <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">project</span>
525:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">task</span> = <span class="ruby-ivar">@task</span>
526:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">started_at</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">utc</span>
527:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">duration</span> = <span class="ruby-value">0</span>
528:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">body</span> = <span class="ruby-identifier">body</span>
529:         <span class="ruby-identifier">worklog</span>.<span class="ruby-identifier">save</span>
530: 
531:         <span class="ruby-keyword kw">if</span>(<span class="ruby-identifier">params</span>[<span class="ruby-value str">'notify'</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span>)
532:           <span class="ruby-constant">Notifications</span><span class="ruby-operator">::</span><span class="ruby-identifier">deliver_changed</span>( <span class="ruby-identifier">update_type</span>, <span class="ruby-ivar">@task</span>, <span class="ruby-identifier">current_user</span>, <span class="ruby-identifier">email_body</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/&lt;[^&gt;]*&gt;/</span>,<span class="ruby-value str">''</span>)) <span class="ruby-keyword kw">rescue</span> <span class="ruby-keyword kw">nil</span>
533:         <span class="ruby-keyword kw">end</span>
534:       <span class="ruby-keyword kw">end</span>
535: 
536:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'tasks', :action =&gt; 'update_tasks', :id =&gt; @task.id)}');&quot;</span>, [<span class="ruby-node">&quot;tasks_#{current_user.company_id}&quot;</span>])
537:       <span class="ruby-constant">Juggernaut</span>.<span class="ruby-identifier">send</span>( <span class="ruby-node">&quot;do_update(#{current_user.id}, '#{url_for(:controller =&gt; 'activities', :action =&gt; 'refresh')}');&quot;</span>, [<span class="ruby-node">&quot;activity_#{current_user.company_id}&quot;</span>])
538: 
539:       <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">request</span>.<span class="ruby-identifier">xhr?</span>
540: 
541:       <span class="ruby-identifier">flash</span>[<span class="ruby-value str">'notice'</span>] <span class="ruby-operator">||=</span> <span class="ruby-node">&quot;#{link_to_task(@task)} - #{_('Task was successfully updated.')}&quot;</span>
542:       <span class="ruby-identifier">redirect_from_last</span>
543:     <span class="ruby-keyword kw">else</span>
544:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'edit'</span>
545:     <span class="ruby-keyword kw">end</span>
546:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000202"><br/></a>
<div class="method_block"><h3>
<a href='#M000202'>


update_ajax

()

</a>
</h3>

<p class="source_link" id="M000202-show-link"><a onclick="toggle('M000202-source'); toggleText('M000202-link'); return false;" href="#" id="M000202-link">Show source...</a></p><div class="source" id="M000202-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 548</span>
548:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">update_ajax</span>
549:     <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">update</span>
550:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000217"><br/></a>
<div class="method_block"><h3>
<a href='#M000217'>


update_sheet_info

()

</a>
</h3>

<p class="source_link" id="M000217-show-link"><a onclick="toggle('M000217-source'); toggleText('M000217-link'); return false;" href="#" id="M000217-link">Show source...</a></p><div class="source" id="M000217-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 924</span>
924:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">update_sheet_info</span>
925:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000218"><br/></a>
<div class="method_block"><h3>
<a href='#M000218'>


update_tasks

()

</a>
</h3>

<p class="source_link" id="M000218-show-link"><a onclick="toggle('M000218-source'); toggleText('M000218-link'); return false;" href="#" id="M000218-link">Show source...</a></p><div class="source" id="M000218-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 927</span>
927:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">update_tasks</span>
928:     <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>( <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>], <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;company_id = ?&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>] )
929:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000216"><br/></a>
<div class="method_block"><h3>
<a href='#M000216'>


updatelog

()

</a>
</h3>

<p class="source_link" id="M000216-show-link"><a onclick="toggle('M000216-source'); toggleText('M000216-link'); return false;" href="#" id="M000216-link">Show source...</a></p><div class="source" id="M000216-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 909</span>
909:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">updatelog</span>
910:     <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@current_sheet</span>
911:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;#{_(&quot;Task not worked on&quot;)} #{current_user.tz.utc_to_local(Time.now.utc).strftime_localized(&quot;%H:%M:%S&quot;)}&quot;</span>
912:       <span class="ruby-keyword kw">return</span>
913:     <span class="ruby-keyword kw">end</span> 
914:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:worklog</span>] <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:worklog</span>][<span class="ruby-identifier">:body</span>] 
915:       <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">body</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:worklog</span>][<span class="ruby-identifier">:body</span>] 
916:       <span class="ruby-ivar">@current_sheet</span>.<span class="ruby-identifier">save</span>
917:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;#{_(&quot;Saved&quot;)} #{current_user.tz.utc_to_local(Time.now.utc).strftime_localized(&quot;%H:%M:%S&quot;)}&quot;</span>
918:     <span class="ruby-keyword kw">else</span> 
919:       <span class="ruby-identifier">render</span> <span class="ruby-identifier">:text</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;#{_(&quot;Error saving&quot;)} #{current_user.tz.utc_to_local(Time.now.utc).strftime_localized(&quot;%H:%M:%S&quot;)}&quot;</span>
920:     <span class="ruby-keyword kw">end</span> 
921:   <span class="ruby-keyword kw">end</span></pre></div>
</div>

<a class="small" name="M000198"><br/></a>
<div class="method_block"><h3>
<a href='#M000198'>


view

()

</a>
</h3>

<p class="source_link" id="M000198-show-link"><a onclick="toggle('M000198-source'); toggleText('M000198-link'); return false;" href="#" id="M000198-link">Show source...</a></p><div class="source" id="M000198-source"><pre>     <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 265</span>
265:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">view</span>
266:     <span class="ruby-ivar">@task</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:first</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;project_id IN (#{current_project_ids}) AND task_num = ?&quot;</span>, <span class="ruby-identifier">params</span>[<span class="ruby-identifier">:id</span>]])
267:     <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@task</span>
268:       <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'edit'</span>, <span class="ruby-identifier">:id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@task</span>.<span class="ruby-identifier">id</span>
269:     <span class="ruby-keyword kw">else</span>
270:       <span class="ruby-identifier">redirect_to</span> <span class="ruby-identifier">:controller</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'views'</span>, <span class="ruby-identifier">:action</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'browse'</span>
271:     <span class="ruby-keyword kw">end</span>
272:   <span class="ruby-keyword kw">end</span></pre></div>
</div>


<h1>Private Instance Methods</h1>


<a class="small" name="M000241"><br/></a>
<div class="method_block"><h3>
<a href='#M000241'>


group_tasks

(tasks)

</a>
</h3>
<p>
Returns a two element array containing the grouped tasks. The first element
is an in-order array of group ids / names The second element is a hash
mapping group ids / names to arrays of tasks.
</p>

<p class="source_link" id="M000241-show-link"><a onclick="toggle('M000241-source'); toggleText('M000241-link'); return false;" href="#" id="M000241-link">Show source...</a></p><div class="source" id="M000241-source"><pre>      <span class="ruby-comment cmt"># File app/controllers/tasks_controller.rb, line 1629</span>
1629:   <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">group_tasks</span>(<span class="ruby-identifier">tasks</span>)
1630:     <span class="ruby-identifier">group_ids</span> = {}
1631:     <span class="ruby-identifier">groups</span> = []
1632:         
1633:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:group_by</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">1</span> <span class="ruby-comment cmt"># tags</span>
1634:       <span class="ruby-ivar">@tag_names</span> = <span class="ruby-ivar">@all_tags</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">i</span>,<span class="ruby-identifier">j</span><span class="ruby-operator">|</span> <span class="ruby-identifier">i</span>}
1635:       <span class="ruby-identifier">groups</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">tag_groups</span>(<span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>, <span class="ruby-ivar">@tag_names</span>, <span class="ruby-identifier">tasks</span>)
1636:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:group_by</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span> <span class="ruby-comment cmt"># Clients</span>
1637:       <span class="ruby-identifier">clients</span> = <span class="ruby-constant">Customer</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-value str">&quot;company_id = ?&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>], <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;name&quot;</span>)
1638:       <span class="ruby-identifier">clients</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-identifier">group_ids</span>[<span class="ruby-identifier">c</span>.<span class="ruby-identifier">name</span>] = <span class="ruby-identifier">c</span>.<span class="ruby-identifier">id</span> }
1639:       <span class="ruby-identifier">items</span> = <span class="ruby-identifier">clients</span>.<span class="ruby-identifier">collect</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">:name</span>).<span class="ruby-identifier">sort</span>
1640:       <span class="ruby-identifier">groups</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">group_by</span>(<span class="ruby-identifier">tasks</span>, <span class="ruby-identifier">items</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">t</span>,<span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">customer</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">i</span> }
1641:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:group_by</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">3</span> <span class="ruby-comment cmt"># Projects</span>
1642:       <span class="ruby-identifier">projects</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>
1643:       <span class="ruby-identifier">projects</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-identifier">group_ids</span>[<span class="ruby-identifier">p</span>.<span class="ruby-identifier">full_name</span>] = <span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span> }
1644:       <span class="ruby-identifier">items</span> = <span class="ruby-identifier">projects</span>.<span class="ruby-identifier">collect</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">:full_name</span>).<span class="ruby-identifier">sort</span>
1645:       <span class="ruby-identifier">groups</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">group_by</span>(<span class="ruby-identifier">tasks</span>, <span class="ruby-identifier">items</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">t</span>,<span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">full_name</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">i</span> }
1646: 
1647:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:group_by</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">4</span> <span class="ruby-comment cmt"># Milestones</span>
1648:       <span class="ruby-identifier">tf</span> = <span class="ruby-constant">TaskFilter</span>.<span class="ruby-identifier">new</span>(<span class="ruby-keyword kw">self</span>, <span class="ruby-identifier">session</span>)
1649:       
1650:       <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">tf</span>.<span class="ruby-identifier">milestone_ids</span>.<span class="ruby-identifier">any?</span>
1651:         <span class="ruby-identifier">filter</span> = <span class="ruby-node">&quot; AND id in (#{ tf.milestone_ids.join(&quot;,&quot;) })&quot;</span>
1652:       <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">tf</span>.<span class="ruby-identifier">project_ids</span>.<span class="ruby-identifier">any?</span>
1653:         <span class="ruby-identifier">filter</span> = <span class="ruby-node">&quot; AND project_id in (#{ tf.project_ids.join(&quot;,&quot;) })&quot;</span>
1654:       <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">tf</span>.<span class="ruby-identifier">customer_ids</span>.<span class="ruby-identifier">any?</span>
1655:         <span class="ruby-identifier">projects</span> = []
1656:         <span class="ruby-identifier">tf</span>.<span class="ruby-identifier">customer_ids</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">id</span><span class="ruby-operator">|</span> <span class="ruby-identifier">projects</span> <span class="ruby-operator">+=</span> <span class="ruby-constant">Customer</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">id</span>).<span class="ruby-identifier">projects</span> }
1657:         <span class="ruby-identifier">projects</span> = <span class="ruby-identifier">projects</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span> }
1658:         <span class="ruby-identifier">filter</span> = <span class="ruby-node">&quot; AND project_id IN (#{ projects.join(&quot;,&quot;) })&quot;</span>
1659:       <span class="ruby-keyword kw">end</span>
1660: 
1661:       <span class="ruby-identifier">conditions</span> = <span class="ruby-node">&quot;company_id = #{ current_user.company.id }&quot;</span>
1662:       <span class="ruby-identifier">conditions</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot; AND project_id IN (#{current_project_ids})#{filter} &quot;</span>
1663:       <span class="ruby-identifier">conditions</span> <span class="ruby-operator">+=</span> <span class="ruby-value str">&quot; AND completed_at IS NULL&quot;</span>
1664: 
1665:       <span class="ruby-identifier">milestones</span> = <span class="ruby-constant">Milestone</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">conditions</span>, 
1666:                                   <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;due_at, name&quot;</span>)
1667:       <span class="ruby-identifier">milestones</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-identifier">group_ids</span>[<span class="ruby-identifier">m</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot; / &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">name</span>] = <span class="ruby-identifier">m</span>.<span class="ruby-identifier">id</span> }
1668:       <span class="ruby-identifier">group_ids</span>[<span class="ruby-value str">'Unassigned'</span>] = <span class="ruby-value">0</span>
1669:       <span class="ruby-identifier">items</span> = [<span class="ruby-value str">&quot;Unassigned&quot;</span>] <span class="ruby-operator">+</span>  <span class="ruby-identifier">milestones</span>.<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot; / &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">m</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">name</span> }
1670:       <span class="ruby-identifier">groups</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">group_by</span>(<span class="ruby-identifier">tasks</span>, <span class="ruby-identifier">items</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">t</span>,<span class="ruby-identifier">i</span><span class="ruby-operator">|</span> (<span class="ruby-identifier">t</span>.<span class="ruby-identifier">milestone</span> <span class="ruby-value">? </span>(<span class="ruby-identifier">t</span>.<span class="ruby-identifier">milestone</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">+</span> <span class="ruby-value str">&quot; / &quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">name</span>) <span class="ruby-operator">:</span> <span class="ruby-value str">&quot;Unassigned&quot;</span> ) <span class="ruby-operator">==</span> <span class="ruby-identifier">i</span> }
1671: 
1672:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:group_by</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">5</span> <span class="ruby-comment cmt"># Users</span>
1673:       <span class="ruby-identifier">users</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company</span>.<span class="ruby-identifier">users</span>
1674:       <span class="ruby-identifier">users</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">u</span><span class="ruby-operator">|</span> <span class="ruby-identifier">group_ids</span>[<span class="ruby-identifier">u</span>.<span class="ruby-identifier">name</span>] = <span class="ruby-identifier">u</span>.<span class="ruby-identifier">id</span> }
1675:       <span class="ruby-identifier">group_ids</span>[<span class="ruby-identifier">_</span>(<span class="ruby-value str">'Unassigned'</span>)] = <span class="ruby-value">0</span>
1676:       <span class="ruby-identifier">items</span> = [<span class="ruby-identifier">_</span>(<span class="ruby-value str">&quot;Unassigned&quot;</span>)] <span class="ruby-operator">+</span> <span class="ruby-identifier">users</span>.<span class="ruby-identifier">collect</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">:name</span>).<span class="ruby-identifier">sort</span>
1677:       <span class="ruby-identifier">groups</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">group_by</span>(<span class="ruby-identifier">tasks</span>, <span class="ruby-identifier">items</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">t</span>,<span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
1678:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">users</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
1679:           <span class="ruby-identifier">res</span> = <span class="ruby-identifier">t</span>.<span class="ruby-identifier">users</span>.<span class="ruby-identifier">collect</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">:name</span>).<span class="ruby-identifier">include?</span> <span class="ruby-identifier">i</span>
1680:         <span class="ruby-keyword kw">else</span>
1681:           <span class="ruby-identifier">res</span> = (<span class="ruby-identifier">_</span>(<span class="ruby-value str">&quot;Unassigned&quot;</span>) <span class="ruby-operator">==</span> <span class="ruby-identifier">i</span>)
1682:           <span class="ruby-keyword kw">end</span>
1683:         <span class="ruby-identifier">res</span>
1684:       }
1685:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:group_by</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">7</span> <span class="ruby-comment cmt"># Status</span>
1686:       <span class="ruby-value">0</span>.<span class="ruby-identifier">upto</span>(<span class="ruby-value">5</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">group_ids</span>[ <span class="ruby-identifier">_</span>(<span class="ruby-constant">Task</span>.<span class="ruby-identifier">status_types</span>[<span class="ruby-identifier">i</span>]) ] = <span class="ruby-identifier">i</span> }
1687:       <span class="ruby-identifier">items</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">status_types</span>.<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">_</span>(<span class="ruby-identifier">i</span>) }
1688:       <span class="ruby-identifier">groups</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">group_by</span>(<span class="ruby-identifier">tasks</span>, <span class="ruby-identifier">items</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">t</span>,<span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">_</span>(<span class="ruby-identifier">t</span>.<span class="ruby-identifier">status_type</span>) <span class="ruby-operator">==</span> <span class="ruby-identifier">i</span> }
1689:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:group_by</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">10</span> <span class="ruby-comment cmt"># Projects / Milestones</span>
1690:       <span class="ruby-identifier">milestones</span> = <span class="ruby-constant">Milestone</span>.<span class="ruby-identifier">find</span>(<span class="ruby-identifier">:all</span>, <span class="ruby-identifier">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;company_id = ? AND project_id IN (#{current_project_ids}) AND completed_at IS NULL&quot;</span>, <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company_id</span>], <span class="ruby-identifier">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">&quot;due_at, name&quot;</span>)
1691:       <span class="ruby-identifier">projects</span> = <span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">projects</span>
1692: 
1693:       <span class="ruby-identifier">milestones</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-identifier">group_ids</span>[<span class="ruby-node">&quot;#{m.project.name} / #{m.name}&quot;</span>] = <span class="ruby-node">&quot;#{m.project_id}_#{m.id}&quot;</span> }
1694:       <span class="ruby-identifier">projects</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">p</span><span class="ruby-operator">|</span> <span class="ruby-identifier">group_ids</span>[<span class="ruby-node">&quot;#{p.name}&quot;</span>] = <span class="ruby-identifier">p</span>.<span class="ruby-identifier">id</span> }
1695: 
1696:       <span class="ruby-identifier">items</span> = <span class="ruby-identifier">milestones</span>.<span class="ruby-identifier">collect</span>{ <span class="ruby-operator">|</span><span class="ruby-identifier">m</span><span class="ruby-operator">|</span> <span class="ruby-node">&quot;#{m.project.name} / #{m.name}&quot;</span> }.<span class="ruby-identifier">flatten</span>
1697:       <span class="ruby-identifier">items</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">projects</span>.<span class="ruby-identifier">collect</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">:name</span>)
1698:       <span class="ruby-identifier">items</span> = <span class="ruby-identifier">items</span>.<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">sort</span>
1699: 
1700:       <span class="ruby-identifier">groups</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">group_by</span>(<span class="ruby-identifier">tasks</span>, <span class="ruby-identifier">items</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">t</span>,<span class="ruby-identifier">i</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">milestone</span> <span class="ruby-value">? </span>(<span class="ruby-node">&quot;#{t.project.name} / #{t.milestone.name}&quot;</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">i</span>) <span class="ruby-operator">:</span> (<span class="ruby-identifier">t</span>.<span class="ruby-identifier">project</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">i</span>)  }
1701:     <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:group_by</span>].<span class="ruby-identifier">to_i</span> <span class="ruby-operator">==</span> <span class="ruby-value">11</span> <span class="ruby-comment cmt"># Requested By</span>
1702:       <span class="ruby-identifier">requested_by</span> = <span class="ruby-identifier">tasks</span>.<span class="ruby-identifier">collect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">requested_by</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-value">? </span><span class="ruby-keyword kw">nil</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">requested_by</span> }.<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">sort</span>
1703:       <span class="ruby-identifier">requested_by</span> = [<span class="ruby-identifier">_</span>(<span class="ruby-value str">'No one'</span>)] <span class="ruby-operator">+</span> <span class="ruby-identifier">requested_by</span>
1704:       <span class="ruby-identifier">groups</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">group_by</span>(<span class="ruby-identifier">tasks</span>, <span class="ruby-identifier">requested_by</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">t</span>,<span class="ruby-identifier">i</span><span class="ruby-operator">|</span> (<span class="ruby-identifier">t</span>.<span class="ruby-identifier">requested_by</span>.<span class="ruby-identifier">blank?</span> <span class="ruby-value">? </span><span class="ruby-identifier">_</span>(<span class="ruby-value str">'No one'</span>) <span class="ruby-operator">:</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">requested_by</span>) <span class="ruby-operator">==</span> <span class="ruby-identifier">i</span> }
1705:     <span class="ruby-keyword kw">elsif</span> (<span class="ruby-identifier">property</span> = <span class="ruby-constant">Property</span>.<span class="ruby-identifier">find_by_group_by</span>(<span class="ruby-identifier">current_user</span>.<span class="ruby-identifier">company</span>, <span class="ruby-identifier">session</span>[<span class="ruby-identifier">:group_by</span>]))
1706:       <span class="ruby-identifier">items</span> = <span class="ruby-identifier">property</span>.<span class="ruby-identifier">property_values</span>
1707:       <span class="ruby-identifier">items</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">pbv</span><span class="ruby-operator">|</span> <span class="ruby-identifier">group_ids</span>[<span class="ruby-identifier">pbv</span>] = <span class="ruby-identifier">pbv</span>.<span class="ruby-identifier">id</span> }
1708: 
1709:       <span class="ruby-comment cmt"># add in for tasks without values</span>
1710:       <span class="ruby-identifier">unassigned</span> = <span class="ruby-identifier">_</span>(<span class="ruby-value str">&quot;Unassigned&quot;</span>)
1711:       <span class="ruby-identifier">group_ids</span>[<span class="ruby-identifier">unassigned</span>] = <span class="ruby-value">0</span>
1712:       <span class="ruby-identifier">items</span> = [ <span class="ruby-identifier">unassigned</span> ] <span class="ruby-operator">+</span> <span class="ruby-identifier">items</span>
1713: 
1714:       <span class="ruby-identifier">groups</span> = <span class="ruby-constant">Task</span>.<span class="ruby-identifier">group_by</span>(<span class="ruby-identifier">tasks</span>, <span class="ruby-identifier">items</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">task</span>, <span class="ruby-identifier">match_value</span><span class="ruby-operator">|</span>
1715:         <span class="ruby-identifier">value</span> = <span class="ruby-identifier">task</span>.<span class="ruby-identifier">property_value</span>(<span class="ruby-identifier">property</span>)
1716:         <span class="ruby-identifier">group</span> = (<span class="ruby-identifier">value</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">value</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">match_value</span>)
1717:         <span class="ruby-identifier">group</span> <span class="ruby-operator">||=</span> (<span class="ruby-identifier">value</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-keyword kw">and</span> <span class="ruby-identifier">match_value</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">unassigned</span>)
1718:         <span class="ruby-identifier">group</span>
1719:         <span class="ruby-keyword kw">end</span>
1720:     <span class="ruby-keyword kw">else</span>
1721:       <span class="ruby-identifier">groups</span> = [<span class="ruby-identifier">tasks</span>]
1722:       <span class="ruby-keyword kw">end</span>
1723: 
1724: 
1725:     <span class="ruby-keyword kw">return</span> [ <span class="ruby-identifier">group_ids</span>, <span class="ruby-identifier">groups</span> ]
1726:     <span class="ruby-keyword kw">end</span></pre></div>
</div>





</div><div class="clear" id="footer">Generated on Jan 21, 2008 / Allison 2 &copy; 2007 <a href="http://cloudbur.st">Cloudburst, LLC</a></div></div></body></html>