<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html>
  <head>
    <%= javascript_include_merged :base %>
    <%= javascript_include_merged :tt %>

    <%= javascript_include_tag "beast" if ['forums', 'posts', 'topics'].include? controller.controller_name %>

    <%= stylesheet_link_merged :tt %>
    <%= stylesheet_link_tag "beast" if ['forums', 'posts', 'topics'].include? controller.controller_name %>
    <%= javascript_include_tag "builder" if ['activities'].include? controller.controller_name %>
    <% if ['activities'].include? controller.controller_name %>
      <%= javascript_include_tag "portal" %>
      <!--[if IE]><%= javascript_include_tag "excanvas" %><![endif]-->
      <%= javascript_include_tag "flotr" %>
    <% end %>
    <%= stylesheet_link_tag "print", { :media => "print" } %>
    <%= auto_discovery_link_tag(:rss, {:controller => 'feeds', :action => 'rss', :id => current_user.uuid }) %>

    <title><%= controller.controller_name + " / " + controller.action_name %></title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<% @internal = Customer.find(:first, :conditions => ["(name = 'Internal' or name = ?) AND company_id = ?", current_user.company.name, current_user.company.id]) %>

<% if session[:project] && session[:project].customer.css && session[:project].customer.css.length > 0 %>

<style type="text/css">
<%= session[:project].customer.css %>
</style>

<% elsif !@internal.nil? && !@internal.css.nil? && @internal.css.length > 0 %>

<style type="text/css">
<%= @internal.css %>
</style>

<% end %>

  </head>

  <body id="body" style="height:100%;">
    <div id="loading" style="z-index: 1000; position:absolute; right: 10px; top: 10px; width:70px; height:20px; color: white; padding:6px; display: none; "><img src="/images/spinner.gif" border="0"></div>
    <div id="tip" style="position:absolute;top:250px;left:250px;visibility:hidden;color:#666666;z-index:60;overflow:hidden;"><table border="0"><tr><td style="background-color:#ffffff;color:#666666;border:1px solid #CCCCCC;padding:0.1em;" id="message"><br/></td></tr></table></div>
    <div id="passive-chat-container" style="display:none;"><table width="100%" cellspacing="0"><tbody id="passive-chat"></tbody></table></div>
    <table width="100%" cellspacing="0" cellpadding="0">
      <tr>
        <td colspan="2">
          <div id="menu">
              <%= render(:partial => "layouts/menu") %>
          </div>

          <table width="100%" cellpadding=0 cellspacing=0 border=0  style="margin-top:0.5em;">
            <tr>
              <td valign=bottom style="padding-left:0px;" width="100%">
              <% form_tag( {:controller => 'search', :action => 'search'}, {:method => 'get'}) do %>
              <div id="globalMenu" width="100%">
              <div id="menucontainer" width="100%">
              <div id="tabmenu" width="100%">
              <ul id="primary">
                <% if current_user.seen_welcome.to_i == 0 %>
                  <% if controller.controller_name == "activities" && controller.action_name == 'welcome' %>
                  <li><%= link_to "#{_('Tutorial')}", { :controller => 'activities', :action => 'welcome'}, :class => "active"%></li>
                  <% else %>
                  <li><%= link_to "<span>#{_('Tutorial')}</span>", { :controller => 'activities', :action => 'welcome'} %></li>
                  <% end %>
                <% end %>

                <% if controller.controller_name == "activities" && controller.action_name != 'welcome' %>
                <li class="active"><%= link_to "#{_('Overview') }", { :controller => 'activities', :action => 'list'}, :class => "active"%>
                <% else %>
                <li><%= link_to "#{_('Overview')}", { :controller => 'activities', :action => 'list'} %>                
		<% end %>
		  <ul>
		    <li><a href="/widgets/add">Add New Widget</a></li>
		  </ul>
		</li>

                <% if controller.controller_name == "tasks" && !['timeline', 'new'].include?(controller.action_name) %>
                <li class="active"><%= link_to "#{_('Browse')}", { :controller => 'views', :action => 'browse'}, :class => "active" %>
                <% else %>
                <li><%= link_to "#{_('Browse')}", :controller => 'views', :action => 'browse' %>
                <% end %>
		  <ul>
		    <li><%= link_to "#{_('Open Tasks')}", :controller => 'views', :action => 'all_tasks'%></li>
                    <li><%= link_to _('My Open Tasks'), :controller => 'views', :action => 'my_tasks'%></li>
                    <li><%= link_to _('My In Progress Tasks'), :controller => 'views', :action => 'my_in_progress_tasks'%></li>
                    <li><%= link_to _('Unassigned Tasks'), :controller => 'views', :action => 'unassigned_tasks'%></li>
                    <% project_ids = current_project_ids %>
                    <% client_ids = current_projects.collect(&:customer_id).join(',')
                       client_ids = "0" if client_ids.nil? || client_ids.empty?

                       views = View.find(:all, :conditions => ["company_id = ? AND (user_id = ? or shared = 1) AND (filter_customer_id = 0 OR filter_customer_id IS NULL OR filter_customer_id IN (#{client_ids})) AND (filter_project_id = 0 OR filter_project_id IS NULL OR filter_project_id IN (#{project_ids}))", current_user.company_id, current_user.id], :order => "shared, name")
                    for view in views %>
                    <li><%= link_to(view.name, { :controller => 'views', :action => 'select', :id => view }) %><%= link_to("[#{_('Edit')}]", {:controller => 'views', :action => 'edit', :id => view}) if view.user_id == current_user.id %><%= "[#{_('Shared')}]" if view.user_id != current_user.id %></li>
		    <% end %>
		    <li><%= link_to "[#{_('New View')}]",  :controller => 'views', :action => 'new' %></li>
		  </ul>
		</li>

                <% if current_user.option_tracktime.to_i == 1%>
                  <% if controller.controller_name == "timeline" && controller.action_name == "list" %>
                  <li><%= link_to "<span class=\"active\">#{_('Timeline')}</span>", { :controller => 'timeline', :action => 'list'}, :class => "active" %></li>
                  <% else %>
                  <li><%= link_to "<span>#{_('Timeline')}</span>", :controller => 'timeline', :action => 'list' %></li>
                  <% end %>
                <% end %>

                <% if controller.controller_name == "project_files"  %>
                <li><%= link_to "<span class=\"active\">#{_('Files')}</span>", {:controller => 'project_files', :action => 'list'}, :class => "active" %> </li>
                <% else %>
                <li><%= link_to "<span>#{_('Files')}</span>", :controller => 'project_files', :action => 'list' %> </li>
                <% end %>

                <% if current_user.option_tracktime.to_i == 1%>
                  <% if controller.controller_name == "reports"  %>
                  <li><%= link_to "<span class=\"active\">#{_('Reports')}</span>", {:controller => 'reports', :action => 'list'}, :class => "active" %></li>
                  <% else %>
                  <li><%= link_to "<span>#{_('Reports')}</span>", :controller => 'reports', :action => 'list' %></li>
                  <% end %>
                <% end %>

                <% if controller.controller_name == "schedule"  %>
                <li><%= link_to "<span class=\"active\">#{_('Schedule')}</span>", {:controller => 'schedule', :action => 'list'}, :class => "active" %></li>
                <% else %>
                <li><%= link_to "<span>#{_('Schedule')}</span>", :controller => 'schedule', :action => 'list' %></li>
                <% end %>

                <% if controller.controller_name == "wiki"  %>
                <li><%= link_to "<span class=\"active\">#{_('Wiki')}</span>", {:controller => 'wiki', :action => 'show', :id => nil}, :class => "active" %></li>
                <% else %>
                <li><%= link_to "<span>#{_('Wiki')}</span>", :controller => 'wiki', :action => 'show' %></li>
                <% end %>

                <% if controller.controller_name == "shout"  %>
                <li><%= link_to "<span class=\"active\">#{_('Chat')}</span>", {:controller => 'shout', :action => 'list'}, :class => "active" %></li>
                <% else %>
                <li><%= link_to "<span>#{_('Chat')}</span>", :controller => 'shout', :action => 'list' %></li>
                <% end %>

                <% if ['forums', 'posts', 'topics'].include? controller.controller_name  %>
                <li><%= link_to "<span class=\"active\">#{_('Forums')}</span>", {:controller => 'forums', :action => 'index'}, :class => "active" %></li>
                <% else %>
                <li><%= link_to "<span>#{_('Forums')}</span>", :controller => 'forums', :action => 'index' %></li>
                <% end %>


                <% if controller.controller_name == "tasks" && controller.action_name == 'new'  %>
                <li><%= link_to "<span class=\"active\">#{_('New Task')}</span>", {:controller => 'tasks', :action => 'new'}, :class => "active" %> 
                <% else %>
                <li><%= link_to "<span>#{_('New Task')}</span>", :controller => 'tasks', :action => 'new' %> 
                <% end %>
		  <ul>
	            <li><%= link_to _("New Project"), :controller => 'projects', :action => 'new' %></li>
	            <li><%= link_to _("New View"), :controller => 'views', :action => 'new' %></li>
	            <li><%= link_to _("New Note"), :controller => 'pages', :action => 'new' %></li>
		  </ul>
		</li>

                <li class="right"><%= link_to "<span class=\"last\">#{_('Log Out')}</span>", { :controller => 'login', :action => 'logout'}, :class => "right" %></li>
                <% if controller.controller_name == "users" && controller.action_name == "edit_preferences" %>
                <li class="right"><%= link_to "<span class=\"right active\">#{_('Preferences')}</span>", { :controller => 'users', :action => 'edit_preferences'}, :class => "right active"%></li>
                <% else %>
                <li class="right"><%= link_to "<span class=\"right\">#{_('Preferences')}</span>", { :controller => 'users', :action => 'edit_preferences'}, :class => "right" %></li>
                <% end %>

                <% if current_user.admin > 0 %>

                <% if current_user.option_externalclients.to_i == 1%>
                <% if controller.controller_name == "customers" %>
                  <li class="right"><%= link_to "<span class=\"active\">#{_('Clients')}</span>", { :controller => 'customers', :action => 'list'}, :class => "active"%></li>
                  <% else %>
                  <li class="right"><%= link_to "<span class=\"right\">#{_('Clients')}</span>", { :controller => 'customers', :action => 'list'}, :class => "right" %></li>
                <% end %>
                <% end %>


                <% if controller.controller_name == "users" && controller.action_name != "edit_preferences" %>
                   <li class="active right"><%= link_to "#{_('Users')}", { :controller => 'users', :action => 'list'}, :class => "right active"%></li>
                <% else %>
                   <li class="right"><%= link_to "#{_('Users')}", { :controller => 'users', :action => 'list'}, :class => "right" %></li>
                <% end %>

                <% end %>

                <li class="right" id="search_menu"><%=_ 'Search' %> <%= text_field_tag 'query', "", {:size => 10, :style => "font-size:9px;"}%></li>

                </ul>
              </div>
              </div>
              </div>
                <% end %>

              </td>
            </tr>
            </table>

          </td>
      </tr>
      <tr><td colspan="2" height="10px">&nbsp;</td></tr>

      <tr>
        <td valign="top" width="100%" class="rounded_content">

        <% if current_user.respond_to?(:seen_news_id)%>
          <% news = NewsItem.find(:first, :order => "created_at desc", :conditions => ["id > ?", current_user.seen_news_id ]) %>
          <% unless news.nil? %>
            <div id="news">
              <table class="news" id="news_table">
                <tr><td width="1%" nowrap valign="top"><span class="news_date">[<%= tz.utc_to_local(news.created_at).strftime("#{current_user.time_format} #{current_user.date_format}") %>]</span></td><td><span class="news_body" id="news_body"><%= news.body %></span></td><td align="right" width="1%" >
                <%= link_to_remote "[#{_('Hide')}]", :url => { :controller => 'users', :action => 'update_seen_news', :id => news.id },
                :success => visual_effect(:fade, "news", :duration => 0.5) %></td></tr>
              </table>
            </div>

          <% end %>
          <% end %>

          <div id="flash" <%="style=\"display:none\"" unless flash['notice']%>>
            <table class="flash" id="flash_body" style="padding-right:1em;"><tr><td id="flash_message"><%= flash['notice'] %><br /></td><td width="1%" align=right><a href="#" onClick="Effect.Fade('flash'); return false;">[<%=_ 'Hide'%>]</a></td></tr></table>
          </div>

          <div class="rounded_content_body" style="margin-left: 4px; margin-right: 4px; padding-top: 0pt;"><div style="background-color: rgb(238, 238, 238);"><span style="border-color: rgb(238, 238, 238); border-width: 1px 2px 0px; border-top: 1px solid rgb(238, 238, 238); overflow: hidden; background-color: rgb(255, 255, 255); display: block; height: 0px; font-size: 1px; margin-left: 3px; margin-right: 3px;"></span><span style="border-style: solid; border-color: rgb(238, 238, 238); border-width: 0px 1px; overflow: hidden; background-color: rgb(255, 255, 255); display: block; height: 1px; font-size: 1px; margin-left: 2px; margin-right: 2px;"></span><span style="border-style: solid; border-color: rgb(238, 238, 238); border-width: 0px 1px; overflow: hidden; background-color: rgb(255, 255, 255); display: block; height: 1px; font-size: 1px; margin-left: 1px; margin-right: 1px;"></span><span style="border-style: solid; border-color: rgb(238, 238, 238); border-width: 0px 1px; overflow: hidden; background-color: rgb(255, 255, 255); display: block; height: 2px; font-size: 1px; margin-left: 0px; margin-right: 0px;"></span></div><div style="border-left: 1px solid rgb(238, 238, 238); border-right: 1px solid rgb(238, 238, 238);">
          <table width="100%">
          <tr><td valign="top" id="main_col" style="height:100%;">
          <%= @content_for_layout %>
          </td>
          <td id="right-menu-collapse" class="open" onclick="new Ajax.Request('/activities/toggle_menu', {asynchronous:true, evalScripts:true, onComplete:function(request){Element.hide('loading');}, onLoading:function(request){Element.show('loading');}}); return false;">&nbsp;</td>
          <td align="right" valign="top" style="width:15%;<%= "display:none;" if session[:collapse_menu].to_i > 0 %>padding-left:1em;" id="left_menu">
            <table align="left" style="width:100%;" class="projects" cellspacing=0 cellpadding=0>
              <tr>
                <td align="left" class="page_header"colspan="2" width="100%">
                  <div style="float: left;"><%=_ 'Views' %></div><div style="float:right;padding-top:0.1em;"><%= link_to _('New'),  :controller => 'views', :action => 'new' %></div></td>

                <tr><td class="views_item" style="padding-top: 0.2em;" colspan="2"><%= link_to "#{_('Open Tasks')}", :controller => 'views', :action => 'all_tasks'%></td></tr>
                <tr><td class="views_item" colspan="2"><%= link_to _('My Open Tasks'), :controller => 'views', :action => 'my_tasks'%></td></tr>
                <tr><td class="views_item" colspan="2"><%= link_to _('My In Progress Tasks'), :controller => 'views', :action => 'my_in_progress_tasks'%></td></tr>
                <tr><td class="views_item" colspan="2"><%= link_to _('Unassigned Tasks'), :controller => 'views', :action => 'unassigned_tasks'%></td></tr>
                <% project_ids = current_project_ids %>
                <% client_ids = current_projects.collect(&:customer_id).join(',')
                   client_ids = "0" if client_ids.nil? || client_ids.empty?

                   views = View.find(:all, :conditions => ["company_id = ? AND (user_id = ? or shared = 1) AND (filter_customer_id = 0 OR filter_customer_id IS NULL OR filter_customer_id IN (#{client_ids})) AND (filter_project_id = 0 OR filter_project_id IS NULL OR filter_project_id IN (#{project_ids}))", current_user.company_id, current_user.id], :order => "shared, name")
                   for view in views %>
                <tr><td class="views_item"><%= link_to view.name, :controller => 'views', :action => 'select', :id => view %></td><td align="right"><%= link_to _('Edit'), :controller => 'views', :action => 'edit', :id => view if view.user_id == current_user.id %><%= "[#{_('Shared')}]" if view.user_id != current_user.id %></td></tr>
                   <% end %>
                <tr><td colspan=2>&nbsp;</td></tr>
                <tr>
                  <td align=left class="page_header" width="100%" colspan="2">
                    <div style="float:left;"><%=_ 'Notes'%></div><div style="float:right;padding-top:0.1em;"><%= link_to _('New'), :controller => 'pages', :action => 'new' %></div></td>
                </tr>
                        <tr><td colspan="2"><div style="height:0.2em;"></div></td></tr>
          <% for page in current_pages %>
                <tr>
                  <td align=left class="pages_item" colspan=2><%= link_to "#{page.name} / #{page.project.name}", { :controller => 'pages', :action => 'show', :id => page} %> <small>(<%=_('%s ago', time_ago_in_words( page.updated_at, false ) )%>)</small></td>
                </tr>
          <% end %>
               <tr><td colspan=2></td></tr>
              </table>
            </td></tr>
          </table>
          </div></td>
        </td>
      </tr>
    </table>
    <span id="contact" class="contact">Clocking IT v0.99.2 - <%=_ 'Feedback? Suggestions? Ideas? Bugs?'%> <a href="mailto:feedback@clockingit.com"><%=_ 'Let me know'%></a> <%= link_to "[Admin]", :controller => "admin", :action => "index" if current_user.admin == 10 %></span>

<%= periodically_call_remote(:url => { :controller => 'tasks', :action => 'update_sheet_info' }, :frequency => 90 ) -%>

<%= flash_plugin(session[:channels]) %>

<script type="text/javascript" language="javascript" charset="utf-8">
// <![CDATA[
var userId=<%=current_user.id%>;
Event.observe(window, "load", function(e) {
<% if current_user.option_tooltips.to_i == 1 %>
  makeTooltips(1);
<% else %>
  makeTooltips(0);
<% end %>

<% if controller.controller_name == 'shout' && controller.action_name == 'room' %>
  init_shout();
  $('contact').scrollTo();
  window.scrollBy(0,200);
<% end %>
});
// ]]>
</script>

</body>
</html>
