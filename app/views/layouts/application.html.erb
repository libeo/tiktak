<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>

  <!-- Javascript includes -->
  <%= javascript_include_merged :base %>
  <%= javascript_include_merged :right_column %>

  <%= yield(:javascript_includes) %>

  <!-- TODO: Is this still useful ? -->
  <%= yield :tinymce %>
  <%= yield :tinymce_init %>

  <!-- CSS includes -->
  <style type='text/css'>
    @charset "UTF-8";
  </style>
  <%= stylesheet_link_merged :base %>

  <%= yield (:stylesheet_includes) %>

  <%= stylesheet_link_tag "print", { :media => "print" } %>

  <%= auto_discovery_link_tag(:rss, {:controller => 'feeds', :action => 'rss', :id => current_user.uuid }) %>

  <!-- perticular cases -->
  <% if ['forums', 'posts', 'topics'].include? controller.controller_name %> 
    <%= javascript_include_merged :forums %>
    <%= stylesheet_link_merged :forums %>
  <% end %>

  <% if ['activities'].include? controller.controller_name %>
    <%= javascript_include_merged :widgets %>
    <%= stylesheet_link_merged :widgets %>
  <% end %>

  <title><%= $CONFIG[:productName] %></title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

  <!-- TODO : is this still used ? -->
  <% @internal = current_user.company.internal_customer %>
  <style type="text/css">
    <% if !@internal.nil? && !@internal.css.nil? && @internal.css.length > 0 %>
      <%= @internal.css %>
    <% end %>

    <% unless current_user.option_floating_chat %>
      #presence {
        position:relative;
      }
    <% end %>
  </style>

</head>
<body>
  <!-- Visual helpers like the 'in progress' cursor and the tooltip -->

  <!-- BEGINNING OF CONTENT -->
  <%= render :partial => 'header/header' %>
  <div id="content">
    <div id="subcontent">
      <div id="sub_subcontent">

        <!-- TODO: Can I remove this ? Is it still used ? -->
        <% news = NewsItem.find(:first, :order => "id desc", :conditions => ["id > ?", current_user.seen_news_id ]) %>
        <% unless news.nil? %>
          <div class="inlineMessage" id="news">
            <span class="date">[<%= tz.utc_to_local(news.created_at).strftime("#{current_user.time_format} #{current_user.date_format}") %>]</span>
            <%= news.body %>
            <%= link_to_remote "[#{_('Hide')}]", :url => { :controller => 'users', :action => 'update_seen_news', :id => news.id },:success => visual_effect(:fade, "news", :duration => 0.5) %>
          </div>
        <% end %>

        <!-- Display flash notice if any, the div container must be outside the partial if ever a notice is inserted through javascript -->
        <div id="notice_msg">
          <%= render :partial => 'layouts/notice_message' if flash['notice'] %>
        </div>

        <!-- MAIN CONTENT, code generated by the main controller gets inserted here -->
        <!-- TODO: check for rails way of inserting content instead of @content_for_layout -->
        <%= yield(:content) or yield %>

      </div>
    </div>

    <!-- RIGHT COLUMN -->
    <!-- Used to show different panels -->
    <div id="right_content">
      <div id="sub_right_content">
        <div id="right_button">
          <%= link_to_function image_tag( 'general/img_co_icon-filters-open.png', :alt => t(:open_close), :title => t(:open_close) ),
            "" %>
        </div>
        <div id="filters_content">
          <% redirect_action = controller.controller_name == 'reports' ? '/reports/list' : nil %>
          <%= render :partial => 'task_filters/panel', :locals => {:redirect_action => redirect_action} %>
          <% # use content_for(:side_panel) to add extra content to this sidebar -%>
          <%= yield(:side_panel) %>
        </div>
      </div>
    </div>
    <div class="clear"></div>
    <%# render :partial => 'layouts/footer' %>
	<div id="loading" style="z-index: 1000; position:absolute; right: 10px; top: 10px; width:70px; height:20px; color: white; padding:6px; display: none; "><%= image_tag('spinner.gif', :border => 0) %></div>

  <!-- flash plugin for push notifications (push_server) -->
  <%= flash_plugin(session[:channels]) %>

  <script type="text/javascript" language="javascript" charset="utf-8">
    // <![CDATA[
    var userId=<%=current_user.id%>;
    jQuery(document).ready(function () {
      defineToggleRightColumn();

      //updates various info on the page every 75 seconds
      toggleUpdater();

      if (!(jQuery.cookie("showrightcolumn") == 'true')) {
        jQuery('#right_button').trigger('click');
      }
    });
    // ]]>
  </script>

</body>
</html>
