<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
  <%= javascript_include_merged :base %>
  
  <!-- Is this still useful ? -->
	<%= yield :tinymce %>
	<%= yield :tinymce_init %>

  <%= javascript_include_tag 'general' %>
	<%= javascript_include_tag "beast" if ['forums', 'posts', 'topics'].include? controller.controller_name %>
	<%= javascript_include_tag "swfobject" %>

  <%= stylesheet_link_merged :base %>
  <!-- general css that can be used everywhere in the site -->
  <%= stylesheet_link_tag 'general' %>
  <%= stylesheet_link_tag 'task' %>
  <%= stylesheet_link_tag "beast" if ['forums', 'posts', 'topics'].include? controller.controller_name %>
  <%= javascript_include_tag "builder" if ['activities'].include? controller.controller_name %>

	<% if ['activities'].include? controller.controller_name %>
	  <%= javascript_include_tag "portal" %>
	  <!--[if IE]><%= javascript_include_tag "excanvas" %><![endif]-->
	  <%= javascript_include_tag "flotr" %>
  <% end %>

  <%= stylesheet_link_tag "print", { :media => "print" } %>

	<%= auto_discovery_link_tag(:rss, {:controller => 'feeds', :action => 'rss', :id => current_user.uuid }) %>

  <!-- activecalendar includes -->
	<%= stylesheet_link_tag "/javascripts/jscalendar-1.0/calendar-blue.css" %>
	<%= javascript_include_tag "jscalendar-1.0/calendar.js" %>
	<%= javascript_include_tag "jscalendar-1.0/lang/calendar-en.js" %>
	<%= javascript_include_tag "jscalendar-1.0/calendar-setup.js" %>

	<title><%= $CONFIG[:productName] %></title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

  <!-- TODO : is this still used ? -->
  <% @internal = current_user.company.internal_customer %>
	<style type="text/css">
	<% if !@internal.nil? && !@internal.css.nil? && @internal.css.length > 0 %>
    <%= @internal.css %>
  <% end %>

	<% unless current_user.option_floating_chat %>
	#presence {
		  position:relative;
	}
  <% end %>
  </style>
</head>
<body>
<!-- Visual helpers like the 'in progress' cursor and the tooltip -->

<!-- BEGINNING OF CONTENT -->
<%= render :partial => 'header/header' %>
<div id="content">
  <div id="subcontent">
    <div id="sub_subcontent">

      <!-- TODO: Can I remove this ? Is it still used ? -->
      <% news = NewsItem.find(:first, :order => "id desc", :conditions => ["id > ?", current_user.seen_news_id ]) %>
      <% unless news.nil? %>
      <div class="inlineMessage" id="news">
        <span class="date">[<%= tz.utc_to_local(news.created_at).strftime("#{current_user.time_format} #{current_user.date_format}") %>]</span>
        <%= news.body %>
        <%= link_to_remote "[#{_('Hide')}]", :url => { :controller => 'users', :action => 'update_seen_news', :id => news.id },:success => visual_effect(:fade, "news", :duration => 0.5) %>
      </div>
      <% end %>

      <!-- Display flash notice if any, the div container must be outside the partial if ever a notice is inserted through javascript -->
      <div id="notice_msg">
        <%= render :partial => 'layouts/notice_message' if flash['notice'] %>
      </div>

      <!-- MAIN CONTENT, code generated by the main controller gets inserted here -->
      <!-- TODO: check for rails way of inserting content instead of @content_for_layout -->
      <%= @content_for_layout %>

      <!-- RIGHT COLUMN -->
      <!-- Used to show different panels -->
      <div id="right_content">
        <div id="sub_right_content">
          <div id="right_button">
            <%= link_to_function image_tag( 'general/img_co_icon-filters.close.png', :alt => t(:open), :title => t(:open) ),
              "toggleRightColumn();" %> 
          </div>
          <div id="filters_content">
            <% redirect_action = controller.controller_name == 'reports' ? '/reports/list' : nil %>
            <%= render :partial => 'panels/filter_panel', :locals => {:redirect_action => redirect_action} %>
            <% # use content_for(:side_panel) to add extra content to this sidebar -%>
            <%= yield(:side_panel) %>
          </div>
        </div>
        <div class="clear"></div>
      </div>
      
      <!-- FOOTER -->
      <div id="footer">
        <div id="logo_clockingit">
          <%= image_tag 'footer/img_co_logo-clockingit.png', :alt => t(:clockingit_logo), :title => t(:clockingit_logo) %>
        </div>
        <div id="menu_footer">
          <ul>
            <li><%=mail_to('gregory@sys-tech.net', t(:help_translate) %></li>
            <li><%=mail_to('gregory@sys-tech.net', t(:give_feedback) %></li>
            <li><%=mail_to('gregory@sys-tech.net', t(:report_bugs) %></li>
          </ul>
        </div>
        <% if current_user.company.show_messaging %>
          <!-- Chat box -->
            <div id="presence-bar">
              <div id="presence-buttons">
                <% current_user.chats.each do |@chat| 
                  @user = @chat.target %>
                  <%= render :partial => 'shout/chat_user' if @chat.active >= 0%>
                  <% if @chat.active == 1 %>
                    <script type="text/javascript" language="javascript" charset="utf-8">
                      toggleChatPopup($('presence-toggle-<%=@chat.target.dom_id%>'));
                      </script>
                    <% end %>
                  <% end %>
                  <div class="presence-section" id="presence-users">
                    <div class="presence-popup" style="display:none;" id="presence-users-popup">
                      <div class="optional"><%= _'Loading'%>...</div>
                    </div>
                  </div>
                </div>
              </div>

        <% end %>




      </div>



      <table width="100%" id="main-table" class="content_body">
        <tr>

          <td valign="top" id="main_col"><%= @content_for_layout %></td>

          <!-- Right column containing stuff that can be hidden with a click on the side bar -->
          <td id="right-menu-collapse" onclick="jQuery('#left_menu').toggle(); jQuery.get('/activities/toggle_menu'); return false;">&nbsp;</td>
          <td align="right" valign="top" style="width:15%;<%= "display:none;" if session[:collapse_menu].to_i > 0 %>" id="left_menu">

            <!-- Panel with list of saved filters -->
            <% redirect_action = controller.controller_name == 'reports' ? '/reports/list' : nil %>
            <%= render(:partial => "/task_filters/panel", :locals => {:redirect_action => redirect_action }) %>

            <!-- Panel listing available notes -->
            <%= render(:partial => "pages/panel") %>

            <% # use content_for(:side_panel) to add extra content to this sidebar -%>
            <%= yield(:side_panel) %>
          </td>
        </tr>
      </table>

      <div id="loading"><%= image_tag('spinner.gif', :border => 0) %></div>
      <div id="tip"><table border="0"><tr><td style="" id="message"><br/></td></tr></table></div>
      <div id="passive-chat-container" style="display:none;"><table width="100%" cellspacing="0"><tbody id="passive-chat"></tbody></table></div>

      <!-- FOOTER -->
      <% if current_user.company.show_messaging %>

        <div id="presence" class="full">
          <div id="presence-ui" class="clearfix">

            <!-- Chat box -->
            <div id="presence-bar">
              <div id="presence-buttons">
                <% current_user.chats.each do |@chat| 
                  @user = @chat.target %>
                  <%= render :partial => 'shout/chat_user' if @chat.active >= 0%>
                  <% if @chat.active == 1 %>
                    <script type="text/javascript" language="javascript" charset="utf-8">
                      toggleChatPopup($('presence-toggle-<%=@chat.target.dom_id%>'));
                      </script>
                    <% end %>
                  <% end %>
                  <div class="presence-section" id="presence-users">
                    <div class="presence-popup" style="display:none;" id="presence-users-popup">
                      <div class="optional"><%= _'Loading'%>...</div>
                    </div>
                    <div class="presence-bar-text" style="float:left;padding-right:2px;"><img src="/images/user_comment.png" border="0" class="presence-img"/></div>
                    <div class="presence-bar-text presence-toggle" id="presence-toggle-users"><%= _('Online')%> (<span id="presence-online"><%= online_users %></span>)</div>
                  </div>
                </div>
              </div>

              <!-- Contact info -->
            <div id="contact" style="padding-left:0.3em;border-top:1px solid #ccc;"><small><em>Clocking IT<% if current_user.locale != 'en_US' %> - <a href="/locales/list"><%= _'Help Translate'%></a><% end %><br /><a href="mailto:feedback@clockingit.com"><%=_ 'Feedback? Suggestions? Ideas? Bugs?'%></a><%= link_to "[Admin]", :controller => "admin", :action => "index" if current_user.admin == 10 %></em></small></div>
            </div>
          </div>

        <% else %>

          <!-- Footer, without chat box -->
        <div id="contact"><% if current_user.locale != 'en_US' %> - <a href="/locales/list"><%= _'Help Translate'%></a><% end %><%= link_to "[Admin]", :controller => "admin", :action => "index" if current_user.admin == 10 %></div>

        <% end %>

        <!-- javascript that frequently updates the page counters (in the header) -->
        <% javascript_tag do %>
          var intervalId = null;
          toggleUpdater();
        <% end %>

<!-- flash plugin for push notifications (push_server) -->
<%= flash_plugin(session[:channels]) %>

<script type="text/javascript" language="javascript" charset="utf-8">
// <![CDATA[
var userId=<%=current_user.id%>;
jQuery(document).ready(function () {
	<% if current_user.option_tooltips.to_i == 1 %>
	  makeTooltips(1);
	<% else %>
	  makeTooltips(0);
	<% end %>
	
	<% if controller.controller_name == 'shout' && controller.action_name == 'room' %>
	  init_shout();
	  $('contact').scrollTo();
	  window.scrollBy(0,200);
	<% end %>
	
	jQuery('#presence-toggle-users').click(function () {
		toggleChatPopupEvent(this); 
	});
});
// ]]>
</script>
<%#= query_review_output %>
</body>
</html>
